import{A as Ca,B as ba,C as Ra,D as Pa,E as xa,o as ga,p as _a,q as ya,r as Me,s as va,t as wa,u as Ea,w as Ia,x as Ta,y as Sa,z as Aa}from"./chunk-Z3C6DEUP.js";import{A as Rg}from"./chunk-2FEP6AZJ.js";import{$ as Yn,$a as la,Ca as aa,Cb as ua,E as yc,G as vc,T as na,_ as ra,aa as Sg,c as ea,da as Ag,ea as ia,fa as Cg,j as ta,la as bg,p as cs,q as hs,qa as sa,ra as oa,ta as pn,u as Fe,va as re}from"./chunk-GCPY7ULT.js";import{A as K,B as ot,C as Ve,D as Tc,E as Ug,F as ps,G as ee,H as Dt,I as fa,J as Sc,K as gt,L as Lr,M as pa,N as ma,P as Ur,Q as gn,a as M,b as Fr,c as Pg,d as xg,e as Ng,f as Ze,g as ca,h as ds,i as wc,j as Dg,k as Nt,l as Ec,m as kg,n as Vg,p as ha,q as Re,r as Mg,s as Og,t as mt,u as mn,v as da,w as fs,x as Ic,y as Fg,z as Lg}from"./chunk-MQNJ6KAK.js";import{a as Or,b as us,h as _c,i as x}from"./chunk-FFXK657A.js";var qg="@firebase/database",Bg="1.0.6";var Oh="";function Fh(n){Oh=n}var Dc=class{constructor(e){this.domStorage_=e,this.prefix_="firebase:"}set(e,t){t==null?this.domStorage_.removeItem(this.prefixedName_(e)):this.domStorage_.setItem(this.prefixedName_(e),Re(t))}get(e){let t=this.domStorage_.getItem(this.prefixedName_(e));return t==null?null:ha(t)}remove(e){this.domStorage_.removeItem(this.prefixedName_(e))}prefixedName_(e){return this.prefix_+e}toString(){return this.domStorage_.toString()}};var kc=class{constructor(){this.cache_={},this.isInMemoryStorage=!0}set(e,t){t==null?delete this.cache_[e]:this.cache_[e]=t}get(e){return mt(this.cache_,e)?this.cache_[e]:null}remove(e){delete this.cache_[e]}};var y_=function(n){try{if(typeof window<"u"&&typeof window[n]<"u"){let e=window[n];return e.setItem("firebase:sentinel","cache"),e.removeItem("firebase:sentinel"),new Dc(e)}}catch{}return new kc},Xn=y_("localStorage"),Vc=y_("sessionStorage");var jr=new Lr("@firebase/database"),v_=function(){let n=1;return function(){return n++}}(),w_=function(n){let e=Ug(n),t=new Lg;t.update(e);let r=t.digest();return Pg.encodeByteArray(r)},Ls=function(...n){let e="";for(let t=0;t<n.length;t++){let r=n[t];Array.isArray(r)||r&&typeof r=="object"&&typeof r.length=="number"?e+=Ls.apply(null,r):typeof r=="object"?e+=Re(r):e+=r,e+=" "}return e},Zn=null,Gg=!0,E_=function(n,e){M(!e||n===!0||n===!1,"Can't turn on custom loggers persistently."),n===!0?(jr.logLevel=gt.VERBOSE,Zn=jr.log.bind(jr),e&&Vc.set("logging_enabled",!0)):typeof n=="function"?Zn=n:(Zn=null,Vc.remove("logging_enabled"))},Le=function(...n){if(Gg===!0&&(Gg=!1,Zn===null&&Vc.get("logging_enabled")===!0&&E_(!0)),Zn){let e=Ls.apply(null,n);Zn(e)}},Us=function(n){return function(...e){Le(n,...e)}},Mc=function(...n){let e="FIREBASE INTERNAL ERROR: "+Ls(...n);jr.error(e)},Mt=function(...n){let e=`FIREBASE FATAL ERROR: ${Ls(...n)}`;throw jr.error(e),new Error(e)},$e=function(...n){let e="FIREBASE WARNING: "+Ls(...n);jr.warn(e)},CT=function(){typeof window<"u"&&window.location&&window.location.protocol&&window.location.protocol.indexOf("https:")!==-1&&$e("Insecure Firebase access from a secure page. Please use https in calls to new Firebase().")},il=function(n){return typeof n=="number"&&(n!==n||n===Number.POSITIVE_INFINITY||n===Number.NEGATIVE_INFINITY)},bT=function(n){if(Nt()||document.readyState==="complete")n();else{let e=!1,t=function(){if(!document.body){setTimeout(t,Math.floor(10));return}e||(e=!0,n())};document.addEventListener?(document.addEventListener("DOMContentLoaded",t,!1),window.addEventListener("load",t,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",()=>{document.readyState==="complete"&&t()}),window.attachEvent("onload",t))}},wn="[MIN_NAME]",Jt="[MAX_NAME]",tr=function(n,e){if(n===e)return 0;if(n===wn||e===Jt)return-1;if(e===wn||n===Jt)return 1;{let t=jg(n),r=jg(e);return t!==null?r!==null?t-r===0?n.length-e.length:t-r:-1:r!==null?1:n<e?-1:1}},RT=function(n,e){return n===e?0:n<e?-1:1},ms=function(n,e){if(e&&n in e)return e[n];throw new Error("Missing required key ("+n+") in object: "+Re(e))},Lh=function(n){if(typeof n!="object"||n===null)return Re(n);let e=[];for(let r in n)e.push(r);e.sort();let t="{";for(let r=0;r<e.length;r++)r!==0&&(t+=","),t+=Re(e[r]),t+=":",t+=Lh(n[e[r]]);return t+="}",t},I_=function(n,e){let t=n.length;if(t<=e)return[n];let r=[];for(let i=0;i<t;i+=e)i+e>t?r.push(n.substring(i,t)):r.push(n.substring(i,i+e));return r};function Ue(n,e){for(let t in n)n.hasOwnProperty(t)&&e(t,n[t])}var T_=function(n){M(!il(n),"Invalid JSON number");let e=11,t=52,r=(1<<e-1)-1,i,s,o,l,u;n===0?(s=0,o=0,i=1/n===-1/0?1:0):(i=n<0,n=Math.abs(n),n>=Math.pow(2,1-r)?(l=Math.min(Math.floor(Math.log(n)/Math.LN2),r),s=l+r,o=Math.round(n*Math.pow(2,t-l)-Math.pow(2,t))):(s=0,o=Math.round(n/Math.pow(2,1-r-t))));let c=[];for(u=t;u;u-=1)c.push(o%2?1:0),o=Math.floor(o/2);for(u=e;u;u-=1)c.push(s%2?1:0),s=Math.floor(s/2);c.push(i?1:0),c.reverse();let d=c.join(""),p="";for(u=0;u<64;u+=8){let m=parseInt(d.substr(u,8),2).toString(16);m.length===1&&(m="0"+m),p=p+m}return p.toLowerCase()},PT=function(){return!!(typeof window=="object"&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href))},xT=function(){return typeof Windows=="object"&&typeof Windows.UI=="object"};function NT(n,e){let t="Unknown Error";n==="too_big"?t="The data requested exceeds the maximum size that can be accessed with a single request.":n==="permission_denied"?t="Client doesn't have permission to access the desired data.":n==="unavailable"&&(t="The service is unavailable");let r=new Error(n+" at "+e._path.toString()+": "+t);return r.code=n.toUpperCase(),r}var DT=new RegExp("^-?(0*)\\d{1,10}$"),kT=-2147483648,VT=2147483647,jg=function(n){if(DT.test(n)){let e=Number(n);if(e>=kT&&e<=VT)return e}return null},Xr=function(n){try{n()}catch(e){setTimeout(()=>{let t=e.stack||"";throw $e("Exception was thrown by user callback.",t),e},Math.floor(0))}},MT=function(){return(typeof window=="object"&&window.navigator&&window.navigator.userAgent||"").search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i)>=0},vs=function(n,e){let t=setTimeout(n,e);return typeof t=="number"&&typeof Deno<"u"&&Deno.unrefTimer?Deno.unrefTimer(t):typeof t=="object"&&t.unref&&t.unref(),t};var Oc=class{constructor(e,t){this.appName_=e,this.appCheckProvider=t,this.appCheck=t?.getImmediate({optional:!0}),this.appCheck||t?.get().then(r=>this.appCheck=r)}getToken(e){return this.appCheck?this.appCheck.getToken(e):new Promise((t,r)=>{setTimeout(()=>{this.appCheck?this.getToken(e).then(t,r):t(null)},0)})}addTokenChangeListener(e){var t;(t=this.appCheckProvider)===null||t===void 0||t.get().then(r=>r.addTokenListener(e))}notifyForInvalidToken(){$e(`Provided AppCheck credentials for the app named "${this.appName_}" are invalid. This usually indicates your app was not initialized correctly.`)}};var Fc=class{constructor(e,t,r){this.appName_=e,this.firebaseOptions_=t,this.authProvider_=r,this.auth_=null,this.auth_=r.getImmediate({optional:!0}),this.auth_||r.onInit(i=>this.auth_=i)}getToken(e){return this.auth_?this.auth_.getToken(e).catch(t=>t&&t.code==="auth/token-not-initialized"?(Le("Got auth/token-not-initialized error.  Treating as null token."),null):Promise.reject(t)):new Promise((t,r)=>{setTimeout(()=>{this.auth_?this.getToken(e).then(t,r):t(null)},0)})}addTokenChangeListener(e){this.auth_?this.auth_.addAuthTokenListener(e):this.authProvider_.get().then(t=>t.addAuthTokenListener(e))}removeTokenChangeListener(e){this.authProvider_.get().then(t=>t.removeAuthTokenListener(e))}notifyForInvalidToken(){let e='Provided authentication credentials for the app named "'+this.appName_+'" are invalid. This usually indicates your app was not initialized correctly. ';"credential"in this.firebaseOptions_?e+='Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':"serviceAccount"in this.firebaseOptions_?e+='Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':e+='Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.',$e(e)}},ws=(()=>{class n{constructor(t){this.accessToken=t}getToken(t){return Promise.resolve({accessToken:this.accessToken})}addTokenChangeListener(t){t(this.accessToken)}removeTokenChangeListener(t){}notifyForInvalidToken(){}}n.OWNER="owner";return n})(),Da="5",S_="v",A_="s",C_="r",b_="f",R_=/(console\.firebase|firebase-console-\w+\.corp|firebase\.corp)\.google\.com/,P_="ls",x_="p",Lc="ac",N_="websocket",D_="long_polling";var ka=class{constructor(e,t,r,i,s=!1,o="",l=!1,u=!1){this.secure=t,this.namespace=r,this.webSocketOnly=i,this.nodeAdmin=s,this.persistenceKey=o,this.includeNamespaceInQueryParams=l,this.isUsingEmulator=u,this._host=e.toLowerCase(),this._domain=this._host.substr(this._host.indexOf(".")+1),this.internalHost=Xn.get("host:"+e)||this._host}isCacheableHost(){return this.internalHost.substr(0,2)==="s-"}isCustomHost(){return this._domain!=="firebaseio.com"&&this._domain!=="firebaseio-demo.com"}get host(){return this._host}set host(e){e!==this.internalHost&&(this.internalHost=e,this.isCacheableHost()&&Xn.set("host:"+this._host,this.internalHost))}toString(){let e=this.toURLString();return this.persistenceKey&&(e+="<"+this.persistenceKey+">"),e}toURLString(){let e=this.secure?"https://":"http://",t=this.includeNamespaceInQueryParams?`?ns=${this.namespace}`:"";return`${e}${this.host}/${t}`}};function OT(n){return n.host!==n.internalHost||n.isCustomHost()||n.includeNamespaceInQueryParams}function k_(n,e,t){M(typeof e=="string","typeof type must == string"),M(typeof t=="object","typeof params must == object");let r;if(e===N_)r=(n.secure?"wss://":"ws://")+n.internalHost+"/.ws?";else if(e===D_)r=(n.secure?"https://":"http://")+n.internalHost+"/.lp?";else throw new Error("Unknown connection type: "+e);OT(n)&&(t.ns=n.namespace);let i=[];return Ue(t,(s,o)=>{i.push(s+"="+o)}),r+i.join("&")}var Uc=class{constructor(){this.counters_={}}incrementCounter(e,t=1){mt(this.counters_,e)||(this.counters_[e]=0),this.counters_[e]+=t}get(){return Ng(this.counters_)}};var Ac={},Cc={};function Uh(n){let e=n.toString();return Ac[e]||(Ac[e]=new Uc),Ac[e]}function FT(n,e){let t=n.toString();return Cc[t]||(Cc[t]=e()),Cc[t]}var qc=class{constructor(e){this.onMessage_=e,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}closeAfter(e,t){this.closeAfterResponse=e,this.onClose=t,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)}handleResponse(e,t){for(this.pendingResponses[e]=t;this.pendingResponses[this.currentResponseNum];){let r=this.pendingResponses[this.currentResponseNum];delete this.pendingResponses[this.currentResponseNum];for(let i=0;i<r.length;++i)r[i]&&Xr(()=>{this.onMessage_(r[i])});if(this.currentResponseNum===this.closeAfterResponse){this.onClose&&(this.onClose(),this.onClose=null);break}this.currentResponseNum++}}};var zg="start",LT="close",UT="pLPCommand",qT="pRTLPCB",V_="id",M_="pw",O_="ser",BT="cb",GT="seg",jT="ts",zT="d",KT="dframe",F_=1870,L_=30,WT=F_-L_,QT=25e3,$T=3e4,Ss=class n{constructor(e,t,r,i,s,o,l){this.connId=e,this.repoInfo=t,this.applicationId=r,this.appCheckToken=i,this.authToken=s,this.transportSessionId=o,this.lastSessionId=l,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=Us(e),this.stats_=Uh(t),this.urlFn=u=>(this.appCheckToken&&(u[Lc]=this.appCheckToken),k_(t,D_,u))}open(e,t){this.curSegmentNum=0,this.onDisconnect_=t,this.myPacketOrderer=new qc(e),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout(()=>{this.log_("Timed out trying to connect."),this.onClosed_(),this.connectTimeoutTimer_=null},Math.floor($T)),bT(()=>{if(this.isClosed_)return;this.scriptTagHolder=new Bc((...s)=>{let[o,l,u,c,d]=s;if(this.incrementIncomingBytes_(s),!!this.scriptTagHolder)if(this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null),this.everConnected_=!0,o===zg)this.id=l,this.password=u;else if(o===LT)l?(this.scriptTagHolder.sendNewPolls=!1,this.myPacketOrderer.closeAfter(l,()=>{this.onClosed_()})):this.onClosed_();else throw new Error("Unrecognized command received: "+o)},(...s)=>{let[o,l]=s;this.incrementIncomingBytes_(s),this.myPacketOrderer.handleResponse(o,l)},()=>{this.onClosed_()},this.urlFn);let r={};r[zg]="t",r[O_]=Math.floor(Math.random()*1e8),this.scriptTagHolder.uniqueCallbackIdentifier&&(r[BT]=this.scriptTagHolder.uniqueCallbackIdentifier),r[S_]=Da,this.transportSessionId&&(r[A_]=this.transportSessionId),this.lastSessionId&&(r[P_]=this.lastSessionId),this.applicationId&&(r[x_]=this.applicationId),this.appCheckToken&&(r[Lc]=this.appCheckToken),typeof location<"u"&&location.hostname&&R_.test(location.hostname)&&(r[C_]=b_);let i=this.urlFn(r);this.log_("Connecting via long-poll to "+i),this.scriptTagHolder.addTag(i,()=>{})})}start(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)}static forceAllow(){n.forceAllow_=!0}static forceDisallow(){n.forceDisallow_=!0}static isAvailable(){return Nt()?!1:n.forceAllow_?!0:!n.forceDisallow_&&typeof document<"u"&&document.createElement!=null&&!PT()&&!xT()}markConnectionHealthy(){}shutdown_(){this.isClosed_=!0,this.scriptTagHolder&&(this.scriptTagHolder.close(),this.scriptTagHolder=null),this.myDisconnFrame&&(document.body.removeChild(this.myDisconnFrame),this.myDisconnFrame=null),this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null)}onClosed_(){this.isClosed_||(this.log_("Longpoll is closing itself"),this.shutdown_(),this.onDisconnect_&&(this.onDisconnect_(this.everConnected_),this.onDisconnect_=null))}close(){this.isClosed_||(this.log_("Longpoll is being closed."),this.shutdown_())}send(e){let t=Re(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);let r=xg(t),i=I_(r,WT);for(let s=0;s<i.length;s++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,i.length,i[s]),this.curSegmentNum++}addDisconnectPingFrame(e,t){if(Nt())return;this.myDisconnFrame=document.createElement("iframe");let r={};r[KT]="t",r[V_]=e,r[M_]=t,this.myDisconnFrame.src=this.urlFn(r),this.myDisconnFrame.style.display="none",document.body.appendChild(this.myDisconnFrame)}incrementIncomingBytes_(e){let t=Re(e).length;this.bytesReceived+=t,this.stats_.incrementCounter("bytes_received",t)}},Bc=class n{constructor(e,t,r,i){if(this.onDisconnect=r,this.urlFn=i,this.outstandingRequests=new Set,this.pendingSegs=[],this.currentSerial=Math.floor(Math.random()*1e8),this.sendNewPolls=!0,Nt())this.commandCB=e,this.onMessageCB=t;else{this.uniqueCallbackIdentifier=v_(),window[UT+this.uniqueCallbackIdentifier]=e,window[qT+this.uniqueCallbackIdentifier]=t,this.myIFrame=n.createIFrame_();let s="";this.myIFrame.src&&this.myIFrame.src.substr(0,11)==="javascript:"&&(s='<script>document.domain="'+document.domain+'";<\/script>');let o="<html><body>"+s+"</body></html>";try{this.myIFrame.doc.open(),this.myIFrame.doc.write(o),this.myIFrame.doc.close()}catch(l){Le("frame writing exception"),l.stack&&Le(l.stack),Le(l)}}}static createIFrame_(){let e=document.createElement("iframe");if(e.style.display="none",document.body){document.body.appendChild(e);try{e.contentWindow.document||Le("No IE domain setting required")}catch{let r=document.domain;e.src="javascript:void((function(){document.open();document.domain='"+r+"';document.close();})())"}}else throw"Document body has not initialized. Wait to initialize Firebase until after the document is ready.";return e.contentDocument?e.doc=e.contentDocument:e.contentWindow?e.doc=e.contentWindow.document:e.document&&(e.doc=e.document),e}close(){this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.textContent="",setTimeout(()=>{this.myIFrame!==null&&(document.body.removeChild(this.myIFrame),this.myIFrame=null)},Math.floor(0)));let e=this.onDisconnect;e&&(this.onDisconnect=null,e())}startLongPoll(e,t){for(this.myID=e,this.myPW=t,this.alive=!0;this.newRequest_(););}newRequest_(){if(this.alive&&this.sendNewPolls&&this.outstandingRequests.size<(this.pendingSegs.length>0?2:1)){this.currentSerial++;let e={};e[V_]=this.myID,e[M_]=this.myPW,e[O_]=this.currentSerial;let t=this.urlFn(e),r="",i=0;for(;this.pendingSegs.length>0&&this.pendingSegs[0].d.length+L_+r.length<=F_;){let o=this.pendingSegs.shift();r=r+"&"+GT+i+"="+o.seg+"&"+jT+i+"="+o.ts+"&"+zT+i+"="+o.d,i++}return t=t+r,this.addLongPollTag_(t,this.currentSerial),!0}else return!1}enqueueSegment(e,t,r){this.pendingSegs.push({seg:e,ts:t,d:r}),this.alive&&this.newRequest_()}addLongPollTag_(e,t){this.outstandingRequests.add(t);let r=()=>{this.outstandingRequests.delete(t),this.newRequest_()},i=setTimeout(r,Math.floor(QT)),s=()=>{clearTimeout(i),r()};this.addTag(e,s)}addTag(e,t){Nt()?this.doNodeLongPoll(e,t):setTimeout(()=>{try{if(!this.sendNewPolls)return;let r=this.myIFrame.doc.createElement("script");r.type="text/javascript",r.async=!0,r.src=e,r.onload=r.onreadystatechange=function(){let i=r.readyState;(!i||i==="loaded"||i==="complete")&&(r.onload=r.onreadystatechange=null,r.parentNode&&r.parentNode.removeChild(r),t())},r.onerror=()=>{Le("Long-poll script failed to load: "+e),this.sendNewPolls=!1,this.close()},this.myIFrame.doc.body.appendChild(r)}catch{}},Math.floor(1))}};var HT=16384,YT=45e3,Va=null;typeof MozWebSocket<"u"?Va=MozWebSocket:typeof WebSocket<"u"&&(Va=WebSocket);var Br=(()=>{class n{constructor(t,r,i,s,o,l,u){this.connId=t,this.applicationId=i,this.appCheckToken=s,this.authToken=o,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=Us(this.connId),this.stats_=Uh(r),this.connURL=n.connectionURL_(r,l,u,s,i),this.nodeAdmin=r.nodeAdmin}static connectionURL_(t,r,i,s,o){let l={};return l[S_]=Da,!Nt()&&typeof location<"u"&&location.hostname&&R_.test(location.hostname)&&(l[C_]=b_),r&&(l[A_]=r),i&&(l[P_]=i),s&&(l[Lc]=s),o&&(l[x_]=o),k_(t,N_,l)}open(t,r){this.onDisconnect=r,this.onMessage=t,this.log_("Websocket connecting to "+this.connURL),this.everConnected_=!1,Xn.set("previous_websocket_failure",!0);try{let i;if(Nt()){let s=this.nodeAdmin?"AdminNode":"Node";i={headers:{"User-Agent":`Firebase/${Da}/${Oh}/${process.platform}/${s}`,"X-Firebase-GMPID":this.applicationId||""}},this.authToken&&(i.headers.Authorization=`Bearer ${this.authToken}`),this.appCheckToken&&(i.headers["X-Firebase-AppCheck"]=this.appCheckToken);let o=process.env,l=this.connURL.indexOf("wss://")===0?o.HTTPS_PROXY||o.https_proxy:o.HTTP_PROXY||o.http_proxy;l&&(i.proxy={origin:l})}this.mySock=new Va(this.connURL,[],i)}catch(i){this.log_("Error instantiating WebSocket.");let s=i.message||i.data;s&&this.log_(s),this.onClosed_();return}this.mySock.onopen=()=>{this.log_("Websocket connected."),this.everConnected_=!0},this.mySock.onclose=()=>{this.log_("Websocket connection was disconnected."),this.mySock=null,this.onClosed_()},this.mySock.onmessage=i=>{this.handleIncomingFrame(i)},this.mySock.onerror=i=>{this.log_("WebSocket error.  Closing connection.");let s=i.message||i.data;s&&this.log_(s),this.onClosed_()}}start(){}static forceDisallow(){n.forceDisallow_=!0}static isAvailable(){let t=!1;if(typeof navigator<"u"&&navigator.userAgent){let r=/Android ([0-9]{0,}\.[0-9]{0,})/,i=navigator.userAgent.match(r);i&&i.length>1&&parseFloat(i[1])<4.4&&(t=!0)}return!t&&Va!==null&&!n.forceDisallow_}static previouslyFailed(){return Xn.isInMemoryStorage||Xn.get("previous_websocket_failure")===!0}markConnectionHealthy(){Xn.remove("previous_websocket_failure")}appendFrame_(t){if(this.frames.push(t),this.frames.length===this.totalFrames){let r=this.frames.join("");this.frames=null;let i=ha(r);this.onMessage(i)}}handleNewFrameCount_(t){this.totalFrames=t,this.frames=[]}extractFrameCount_(t){if(M(this.frames===null,"We already have a frame buffer"),t.length<=6){let r=Number(t);if(!isNaN(r))return this.handleNewFrameCount_(r),null}return this.handleNewFrameCount_(1),t}handleIncomingFrame(t){if(this.mySock===null)return;let r=t.data;if(this.bytesReceived+=r.length,this.stats_.incrementCounter("bytes_received",r.length),this.resetKeepAlive(),this.frames!==null)this.appendFrame_(r);else{let i=this.extractFrameCount_(r);i!==null&&this.appendFrame_(i)}}send(t){this.resetKeepAlive();let r=Re(t);this.bytesSent+=r.length,this.stats_.incrementCounter("bytes_sent",r.length);let i=I_(r,HT);i.length>1&&this.sendString_(String(i.length));for(let s=0;s<i.length;s++)this.sendString_(i[s])}shutdown_(){this.isClosed_=!0,this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null),this.mySock&&(this.mySock.close(),this.mySock=null)}onClosed_(){this.isClosed_||(this.log_("WebSocket is closing itself"),this.shutdown_(),this.onDisconnect&&(this.onDisconnect(this.everConnected_),this.onDisconnect=null))}close(){this.isClosed_||(this.log_("WebSocket is being closed"),this.shutdown_())}resetKeepAlive(){clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval(()=>{this.mySock&&this.sendString_("0"),this.resetKeepAlive()},Math.floor(YT))}sendString_(t){try{this.mySock.send(t)}catch(r){this.log_("Exception thrown from WebSocket.send():",r.message||r.data,"Closing connection."),setTimeout(this.onClosed_.bind(this),0)}}}n.responsesRequiredToBeHealthy=2,n.healthyTimeout=3e4;return n})(),U_=(()=>{class n{constructor(t){this.initTransports_(t)}static get ALL_TRANSPORTS(){return[Ss,Br]}static get IS_TRANSPORT_INITIALIZED(){return this.globalTransportInitialized_}initTransports_(t){let r=Br&&Br.isAvailable(),i=r&&!Br.previouslyFailed();if(t.webSocketOnly&&(r||$e("wss:// URL used, but browser isn't known to support websockets.  Trying anyway."),i=!0),i)this.transports_=[Br];else{let s=this.transports_=[];for(let o of n.ALL_TRANSPORTS)o&&o.isAvailable()&&s.push(o);n.globalTransportInitialized_=!0}}initialTransport(){if(this.transports_.length>0)return this.transports_[0];throw new Error("No transports available")}upgradeTransport(){return this.transports_.length>1?this.transports_[1]:null}}n.globalTransportInitialized_=!1;return n})(),JT=6e4,XT=5e3,ZT=10*1024,eS=100*1024,bc="t",Kg="d",tS="s",Wg="r",nS="e",Qg="o",$g="a",Hg="n",Yg="p",rS="h",Gc=class{constructor(e,t,r,i,s,o,l,u,c,d){this.id=e,this.repoInfo_=t,this.applicationId_=r,this.appCheckToken_=i,this.authToken_=s,this.onMessage_=o,this.onReady_=l,this.onDisconnect_=u,this.onKill_=c,this.lastSessionId=d,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=Us("c:"+this.id+":"),this.transportManager_=new U_(t),this.log_("Connection created"),this.start_()}start_(){let e=this.transportManager_.initialTransport();this.conn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,null,this.lastSessionId),this.primaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;let t=this.connReceiver_(this.conn_),r=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout(()=>{this.conn_&&this.conn_.open(t,r)},Math.floor(0));let i=e.healthyTimeout||0;i>0&&(this.healthyTimeout_=vs(()=>{this.healthyTimeout_=null,this.isHealthy_||(this.conn_&&this.conn_.bytesReceived>eS?(this.log_("Connection exceeded healthy timeout but has received "+this.conn_.bytesReceived+" bytes.  Marking connection healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()):this.conn_&&this.conn_.bytesSent>ZT?this.log_("Connection exceeded healthy timeout but has sent "+this.conn_.bytesSent+" bytes.  Leaving connection alive."):(this.log_("Closing unhealthy connection after timeout."),this.close()))},Math.floor(i)))}nextTransportId_(){return"c:"+this.id+":"+this.connectionCount++}disconnReceiver_(e){return t=>{e===this.conn_?this.onConnectionLost_(t):e===this.secondaryConn_?(this.log_("Secondary connection lost."),this.onSecondaryConnectionLost_()):this.log_("closing an old connection")}}connReceiver_(e){return t=>{this.state_!==2&&(e===this.rx_?this.onPrimaryMessageReceived_(t):e===this.secondaryConn_?this.onSecondaryMessageReceived_(t):this.log_("message on old connection"))}}sendRequest(e){let t={t:"d",d:e};this.sendData_(t)}tryCleanupConnection(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_("cleaning up and promoting a connection: "+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)}onSecondaryControl_(e){if(bc in e){let t=e[bc];t===$g?this.upgradeIfSecondaryHealthy_():t===Wg?(this.log_("Got a reset on secondary, closing it"),this.secondaryConn_.close(),(this.tx_===this.secondaryConn_||this.rx_===this.secondaryConn_)&&this.close()):t===Qg&&(this.log_("got pong on secondary."),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_())}}onSecondaryMessageReceived_(e){let t=ms("t",e),r=ms("d",e);if(t==="c")this.onSecondaryControl_(r);else if(t==="d")this.pendingDataMessages.push(r);else throw new Error("Unknown protocol layer: "+t)}upgradeIfSecondaryHealthy_(){this.secondaryResponsesRequired_<=0?(this.log_("Secondary connection is healthy."),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_("sending ping on secondary."),this.secondaryConn_.send({t:"c",d:{t:Yg,d:{}}}))}proceedWithUpgrade_(){this.secondaryConn_.start(),this.log_("sending client ack on secondary"),this.secondaryConn_.send({t:"c",d:{t:$g,d:{}}}),this.log_("Ending transmission on primary"),this.conn_.send({t:"c",d:{t:Hg,d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()}onPrimaryMessageReceived_(e){let t=ms("t",e),r=ms("d",e);t==="c"?this.onControl_(r):t==="d"&&this.onDataMessage_(r)}onDataMessage_(e){this.onPrimaryResponse_(),this.onMessage_(e)}onPrimaryResponse_(){this.isHealthy_||(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_("Primary connection is healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))}onControl_(e){let t=ms(bc,e);if(Kg in e){let r=e[Kg];if(t===rS){let i=Object.assign({},r);this.repoInfo_.isUsingEmulator&&(i.h=this.repoInfo_.host),this.onHandshake_(i)}else if(t===Hg){this.log_("recvd end transmission on primary"),this.rx_=this.secondaryConn_;for(let i=0;i<this.pendingDataMessages.length;++i)this.onDataMessage_(this.pendingDataMessages[i]);this.pendingDataMessages=[],this.tryCleanupConnection()}else t===tS?this.onConnectionShutdown_(r):t===Wg?this.onReset_(r):t===nS?Mc("Server Error: "+r):t===Qg?(this.log_("got pong on primary."),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):Mc("Unknown control packet command: "+t)}}onHandshake_(e){let t=e.ts,r=e.v,i=e.h;this.sessionId=e.s,this.repoInfo_.host=i,this.state_===0&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,t),Da!==r&&$e("Protocol version mismatch detected"),this.tryStartUpgrade_())}tryStartUpgrade_(){let e=this.transportManager_.upgradeTransport();e&&this.startUpgrade_(e)}startUpgrade_(e){this.secondaryConn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,this.sessionId),this.secondaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;let t=this.connReceiver_(this.secondaryConn_),r=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(t,r),vs(()=>{this.secondaryConn_&&(this.log_("Timed out trying to upgrade."),this.secondaryConn_.close())},Math.floor(JT))}onReset_(e){this.log_("Reset packet received.  New host: "+e),this.repoInfo_.host=e,this.state_===1?this.close():(this.closeConnections_(),this.start_())}onConnectionEstablished_(e,t){this.log_("Realtime connection established."),this.conn_=e,this.state_=1,this.onReady_&&(this.onReady_(t,this.sessionId),this.onReady_=null),this.primaryResponsesRequired_===0?(this.log_("Primary connection is healthy."),this.isHealthy_=!0):vs(()=>{this.sendPingOnPrimaryIfNecessary_()},Math.floor(XT))}sendPingOnPrimaryIfNecessary_(){!this.isHealthy_&&this.state_===1&&(this.log_("sending ping on primary."),this.sendData_({t:"c",d:{t:Yg,d:{}}}))}onSecondaryConnectionLost_(){let e=this.secondaryConn_;this.secondaryConn_=null,(this.tx_===e||this.rx_===e)&&this.close()}onConnectionLost_(e){this.conn_=null,!e&&this.state_===0?(this.log_("Realtime connection failed."),this.repoInfo_.isCacheableHost()&&(Xn.remove("host:"+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)):this.state_===1&&this.log_("Realtime connection lost."),this.close()}onConnectionShutdown_(e){this.log_("Connection shutdown command received. Shutting down..."),this.onKill_&&(this.onKill_(e),this.onKill_=null),this.onDisconnect_=null,this.close()}sendData_(e){if(this.state_!==1)throw"Connection is not connected";this.tx_.send(e)}close(){this.state_!==2&&(this.log_("Closing realtime connection."),this.state_=2,this.closeConnections_(),this.onDisconnect_&&(this.onDisconnect_(),this.onDisconnect_=null))}closeConnections_(){this.log_("Shutting down all connections"),this.conn_&&(this.conn_.close(),this.conn_=null),this.secondaryConn_&&(this.secondaryConn_.close(),this.secondaryConn_=null),this.healthyTimeout_&&(clearTimeout(this.healthyTimeout_),this.healthyTimeout_=null)}};var Ma=class{put(e,t,r,i){}merge(e,t,r,i){}refreshAuthToken(e){}refreshAppCheckToken(e){}onDisconnectPut(e,t,r){}onDisconnectMerge(e,t,r){}onDisconnectCancel(e,t){}reportStats(e){}};var Oa=class{constructor(e){this.allowedEvents_=e,this.listeners_={},M(Array.isArray(e)&&e.length>0,"Requires a non-empty array")}trigger(e,...t){if(Array.isArray(this.listeners_[e])){let r=[...this.listeners_[e]];for(let i=0;i<r.length;i++)r[i].callback.apply(r[i].context,t)}}on(e,t,r){this.validateEventType_(e),this.listeners_[e]=this.listeners_[e]||[],this.listeners_[e].push({callback:t,context:r});let i=this.getInitialEvent(e);i&&t.apply(r,i)}off(e,t,r){this.validateEventType_(e);let i=this.listeners_[e]||[];for(let s=0;s<i.length;s++)if(i[s].callback===t&&(!r||r===i[s].context)){i.splice(s,1);return}}validateEventType_(e){M(this.allowedEvents_.find(t=>t===e),"Unknown event: "+e)}};var Fa=class n extends Oa{constructor(){super(["online"]),this.online_=!0,typeof window<"u"&&typeof window.addEventListener<"u"&&!wc()&&(window.addEventListener("online",()=>{this.online_||(this.online_=!0,this.trigger("online",!0))},!1),window.addEventListener("offline",()=>{this.online_&&(this.online_=!1,this.trigger("online",!1))},!1))}static getInstance(){return new n}getInitialEvent(e){return M(e==="online","Unknown event type: "+e),[this.online_]}currentlyOnline(){return this.online_}};var Jg=32,Xg=768,ue=class{constructor(e,t){if(t===void 0){this.pieces_=e.split("/");let r=0;for(let i=0;i<this.pieces_.length;i++)this.pieces_[i].length>0&&(this.pieces_[r]=this.pieces_[i],r++);this.pieces_.length=r,this.pieceNum_=0}else this.pieces_=e,this.pieceNum_=t}toString(){let e="";for(let t=this.pieceNum_;t<this.pieces_.length;t++)this.pieces_[t]!==""&&(e+="/"+this.pieces_[t]);return e||"/"}};function le(){return new ue("")}function J(n){return n.pieceNum_>=n.pieces_.length?null:n.pieces_[n.pieceNum_]}function En(n){return n.pieces_.length-n.pieceNum_}function de(n){let e=n.pieceNum_;return e<n.pieces_.length&&e++,new ue(n.pieces_,e)}function qh(n){return n.pieceNum_<n.pieces_.length?n.pieces_[n.pieces_.length-1]:null}function iS(n){let e="";for(let t=n.pieceNum_;t<n.pieces_.length;t++)n.pieces_[t]!==""&&(e+="/"+encodeURIComponent(String(n.pieces_[t])));return e||"/"}function As(n,e=0){return n.pieces_.slice(n.pieceNum_+e)}function q_(n){if(n.pieceNum_>=n.pieces_.length)return null;let e=[];for(let t=n.pieceNum_;t<n.pieces_.length-1;t++)e.push(n.pieces_[t]);return new ue(e,0)}function ye(n,e){let t=[];for(let r=n.pieceNum_;r<n.pieces_.length;r++)t.push(n.pieces_[r]);if(e instanceof ue)for(let r=e.pieceNum_;r<e.pieces_.length;r++)t.push(e.pieces_[r]);else{let r=e.split("/");for(let i=0;i<r.length;i++)r[i].length>0&&t.push(r[i])}return new ue(t,0)}function X(n){return n.pieceNum_>=n.pieces_.length}function et(n,e){let t=J(n),r=J(e);if(t===null)return e;if(t===r)return et(de(n),de(e));throw new Error("INTERNAL ERROR: innerPath ("+e+") is not within outerPath ("+n+")")}function sS(n,e){let t=As(n,0),r=As(e,0);for(let i=0;i<t.length&&i<r.length;i++){let s=tr(t[i],r[i]);if(s!==0)return s}return t.length===r.length?0:t.length<r.length?-1:1}function Bh(n,e){if(En(n)!==En(e))return!1;for(let t=n.pieceNum_,r=e.pieceNum_;t<=n.pieces_.length;t++,r++)if(n.pieces_[t]!==e.pieces_[r])return!1;return!0}function _t(n,e){let t=n.pieceNum_,r=e.pieceNum_;if(En(n)>En(e))return!1;for(;t<n.pieces_.length;){if(n.pieces_[t]!==e.pieces_[r])return!1;++t,++r}return!0}var jc=class{constructor(e,t){this.errorPrefix_=t,this.parts_=As(e,0),this.byteLength_=Math.max(1,this.parts_.length);for(let r=0;r<this.parts_.length;r++)this.byteLength_+=ps(this.parts_[r]);B_(this)}};function oS(n,e){n.parts_.length>0&&(n.byteLength_+=1),n.parts_.push(e),n.byteLength_+=ps(e),B_(n)}function aS(n){let e=n.parts_.pop();n.byteLength_-=ps(e),n.parts_.length>0&&(n.byteLength_-=1)}function B_(n){if(n.byteLength_>Xg)throw new Error(n.errorPrefix_+"has a key path longer than "+Xg+" bytes ("+n.byteLength_+").");if(n.parts_.length>Jg)throw new Error(n.errorPrefix_+"path specified exceeds the maximum depth that can be written ("+Jg+") or object contains a cycle "+Jn(n))}function Jn(n){return n.parts_.length===0?"":"in property '"+n.parts_.join(".")+"'"}var zc=class n extends Oa{constructor(){super(["visible"]);let e,t;typeof document<"u"&&typeof document.addEventListener<"u"&&(typeof document.hidden<"u"?(t="visibilitychange",e="hidden"):typeof document.mozHidden<"u"?(t="mozvisibilitychange",e="mozHidden"):typeof document.msHidden<"u"?(t="msvisibilitychange",e="msHidden"):typeof document.webkitHidden<"u"&&(t="webkitvisibilitychange",e="webkitHidden")),this.visible_=!0,t&&document.addEventListener(t,()=>{let r=!document[e];r!==this.visible_&&(this.visible_=r,this.trigger("visible",r))},!1)}static getInstance(){return new n}getInitialEvent(e){return M(e==="visible","Unknown event type: "+e),[this.visible_]}};var gs=1e3,lS=60*5*1e3,Zg=30*1e3,uS=1.3,cS=3e4,hS="server_kill",e_=3,Gh=(()=>{class n extends Ma{constructor(t,r,i,s,o,l,u,c){if(super(),this.repoInfo_=t,this.applicationId_=r,this.onDataUpdate_=i,this.onConnectStatus_=s,this.onServerInfoUpdate_=o,this.authTokenProvider_=l,this.appCheckTokenProvider_=u,this.authOverride_=c,this.id=n.nextPersistentConnectionId_++,this.log_=Us("p:"+this.id+":"),this.interruptReasons_={},this.listens=new Map,this.outstandingPuts_=[],this.outstandingGets_=[],this.outstandingPutCount_=0,this.outstandingGetCount_=0,this.onDisconnectRequestQueue_=[],this.connected_=!1,this.reconnectDelay_=gs,this.maxReconnectDelay_=lS,this.securityDebugCallback_=null,this.lastSessionId=null,this.establishConnectionTimer_=null,this.visible_=!1,this.requestCBHash_={},this.requestNumber_=0,this.realtime_=null,this.authToken_=null,this.appCheckToken_=null,this.forceTokenRefresh_=!1,this.invalidAuthTokenCount_=0,this.invalidAppCheckTokenCount_=0,this.firstConnection_=!0,this.lastConnectionAttemptTime_=null,this.lastConnectionEstablishedTime_=null,c&&!Nt())throw new Error("Auth override specified in options, but not supported on non Node.js platforms");zc.getInstance().on("visible",this.onVisible_,this),t.host.indexOf("fblocal")===-1&&Fa.getInstance().on("online",this.onOnline_,this)}sendRequest(t,r,i){let s=++this.requestNumber_,o={r:s,a:t,b:r};this.log_(Re(o)),M(this.connected_,"sendRequest call when we're not connected not allowed."),this.realtime_.sendRequest(o),i&&(this.requestCBHash_[s]=i)}get(t){this.initConnection_();let r=new Ze,s={action:"g",request:{p:t._path.toString(),q:t._queryObject},onComplete:l=>{let u=l.d;l.s==="ok"?r.resolve(u):r.reject(u)}};this.outstandingGets_.push(s),this.outstandingGetCount_++;let o=this.outstandingGets_.length-1;return this.connected_&&this.sendGet_(o),r.promise}listen(t,r,i,s){this.initConnection_();let o=t._queryIdentifier,l=t._path.toString();this.log_("Listen called for "+l+" "+o),this.listens.has(l)||this.listens.set(l,new Map),M(t._queryParams.isDefault()||!t._queryParams.loadsAllData(),"listen() called for non-default but complete query"),M(!this.listens.get(l).has(o),"listen() called twice for same path/queryId.");let u={onComplete:s,hashFn:r,query:t,tag:i};this.listens.get(l).set(o,u),this.connected_&&this.sendListen_(u)}sendGet_(t){let r=this.outstandingGets_[t];this.sendRequest("g",r.request,i=>{delete this.outstandingGets_[t],this.outstandingGetCount_--,this.outstandingGetCount_===0&&(this.outstandingGets_=[]),r.onComplete&&r.onComplete(i)})}sendListen_(t){let r=t.query,i=r._path.toString(),s=r._queryIdentifier;this.log_("Listen on "+i+" for "+s);let o={p:i},l="q";t.tag&&(o.q=r._queryObject,o.t=t.tag),o.h=t.hashFn(),this.sendRequest(l,o,u=>{let c=u.d,d=u.s;n.warnOnListenWarnings_(c,r),(this.listens.get(i)&&this.listens.get(i).get(s))===t&&(this.log_("listen response",u),d!=="ok"&&this.removeListen_(i,s),t.onComplete&&t.onComplete(d,c))})}static warnOnListenWarnings_(t,r){if(t&&typeof t=="object"&&mt(t,"w")){let i=mn(t,"w");if(Array.isArray(i)&&~i.indexOf("no_index")){let s='".indexOn": "'+r._queryParams.getIndex().toString()+'"',o=r._path.toString();$e(`Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding ${s} at ${o} to your security rules for better performance.`)}}}refreshAuthToken(t){this.authToken_=t,this.log_("Auth token refreshed"),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest("unauth",{},()=>{}),this.reduceReconnectDelayIfAdminCredential_(t)}reduceReconnectDelayIfAdminCredential_(t){(t&&t.length===40||Og(t))&&(this.log_("Admin auth credential detected.  Reducing max reconnect time."),this.maxReconnectDelay_=Zg)}refreshAppCheckToken(t){this.appCheckToken_=t,this.log_("App check token refreshed"),this.appCheckToken_?this.tryAppCheck():this.connected_&&this.sendRequest("unappeck",{},()=>{})}tryAuth(){if(this.connected_&&this.authToken_){let t=this.authToken_,r=Mg(t)?"auth":"gauth",i={cred:t};this.authOverride_===null?i.noauth=!0:typeof this.authOverride_=="object"&&(i.authvar=this.authOverride_),this.sendRequest(r,i,s=>{let o=s.s,l=s.d||"error";this.authToken_===t&&(o==="ok"?this.invalidAuthTokenCount_=0:this.onAuthRevoked_(o,l))})}}tryAppCheck(){this.connected_&&this.appCheckToken_&&this.sendRequest("appcheck",{token:this.appCheckToken_},t=>{let r=t.s,i=t.d||"error";r==="ok"?this.invalidAppCheckTokenCount_=0:this.onAppCheckRevoked_(r,i)})}unlisten(t,r){let i=t._path.toString(),s=t._queryIdentifier;this.log_("Unlisten called for "+i+" "+s),M(t._queryParams.isDefault()||!t._queryParams.loadsAllData(),"unlisten() called for non-default but complete query"),this.removeListen_(i,s)&&this.connected_&&this.sendUnlisten_(i,s,t._queryObject,r)}sendUnlisten_(t,r,i,s){this.log_("Unlisten on "+t+" for "+r);let o={p:t},l="n";s&&(o.q=i,o.t=s),this.sendRequest(l,o)}onDisconnectPut(t,r,i){this.initConnection_(),this.connected_?this.sendOnDisconnect_("o",t,r,i):this.onDisconnectRequestQueue_.push({pathString:t,action:"o",data:r,onComplete:i})}onDisconnectMerge(t,r,i){this.initConnection_(),this.connected_?this.sendOnDisconnect_("om",t,r,i):this.onDisconnectRequestQueue_.push({pathString:t,action:"om",data:r,onComplete:i})}onDisconnectCancel(t,r){this.initConnection_(),this.connected_?this.sendOnDisconnect_("oc",t,null,r):this.onDisconnectRequestQueue_.push({pathString:t,action:"oc",data:null,onComplete:r})}sendOnDisconnect_(t,r,i,s){let o={p:r,d:i};this.log_("onDisconnect "+t,o),this.sendRequest(t,o,l=>{s&&setTimeout(()=>{s(l.s,l.d)},Math.floor(0))})}put(t,r,i,s){this.putInternal("p",t,r,i,s)}merge(t,r,i,s){this.putInternal("m",t,r,i,s)}putInternal(t,r,i,s,o){this.initConnection_();let l={p:r,d:i};o!==void 0&&(l.h=o),this.outstandingPuts_.push({action:t,request:l,onComplete:s}),this.outstandingPutCount_++;let u=this.outstandingPuts_.length-1;this.connected_?this.sendPut_(u):this.log_("Buffering put: "+r)}sendPut_(t){let r=this.outstandingPuts_[t].action,i=this.outstandingPuts_[t].request,s=this.outstandingPuts_[t].onComplete;this.outstandingPuts_[t].queued=this.connected_,this.sendRequest(r,i,o=>{this.log_(r+" response",o),delete this.outstandingPuts_[t],this.outstandingPutCount_--,this.outstandingPutCount_===0&&(this.outstandingPuts_=[]),s&&s(o.s,o.d)})}reportStats(t){if(this.connected_){let r={c:t};this.log_("reportStats",r),this.sendRequest("s",r,i=>{if(i.s!=="ok"){let o=i.d;this.log_("reportStats","Error sending stats: "+o)}})}}onDataMessage_(t){if("r"in t){this.log_("from server: "+Re(t));let r=t.r,i=this.requestCBHash_[r];i&&(delete this.requestCBHash_[r],i(t.b))}else{if("error"in t)throw"A server-side error has occurred: "+t.error;"a"in t&&this.onDataPush_(t.a,t.b)}}onDataPush_(t,r){this.log_("handleServerMessage",t,r),t==="d"?this.onDataUpdate_(r.p,r.d,!1,r.t):t==="m"?this.onDataUpdate_(r.p,r.d,!0,r.t):t==="c"?this.onListenRevoked_(r.p,r.q):t==="ac"?this.onAuthRevoked_(r.s,r.d):t==="apc"?this.onAppCheckRevoked_(r.s,r.d):t==="sd"?this.onSecurityDebugPacket_(r):Mc("Unrecognized action received from server: "+Re(t)+`
Are you using the latest client?`)}onReady_(t,r){this.log_("connection ready"),this.connected_=!0,this.lastConnectionEstablishedTime_=new Date().getTime(),this.handleTimestamp_(t),this.lastSessionId=r,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)}scheduleConnect_(t){M(!this.realtime_,"Scheduling a connect when we're already connected/ing?"),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout(()=>{this.establishConnectionTimer_=null,this.establishConnection_()},Math.floor(t))}initConnection_(){!this.realtime_&&this.firstConnection_&&this.scheduleConnect_(0)}onVisible_(t){t&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_("Window became visible.  Reducing delay."),this.reconnectDelay_=gs,this.realtime_||this.scheduleConnect_(0)),this.visible_=t}onOnline_(t){t?(this.log_("Browser went online."),this.reconnectDelay_=gs,this.realtime_||this.scheduleConnect_(0)):(this.log_("Browser went offline.  Killing connection."),this.realtime_&&this.realtime_.close())}onRealtimeDisconnect_(){if(this.log_("data client disconnected"),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){this.visible_?this.lastConnectionEstablishedTime_&&(new Date().getTime()-this.lastConnectionEstablishedTime_>cS&&(this.reconnectDelay_=gs),this.lastConnectionEstablishedTime_=null):(this.log_("Window isn't visible.  Delaying reconnect."),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=new Date().getTime());let t=new Date().getTime()-this.lastConnectionAttemptTime_,r=Math.max(0,this.reconnectDelay_-t);r=Math.random()*r,this.log_("Trying to reconnect in "+r+"ms"),this.scheduleConnect_(r),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,this.reconnectDelay_*uS)}this.onConnectStatus_(!1)}establishConnection_(){return x(this,null,function*(){if(this.shouldReconnect_()){this.log_("Making a connection attempt"),this.lastConnectionAttemptTime_=new Date().getTime(),this.lastConnectionEstablishedTime_=null;let t=this.onDataMessage_.bind(this),r=this.onReady_.bind(this),i=this.onRealtimeDisconnect_.bind(this),s=this.id+":"+n.nextConnectionId_++,o=this.lastSessionId,l=!1,u=null,c=function(){u?u.close():(l=!0,i())},d=function(m){M(u,"sendRequest call when we're not connected not allowed."),u.sendRequest(m)};this.realtime_={close:c,sendRequest:d};let p=this.forceTokenRefresh_;this.forceTokenRefresh_=!1;try{let[m,v]=yield Promise.all([this.authTokenProvider_.getToken(p),this.appCheckTokenProvider_.getToken(p)]);l?Le("getToken() completed but was canceled"):(Le("getToken() completed. Creating connection."),this.authToken_=m&&m.accessToken,this.appCheckToken_=v&&v.token,u=new Gc(s,this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,t,r,i,C=>{$e(C+" ("+this.repoInfo_.toString()+")"),this.interrupt(hS)},o))}catch(m){this.log_("Failed to get token: "+m),l||(this.repoInfo_.nodeAdmin&&$e(m),c())}}})}interrupt(t){Le("Interrupting connection for reason: "+t),this.interruptReasons_[t]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_&&this.onRealtimeDisconnect_())}resume(t){Le("Resuming connection for reason: "+t),delete this.interruptReasons_[t],da(this.interruptReasons_)&&(this.reconnectDelay_=gs,this.realtime_||this.scheduleConnect_(0))}handleTimestamp_(t){let r=t-new Date().getTime();this.onServerInfoUpdate_({serverTimeOffset:r})}cancelSentTransactions_(){for(let t=0;t<this.outstandingPuts_.length;t++){let r=this.outstandingPuts_[t];r&&"h"in r.request&&r.queued&&(r.onComplete&&r.onComplete("disconnect"),delete this.outstandingPuts_[t],this.outstandingPutCount_--)}this.outstandingPutCount_===0&&(this.outstandingPuts_=[])}onListenRevoked_(t,r){let i;r?i=r.map(o=>Lh(o)).join("$"):i="default";let s=this.removeListen_(t,i);s&&s.onComplete&&s.onComplete("permission_denied")}removeListen_(t,r){let i=new ue(t).toString(),s;if(this.listens.has(i)){let o=this.listens.get(i);s=o.get(r),o.delete(r),o.size===0&&this.listens.delete(i)}else s=void 0;return s}onAuthRevoked_(t,r){Le("Auth token revoked: "+t+"/"+r),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),(t==="invalid_token"||t==="permission_denied")&&(this.invalidAuthTokenCount_++,this.invalidAuthTokenCount_>=e_&&(this.reconnectDelay_=Zg,this.authTokenProvider_.notifyForInvalidToken()))}onAppCheckRevoked_(t,r){Le("App check token revoked: "+t+"/"+r),this.appCheckToken_=null,this.forceTokenRefresh_=!0,(t==="invalid_token"||t==="permission_denied")&&(this.invalidAppCheckTokenCount_++,this.invalidAppCheckTokenCount_>=e_&&this.appCheckTokenProvider_.notifyForInvalidToken())}onSecurityDebugPacket_(t){this.securityDebugCallback_?this.securityDebugCallback_(t):"msg"in t&&console.log("FIREBASE: "+t.msg.replace(`
`,`
FIREBASE: `))}restoreState_(){this.tryAuth(),this.tryAppCheck();for(let t of this.listens.values())for(let r of t.values())this.sendListen_(r);for(let t=0;t<this.outstandingPuts_.length;t++)this.outstandingPuts_[t]&&this.sendPut_(t);for(;this.onDisconnectRequestQueue_.length;){let t=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(t.action,t.pathString,t.data,t.onComplete)}for(let t=0;t<this.outstandingGets_.length;t++)this.outstandingGets_[t]&&this.sendGet_(t)}sendConnectStats_(){let t={},r="js";Nt()&&(this.repoInfo_.nodeAdmin?r="admin_node":r="node"),t["sdk."+r+"."+Oh.replace(/\./g,"-")]=1,wc()?t["framework.cordova"]=1:Dg()&&(t["framework.reactnative"]=1),this.reportStats(t)}shouldReconnect_(){let t=Fa.getInstance().currentlyOnline();return da(this.interruptReasons_)&&t}}n.nextPersistentConnectionId_=0,n.nextConnectionId_=0;return n})(),Z=class n{constructor(e,t){this.name=e,this.node=t}static Wrap(e,t){return new n(e,t)}};var zr=class{getCompare(){return this.compare.bind(this)}indexedValueChanged(e,t){let r=new Z(wn,e),i=new Z(wn,t);return this.compare(r,i)!==0}minPost(){return Z.MIN}};var Na,La=class extends zr{static get __EMPTY_NODE(){return Na}static set __EMPTY_NODE(e){Na=e}compare(e,t){return tr(e.name,t.name)}isDefinedOn(e){throw Fr("KeyIndex.isDefinedOn not expected to be called.")}indexedValueChanged(e,t){return!1}minPost(){return Z.MIN}maxPost(){return new Z(Jt,Na)}makePost(e,t){return M(typeof e=="string","KeyIndex indexValue must always be a string."),new Z(e,Na)}toString(){return".key"}},Vt=new La;var Gr=class{constructor(e,t,r,i,s=null){this.isReverse_=i,this.resultGenerator_=s,this.nodeStack_=[];let o=1;for(;!e.isEmpty();)if(e=e,o=t?r(e.key,t):1,i&&(o*=-1),o<0)this.isReverse_?e=e.left:e=e.right;else if(o===0){this.nodeStack_.push(e);break}else this.nodeStack_.push(e),this.isReverse_?e=e.right:e=e.left}getNext(){if(this.nodeStack_.length===0)return null;let e=this.nodeStack_.pop(),t;if(this.resultGenerator_?t=this.resultGenerator_(e.key,e.value):t={key:e.key,value:e.value},this.isReverse_)for(e=e.left;!e.isEmpty();)this.nodeStack_.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack_.push(e),e=e.left;return t}hasNext(){return this.nodeStack_.length>0}peek(){if(this.nodeStack_.length===0)return null;let e=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(e.key,e.value):{key:e.key,value:e.value}}},At=(()=>{class n{constructor(t,r,i,s,o){this.key=t,this.value=r,this.color=i??n.RED,this.left=s??yt.EMPTY_NODE,this.right=o??yt.EMPTY_NODE}copy(t,r,i,s,o){return new n(t??this.key,r??this.value,i??this.color,s??this.left,o??this.right)}count(){return this.left.count()+1+this.right.count()}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||!!t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min_(){return this.left.isEmpty()?this:this.left.min_()}minKey(){return this.min_().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,r,i){let s=this,o=i(t,s.key);return o<0?s=s.copy(null,null,null,s.left.insert(t,r,i),null):o===0?s=s.copy(null,r,null,null,null):s=s.copy(null,null,null,null,s.right.insert(t,r,i)),s.fixUp_()}removeMin_(){if(this.left.isEmpty())return yt.EMPTY_NODE;let t=this;return!t.left.isRed_()&&!t.left.left.isRed_()&&(t=t.moveRedLeft_()),t=t.copy(null,null,null,t.left.removeMin_(),null),t.fixUp_()}remove(t,r){let i,s;if(i=this,r(t,i.key)<0)!i.left.isEmpty()&&!i.left.isRed_()&&!i.left.left.isRed_()&&(i=i.moveRedLeft_()),i=i.copy(null,null,null,i.left.remove(t,r),null);else{if(i.left.isRed_()&&(i=i.rotateRight_()),!i.right.isEmpty()&&!i.right.isRed_()&&!i.right.left.isRed_()&&(i=i.moveRedRight_()),r(t,i.key)===0){if(i.right.isEmpty())return yt.EMPTY_NODE;s=i.right.min_(),i=i.copy(s.key,s.value,null,null,i.right.removeMin_())}i=i.copy(null,null,null,null,i.right.remove(t,r))}return i.fixUp_()}isRed_(){return this.color}fixUp_(){let t=this;return t.right.isRed_()&&!t.left.isRed_()&&(t=t.rotateLeft_()),t.left.isRed_()&&t.left.left.isRed_()&&(t=t.rotateRight_()),t.left.isRed_()&&t.right.isRed_()&&(t=t.colorFlip_()),t}moveRedLeft_(){let t=this.colorFlip_();return t.right.left.isRed_()&&(t=t.copy(null,null,null,null,t.right.rotateRight_()),t=t.rotateLeft_(),t=t.colorFlip_()),t}moveRedRight_(){let t=this.colorFlip_();return t.left.left.isRed_()&&(t=t.rotateRight_(),t=t.colorFlip_()),t}rotateLeft_(){let t=this.copy(null,null,n.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight_(){let t=this.copy(null,null,n.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip_(){let t=this.left.copy(null,null,!this.left.color,null,null),r=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,r)}checkMaxDepth_(){let t=this.check_();return Math.pow(2,t)<=this.count()+1}check_(){if(this.isRed_()&&this.left.isRed_())throw new Error("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed_())throw new Error("Right child of ("+this.key+","+this.value+") is red");let t=this.left.check_();if(t!==this.right.check_())throw new Error("Black depths differ");return t+(this.isRed_()?0:1)}}return n.RED=!0,n.BLACK=!1,n})(),Kc=class{copy(e,t,r,i,s){return this}insert(e,t,r){return new At(e,t,null)}remove(e,t){return this}count(){return 0}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}check_(){return 0}isRed_(){return!1}},yt=class n{constructor(e,t=n.EMPTY_NODE){this.comparator_=e,this.root_=t}insert(e,t){return new n(this.comparator_,this.root_.insert(e,t,this.comparator_).copy(null,null,At.BLACK,null,null))}remove(e){return new n(this.comparator_,this.root_.remove(e,this.comparator_).copy(null,null,At.BLACK,null,null))}get(e){let t,r=this.root_;for(;!r.isEmpty();){if(t=this.comparator_(e,r.key),t===0)return r.value;t<0?r=r.left:t>0&&(r=r.right)}return null}getPredecessorKey(e){let t,r=this.root_,i=null;for(;!r.isEmpty();)if(t=this.comparator_(e,r.key),t===0){if(r.left.isEmpty())return i?i.key:null;for(r=r.left;!r.right.isEmpty();)r=r.right;return r.key}else t<0?r=r.left:t>0&&(i=r,r=r.right);throw new Error("Attempted to find predecessor key for a nonexistent key.  What gives?")}isEmpty(){return this.root_.isEmpty()}count(){return this.root_.count()}minKey(){return this.root_.minKey()}maxKey(){return this.root_.maxKey()}inorderTraversal(e){return this.root_.inorderTraversal(e)}reverseTraversal(e){return this.root_.reverseTraversal(e)}getIterator(e){return new Gr(this.root_,null,this.comparator_,!1,e)}getIteratorFrom(e,t){return new Gr(this.root_,e,this.comparator_,!1,t)}getReverseIteratorFrom(e,t){return new Gr(this.root_,e,this.comparator_,!0,t)}getReverseIterator(e){return new Gr(this.root_,null,this.comparator_,!0,e)}};yt.EMPTY_NODE=new Kc;function dS(n,e){return tr(n.name,e.name)}function jh(n,e){return tr(n,e)}var Wc;function fS(n){Wc=n}var G_=function(n){return typeof n=="number"?"number:"+T_(n):"string:"+n},j_=function(n){if(n.isLeafNode()){let e=n.val();M(typeof e=="string"||typeof e=="number"||typeof e=="object"&&mt(e,".sv"),"Priority must be a string or number.")}else M(n===Wc||n.isEmpty(),"priority of unexpected type.");M(n===Wc||n.getPriority().isEmpty(),"Priority nodes can't have a priority of their own.")};var t_,Kr=(()=>{class n{constructor(t,r=n.__childrenNodeConstructor.EMPTY_NODE){this.value_=t,this.priorityNode_=r,this.lazyHash_=null,M(this.value_!==void 0&&this.value_!==null,"LeafNode shouldn't be created with null/undefined value."),j_(this.priorityNode_)}static set __childrenNodeConstructor(t){t_=t}static get __childrenNodeConstructor(){return t_}isLeafNode(){return!0}getPriority(){return this.priorityNode_}updatePriority(t){return new n(this.value_,t)}getImmediateChild(t){return t===".priority"?this.priorityNode_:n.__childrenNodeConstructor.EMPTY_NODE}getChild(t){return X(t)?this:J(t)===".priority"?this.priorityNode_:n.__childrenNodeConstructor.EMPTY_NODE}hasChild(){return!1}getPredecessorChildName(t,r){return null}updateImmediateChild(t,r){return t===".priority"?this.updatePriority(r):r.isEmpty()&&t!==".priority"?this:n.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(t,r).updatePriority(this.priorityNode_)}updateChild(t,r){let i=J(t);return i===null?r:r.isEmpty()&&i!==".priority"?this:(M(i!==".priority"||En(t)===1,".priority must be the last token in a path"),this.updateImmediateChild(i,n.__childrenNodeConstructor.EMPTY_NODE.updateChild(de(t),r)))}isEmpty(){return!1}numChildren(){return 0}forEachChild(t,r){return!1}val(t){return t&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()}hash(){if(this.lazyHash_===null){let t="";this.priorityNode_.isEmpty()||(t+="priority:"+G_(this.priorityNode_.val())+":");let r=typeof this.value_;t+=r+":",r==="number"?t+=T_(this.value_):t+=this.value_,this.lazyHash_=w_(t)}return this.lazyHash_}getValue(){return this.value_}compareTo(t){return t===n.__childrenNodeConstructor.EMPTY_NODE?1:t instanceof n.__childrenNodeConstructor?-1:(M(t.isLeafNode(),"Unknown node type"),this.compareToLeafNode_(t))}compareToLeafNode_(t){let r=typeof t.value_,i=typeof this.value_,s=n.VALUE_TYPE_ORDER.indexOf(r),o=n.VALUE_TYPE_ORDER.indexOf(i);return M(s>=0,"Unknown leaf type: "+r),M(o>=0,"Unknown leaf type: "+i),s===o?i==="object"?0:this.value_<t.value_?-1:this.value_===t.value_?0:1:o-s}withIndex(){return this}isIndexed(){return!0}equals(t){if(t===this)return!0;if(t.isLeafNode()){let r=t;return this.value_===r.value_&&this.priorityNode_.equals(r.priorityNode_)}else return!1}}n.VALUE_TYPE_ORDER=["object","boolean","number","string"];return n})(),z_,K_;function pS(n){z_=n}function mS(n){K_=n}var Qc=class extends zr{compare(e,t){let r=e.node.getPriority(),i=t.node.getPriority(),s=r.compareTo(i);return s===0?tr(e.name,t.name):s}isDefinedOn(e){return!e.getPriority().isEmpty()}indexedValueChanged(e,t){return!e.getPriority().equals(t.getPriority())}minPost(){return Z.MIN}maxPost(){return new Z(Jt,new Kr("[PRIORITY-POST]",K_))}makePost(e,t){let r=z_(e);return new Z(t,new Kr("[PRIORITY-POST]",r))}toString(){return".priority"}},pe=new Qc;var gS=Math.log(2),$c=class{constructor(e){let t=s=>parseInt(Math.log(s)/gS,10),r=s=>parseInt(Array(s+1).join("1"),2);this.count=t(e+1),this.current_=this.count-1;let i=r(this.count);this.bits_=e+1&i}nextBitIsOne(){let e=!(this.bits_&1<<this.current_);return this.current_--,e}},Ua=function(n,e,t,r){n.sort(e);let i=function(u,c){let d=c-u,p,m;if(d===0)return null;if(d===1)return p=n[u],m=t?t(p):p,new At(m,p.node,At.BLACK,null,null);{let v=parseInt(d/2,10)+u,C=i(u,v),N=i(v+1,c);return p=n[v],m=t?t(p):p,new At(m,p.node,At.BLACK,C,N)}},s=function(u){let c=null,d=null,p=n.length,m=function(C,N){let D=p-C,B=p;p-=C;let j=i(D+1,B),q=n[D],Y=t?t(q):q;v(new At(Y,q.node,N,null,j))},v=function(C){c?(c.left=C,c=C):(d=C,c=C)};for(let C=0;C<u.count;++C){let N=u.nextBitIsOne(),D=Math.pow(2,u.count-(C+1));N?m(D,At.BLACK):(m(D,At.BLACK),m(D,At.RED))}return d},o=new $c(n.length),l=s(o);return new yt(r||e,l)};var Rc,qr={},Wr=class n{constructor(e,t){this.indexes_=e,this.indexSet_=t}static get Default(){return M(qr&&pe,"ChildrenNode.ts has not been loaded"),Rc=Rc||new n({".priority":qr},{".priority":pe}),Rc}get(e){let t=mn(this.indexes_,e);if(!t)throw new Error("No index defined for "+e);return t instanceof yt?t:null}hasIndex(e){return mt(this.indexSet_,e.toString())}addIndex(e,t){M(e!==Vt,"KeyIndex always exists and isn't meant to be added to the IndexMap.");let r=[],i=!1,s=t.getIterator(Z.Wrap),o=s.getNext();for(;o;)i=i||e.isDefinedOn(o.node),r.push(o),o=s.getNext();let l;i?l=Ua(r,e.getCompare()):l=qr;let u=e.toString(),c=Object.assign({},this.indexSet_);c[u]=e;let d=Object.assign({},this.indexes_);return d[u]=l,new n(d,c)}addToIndexes(e,t){let r=fs(this.indexes_,(i,s)=>{let o=mn(this.indexSet_,s);if(M(o,"Missing index implementation for "+s),i===qr)if(o.isDefinedOn(e.node)){let l=[],u=t.getIterator(Z.Wrap),c=u.getNext();for(;c;)c.name!==e.name&&l.push(c),c=u.getNext();return l.push(e),Ua(l,o.getCompare())}else return qr;else{let l=t.get(e.name),u=i;return l&&(u=u.remove(new Z(e.name,l))),u.insert(e,e.node)}});return new n(r,this.indexSet_)}removeFromIndexes(e,t){let r=fs(this.indexes_,i=>{if(i===qr)return i;{let s=t.get(e.name);return s?i.remove(new Z(e.name,s)):i}});return new n(r,this.indexSet_)}};var _s,Q=(()=>{class n{constructor(t,r,i){this.children_=t,this.priorityNode_=r,this.indexMap_=i,this.lazyHash_=null,this.priorityNode_&&j_(this.priorityNode_),this.children_.isEmpty()&&M(!this.priorityNode_||this.priorityNode_.isEmpty(),"An empty node cannot have a priority")}static get EMPTY_NODE(){return _s||(_s=new n(new yt(jh),null,Wr.Default))}isLeafNode(){return!1}getPriority(){return this.priorityNode_||_s}updatePriority(t){return this.children_.isEmpty()?this:new n(this.children_,t,this.indexMap_)}getImmediateChild(t){if(t===".priority")return this.getPriority();{let r=this.children_.get(t);return r===null?_s:r}}getChild(t){let r=J(t);return r===null?this:this.getImmediateChild(r).getChild(de(t))}hasChild(t){return this.children_.get(t)!==null}updateImmediateChild(t,r){if(M(r,"We should always be passing snapshot nodes"),t===".priority")return this.updatePriority(r);{let i=new Z(t,r),s,o;r.isEmpty()?(s=this.children_.remove(t),o=this.indexMap_.removeFromIndexes(i,this.children_)):(s=this.children_.insert(t,r),o=this.indexMap_.addToIndexes(i,this.children_));let l=s.isEmpty()?_s:this.priorityNode_;return new n(s,l,o)}}updateChild(t,r){let i=J(t);if(i===null)return r;{M(J(t)!==".priority"||En(t)===1,".priority must be the last token in a path");let s=this.getImmediateChild(i).updateChild(de(t),r);return this.updateImmediateChild(i,s)}}isEmpty(){return this.children_.isEmpty()}numChildren(){return this.children_.count()}val(t){if(this.isEmpty())return null;let r={},i=0,s=0,o=!0;if(this.forEachChild(pe,(l,u)=>{r[l]=u.val(t),i++,o&&n.INTEGER_REGEXP_.test(l)?s=Math.max(s,Number(l)):o=!1}),!t&&o&&s<2*i){let l=[];for(let u in r)l[u]=r[u];return l}else return t&&!this.getPriority().isEmpty()&&(r[".priority"]=this.getPriority().val()),r}hash(){if(this.lazyHash_===null){let t="";this.getPriority().isEmpty()||(t+="priority:"+G_(this.getPriority().val())+":"),this.forEachChild(pe,(r,i)=>{let s=i.hash();s!==""&&(t+=":"+r+":"+s)}),this.lazyHash_=t===""?"":w_(t)}return this.lazyHash_}getPredecessorChildName(t,r,i){let s=this.resolveIndex_(i);if(s){let o=s.getPredecessorKey(new Z(t,r));return o?o.name:null}else return this.children_.getPredecessorKey(t)}getFirstChildName(t){let r=this.resolveIndex_(t);if(r){let i=r.minKey();return i&&i.name}else return this.children_.minKey()}getFirstChild(t){let r=this.getFirstChildName(t);return r?new Z(r,this.children_.get(r)):null}getLastChildName(t){let r=this.resolveIndex_(t);if(r){let i=r.maxKey();return i&&i.name}else return this.children_.maxKey()}getLastChild(t){let r=this.getLastChildName(t);return r?new Z(r,this.children_.get(r)):null}forEachChild(t,r){let i=this.resolveIndex_(t);return i?i.inorderTraversal(s=>r(s.name,s.node)):this.children_.inorderTraversal(r)}getIterator(t){return this.getIteratorFrom(t.minPost(),t)}getIteratorFrom(t,r){let i=this.resolveIndex_(r);if(i)return i.getIteratorFrom(t,s=>s);{let s=this.children_.getIteratorFrom(t.name,Z.Wrap),o=s.peek();for(;o!=null&&r.compare(o,t)<0;)s.getNext(),o=s.peek();return s}}getReverseIterator(t){return this.getReverseIteratorFrom(t.maxPost(),t)}getReverseIteratorFrom(t,r){let i=this.resolveIndex_(r);if(i)return i.getReverseIteratorFrom(t,s=>s);{let s=this.children_.getReverseIteratorFrom(t.name,Z.Wrap),o=s.peek();for(;o!=null&&r.compare(o,t)>0;)s.getNext(),o=s.peek();return s}}compareTo(t){return this.isEmpty()?t.isEmpty()?0:-1:t.isLeafNode()||t.isEmpty()?1:t===qs?-1:0}withIndex(t){if(t===Vt||this.indexMap_.hasIndex(t))return this;{let r=this.indexMap_.addIndex(t,this.children_);return new n(this.children_,this.priorityNode_,r)}}isIndexed(t){return t===Vt||this.indexMap_.hasIndex(t)}equals(t){if(t===this)return!0;if(t.isLeafNode())return!1;{let r=t;if(this.getPriority().equals(r.getPriority()))if(this.children_.count()===r.children_.count()){let i=this.getIterator(pe),s=r.getIterator(pe),o=i.getNext(),l=s.getNext();for(;o&&l;){if(o.name!==l.name||!o.node.equals(l.node))return!1;o=i.getNext(),l=s.getNext()}return o===null&&l===null}else return!1;else return!1}}resolveIndex_(t){return t===Vt?null:this.indexMap_.get(t.toString())}}return n.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/,n})(),Hc=class extends Q{constructor(){super(new yt(jh),Q.EMPTY_NODE,Wr.Default)}compareTo(e){return e===this?0:1}equals(e){return e===this}getPriority(){return this}getImmediateChild(e){return Q.EMPTY_NODE}isEmpty(){return!1}},qs=new Hc;Object.defineProperties(Z,{MIN:{value:new Z(wn,Q.EMPTY_NODE)},MAX:{value:new Z(Jt,qs)}});La.__EMPTY_NODE=Q.EMPTY_NODE;Kr.__childrenNodeConstructor=Q;fS(qs);mS(qs);var _S=!0;function we(n,e=null){if(n===null)return Q.EMPTY_NODE;if(typeof n=="object"&&".priority"in n&&(e=n[".priority"]),M(e===null||typeof e=="string"||typeof e=="number"||typeof e=="object"&&".sv"in e,"Invalid priority type found: "+typeof e),typeof n=="object"&&".value"in n&&n[".value"]!==null&&(n=n[".value"]),typeof n!="object"||".sv"in n){let t=n;return new Kr(t,we(e))}if(!(n instanceof Array)&&_S){let t=[],r=!1;if(Ue(n,(o,l)=>{if(o.substring(0,1)!=="."){let u=we(l);u.isEmpty()||(r=r||!u.getPriority().isEmpty(),t.push(new Z(o,u)))}}),t.length===0)return Q.EMPTY_NODE;let s=Ua(t,dS,o=>o.name,jh);if(r){let o=Ua(t,pe.getCompare());return new Q(s,we(e),new Wr({".priority":o},{".priority":pe}))}else return new Q(s,we(e),Wr.Default)}else{let t=Q.EMPTY_NODE;return Ue(n,(r,i)=>{if(mt(n,r)&&r.substring(0,1)!=="."){let s=we(i);(s.isLeafNode()||!s.isEmpty())&&(t=t.updateImmediateChild(r,s))}}),t.updatePriority(we(e))}}pS(we);var Cs=class extends zr{constructor(e){super(),this.indexPath_=e,M(!X(e)&&J(e)!==".priority","Can't create PathIndex with empty path or .priority key")}extractChild(e){return e.getChild(this.indexPath_)}isDefinedOn(e){return!e.getChild(this.indexPath_).isEmpty()}compare(e,t){let r=this.extractChild(e.node),i=this.extractChild(t.node),s=r.compareTo(i);return s===0?tr(e.name,t.name):s}makePost(e,t){let r=we(e),i=Q.EMPTY_NODE.updateChild(this.indexPath_,r);return new Z(t,i)}maxPost(){let e=Q.EMPTY_NODE.updateChild(this.indexPath_,qs);return new Z(Jt,e)}toString(){return As(this.indexPath_,0).join("/")}};var Yc=class extends zr{compare(e,t){let r=e.node.compareTo(t.node);return r===0?tr(e.name,t.name):r}isDefinedOn(e){return!0}indexedValueChanged(e,t){return!e.equals(t)}minPost(){return Z.MIN}maxPost(){return Z.MAX}makePost(e,t){let r=we(e);return new Z(t,r)}toString(){return".value"}},zh=new Yc;function W_(n){return{type:"value",snapshotNode:n}}function Qr(n,e){return{type:"child_added",snapshotNode:e,childName:n}}function bs(n,e){return{type:"child_removed",snapshotNode:e,childName:n}}function Rs(n,e,t){return{type:"child_changed",snapshotNode:e,childName:n,oldSnap:t}}function yS(n,e){return{type:"child_moved",snapshotNode:e,childName:n}}var Ps=class{constructor(e){this.index_=e}updateChild(e,t,r,i,s,o){M(e.isIndexed(this.index_),"A node must be indexed if only a child is updated");let l=e.getImmediateChild(t);return l.getChild(i).equals(r.getChild(i))&&l.isEmpty()===r.isEmpty()||(o!=null&&(r.isEmpty()?e.hasChild(t)?o.trackChildChange(bs(t,l)):M(e.isLeafNode(),"A child remove without an old child only makes sense on a leaf node"):l.isEmpty()?o.trackChildChange(Qr(t,r)):o.trackChildChange(Rs(t,r,l))),e.isLeafNode()&&r.isEmpty())?e:e.updateImmediateChild(t,r).withIndex(this.index_)}updateFullNode(e,t,r){return r!=null&&(e.isLeafNode()||e.forEachChild(pe,(i,s)=>{t.hasChild(i)||r.trackChildChange(bs(i,s))}),t.isLeafNode()||t.forEachChild(pe,(i,s)=>{if(e.hasChild(i)){let o=e.getImmediateChild(i);o.equals(s)||r.trackChildChange(Rs(i,s,o))}else r.trackChildChange(Qr(i,s))})),t.withIndex(this.index_)}updatePriority(e,t){return e.isEmpty()?Q.EMPTY_NODE:e.updatePriority(t)}filtersNodes(){return!1}getIndexedFilter(){return this}getIndex(){return this.index_}};var qa=class n{constructor(e){this.indexedFilter_=new Ps(e.getIndex()),this.index_=e.getIndex(),this.startPost_=n.getStartPost_(e),this.endPost_=n.getEndPost_(e),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}getStartPost(){return this.startPost_}getEndPost(){return this.endPost_}matches(e){let t=this.startIsInclusive_?this.index_.compare(this.getStartPost(),e)<=0:this.index_.compare(this.getStartPost(),e)<0,r=this.endIsInclusive_?this.index_.compare(e,this.getEndPost())<=0:this.index_.compare(e,this.getEndPost())<0;return t&&r}updateChild(e,t,r,i,s,o){return this.matches(new Z(t,r))||(r=Q.EMPTY_NODE),this.indexedFilter_.updateChild(e,t,r,i,s,o)}updateFullNode(e,t,r){t.isLeafNode()&&(t=Q.EMPTY_NODE);let i=t.withIndex(this.index_);i=i.updatePriority(Q.EMPTY_NODE);let s=this;return t.forEachChild(pe,(o,l)=>{s.matches(new Z(o,l))||(i=i.updateImmediateChild(o,Q.EMPTY_NODE))}),this.indexedFilter_.updateFullNode(e,i,r)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.indexedFilter_}getIndex(){return this.index_}static getStartPost_(e){if(e.hasStart()){let t=e.getIndexStartName();return e.getIndex().makePost(e.getIndexStartValue(),t)}else return e.getIndex().minPost()}static getEndPost_(e){if(e.hasEnd()){let t=e.getIndexEndName();return e.getIndex().makePost(e.getIndexEndValue(),t)}else return e.getIndex().maxPost()}};var Jc=class{constructor(e){this.withinDirectionalStart=t=>this.reverse_?this.withinEndPost(t):this.withinStartPost(t),this.withinDirectionalEnd=t=>this.reverse_?this.withinStartPost(t):this.withinEndPost(t),this.withinStartPost=t=>{let r=this.index_.compare(this.rangedFilter_.getStartPost(),t);return this.startIsInclusive_?r<=0:r<0},this.withinEndPost=t=>{let r=this.index_.compare(t,this.rangedFilter_.getEndPost());return this.endIsInclusive_?r<=0:r<0},this.rangedFilter_=new qa(e),this.index_=e.getIndex(),this.limit_=e.getLimit(),this.reverse_=!e.isViewFromLeft(),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}updateChild(e,t,r,i,s,o){return this.rangedFilter_.matches(new Z(t,r))||(r=Q.EMPTY_NODE),e.getImmediateChild(t).equals(r)?e:e.numChildren()<this.limit_?this.rangedFilter_.getIndexedFilter().updateChild(e,t,r,i,s,o):this.fullLimitUpdateChild_(e,t,r,s,o)}updateFullNode(e,t,r){let i;if(t.isLeafNode()||t.isEmpty())i=Q.EMPTY_NODE.withIndex(this.index_);else if(this.limit_*2<t.numChildren()&&t.isIndexed(this.index_)){i=Q.EMPTY_NODE.withIndex(this.index_);let s;this.reverse_?s=t.getReverseIteratorFrom(this.rangedFilter_.getEndPost(),this.index_):s=t.getIteratorFrom(this.rangedFilter_.getStartPost(),this.index_);let o=0;for(;s.hasNext()&&o<this.limit_;){let l=s.getNext();if(this.withinDirectionalStart(l))if(this.withinDirectionalEnd(l))i=i.updateImmediateChild(l.name,l.node),o++;else break;else continue}}else{i=t.withIndex(this.index_),i=i.updatePriority(Q.EMPTY_NODE);let s;this.reverse_?s=i.getReverseIterator(this.index_):s=i.getIterator(this.index_);let o=0;for(;s.hasNext();){let l=s.getNext();o<this.limit_&&this.withinDirectionalStart(l)&&this.withinDirectionalEnd(l)?o++:i=i.updateImmediateChild(l.name,Q.EMPTY_NODE)}}return this.rangedFilter_.getIndexedFilter().updateFullNode(e,i,r)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.rangedFilter_.getIndexedFilter()}getIndex(){return this.index_}fullLimitUpdateChild_(e,t,r,i,s){let o;if(this.reverse_){let p=this.index_.getCompare();o=(m,v)=>p(v,m)}else o=this.index_.getCompare();let l=e;M(l.numChildren()===this.limit_,"");let u=new Z(t,r),c=this.reverse_?l.getFirstChild(this.index_):l.getLastChild(this.index_),d=this.rangedFilter_.matches(u);if(l.hasChild(t)){let p=l.getImmediateChild(t),m=i.getChildAfterChild(this.index_,c,this.reverse_);for(;m!=null&&(m.name===t||l.hasChild(m.name));)m=i.getChildAfterChild(this.index_,m,this.reverse_);let v=m==null?1:o(m,u);if(d&&!r.isEmpty()&&v>=0)return s?.trackChildChange(Rs(t,r,p)),l.updateImmediateChild(t,r);{s?.trackChildChange(bs(t,p));let N=l.updateImmediateChild(t,Q.EMPTY_NODE);return m!=null&&this.rangedFilter_.matches(m)?(s?.trackChildChange(Qr(m.name,m.node)),N.updateImmediateChild(m.name,m.node)):N}}else return r.isEmpty()?e:d&&o(c,u)>=0?(s!=null&&(s.trackChildChange(bs(c.name,c.node)),s.trackChildChange(Qr(t,r))),l.updateImmediateChild(t,r).updateImmediateChild(c.name,Q.EMPTY_NODE)):e}};var xs=class n{constructor(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.startAfterSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.endBeforeSet_=!1,this.limit_=0,this.viewFrom_="",this.indexStartValue_=null,this.indexStartName_="",this.indexEndValue_=null,this.indexEndName_="",this.index_=pe}hasStart(){return this.startSet_}isViewFromLeft(){return this.viewFrom_===""?this.startSet_:this.viewFrom_==="l"}getIndexStartValue(){return M(this.startSet_,"Only valid if start has been set"),this.indexStartValue_}getIndexStartName(){return M(this.startSet_,"Only valid if start has been set"),this.startNameSet_?this.indexStartName_:wn}hasEnd(){return this.endSet_}getIndexEndValue(){return M(this.endSet_,"Only valid if end has been set"),this.indexEndValue_}getIndexEndName(){return M(this.endSet_,"Only valid if end has been set"),this.endNameSet_?this.indexEndName_:Jt}hasLimit(){return this.limitSet_}hasAnchoredLimit(){return this.limitSet_&&this.viewFrom_!==""}getLimit(){return M(this.limitSet_,"Only valid if limit has been set"),this.limit_}getIndex(){return this.index_}loadsAllData(){return!(this.startSet_||this.endSet_||this.limitSet_)}isDefault(){return this.loadsAllData()&&this.index_===pe}copy(){let e=new n;return e.limitSet_=this.limitSet_,e.limit_=this.limit_,e.startSet_=this.startSet_,e.startAfterSet_=this.startAfterSet_,e.indexStartValue_=this.indexStartValue_,e.startNameSet_=this.startNameSet_,e.indexStartName_=this.indexStartName_,e.endSet_=this.endSet_,e.endBeforeSet_=this.endBeforeSet_,e.indexEndValue_=this.indexEndValue_,e.endNameSet_=this.endNameSet_,e.indexEndName_=this.indexEndName_,e.index_=this.index_,e.viewFrom_=this.viewFrom_,e}};function vS(n){return n.loadsAllData()?new Ps(n.getIndex()):n.hasLimit()?new Jc(n):new qa(n)}function wS(n,e){let t=n.copy();return t.limitSet_=!0,t.limit_=e,t.viewFrom_="l",t}function ES(n,e){let t=n.copy();return t.limitSet_=!0,t.limit_=e,t.viewFrom_="r",t}function Xc(n,e,t){let r=n.copy();return r.startSet_=!0,e===void 0&&(e=null),r.indexStartValue_=e,t!=null?(r.startNameSet_=!0,r.indexStartName_=t):(r.startNameSet_=!1,r.indexStartName_=""),r}function IS(n,e,t){let r;return n.index_===Vt||t?r=Xc(n,e,t):r=Xc(n,e,Jt),r.startAfterSet_=!0,r}function Zc(n,e,t){let r=n.copy();return r.endSet_=!0,e===void 0&&(e=null),r.indexEndValue_=e,t!==void 0?(r.endNameSet_=!0,r.indexEndName_=t):(r.endNameSet_=!1,r.indexEndName_=""),r}function TS(n,e,t){let r;return n.index_===Vt||t?r=Zc(n,e,t):r=Zc(n,e,wn),r.endBeforeSet_=!0,r}function sl(n,e){let t=n.copy();return t.index_=e,t}function n_(n){let e={};if(n.isDefault())return e;let t;if(n.index_===pe?t="$priority":n.index_===zh?t="$value":n.index_===Vt?t="$key":(M(n.index_ instanceof Cs,"Unrecognized index type!"),t=n.index_.toString()),e.orderBy=Re(t),n.startSet_){let r=n.startAfterSet_?"startAfter":"startAt";e[r]=Re(n.indexStartValue_),n.startNameSet_&&(e[r]+=","+Re(n.indexStartName_))}if(n.endSet_){let r=n.endBeforeSet_?"endBefore":"endAt";e[r]=Re(n.indexEndValue_),n.endNameSet_&&(e[r]+=","+Re(n.indexEndName_))}return n.limitSet_&&(n.isViewFromLeft()?e.limitToFirst=n.limit_:e.limitToLast=n.limit_),e}function r_(n){let e={};if(n.startSet_&&(e.sp=n.indexStartValue_,n.startNameSet_&&(e.sn=n.indexStartName_),e.sin=!n.startAfterSet_),n.endSet_&&(e.ep=n.indexEndValue_,n.endNameSet_&&(e.en=n.indexEndName_),e.ein=!n.endBeforeSet_),n.limitSet_){e.l=n.limit_;let t=n.viewFrom_;t===""&&(n.isViewFromLeft()?t="l":t="r"),e.vf=t}return n.index_!==pe&&(e.i=n.index_.toString()),e}var eh=class n extends Ma{constructor(e,t,r,i){super(),this.repoInfo_=e,this.onDataUpdate_=t,this.authTokenProvider_=r,this.appCheckTokenProvider_=i,this.log_=Us("p:rest:"),this.listens_={}}reportStats(e){throw new Error("Method not implemented.")}static getListenId_(e,t){return t!==void 0?"tag$"+t:(M(e._queryParams.isDefault(),"should have a tag if it's not a default query."),e._path.toString())}listen(e,t,r,i){let s=e._path.toString();this.log_("Listen called for "+s+" "+e._queryIdentifier);let o=n.getListenId_(e,r),l={};this.listens_[o]=l;let u=n_(e._queryParams);this.restRequest_(s+".json",u,(c,d)=>{let p=d;if(c===404&&(p=null,c=null),c===null&&this.onDataUpdate_(s,p,!1,r),mn(this.listens_,o)===l){let m;c?c===401?m="permission_denied":m="rest_error:"+c:m="ok",i(m,null)}})}unlisten(e,t){let r=n.getListenId_(e,t);delete this.listens_[r]}get(e){let t=n_(e._queryParams),r=e._path.toString(),i=new Ze;return this.restRequest_(r+".json",t,(s,o)=>{let l=o;s===404&&(l=null,s=null),s===null?(this.onDataUpdate_(r,l,!1,null),i.resolve(l)):i.reject(new Error(l))}),i.promise}refreshAuthToken(e){}restRequest_(e,t={},r){return t.format="export",Promise.all([this.authTokenProvider_.getToken(!1),this.appCheckTokenProvider_.getToken(!1)]).then(([i,s])=>{i&&i.accessToken&&(t.auth=i.accessToken),s&&s.token&&(t.ac=s.token);let o=(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host+e+"?ns="+this.repoInfo_.namespace+Fg(t);this.log_("Sending REST request for "+o);let l=new XMLHttpRequest;l.onreadystatechange=()=>{if(r&&l.readyState===4){this.log_("REST Response for "+o+" received. status:",l.status,"response:",l.responseText);let u=null;if(l.status>=200&&l.status<300){try{u=ha(l.responseText)}catch{$e("Failed to parse JSON response for "+o+": "+l.responseText)}r(null,u)}else l.status!==401&&l.status!==404&&$e("Got unsuccessful REST response for "+o+" Status: "+l.status),r(l.status);r=null}},l.open("GET",o,!0),l.send()})}};var th=class{constructor(){this.rootNode_=Q.EMPTY_NODE}getNode(e){return this.rootNode_.getChild(e)}updateSnapshot(e,t){this.rootNode_=this.rootNode_.updateChild(e,t)}};function Ba(){return{value:null,children:new Map}}function Zr(n,e,t){if(X(e))n.value=t,n.children.clear();else if(n.value!==null)n.value=n.value.updateChild(e,t);else{let r=J(e);n.children.has(r)||n.children.set(r,Ba());let i=n.children.get(r);e=de(e),Zr(i,e,t)}}function nh(n,e){if(X(e))return n.value=null,n.children.clear(),!0;if(n.value!==null){if(n.value.isLeafNode())return!1;{let t=n.value;return n.value=null,t.forEachChild(pe,(r,i)=>{Zr(n,new ue(r),i)}),nh(n,e)}}else if(n.children.size>0){let t=J(e);return e=de(e),n.children.has(t)&&nh(n.children.get(t),e)&&n.children.delete(t),n.children.size===0}else return!0}function rh(n,e,t){n.value!==null?t(e,n.value):SS(n,(r,i)=>{let s=new ue(e.toString()+"/"+r);rh(i,s,t)})}function SS(n,e){n.children.forEach((t,r)=>{e(r,t)})}var ih=class{constructor(e){this.collection_=e,this.last_=null}get(){let e=this.collection_.get(),t=Object.assign({},e);return this.last_&&Ue(this.last_,(r,i)=>{t[r]=t[r]-i}),this.last_=e,t}};var i_=10*1e3,AS=30*1e3,CS=5*60*1e3,sh=class{constructor(e,t){this.server_=t,this.statsToReport_={},this.statsListener_=new ih(e);let r=i_+(AS-i_)*Math.random();vs(this.reportStats_.bind(this),Math.floor(r))}reportStats_(){let e=this.statsListener_.get(),t={},r=!1;Ue(e,(i,s)=>{s>0&&mt(this.statsToReport_,i)&&(t[i]=s,r=!0)}),r&&this.server_.reportStats(t),vs(this.reportStats_.bind(this),Math.floor(Math.random()*2*CS))}};var kt=function(n){return n[n.OVERWRITE=0]="OVERWRITE",n[n.MERGE=1]="MERGE",n[n.ACK_USER_WRITE=2]="ACK_USER_WRITE",n[n.LISTEN_COMPLETE=3]="LISTEN_COMPLETE",n}(kt||{});function Kh(){return{fromUser:!0,fromServer:!1,queryId:null,tagged:!1}}function Wh(){return{fromUser:!1,fromServer:!0,queryId:null,tagged:!1}}function Qh(n){return{fromUser:!1,fromServer:!0,queryId:n,tagged:!0}}var oh=class n{constructor(e,t,r){this.path=e,this.affectedTree=t,this.revert=r,this.type=kt.ACK_USER_WRITE,this.source=Kh()}operationForChild(e){if(X(this.path)){if(this.affectedTree.value!=null)return M(this.affectedTree.children.isEmpty(),"affectedTree should not have overlapping affected paths."),this;{let t=this.affectedTree.subtree(new ue(e));return new n(le(),t,this.revert)}}else return M(J(this.path)===e,"operationForChild called for unrelated child."),new n(de(this.path),this.affectedTree,this.revert)}};var Ga=class n{constructor(e,t){this.source=e,this.path=t,this.type=kt.LISTEN_COMPLETE}operationForChild(e){return X(this.path)?new n(this.source,le()):new n(this.source,de(this.path))}};var $r=class n{constructor(e,t,r){this.source=e,this.path=t,this.snap=r,this.type=kt.OVERWRITE}operationForChild(e){return X(this.path)?new n(this.source,le(),this.snap.getImmediateChild(e)):new n(this.source,de(this.path),this.snap)}};var Ns=class n{constructor(e,t,r){this.source=e,this.path=t,this.children=r,this.type=kt.MERGE}operationForChild(e){if(X(this.path)){let t=this.children.subtree(new ue(e));return t.isEmpty()?null:t.value?new $r(this.source,le(),t.value):new n(this.source,le(),t)}else return M(J(this.path)===e,"Can't get a merge for a child not on the path of the operation"),new n(this.source,de(this.path),this.children)}toString(){return"Operation("+this.path+": "+this.source.toString()+" merge: "+this.children.toString()+")"}};var Ot=class{constructor(e,t,r){this.node_=e,this.fullyInitialized_=t,this.filtered_=r}isFullyInitialized(){return this.fullyInitialized_}isFiltered(){return this.filtered_}isCompleteForPath(e){if(X(e))return this.isFullyInitialized()&&!this.filtered_;let t=J(e);return this.isCompleteForChild(t)}isCompleteForChild(e){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(e)}getNode(){return this.node_}};var ah=class{constructor(e){this.query_=e,this.index_=this.query_._queryParams.getIndex()}};function bS(n,e,t,r){let i=[],s=[];return e.forEach(o=>{o.type==="child_changed"&&n.index_.indexedValueChanged(o.oldSnap,o.snapshotNode)&&s.push(yS(o.childName,o.snapshotNode))}),ys(n,i,"child_removed",e,r,t),ys(n,i,"child_added",e,r,t),ys(n,i,"child_moved",s,r,t),ys(n,i,"child_changed",e,r,t),ys(n,i,"value",e,r,t),i}function ys(n,e,t,r,i,s){let o=r.filter(l=>l.type===t);o.sort((l,u)=>PS(n,l,u)),o.forEach(l=>{let u=RS(n,l,s);i.forEach(c=>{c.respondsTo(l.type)&&e.push(c.createEvent(u,n.query_))})})}function RS(n,e,t){return e.type==="value"||e.type==="child_removed"||(e.prevName=t.getPredecessorChildName(e.childName,e.snapshotNode,n.index_)),e}function PS(n,e,t){if(e.childName==null||t.childName==null)throw Fr("Should only compare child_ events.");let r=new Z(e.childName,e.snapshotNode),i=new Z(t.childName,t.snapshotNode);return n.index_.compare(r,i)}function ol(n,e){return{eventCache:n,serverCache:e}}function Es(n,e,t,r){return ol(new Ot(e,t,r),n.serverCache)}function Q_(n,e,t,r){return ol(n.eventCache,new Ot(e,t,r))}function ja(n){return n.eventCache.isFullyInitialized()?n.eventCache.getNode():null}function er(n){return n.serverCache.isFullyInitialized()?n.serverCache.getNode():null}var Pc,xS=()=>(Pc||(Pc=new yt(RT)),Pc),tt=class n{constructor(e,t=xS()){this.value=e,this.children=t}static fromObject(e){let t=new n(null);return Ue(e,(r,i)=>{t=t.set(new ue(r),i)}),t}isEmpty(){return this.value===null&&this.children.isEmpty()}findRootMostMatchingPathAndValue(e,t){if(this.value!=null&&t(this.value))return{path:le(),value:this.value};if(X(e))return null;{let r=J(e),i=this.children.get(r);if(i!==null){let s=i.findRootMostMatchingPathAndValue(de(e),t);return s!=null?{path:ye(new ue(r),s.path),value:s.value}:null}else return null}}findRootMostValueAndPath(e){return this.findRootMostMatchingPathAndValue(e,()=>!0)}subtree(e){if(X(e))return this;{let t=J(e),r=this.children.get(t);return r!==null?r.subtree(de(e)):new n(null)}}set(e,t){if(X(e))return new n(t,this.children);{let r=J(e),s=(this.children.get(r)||new n(null)).set(de(e),t),o=this.children.insert(r,s);return new n(this.value,o)}}remove(e){if(X(e))return this.children.isEmpty()?new n(null):new n(null,this.children);{let t=J(e),r=this.children.get(t);if(r){let i=r.remove(de(e)),s;return i.isEmpty()?s=this.children.remove(t):s=this.children.insert(t,i),this.value===null&&s.isEmpty()?new n(null):new n(this.value,s)}else return this}}get(e){if(X(e))return this.value;{let t=J(e),r=this.children.get(t);return r?r.get(de(e)):null}}setTree(e,t){if(X(e))return t;{let r=J(e),s=(this.children.get(r)||new n(null)).setTree(de(e),t),o;return s.isEmpty()?o=this.children.remove(r):o=this.children.insert(r,s),new n(this.value,o)}}fold(e){return this.fold_(le(),e)}fold_(e,t){let r={};return this.children.inorderTraversal((i,s)=>{r[i]=s.fold_(ye(e,i),t)}),t(e,this.value,r)}findOnPath(e,t){return this.findOnPath_(e,le(),t)}findOnPath_(e,t,r){let i=this.value?r(t,this.value):!1;if(i)return i;if(X(e))return null;{let s=J(e),o=this.children.get(s);return o?o.findOnPath_(de(e),ye(t,s),r):null}}foreachOnPath(e,t){return this.foreachOnPath_(e,le(),t)}foreachOnPath_(e,t,r){if(X(e))return this;{this.value&&r(t,this.value);let i=J(e),s=this.children.get(i);return s?s.foreachOnPath_(de(e),ye(t,i),r):new n(null)}}foreach(e){this.foreach_(le(),e)}foreach_(e,t){this.children.inorderTraversal((r,i)=>{i.foreach_(ye(e,r),t)}),this.value&&t(e,this.value)}foreachChild(e){this.children.inorderTraversal((t,r)=>{r.value&&e(t,r.value)})}};var Ct=class n{constructor(e){this.writeTree_=e}static empty(){return new n(new tt(null))}};function Is(n,e,t){if(X(e))return new Ct(new tt(t));{let r=n.writeTree_.findRootMostValueAndPath(e);if(r!=null){let i=r.path,s=r.value,o=et(i,e);return s=s.updateChild(o,t),new Ct(n.writeTree_.set(i,s))}else{let i=new tt(t),s=n.writeTree_.setTree(e,i);return new Ct(s)}}}function lh(n,e,t){let r=n;return Ue(t,(i,s)=>{r=Is(r,ye(e,i),s)}),r}function s_(n,e){if(X(e))return Ct.empty();{let t=n.writeTree_.setTree(e,new tt(null));return new Ct(t)}}function uh(n,e){return nr(n,e)!=null}function nr(n,e){let t=n.writeTree_.findRootMostValueAndPath(e);return t!=null?n.writeTree_.get(t.path).getChild(et(t.path,e)):null}function o_(n){let e=[],t=n.writeTree_.value;return t!=null?t.isLeafNode()||t.forEachChild(pe,(r,i)=>{e.push(new Z(r,i))}):n.writeTree_.children.inorderTraversal((r,i)=>{i.value!=null&&e.push(new Z(r,i.value))}),e}function yn(n,e){if(X(e))return n;{let t=nr(n,e);return t!=null?new Ct(new tt(t)):new Ct(n.writeTree_.subtree(e))}}function ch(n){return n.writeTree_.isEmpty()}function Hr(n,e){return $_(le(),n.writeTree_,e)}function $_(n,e,t){if(e.value!=null)return t.updateChild(n,e.value);{let r=null;return e.children.inorderTraversal((i,s)=>{i===".priority"?(M(s.value!==null,"Priority writes must always be leaf nodes"),r=s.value):t=$_(ye(n,i),s,t)}),!t.getChild(n).isEmpty()&&r!==null&&(t=t.updateChild(ye(n,".priority"),r)),t}}function al(n,e){return X_(e,n)}function NS(n,e,t,r,i){M(r>n.lastWriteId,"Stacking an older write on top of newer ones"),i===void 0&&(i=!0),n.allWrites.push({path:e,snap:t,writeId:r,visible:i}),i&&(n.visibleWrites=Is(n.visibleWrites,e,t)),n.lastWriteId=r}function DS(n,e,t,r){M(r>n.lastWriteId,"Stacking an older merge on top of newer ones"),n.allWrites.push({path:e,children:t,writeId:r,visible:!0}),n.visibleWrites=lh(n.visibleWrites,e,t),n.lastWriteId=r}function kS(n,e){for(let t=0;t<n.allWrites.length;t++){let r=n.allWrites[t];if(r.writeId===e)return r}return null}function VS(n,e){let t=n.allWrites.findIndex(l=>l.writeId===e);M(t>=0,"removeWrite called with nonexistent writeId.");let r=n.allWrites[t];n.allWrites.splice(t,1);let i=r.visible,s=!1,o=n.allWrites.length-1;for(;i&&o>=0;){let l=n.allWrites[o];l.visible&&(o>=t&&MS(l,r.path)?i=!1:_t(r.path,l.path)&&(s=!0)),o--}if(i){if(s)return OS(n),!0;if(r.snap)n.visibleWrites=s_(n.visibleWrites,r.path);else{let l=r.children;Ue(l,u=>{n.visibleWrites=s_(n.visibleWrites,ye(r.path,u))})}return!0}else return!1}function MS(n,e){if(n.snap)return _t(n.path,e);for(let t in n.children)if(n.children.hasOwnProperty(t)&&_t(ye(n.path,t),e))return!0;return!1}function OS(n){n.visibleWrites=H_(n.allWrites,FS,le()),n.allWrites.length>0?n.lastWriteId=n.allWrites[n.allWrites.length-1].writeId:n.lastWriteId=-1}function FS(n){return n.visible}function H_(n,e,t){let r=Ct.empty();for(let i=0;i<n.length;++i){let s=n[i];if(e(s)){let o=s.path,l;if(s.snap)_t(t,o)?(l=et(t,o),r=Is(r,l,s.snap)):_t(o,t)&&(l=et(o,t),r=Is(r,le(),s.snap.getChild(l)));else if(s.children){if(_t(t,o))l=et(t,o),r=lh(r,l,s.children);else if(_t(o,t))if(l=et(o,t),X(l))r=lh(r,le(),s.children);else{let u=mn(s.children,J(l));if(u){let c=u.getChild(de(l));r=Is(r,le(),c)}}}else throw Fr("WriteRecord should have .snap or .children")}}return r}function Y_(n,e,t,r,i){if(!r&&!i){let s=nr(n.visibleWrites,e);if(s!=null)return s;{let o=yn(n.visibleWrites,e);if(ch(o))return t;if(t==null&&!uh(o,le()))return null;{let l=t||Q.EMPTY_NODE;return Hr(o,l)}}}else{let s=yn(n.visibleWrites,e);if(!i&&ch(s))return t;if(!i&&t==null&&!uh(s,le()))return null;{let o=function(c){return(c.visible||i)&&(!r||!~r.indexOf(c.writeId))&&(_t(c.path,e)||_t(e,c.path))},l=H_(n.allWrites,o,e),u=t||Q.EMPTY_NODE;return Hr(l,u)}}}function LS(n,e,t){let r=Q.EMPTY_NODE,i=nr(n.visibleWrites,e);if(i)return i.isLeafNode()||i.forEachChild(pe,(s,o)=>{r=r.updateImmediateChild(s,o)}),r;if(t){let s=yn(n.visibleWrites,e);return t.forEachChild(pe,(o,l)=>{let u=Hr(yn(s,new ue(o)),l);r=r.updateImmediateChild(o,u)}),o_(s).forEach(o=>{r=r.updateImmediateChild(o.name,o.node)}),r}else{let s=yn(n.visibleWrites,e);return o_(s).forEach(o=>{r=r.updateImmediateChild(o.name,o.node)}),r}}function US(n,e,t,r,i){M(r||i,"Either existingEventSnap or existingServerSnap must exist");let s=ye(e,t);if(uh(n.visibleWrites,s))return null;{let o=yn(n.visibleWrites,s);return ch(o)?i.getChild(t):Hr(o,i.getChild(t))}}function qS(n,e,t,r){let i=ye(e,t),s=nr(n.visibleWrites,i);if(s!=null)return s;if(r.isCompleteForChild(t)){let o=yn(n.visibleWrites,i);return Hr(o,r.getNode().getImmediateChild(t))}else return null}function BS(n,e){return nr(n.visibleWrites,e)}function GS(n,e,t,r,i,s,o){let l,u=yn(n.visibleWrites,e),c=nr(u,le());if(c!=null)l=c;else if(t!=null)l=Hr(u,t);else return[];if(l=l.withIndex(o),!l.isEmpty()&&!l.isLeafNode()){let d=[],p=o.getCompare(),m=s?l.getReverseIteratorFrom(r,o):l.getIteratorFrom(r,o),v=m.getNext();for(;v&&d.length<i;)p(v,r)!==0&&d.push(v),v=m.getNext();return d}else return[]}function jS(){return{visibleWrites:Ct.empty(),allWrites:[],lastWriteId:-1}}function za(n,e,t,r){return Y_(n.writeTree,n.treePath,e,t,r)}function $h(n,e){return LS(n.writeTree,n.treePath,e)}function a_(n,e,t,r){return US(n.writeTree,n.treePath,e,t,r)}function Ka(n,e){return BS(n.writeTree,ye(n.treePath,e))}function zS(n,e,t,r,i,s){return GS(n.writeTree,n.treePath,e,t,r,i,s)}function Hh(n,e,t){return qS(n.writeTree,n.treePath,e,t)}function J_(n,e){return X_(ye(n.treePath,e),n.writeTree)}function X_(n,e){return{treePath:n,writeTree:e}}var hh=class{constructor(){this.changeMap=new Map}trackChildChange(e){let t=e.type,r=e.childName;M(t==="child_added"||t==="child_changed"||t==="child_removed","Only child changes supported for tracking"),M(r!==".priority","Only non-priority child changes can be tracked.");let i=this.changeMap.get(r);if(i){let s=i.type;if(t==="child_added"&&s==="child_removed")this.changeMap.set(r,Rs(r,e.snapshotNode,i.snapshotNode));else if(t==="child_removed"&&s==="child_added")this.changeMap.delete(r);else if(t==="child_removed"&&s==="child_changed")this.changeMap.set(r,bs(r,i.oldSnap));else if(t==="child_changed"&&s==="child_added")this.changeMap.set(r,Qr(r,e.snapshotNode));else if(t==="child_changed"&&s==="child_changed")this.changeMap.set(r,Rs(r,e.snapshotNode,i.oldSnap));else throw Fr("Illegal combination of changes: "+e+" occurred after "+i)}else this.changeMap.set(r,e)}getChanges(){return Array.from(this.changeMap.values())}};var dh=class{getCompleteChild(e){return null}getChildAfterChild(e,t,r){return null}},Z_=new dh,Ds=class{constructor(e,t,r=null){this.writes_=e,this.viewCache_=t,this.optCompleteServerCache_=r}getCompleteChild(e){let t=this.viewCache_.eventCache;if(t.isCompleteForChild(e))return t.getNode().getImmediateChild(e);{let r=this.optCompleteServerCache_!=null?new Ot(this.optCompleteServerCache_,!0,!1):this.viewCache_.serverCache;return Hh(this.writes_,e,r)}}getChildAfterChild(e,t,r){let i=this.optCompleteServerCache_!=null?this.optCompleteServerCache_:er(this.viewCache_),s=zS(this.writes_,i,t,1,r,e);return s.length===0?null:s[0]}};function KS(n){return{filter:n}}function WS(n,e){M(e.eventCache.getNode().isIndexed(n.filter.getIndex()),"Event snap not indexed"),M(e.serverCache.getNode().isIndexed(n.filter.getIndex()),"Server snap not indexed")}function QS(n,e,t,r,i){let s=new hh,o,l;if(t.type===kt.OVERWRITE){let c=t;c.source.fromUser?o=fh(n,e,c.path,c.snap,r,i,s):(M(c.source.fromServer,"Unknown source."),l=c.source.tagged||e.serverCache.isFiltered()&&!X(c.path),o=Wa(n,e,c.path,c.snap,r,i,l,s))}else if(t.type===kt.MERGE){let c=t;c.source.fromUser?o=HS(n,e,c.path,c.children,r,i,s):(M(c.source.fromServer,"Unknown source."),l=c.source.tagged||e.serverCache.isFiltered(),o=ph(n,e,c.path,c.children,r,i,l,s))}else if(t.type===kt.ACK_USER_WRITE){let c=t;c.revert?o=XS(n,e,c.path,r,i,s):o=YS(n,e,c.path,c.affectedTree,r,i,s)}else if(t.type===kt.LISTEN_COMPLETE)o=JS(n,e,t.path,r,s);else throw Fr("Unknown operation type: "+t.type);let u=s.getChanges();return $S(e,o,u),{viewCache:o,changes:u}}function $S(n,e,t){let r=e.eventCache;if(r.isFullyInitialized()){let i=r.getNode().isLeafNode()||r.getNode().isEmpty(),s=ja(n);(t.length>0||!n.eventCache.isFullyInitialized()||i&&!r.getNode().equals(s)||!r.getNode().getPriority().equals(s.getPriority()))&&t.push(W_(ja(e)))}}function ey(n,e,t,r,i,s){let o=e.eventCache;if(Ka(r,t)!=null)return e;{let l,u;if(X(t))if(M(e.serverCache.isFullyInitialized(),"If change path is empty, we must have complete server data"),e.serverCache.isFiltered()){let c=er(e),d=c instanceof Q?c:Q.EMPTY_NODE,p=$h(r,d);l=n.filter.updateFullNode(e.eventCache.getNode(),p,s)}else{let c=za(r,er(e));l=n.filter.updateFullNode(e.eventCache.getNode(),c,s)}else{let c=J(t);if(c===".priority"){M(En(t)===1,"Can't have a priority with additional path components");let d=o.getNode();u=e.serverCache.getNode();let p=a_(r,t,d,u);p!=null?l=n.filter.updatePriority(d,p):l=o.getNode()}else{let d=de(t),p;if(o.isCompleteForChild(c)){u=e.serverCache.getNode();let m=a_(r,t,o.getNode(),u);m!=null?p=o.getNode().getImmediateChild(c).updateChild(d,m):p=o.getNode().getImmediateChild(c)}else p=Hh(r,c,e.serverCache);p!=null?l=n.filter.updateChild(o.getNode(),c,p,d,i,s):l=o.getNode()}}return Es(e,l,o.isFullyInitialized()||X(t),n.filter.filtersNodes())}}function Wa(n,e,t,r,i,s,o,l){let u=e.serverCache,c,d=o?n.filter:n.filter.getIndexedFilter();if(X(t))c=d.updateFullNode(u.getNode(),r,null);else if(d.filtersNodes()&&!u.isFiltered()){let v=u.getNode().updateChild(t,r);c=d.updateFullNode(u.getNode(),v,null)}else{let v=J(t);if(!u.isCompleteForPath(t)&&En(t)>1)return e;let C=de(t),D=u.getNode().getImmediateChild(v).updateChild(C,r);v===".priority"?c=d.updatePriority(u.getNode(),D):c=d.updateChild(u.getNode(),v,D,C,Z_,null)}let p=Q_(e,c,u.isFullyInitialized()||X(t),d.filtersNodes()),m=new Ds(i,p,s);return ey(n,p,t,i,m,l)}function fh(n,e,t,r,i,s,o){let l=e.eventCache,u,c,d=new Ds(i,e,s);if(X(t))c=n.filter.updateFullNode(e.eventCache.getNode(),r,o),u=Es(e,c,!0,n.filter.filtersNodes());else{let p=J(t);if(p===".priority")c=n.filter.updatePriority(e.eventCache.getNode(),r),u=Es(e,c,l.isFullyInitialized(),l.isFiltered());else{let m=de(t),v=l.getNode().getImmediateChild(p),C;if(X(m))C=r;else{let N=d.getCompleteChild(p);N!=null?qh(m)===".priority"&&N.getChild(q_(m)).isEmpty()?C=N:C=N.updateChild(m,r):C=Q.EMPTY_NODE}if(v.equals(C))u=e;else{let N=n.filter.updateChild(l.getNode(),p,C,m,d,o);u=Es(e,N,l.isFullyInitialized(),n.filter.filtersNodes())}}}return u}function l_(n,e){return n.eventCache.isCompleteForChild(e)}function HS(n,e,t,r,i,s,o){let l=e;return r.foreach((u,c)=>{let d=ye(t,u);l_(e,J(d))&&(l=fh(n,l,d,c,i,s,o))}),r.foreach((u,c)=>{let d=ye(t,u);l_(e,J(d))||(l=fh(n,l,d,c,i,s,o))}),l}function u_(n,e,t){return t.foreach((r,i)=>{e=e.updateChild(r,i)}),e}function ph(n,e,t,r,i,s,o,l){if(e.serverCache.getNode().isEmpty()&&!e.serverCache.isFullyInitialized())return e;let u=e,c;X(t)?c=r:c=new tt(null).setTree(t,r);let d=e.serverCache.getNode();return c.children.inorderTraversal((p,m)=>{if(d.hasChild(p)){let v=e.serverCache.getNode().getImmediateChild(p),C=u_(n,v,m);u=Wa(n,u,new ue(p),C,i,s,o,l)}}),c.children.inorderTraversal((p,m)=>{let v=!e.serverCache.isCompleteForChild(p)&&m.value===null;if(!d.hasChild(p)&&!v){let C=e.serverCache.getNode().getImmediateChild(p),N=u_(n,C,m);u=Wa(n,u,new ue(p),N,i,s,o,l)}}),u}function YS(n,e,t,r,i,s,o){if(Ka(i,t)!=null)return e;let l=e.serverCache.isFiltered(),u=e.serverCache;if(r.value!=null){if(X(t)&&u.isFullyInitialized()||u.isCompleteForPath(t))return Wa(n,e,t,u.getNode().getChild(t),i,s,l,o);if(X(t)){let c=new tt(null);return u.getNode().forEachChild(Vt,(d,p)=>{c=c.set(new ue(d),p)}),ph(n,e,t,c,i,s,l,o)}else return e}else{let c=new tt(null);return r.foreach((d,p)=>{let m=ye(t,d);u.isCompleteForPath(m)&&(c=c.set(d,u.getNode().getChild(m)))}),ph(n,e,t,c,i,s,l,o)}}function JS(n,e,t,r,i){let s=e.serverCache,o=Q_(e,s.getNode(),s.isFullyInitialized()||X(t),s.isFiltered());return ey(n,o,t,r,Z_,i)}function XS(n,e,t,r,i,s){let o;if(Ka(r,t)!=null)return e;{let l=new Ds(r,e,i),u=e.eventCache.getNode(),c;if(X(t)||J(t)===".priority"){let d;if(e.serverCache.isFullyInitialized())d=za(r,er(e));else{let p=e.serverCache.getNode();M(p instanceof Q,"serverChildren would be complete if leaf node"),d=$h(r,p)}d=d,c=n.filter.updateFullNode(u,d,s)}else{let d=J(t),p=Hh(r,d,e.serverCache);p==null&&e.serverCache.isCompleteForChild(d)&&(p=u.getImmediateChild(d)),p!=null?c=n.filter.updateChild(u,d,p,de(t),l,s):e.eventCache.getNode().hasChild(d)?c=n.filter.updateChild(u,d,Q.EMPTY_NODE,de(t),l,s):c=u,c.isEmpty()&&e.serverCache.isFullyInitialized()&&(o=za(r,er(e)),o.isLeafNode()&&(c=n.filter.updateFullNode(c,o,s)))}return o=e.serverCache.isFullyInitialized()||Ka(r,le())!=null,Es(e,c,o,n.filter.filtersNodes())}}var mh=class{constructor(e,t){this.query_=e,this.eventRegistrations_=[];let r=this.query_._queryParams,i=new Ps(r.getIndex()),s=vS(r);this.processor_=KS(s);let o=t.serverCache,l=t.eventCache,u=i.updateFullNode(Q.EMPTY_NODE,o.getNode(),null),c=s.updateFullNode(Q.EMPTY_NODE,l.getNode(),null),d=new Ot(u,o.isFullyInitialized(),i.filtersNodes()),p=new Ot(c,l.isFullyInitialized(),s.filtersNodes());this.viewCache_=ol(p,d),this.eventGenerator_=new ah(this.query_)}get query(){return this.query_}};function ZS(n){return n.viewCache_.serverCache.getNode()}function eA(n){return ja(n.viewCache_)}function tA(n,e){let t=er(n.viewCache_);return t&&(n.query._queryParams.loadsAllData()||!X(e)&&!t.getImmediateChild(J(e)).isEmpty())?t.getChild(e):null}function c_(n){return n.eventRegistrations_.length===0}function nA(n,e){n.eventRegistrations_.push(e)}function h_(n,e,t){let r=[];if(t){M(e==null,"A cancel should cancel all event registrations.");let i=n.query._path;n.eventRegistrations_.forEach(s=>{let o=s.createCancelEvent(t,i);o&&r.push(o)})}if(e){let i=[];for(let s=0;s<n.eventRegistrations_.length;++s){let o=n.eventRegistrations_[s];if(!o.matches(e))i.push(o);else if(e.hasAnyCallback()){i=i.concat(n.eventRegistrations_.slice(s+1));break}}n.eventRegistrations_=i}else n.eventRegistrations_=[];return r}function d_(n,e,t,r){e.type===kt.MERGE&&e.source.queryId!==null&&(M(er(n.viewCache_),"We should always have a full cache before handling merges"),M(ja(n.viewCache_),"Missing event cache, even though we have a server cache"));let i=n.viewCache_,s=QS(n.processor_,i,e,t,r);return WS(n.processor_,s.viewCache),M(s.viewCache.serverCache.isFullyInitialized()||!i.serverCache.isFullyInitialized(),"Once a server snap is complete, it should never go back"),n.viewCache_=s.viewCache,ty(n,s.changes,s.viewCache.eventCache.getNode(),null)}function rA(n,e){let t=n.viewCache_.eventCache,r=[];return t.getNode().isLeafNode()||t.getNode().forEachChild(pe,(s,o)=>{r.push(Qr(s,o))}),t.isFullyInitialized()&&r.push(W_(t.getNode())),ty(n,r,t.getNode(),e)}function ty(n,e,t,r){let i=r?[r]:n.eventRegistrations_;return bS(n.eventGenerator_,e,t,i)}var Qa,$a=class{constructor(){this.views=new Map}};function iA(n){M(!Qa,"__referenceConstructor has already been defined"),Qa=n}function sA(){return M(Qa,"Reference.ts has not been loaded"),Qa}function oA(n){return n.views.size===0}function Yh(n,e,t,r){let i=e.source.queryId;if(i!==null){let s=n.views.get(i);return M(s!=null,"SyncTree gave us an op for an invalid query."),d_(s,e,t,r)}else{let s=[];for(let o of n.views.values())s=s.concat(d_(o,e,t,r));return s}}function ny(n,e,t,r,i){let s=e._queryIdentifier,o=n.views.get(s);if(!o){let l=za(t,i?r:null),u=!1;l?u=!0:r instanceof Q?(l=$h(t,r),u=!1):(l=Q.EMPTY_NODE,u=!1);let c=ol(new Ot(l,u,!1),new Ot(r,i,!1));return new mh(e,c)}return o}function aA(n,e,t,r,i,s){let o=ny(n,e,r,i,s);return n.views.has(e._queryIdentifier)||n.views.set(e._queryIdentifier,o),nA(o,t),rA(o,t)}function lA(n,e,t,r){let i=e._queryIdentifier,s=[],o=[],l=In(n);if(i==="default")for(let[u,c]of n.views.entries())o=o.concat(h_(c,t,r)),c_(c)&&(n.views.delete(u),c.query._queryParams.loadsAllData()||s.push(c.query));else{let u=n.views.get(i);u&&(o=o.concat(h_(u,t,r)),c_(u)&&(n.views.delete(i),u.query._queryParams.loadsAllData()||s.push(u.query)))}return l&&!In(n)&&s.push(new(sA())(e._repo,e._path)),{removed:s,events:o}}function ry(n){let e=[];for(let t of n.views.values())t.query._queryParams.loadsAllData()||e.push(t);return e}function vn(n,e){let t=null;for(let r of n.views.values())t=t||tA(r,e);return t}function iy(n,e){if(e._queryParams.loadsAllData())return ll(n);{let r=e._queryIdentifier;return n.views.get(r)}}function sy(n,e){return iy(n,e)!=null}function In(n){return ll(n)!=null}function ll(n){for(let e of n.views.values())if(e.query._queryParams.loadsAllData())return e;return null}var Ha;function uA(n){M(!Ha,"__referenceConstructor has already been defined"),Ha=n}function cA(){return M(Ha,"Reference.ts has not been loaded"),Ha}var hA=1,Ya=class{constructor(e){this.listenProvider_=e,this.syncPointTree_=new tt(null),this.pendingWriteTree_=jS(),this.tagToQueryMap=new Map,this.queryToTagMap=new Map}};function Jh(n,e,t,r,i){return NS(n.pendingWriteTree_,e,t,r,i),i?ei(n,new $r(Kh(),e,t)):[]}function dA(n,e,t,r){DS(n.pendingWriteTree_,e,t,r);let i=tt.fromObject(t);return ei(n,new Ns(Kh(),e,i))}function _n(n,e,t=!1){let r=kS(n.pendingWriteTree_,e);if(VS(n.pendingWriteTree_,e)){let s=new tt(null);return r.snap!=null?s=s.set(le(),!0):Ue(r.children,o=>{s=s.set(new ue(o),!0)}),ei(n,new oh(r.path,s,t))}else return[]}function Bs(n,e,t){return ei(n,new $r(Wh(),e,t))}function fA(n,e,t){let r=tt.fromObject(t);return ei(n,new Ns(Wh(),e,r))}function pA(n,e){return ei(n,new Ga(Wh(),e))}function mA(n,e,t){let r=Xh(n,t);if(r){let i=Zh(r),s=i.path,o=i.queryId,l=et(s,e),u=new Ga(Qh(o),l);return ed(n,s,u)}else return[]}function Ja(n,e,t,r,i=!1){let s=e._path,o=n.syncPointTree_.get(s),l=[];if(o&&(e._queryIdentifier==="default"||sy(o,e))){let u=lA(o,e,t,r);oA(o)&&(n.syncPointTree_=n.syncPointTree_.remove(s));let c=u.removed;if(l=u.events,!i){let d=c.findIndex(m=>m._queryParams.loadsAllData())!==-1,p=n.syncPointTree_.findOnPath(s,(m,v)=>In(v));if(d&&!p){let m=n.syncPointTree_.subtree(s);if(!m.isEmpty()){let v=yA(m);for(let C=0;C<v.length;++C){let N=v[C],D=N.query,B=uy(n,N);n.listenProvider_.startListening(Ts(D),ks(n,D),B.hashFn,B.onComplete)}}}!p&&c.length>0&&!r&&(d?n.listenProvider_.stopListening(Ts(e),null):c.forEach(m=>{let v=n.queryToTagMap.get(cl(m));n.listenProvider_.stopListening(Ts(m),v)}))}vA(n,c)}return l}function oy(n,e,t,r){let i=Xh(n,r);if(i!=null){let s=Zh(i),o=s.path,l=s.queryId,u=et(o,e),c=new $r(Qh(l),u,t);return ed(n,o,c)}else return[]}function gA(n,e,t,r){let i=Xh(n,r);if(i){let s=Zh(i),o=s.path,l=s.queryId,u=et(o,e),c=tt.fromObject(t),d=new Ns(Qh(l),u,c);return ed(n,o,d)}else return[]}function gh(n,e,t,r=!1){let i=e._path,s=null,o=!1;n.syncPointTree_.foreachOnPath(i,(m,v)=>{let C=et(m,i);s=s||vn(v,C),o=o||In(v)});let l=n.syncPointTree_.get(i);l?(o=o||In(l),s=s||vn(l,le())):(l=new $a,n.syncPointTree_=n.syncPointTree_.set(i,l));let u;s!=null?u=!0:(u=!1,s=Q.EMPTY_NODE,n.syncPointTree_.subtree(i).foreachChild((v,C)=>{let N=vn(C,le());N&&(s=s.updateImmediateChild(v,N))}));let c=sy(l,e);if(!c&&!e._queryParams.loadsAllData()){let m=cl(e);M(!n.queryToTagMap.has(m),"View does not exist, but we have a tag");let v=wA();n.queryToTagMap.set(m,v),n.tagToQueryMap.set(v,m)}let d=al(n.pendingWriteTree_,i),p=aA(l,e,t,d,s,u);if(!c&&!o&&!r){let m=iy(l,e);p=p.concat(EA(n,e,m))}return p}function ul(n,e,t){let i=n.pendingWriteTree_,s=n.syncPointTree_.findOnPath(e,(o,l)=>{let u=et(o,e),c=vn(l,u);if(c)return c});return Y_(i,e,s,t,!0)}function _A(n,e){let t=e._path,r=null;n.syncPointTree_.foreachOnPath(t,(c,d)=>{let p=et(c,t);r=r||vn(d,p)});let i=n.syncPointTree_.get(t);i?r=r||vn(i,le()):(i=new $a,n.syncPointTree_=n.syncPointTree_.set(t,i));let s=r!=null,o=s?new Ot(r,!0,!1):null,l=al(n.pendingWriteTree_,e._path),u=ny(i,e,l,s?o.getNode():Q.EMPTY_NODE,s);return eA(u)}function ei(n,e){return ay(e,n.syncPointTree_,null,al(n.pendingWriteTree_,le()))}function ay(n,e,t,r){if(X(n.path))return ly(n,e,t,r);{let i=e.get(le());t==null&&i!=null&&(t=vn(i,le()));let s=[],o=J(n.path),l=n.operationForChild(o),u=e.children.get(o);if(u&&l){let c=t?t.getImmediateChild(o):null,d=J_(r,o);s=s.concat(ay(l,u,c,d))}return i&&(s=s.concat(Yh(i,n,r,t))),s}}function ly(n,e,t,r){let i=e.get(le());t==null&&i!=null&&(t=vn(i,le()));let s=[];return e.children.inorderTraversal((o,l)=>{let u=t?t.getImmediateChild(o):null,c=J_(r,o),d=n.operationForChild(o);d&&(s=s.concat(ly(d,l,u,c)))}),i&&(s=s.concat(Yh(i,n,r,t))),s}function uy(n,e){let t=e.query,r=ks(n,t);return{hashFn:()=>(ZS(e)||Q.EMPTY_NODE).hash(),onComplete:i=>{if(i==="ok")return r?mA(n,t._path,r):pA(n,t._path);{let s=NT(i,t);return Ja(n,t,null,s)}}}}function ks(n,e){let t=cl(e);return n.queryToTagMap.get(t)}function cl(n){return n._path.toString()+"$"+n._queryIdentifier}function Xh(n,e){return n.tagToQueryMap.get(e)}function Zh(n){let e=n.indexOf("$");return M(e!==-1&&e<n.length-1,"Bad queryKey."),{queryId:n.substr(e+1),path:new ue(n.substr(0,e))}}function ed(n,e,t){let r=n.syncPointTree_.get(e);M(r,"Missing sync point for query tag that we're tracking");let i=al(n.pendingWriteTree_,e);return Yh(r,t,i,null)}function yA(n){return n.fold((e,t,r)=>{if(t&&In(t))return[ll(t)];{let i=[];return t&&(i=ry(t)),Ue(r,(s,o)=>{i=i.concat(o)}),i}})}function Ts(n){return n._queryParams.loadsAllData()&&!n._queryParams.isDefault()?new(cA())(n._repo,n._path):n}function vA(n,e){for(let t=0;t<e.length;++t){let r=e[t];if(!r._queryParams.loadsAllData()){let i=cl(r),s=n.queryToTagMap.get(i);n.queryToTagMap.delete(i),n.tagToQueryMap.delete(s)}}}function wA(){return hA++}function EA(n,e,t){let r=e._path,i=ks(n,e),s=uy(n,t),o=n.listenProvider_.startListening(Ts(e),i,s.hashFn,s.onComplete),l=n.syncPointTree_.subtree(r);if(i)M(!In(l.value),"If we're adding a query, it shouldn't be shadowed");else{let u=l.fold((c,d,p)=>{if(!X(c)&&d&&In(d))return[ll(d).query];{let m=[];return d&&(m=m.concat(ry(d).map(v=>v.query))),Ue(p,(v,C)=>{m=m.concat(C)}),m}});for(let c=0;c<u.length;++c){let d=u[c];n.listenProvider_.stopListening(Ts(d),ks(n,d))}}return o}var _h=class n{constructor(e){this.node_=e}getImmediateChild(e){let t=this.node_.getImmediateChild(e);return new n(t)}node(){return this.node_}},yh=class n{constructor(e,t){this.syncTree_=e,this.path_=t}getImmediateChild(e){let t=ye(this.path_,e);return new n(this.syncTree_,t)}node(){return ul(this.syncTree_,this.path_)}},IA=function(n){return n=n||{},n.timestamp=n.timestamp||new Date().getTime(),n},f_=function(n,e,t){if(!n||typeof n!="object")return n;if(M(".sv"in n,"Unexpected leaf node or priority contents"),typeof n[".sv"]=="string")return TA(n[".sv"],e,t);if(typeof n[".sv"]=="object")return SA(n[".sv"],e);M(!1,"Unexpected server value: "+JSON.stringify(n,null,2))},TA=function(n,e,t){switch(n){case"timestamp":return t.timestamp;default:M(!1,"Unexpected server value: "+n)}},SA=function(n,e,t){n.hasOwnProperty("increment")||M(!1,"Unexpected server value: "+JSON.stringify(n,null,2));let r=n.increment;typeof r!="number"&&M(!1,"Unexpected increment value: "+r);let i=e.node();if(M(i!==null&&typeof i<"u","Expected ChildrenNode.EMPTY_NODE for nulls"),!i.isLeafNode())return r;let o=i.getValue();return typeof o!="number"?r:o+r},cy=function(n,e,t,r){return nd(e,new yh(t,n),r)},td=function(n,e,t){return nd(n,new _h(e),t)};function nd(n,e,t){let r=n.getPriority().val(),i=f_(r,e.getImmediateChild(".priority"),t),s;if(n.isLeafNode()){let o=n,l=f_(o.getValue(),e,t);return l!==o.getValue()||i!==o.getPriority().val()?new Kr(l,we(i)):n}else{let o=n;return s=o,i!==o.getPriority().val()&&(s=s.updatePriority(new Kr(i))),o.forEachChild(pe,(l,u)=>{let c=nd(u,e.getImmediateChild(l),t);c!==u&&(s=s.updateImmediateChild(l,c))}),s}}var Vs=class{constructor(e="",t=null,r={children:{},childCount:0}){this.name=e,this.parent=t,this.node=r}};function hl(n,e){let t=e instanceof ue?e:new ue(e),r=n,i=J(t);for(;i!==null;){let s=mn(r.node.children,i)||{children:{},childCount:0};r=new Vs(i,r,s),t=de(t),i=J(t)}return r}function rr(n){return n.node.value}function rd(n,e){n.node.value=e,vh(n)}function hy(n){return n.node.childCount>0}function AA(n){return rr(n)===void 0&&!hy(n)}function dl(n,e){Ue(n.node.children,(t,r)=>{e(new Vs(t,n,r))})}function dy(n,e,t,r){t&&!r&&e(n),dl(n,i=>{dy(i,e,!0,r)}),t&&r&&e(n)}function CA(n,e,t){let r=t?n:n.parent;for(;r!==null;){if(e(r))return!0;r=r.parent}return!1}function Gs(n){return new ue(n.parent===null?n.name:Gs(n.parent)+"/"+n.name)}function vh(n){n.parent!==null&&bA(n.parent,n.name,n)}function bA(n,e,t){let r=AA(t),i=mt(n.node.children,e);r&&i?(delete n.node.children[e],n.node.childCount--,vh(n)):!r&&!i&&(n.node.children[e]=t.node,n.node.childCount++,vh(n))}var RA=/[\[\].#$\/\u0000-\u001F\u007F]/,PA=/[\[\].#$\u0000-\u001F\u007F]/,xc=10*1024*1024,fl=function(n){return typeof n=="string"&&n.length!==0&&!RA.test(n)},fy=function(n){return typeof n=="string"&&n.length!==0&&!PA.test(n)},xA=function(n){return n&&(n=n.replace(/^\/*\.info(\/|$)/,"/")),fy(n)},Ms=function(n){return n===null||typeof n=="string"||typeof n=="number"&&!il(n)||n&&typeof n=="object"&&mt(n,".sv")},Ft=function(n,e,t,r){r&&e===void 0||js(ot(n,"value"),e,t)},js=function(n,e,t){let r=t instanceof ue?new jc(t,n):t;if(e===void 0)throw new Error(n+"contains undefined "+Jn(r));if(typeof e=="function")throw new Error(n+"contains a function "+Jn(r)+" with contents = "+e.toString());if(il(e))throw new Error(n+"contains "+e.toString()+" "+Jn(r));if(typeof e=="string"&&e.length>xc/3&&ps(e)>xc)throw new Error(n+"contains a string greater than "+xc+" utf8 bytes "+Jn(r)+" ('"+e.substring(0,50)+"...')");if(e&&typeof e=="object"){let i=!1,s=!1;if(Ue(e,(o,l)=>{if(o===".value")i=!0;else if(o!==".priority"&&o!==".sv"&&(s=!0,!fl(o)))throw new Error(n+" contains an invalid key ("+o+") "+Jn(r)+`.  Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`);oS(r,o),js(n,l,r),aS(r)}),i&&s)throw new Error(n+' contains ".value" child '+Jn(r)+" in addition to actual children.")}},NA=function(n,e){let t,r;for(t=0;t<e.length;t++){r=e[t];let s=As(r);for(let o=0;o<s.length;o++)if(!(s[o]===".priority"&&o===s.length-1)){if(!fl(s[o]))throw new Error(n+"contains an invalid key ("+s[o]+") in path "+r.toString()+`. Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`)}}e.sort(sS);let i=null;for(t=0;t<e.length;t++){if(r=e[t],i!==null&&_t(i,r))throw new Error(n+"contains a path "+i.toString()+" that is ancestor of another path "+r.toString());i=r}},py=function(n,e,t,r){if(r&&e===void 0)return;let i=ot(n,"values");if(!(e&&typeof e=="object")||Array.isArray(e))throw new Error(i+" must be an object containing the children to replace.");let s=[];Ue(e,(o,l)=>{let u=new ue(o);if(js(i,l,ye(t,u)),qh(u)===".priority"&&!Ms(l))throw new Error(i+"contains an invalid value for '"+u.toString()+"', which must be a valid Firebase priority (a string, finite number, server value, or null).");s.push(u)}),NA(i,s)},id=function(n,e,t){if(!(t&&e===void 0)){if(il(e))throw new Error(ot(n,"priority")+"is "+e.toString()+", but must be a valid Firebase priority (a string, finite number, server value, or null).");if(!Ms(e))throw new Error(ot(n,"priority")+"must be a valid Firebase priority (a string, finite number, server value, or null).")}},zs=function(n,e,t,r){if(!(r&&t===void 0)&&!fl(t))throw new Error(ot(n,e)+'was an invalid key = "'+t+`".  Firebase keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]").`)},ti=function(n,e,t,r){if(!(r&&t===void 0)&&!fy(t))throw new Error(ot(n,e)+'was an invalid path = "'+t+`". Paths must be non-empty strings and can't contain ".", "#", "$", "[", or "]"`)},DA=function(n,e,t,r){t&&(t=t.replace(/^\/*\.info(\/|$)/,"/")),ti(n,e,t,r)},ut=function(n,e){if(J(e)===".info")throw new Error(n+" failed = Can't modify data under /.info/")},my=function(n,e){let t=e.path.toString();if(typeof e.repoInfo.host!="string"||e.repoInfo.host.length===0||!fl(e.repoInfo.namespace)&&e.repoInfo.host.split(":")[0]!=="localhost"||t.length!==0&&!xA(t))throw new Error(ot(n,"url")+`must be a valid firebase URL and the path can't contain ".", "#", "$", "[", or "]".`)};var wh=class{constructor(){this.eventLists_=[],this.recursionDepth_=0}};function pl(n,e){let t=null;for(let r=0;r<e.length;r++){let i=e[r],s=i.getPath();t!==null&&!Bh(s,t.path)&&(n.eventLists_.push(t),t=null),t===null&&(t={events:[],path:s}),t.events.push(i)}t&&n.eventLists_.push(t)}function gy(n,e,t){pl(n,t),_y(n,r=>Bh(r,e))}function ct(n,e,t){pl(n,t),_y(n,r=>_t(r,e)||_t(e,r))}function _y(n,e){n.recursionDepth_++;let t=!0;for(let r=0;r<n.eventLists_.length;r++){let i=n.eventLists_[r];if(i){let s=i.path;e(s)?(kA(n.eventLists_[r]),n.eventLists_[r]=null):t=!1}}t&&(n.eventLists_=[]),n.recursionDepth_--}function kA(n){for(let e=0;e<n.events.length;e++){let t=n.events[e];if(t!==null){n.events[e]=null;let r=t.getEventRunner();Zn&&Le("event: "+t.toString()),Xr(r)}}}var yy="repo_interrupt",VA=25,Eh=class{constructor(e,t,r,i){this.repoInfo_=e,this.forceRestClient_=t,this.authTokenProvider_=r,this.appCheckProvider_=i,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new wh,this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=Ba(),this.transactionQueueTree_=new Vs,this.persistentConnection_=null,this.key=this.repoInfo_.toURLString()}toString(){return(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host}};function MA(n,e,t){if(n.stats_=Uh(n.repoInfo_),n.forceRestClient_||MT())n.server_=new eh(n.repoInfo_,(r,i,s,o)=>{p_(n,r,i,s,o)},n.authTokenProvider_,n.appCheckProvider_),setTimeout(()=>m_(n,!0),0);else{if(typeof t<"u"&&t!==null){if(typeof t!="object")throw new Error("Only objects are supported for option databaseAuthVariableOverride");try{Re(t)}catch(r){throw new Error("Invalid authOverride provided: "+r)}}n.persistentConnection_=new Gh(n.repoInfo_,e,(r,i,s,o)=>{p_(n,r,i,s,o)},r=>{m_(n,r)},r=>{OA(n,r)},n.authTokenProvider_,n.appCheckProvider_,t),n.server_=n.persistentConnection_}n.authTokenProvider_.addTokenChangeListener(r=>{n.server_.refreshAuthToken(r)}),n.appCheckProvider_.addTokenChangeListener(r=>{n.server_.refreshAppCheckToken(r.token)}),n.statsReporter_=FT(n.repoInfo_,()=>new sh(n.stats_,n.server_)),n.infoData_=new th,n.infoSyncTree_=new Ya({startListening:(r,i,s,o)=>{let l=[],u=n.infoData_.getNode(r._path);return u.isEmpty()||(l=Bs(n.infoSyncTree_,r._path,u),setTimeout(()=>{o("ok")},0)),l},stopListening:()=>{}}),sd(n,"connected",!1),n.serverSyncTree_=new Ya({startListening:(r,i,s,o)=>(n.server_.listen(r,s,i,(l,u)=>{let c=o(l,u);ct(n.eventQueue_,r._path,c)}),[]),stopListening:(r,i)=>{n.server_.unlisten(r,i)}})}function vy(n){let t=n.infoData_.getNode(new ue(".info/serverTimeOffset")).val()||0;return new Date().getTime()+t}function Ks(n){return IA({timestamp:vy(n)})}function p_(n,e,t,r,i){n.dataUpdateCount++;let s=new ue(e);t=n.interceptServerDataCallback_?n.interceptServerDataCallback_(e,t):t;let o=[];if(i)if(r){let u=fs(t,c=>we(c));o=gA(n.serverSyncTree_,s,u,i)}else{let u=we(t);o=oy(n.serverSyncTree_,s,u,i)}else if(r){let u=fs(t,c=>we(c));o=fA(n.serverSyncTree_,s,u)}else{let u=we(t);o=Bs(n.serverSyncTree_,s,u)}let l=s;o.length>0&&(l=Yr(n,s)),ct(n.eventQueue_,l,o)}function m_(n,e){sd(n,"connected",e),e===!1&&UA(n)}function OA(n,e){Ue(e,(t,r)=>{sd(n,t,r)})}function sd(n,e,t){let r=new ue("/.info/"+e),i=we(t);n.infoData_.updateSnapshot(r,i);let s=Bs(n.infoSyncTree_,r,i);ct(n.eventQueue_,r,s)}function ml(n){return n.nextWriteId_++}function FA(n,e,t){let r=_A(n.serverSyncTree_,e);return r!=null?Promise.resolve(r):n.server_.get(e).then(i=>{let s=we(i).withIndex(e._queryParams.getIndex());gh(n.serverSyncTree_,e,t,!0);let o;if(e._queryParams.loadsAllData())o=Bs(n.serverSyncTree_,e._path,s);else{let l=ks(n.serverSyncTree_,e);o=oy(n.serverSyncTree_,e._path,s,l)}return ct(n.eventQueue_,e._path,o),Ja(n.serverSyncTree_,e,t,null,!0),s},i=>(ni(n,"get for query "+Re(e)+" failed: "+i),Promise.reject(new Error(i))))}function od(n,e,t,r,i){ni(n,"set",{path:e.toString(),value:t,priority:r});let s=Ks(n),o=we(t,r),l=ul(n.serverSyncTree_,e),u=td(o,l,s),c=ml(n),d=Jh(n.serverSyncTree_,e,u,c,!0);pl(n.eventQueue_,d),n.server_.put(e.toString(),o.val(!0),(m,v)=>{let C=m==="ok";C||$e("set at "+e+" failed: "+m);let N=_n(n.serverSyncTree_,c,!C);ct(n.eventQueue_,e,N),Tn(n,i,m,v)});let p=ld(n,e);Yr(n,p),ct(n.eventQueue_,p,[])}function LA(n,e,t,r){ni(n,"update",{path:e.toString(),value:t});let i=!0,s=Ks(n),o={};if(Ue(t,(l,u)=>{i=!1,o[l]=cy(ye(e,l),we(u),n.serverSyncTree_,s)}),i)Le("update() called with empty data.  Don't do anything."),Tn(n,r,"ok",void 0);else{let l=ml(n),u=dA(n.serverSyncTree_,e,o,l);pl(n.eventQueue_,u),n.server_.merge(e.toString(),t,(c,d)=>{let p=c==="ok";p||$e("update at "+e+" failed: "+c);let m=_n(n.serverSyncTree_,l,!p),v=m.length>0?Yr(n,e):e;ct(n.eventQueue_,v,m),Tn(n,r,c,d)}),Ue(t,c=>{let d=ld(n,ye(e,c));Yr(n,d)}),ct(n.eventQueue_,e,[])}}function UA(n){ni(n,"onDisconnectEvents");let e=Ks(n),t=Ba();rh(n.onDisconnect_,le(),(i,s)=>{let o=cy(i,s,n.serverSyncTree_,e);Zr(t,i,o)});let r=[];rh(t,le(),(i,s)=>{r=r.concat(Bs(n.serverSyncTree_,i,s));let o=ld(n,i);Yr(n,o)}),n.onDisconnect_=Ba(),ct(n.eventQueue_,le(),r)}function qA(n,e,t){n.server_.onDisconnectCancel(e.toString(),(r,i)=>{r==="ok"&&nh(n.onDisconnect_,e),Tn(n,t,r,i)})}function g_(n,e,t,r){let i=we(t);n.server_.onDisconnectPut(e.toString(),i.val(!0),(s,o)=>{s==="ok"&&Zr(n.onDisconnect_,e,i),Tn(n,r,s,o)})}function BA(n,e,t,r,i){let s=we(t,r);n.server_.onDisconnectPut(e.toString(),s.val(!0),(o,l)=>{o==="ok"&&Zr(n.onDisconnect_,e,s),Tn(n,i,o,l)})}function GA(n,e,t,r){if(da(t)){Le("onDisconnect().update() called with empty data.  Don't do anything."),Tn(n,r,"ok",void 0);return}n.server_.onDisconnectMerge(e.toString(),t,(i,s)=>{i==="ok"&&Ue(t,(o,l)=>{let u=we(l);Zr(n.onDisconnect_,ye(e,o),u)}),Tn(n,r,i,s)})}function jA(n,e,t){let r;J(e._path)===".info"?r=gh(n.infoSyncTree_,e,t):r=gh(n.serverSyncTree_,e,t),gy(n.eventQueue_,e._path,r)}function Ih(n,e,t){let r;J(e._path)===".info"?r=Ja(n.infoSyncTree_,e,t):r=Ja(n.serverSyncTree_,e,t),gy(n.eventQueue_,e._path,r)}function wy(n){n.persistentConnection_&&n.persistentConnection_.interrupt(yy)}function zA(n){n.persistentConnection_&&n.persistentConnection_.resume(yy)}function ni(n,...e){let t="";n.persistentConnection_&&(t=n.persistentConnection_.id+":"),Le(t,...e)}function Tn(n,e,t,r){e&&Xr(()=>{if(t==="ok")e(null);else{let i=(t||"error").toUpperCase(),s=i;r&&(s+=": "+r);let o=new Error(s);o.code=i,e(o)}})}function KA(n,e,t,r,i,s){ni(n,"transaction on "+e);let o={path:e,update:t,onComplete:r,status:null,order:v_(),applyLocally:s,retryCount:0,unwatcher:i,abortReason:null,currentWriteId:null,currentInputSnapshot:null,currentOutputSnapshotRaw:null,currentOutputSnapshotResolved:null},l=ad(n,e,void 0);o.currentInputSnapshot=l;let u=o.update(l.val());if(u===void 0)o.unwatcher(),o.currentOutputSnapshotRaw=null,o.currentOutputSnapshotResolved=null,o.onComplete&&o.onComplete(null,!1,o.currentInputSnapshot);else{js("transaction failed: Data returned ",u,o.path),o.status=0;let c=hl(n.transactionQueueTree_,e),d=rr(c)||[];d.push(o),rd(c,d);let p;typeof u=="object"&&u!==null&&mt(u,".priority")?(p=mn(u,".priority"),M(Ms(p),"Invalid priority returned by transaction. Priority must be a valid string, finite number, server value, or null.")):p=(ul(n.serverSyncTree_,e)||Q.EMPTY_NODE).getPriority().val();let m=Ks(n),v=we(u,p),C=td(v,l,m);o.currentOutputSnapshotRaw=v,o.currentOutputSnapshotResolved=C,o.currentWriteId=ml(n);let N=Jh(n.serverSyncTree_,e,C,o.currentWriteId,o.applyLocally);ct(n.eventQueue_,e,N),gl(n,n.transactionQueueTree_)}}function ad(n,e,t){return ul(n.serverSyncTree_,e,t)||Q.EMPTY_NODE}function gl(n,e=n.transactionQueueTree_){if(e||_l(n,e),rr(e)){let t=Iy(n,e);M(t.length>0,"Sending zero length transaction queue"),t.every(i=>i.status===0)&&WA(n,Gs(e),t)}else hy(e)&&dl(e,t=>{gl(n,t)})}function WA(n,e,t){let r=t.map(c=>c.currentWriteId),i=ad(n,e,r),s=i,o=i.hash();for(let c=0;c<t.length;c++){let d=t[c];M(d.status===0,"tryToSendTransactionQueue_: items in queue should all be run."),d.status=1,d.retryCount++;let p=et(e,d.path);s=s.updateChild(p,d.currentOutputSnapshotRaw)}let l=s.val(!0),u=e;n.server_.put(u.toString(),l,c=>{ni(n,"transaction put response",{path:u.toString(),status:c});let d=[];if(c==="ok"){let p=[];for(let m=0;m<t.length;m++)t[m].status=2,d=d.concat(_n(n.serverSyncTree_,t[m].currentWriteId)),t[m].onComplete&&p.push(()=>t[m].onComplete(null,!0,t[m].currentOutputSnapshotResolved)),t[m].unwatcher();_l(n,hl(n.transactionQueueTree_,e)),gl(n,n.transactionQueueTree_),ct(n.eventQueue_,e,d);for(let m=0;m<p.length;m++)Xr(p[m])}else{if(c==="datastale")for(let p=0;p<t.length;p++)t[p].status===3?t[p].status=4:t[p].status=0;else{$e("transaction at "+u.toString()+" failed: "+c);for(let p=0;p<t.length;p++)t[p].status=4,t[p].abortReason=c}Yr(n,e)}},o)}function Yr(n,e){let t=Ey(n,e),r=Gs(t),i=Iy(n,t);return QA(n,i,r),r}function QA(n,e,t){if(e.length===0)return;let r=[],i=[],o=e.filter(l=>l.status===0).map(l=>l.currentWriteId);for(let l=0;l<e.length;l++){let u=e[l],c=et(t,u.path),d=!1,p;if(M(c!==null,"rerunTransactionsUnderNode_: relativePath should not be null."),u.status===4)d=!0,p=u.abortReason,i=i.concat(_n(n.serverSyncTree_,u.currentWriteId,!0));else if(u.status===0)if(u.retryCount>=VA)d=!0,p="maxretry",i=i.concat(_n(n.serverSyncTree_,u.currentWriteId,!0));else{let m=ad(n,u.path,o);u.currentInputSnapshot=m;let v=e[l].update(m.val());if(v!==void 0){js("transaction failed: Data returned ",v,u.path);let C=we(v);typeof v=="object"&&v!=null&&mt(v,".priority")||(C=C.updatePriority(m.getPriority()));let D=u.currentWriteId,B=Ks(n),j=td(C,m,B);u.currentOutputSnapshotRaw=C,u.currentOutputSnapshotResolved=j,u.currentWriteId=ml(n),o.splice(o.indexOf(D),1),i=i.concat(Jh(n.serverSyncTree_,u.path,j,u.currentWriteId,u.applyLocally)),i=i.concat(_n(n.serverSyncTree_,D,!0))}else d=!0,p="nodata",i=i.concat(_n(n.serverSyncTree_,u.currentWriteId,!0))}ct(n.eventQueue_,t,i),i=[],d&&(e[l].status=2,function(m){setTimeout(m,Math.floor(0))}(e[l].unwatcher),e[l].onComplete&&(p==="nodata"?r.push(()=>e[l].onComplete(null,!1,e[l].currentInputSnapshot)):r.push(()=>e[l].onComplete(new Error(p),!1,null))))}_l(n,n.transactionQueueTree_);for(let l=0;l<r.length;l++)Xr(r[l]);gl(n,n.transactionQueueTree_)}function Ey(n,e){let t,r=n.transactionQueueTree_;for(t=J(e);t!==null&&rr(r)===void 0;)r=hl(r,t),e=de(e),t=J(e);return r}function Iy(n,e){let t=[];return Ty(n,e,t),t.sort((r,i)=>r.order-i.order),t}function Ty(n,e,t){let r=rr(e);if(r)for(let i=0;i<r.length;i++)t.push(r[i]);dl(e,i=>{Ty(n,i,t)})}function _l(n,e){let t=rr(e);if(t){let r=0;for(let i=0;i<t.length;i++)t[i].status!==2&&(t[r]=t[i],r++);t.length=r,rd(e,t.length>0?t:void 0)}dl(e,r=>{_l(n,r)})}function ld(n,e){let t=Gs(Ey(n,e)),r=hl(n.transactionQueueTree_,e);return CA(r,i=>{Nc(n,i)}),Nc(n,r),dy(r,i=>{Nc(n,i)}),t}function Nc(n,e){let t=rr(e);if(t){let r=[],i=[],s=-1;for(let o=0;o<t.length;o++)t[o].status===3||(t[o].status===1?(M(s===o-1,"All SENT items should be at beginning of queue."),s=o,t[o].status=3,t[o].abortReason="set"):(M(t[o].status===0,"Unexpected transaction status in abort"),t[o].unwatcher(),i=i.concat(_n(n.serverSyncTree_,t[o].currentWriteId,!0)),t[o].onComplete&&r.push(t[o].onComplete.bind(null,new Error("set"),!1,null))));s===-1?rd(e,void 0):t.length=s+1,ct(n.eventQueue_,Gs(e),i);for(let o=0;o<r.length;o++)Xr(r[o])}}function $A(n){let e="",t=n.split("/");for(let r=0;r<t.length;r++)if(t[r].length>0){let i=t[r];try{i=decodeURIComponent(i.replace(/\+/g," "))}catch{}e+="/"+i}return e}function HA(n){let e={};n.charAt(0)==="?"&&(n=n.substring(1));for(let t of n.split("&")){if(t.length===0)continue;let r=t.split("=");r.length===2?e[decodeURIComponent(r[0])]=decodeURIComponent(r[1]):$e(`Invalid query segment '${t}' in query '${n}'`)}return e}var Th=function(n,e){let t=YA(n),r=t.namespace;t.domain==="firebase.com"&&Mt(t.host+" is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead"),(!r||r==="undefined")&&t.domain!=="localhost"&&Mt("Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com"),t.secure||CT();let i=t.scheme==="ws"||t.scheme==="wss";return{repoInfo:new ka(t.host,t.secure,r,i,e,"",r!==t.subdomain),path:new ue(t.pathString)}},YA=function(n){let e="",t="",r="",i="",s="",o=!0,l="https",u=443;if(typeof n=="string"){let c=n.indexOf("//");c>=0&&(l=n.substring(0,c-1),n=n.substring(c+2));let d=n.indexOf("/");d===-1&&(d=n.length);let p=n.indexOf("?");p===-1&&(p=n.length),e=n.substring(0,Math.min(d,p)),d<p&&(i=$A(n.substring(d,p)));let m=HA(n.substring(Math.min(n.length,p)));c=e.indexOf(":"),c>=0?(o=l==="https"||l==="wss",u=parseInt(e.substring(c+1),10)):c=e.length;let v=e.slice(0,c);if(v.toLowerCase()==="localhost")t="localhost";else if(v.split(".").length<=2)t=v;else{let C=e.indexOf(".");r=e.substring(0,C).toLowerCase(),t=e.substring(C+1),s=r}"ns"in m&&(s=m.ns)}return{host:e,port:u,domain:t,subdomain:r,secure:o,scheme:l,pathString:i,namespace:s}};var __="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",JA=function(){let n=0,e=[];return function(t){let r=t===n;n=t;let i,s=new Array(8);for(i=7;i>=0;i--)s[i]=__.charAt(t%64),t=Math.floor(t/64);M(t===0,"Cannot push at time == 0");let o=s.join("");if(r){for(i=11;i>=0&&e[i]===63;i--)e[i]=0;e[i]++}else for(i=0;i<12;i++)e[i]=Math.floor(Math.random()*64);for(i=0;i<12;i++)o+=__.charAt(e[i]);return M(o.length===20,"nextPushId: Length should be 20."),o}}();var Xa=class{constructor(e,t,r,i){this.eventType=e,this.eventRegistration=t,this.snapshot=r,this.prevName=i}getPath(){let e=this.snapshot.ref;return this.eventType==="value"?e._path:e.parent._path}getEventType(){return this.eventType}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.getPath().toString()+":"+this.eventType+":"+Re(this.snapshot.exportVal())}},Za=class{constructor(e,t,r){this.eventRegistration=e,this.error=t,this.path=r}getPath(){return this.path}getEventType(){return"cancel"}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.path.toString()+":cancel"}};var Os=class{constructor(e,t){this.snapshotCallback=e,this.cancelCallback=t}onValue(e,t){this.snapshotCallback.call(null,e,t)}onCancel(e){return M(this.hasCancelCallback,"Raising a cancel event on a listener with no cancel callback"),this.cancelCallback.call(null,e)}get hasCancelCallback(){return!!this.cancelCallback}matches(e){return this.snapshotCallback===e.snapshotCallback||this.snapshotCallback.userCallback!==void 0&&this.snapshotCallback.userCallback===e.snapshotCallback.userCallback&&this.snapshotCallback.context===e.snapshotCallback.context}};var el=class{constructor(e,t){this._repo=e,this._path=t}cancel(){let e=new Ze;return qA(this._repo,this._path,e.wrapCallback(()=>{})),e.promise}remove(){ut("OnDisconnect.remove",this._path);let e=new Ze;return g_(this._repo,this._path,null,e.wrapCallback(()=>{})),e.promise}set(e){ut("OnDisconnect.set",this._path),Ft("OnDisconnect.set",e,this._path,!1);let t=new Ze;return g_(this._repo,this._path,e,t.wrapCallback(()=>{})),t.promise}setWithPriority(e,t){ut("OnDisconnect.setWithPriority",this._path),Ft("OnDisconnect.setWithPriority",e,this._path,!1),id("OnDisconnect.setWithPriority",t,!1);let r=new Ze;return BA(this._repo,this._path,e,t,r.wrapCallback(()=>{})),r.promise}update(e){ut("OnDisconnect.update",this._path),py("OnDisconnect.update",e,this._path,!1);let t=new Ze;return GA(this._repo,this._path,e,t.wrapCallback(()=>{})),t.promise}};var nt=class n{constructor(e,t,r,i){this._repo=e,this._path=t,this._queryParams=r,this._orderByCalled=i}get key(){return X(this._path)?null:qh(this._path)}get ref(){return new ht(this._repo,this._path)}get _queryIdentifier(){let e=r_(this._queryParams),t=Lh(e);return t==="{}"?"default":t}get _queryObject(){return r_(this._queryParams)}isEqual(e){if(e=ee(e),!(e instanceof n))return!1;let t=this._repo===e._repo,r=Bh(this._path,e._path),i=this._queryIdentifier===e._queryIdentifier;return t&&r&&i}toJSON(){return this.toString()}toString(){return this._repo.toString()+iS(this._path)}};function yl(n,e){if(n._orderByCalled===!0)throw new Error(e+": You can't combine multiple orderBy calls.")}function An(n){let e=null,t=null;if(n.hasStart()&&(e=n.getIndexStartValue()),n.hasEnd()&&(t=n.getIndexEndValue()),n.getIndex()===Vt){let r="Query: When ordering by key, you may only pass one argument to startAt(), endAt(), or equalTo().",i="Query: When ordering by key, the argument passed to startAt(), startAfter(), endAt(), endBefore(), or equalTo() must be a string.";if(n.hasStart()){if(n.getIndexStartName()!==wn)throw new Error(r);if(typeof e!="string")throw new Error(i)}if(n.hasEnd()){if(n.getIndexEndName()!==Jt)throw new Error(r);if(typeof t!="string")throw new Error(i)}}else if(n.getIndex()===pe){if(e!=null&&!Ms(e)||t!=null&&!Ms(t))throw new Error("Query: When ordering by priority, the first argument passed to startAt(), startAfter() endAt(), endBefore(), or equalTo() must be a valid priority value (null, a number, or a string).")}else if(M(n.getIndex()instanceof Cs||n.getIndex()===zh,"unknown index type."),e!=null&&typeof e=="object"||t!=null&&typeof t=="object")throw new Error("Query: First argument passed to startAt(), startAfter(), endAt(), endBefore(), or equalTo() cannot be an object.")}function vl(n){if(n.hasStart()&&n.hasEnd()&&n.hasLimit()&&!n.hasAnchoredLimit())throw new Error("Query: Can't combine startAt(), startAfter(), endAt(), endBefore(), and limit(). Use limitToFirst() or limitToLast() instead.")}var ht=class n extends nt{constructor(e,t){super(e,t,new xs,!1)}get parent(){let e=q_(this._path);return e===null?null:new n(this._repo,e)}get root(){let e=this;for(;e.parent!==null;)e=e.parent;return e}},Jr=class n{constructor(e,t,r){this._node=e,this.ref=t,this._index=r}get priority(){return this._node.getPriority().val()}get key(){return this.ref.key}get size(){return this._node.numChildren()}child(e){let t=new ue(e),r=Sn(this.ref,e);return new n(this._node.getChild(t),r,pe)}exists(){return!this._node.isEmpty()}exportVal(){return this._node.val(!0)}forEach(e){return this._node.isLeafNode()?!1:!!this._node.forEachChild(this._index,(r,i)=>e(new n(i,Sn(this.ref,r),pe)))}hasChild(e){let t=new ue(e);return!this._node.getChild(t).isEmpty()}hasChildren(){return this._node.isLeafNode()?!1:!this._node.isEmpty()}toJSON(){return this.exportVal()}val(){return this._node.val()}};function ud(n,e){return n=ee(n),n._checkNotDeleted("ref"),e!==void 0?Sn(n._root,e):n._root}function cd(n,e){n=ee(n),n._checkNotDeleted("refFromURL");let t=Th(e,n._repo.repoInfo_.nodeAdmin);my("refFromURL",t);let r=t.repoInfo;return!n._repo.repoInfo_.isCustomHost()&&r.host!==n._repo.repoInfo_.host&&Mt("refFromURL: Host name does not match the current database: (found "+r.host+" but expected "+n._repo.repoInfo_.host+")"),ud(n,t.path.toString())}function Sn(n,e){return n=ee(n),J(n._path)===null?DA("child","path",e,!1):ti("child","path",e,!1),new ht(n._repo,ye(n._path,e))}function Sy(n,e){n=ee(n),ut("push",n._path),Ft("push",e,n._path,!0);let t=vy(n._repo),r=JA(t),i=Sn(n,r),s=Sn(n,r),o;return e!=null?o=wl(s,e).then(()=>s):o=Promise.resolve(s),i.then=o.then.bind(o),i.catch=o.then.bind(o,void 0),i}function Ay(n){return ut("remove",n._path),wl(n,null)}function wl(n,e){n=ee(n),ut("set",n._path),Ft("set",e,n._path,!1);let t=new Ze;return od(n._repo,n._path,e,null,t.wrapCallback(()=>{})),t.promise}function Cy(n,e){n=ee(n),ut("setPriority",n._path),id("setPriority",e,!1);let t=new Ze;return od(n._repo,ye(n._path,".priority"),e,null,t.wrapCallback(()=>{})),t.promise}function by(n,e,t){if(ut("setWithPriority",n._path),Ft("setWithPriority",e,n._path,!1),id("setWithPriority",t,!1),n.key===".length"||n.key===".keys")throw"setWithPriority failed: "+n.key+" is a read-only object.";let r=new Ze;return od(n._repo,n._path,e,t,r.wrapCallback(()=>{})),r.promise}function Ry(n,e){py("update",e,n._path,!1);let t=new Ze;return LA(n._repo,n._path,e,t.wrapCallback(()=>{})),t.promise}function Py(n){n=ee(n);let e=new Os(()=>{}),t=new Fs(e);return FA(n._repo,n,t).then(r=>new Jr(r,new ht(n._repo,n._path),n._queryParams.getIndex()))}var Fs=class n{constructor(e){this.callbackContext=e}respondsTo(e){return e==="value"}createEvent(e,t){let r=t._queryParams.getIndex();return new Xa("value",this,new Jr(e.snapshotNode,new ht(t._repo,t._path),r))}getEventRunner(e){return e.getEventType()==="cancel"?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,null)}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new Za(this,e,t):null}matches(e){return e instanceof n?!e.callbackContext||!this.callbackContext?!0:e.callbackContext.matches(this.callbackContext):!1}hasAnyCallback(){return this.callbackContext!==null}},tl=class n{constructor(e,t){this.eventType=e,this.callbackContext=t}respondsTo(e){let t=e==="children_added"?"child_added":e;return t=t==="children_removed"?"child_removed":t,this.eventType===t}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new Za(this,e,t):null}createEvent(e,t){M(e.childName!=null,"Child events should have a childName.");let r=Sn(new ht(t._repo,t._path),e.childName),i=t._queryParams.getIndex();return new Xa(e.type,this,new Jr(e.snapshotNode,r,i),e.prevName)}getEventRunner(e){return e.getEventType()==="cancel"?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,e.prevName)}matches(e){return e instanceof n?this.eventType===e.eventType&&(!this.callbackContext||!e.callbackContext||this.callbackContext.matches(e.callbackContext)):!1}hasAnyCallback(){return!!this.callbackContext}};function Ws(n,e,t,r,i){let s;if(typeof r=="object"&&(s=void 0,i=r),typeof r=="function"&&(s=r),i&&i.onlyOnce){let u=t,c=(d,p)=>{Ih(n._repo,n,l),u(d,p)};c.userCallback=t.userCallback,c.context=t.context,t=c}let o=new Os(t,s||void 0),l=e==="value"?new Fs(o):new tl(e,o);return jA(n._repo,n,l),()=>Ih(n._repo,n,l)}function El(n,e,t,r){return Ws(n,"value",e,t,r)}function hd(n,e,t,r){return Ws(n,"child_added",e,t,r)}function dd(n,e,t,r){return Ws(n,"child_changed",e,t,r)}function fd(n,e,t,r){return Ws(n,"child_moved",e,t,r)}function pd(n,e,t,r){return Ws(n,"child_removed",e,t,r)}function md(n,e,t){let r=null,i=t?new Os(t):null;e==="value"?r=new Fs(i):e&&(r=new tl(e,i)),Ih(n._repo,n,r)}var dt=class{},nl=class extends dt{constructor(e,t){super(),this._value=e,this._key=t,this.type="endAt"}_apply(e){Ft("endAt",this._value,e._path,!0);let t=Zc(e._queryParams,this._value,this._key);if(vl(t),An(t),e._queryParams.hasEnd())throw new Error("endAt: Starting point was already set (by another call to endAt, endBefore or equalTo).");return new nt(e._repo,e._path,t,e._orderByCalled)}};function xy(n,e){return zs("endAt","key",e,!0),new nl(n,e)}var Sh=class extends dt{constructor(e,t){super(),this._value=e,this._key=t,this.type="endBefore"}_apply(e){Ft("endBefore",this._value,e._path,!1);let t=TS(e._queryParams,this._value,this._key);if(vl(t),An(t),e._queryParams.hasEnd())throw new Error("endBefore: Starting point was already set (by another call to endAt, endBefore or equalTo).");return new nt(e._repo,e._path,t,e._orderByCalled)}};function Ny(n,e){return zs("endBefore","key",e,!0),new Sh(n,e)}var rl=class extends dt{constructor(e,t){super(),this._value=e,this._key=t,this.type="startAt"}_apply(e){Ft("startAt",this._value,e._path,!0);let t=Xc(e._queryParams,this._value,this._key);if(vl(t),An(t),e._queryParams.hasStart())throw new Error("startAt: Starting point was already set (by another call to startAt, startBefore or equalTo).");return new nt(e._repo,e._path,t,e._orderByCalled)}};function Dy(n=null,e){return zs("startAt","key",e,!0),new rl(n,e)}var Ah=class extends dt{constructor(e,t){super(),this._value=e,this._key=t,this.type="startAfter"}_apply(e){Ft("startAfter",this._value,e._path,!1);let t=IS(e._queryParams,this._value,this._key);if(vl(t),An(t),e._queryParams.hasStart())throw new Error("startAfter: Starting point was already set (by another call to startAt, startAfter, or equalTo).");return new nt(e._repo,e._path,t,e._orderByCalled)}};function ky(n,e){return zs("startAfter","key",e,!0),new Ah(n,e)}var Ch=class extends dt{constructor(e){super(),this._limit=e,this.type="limitToFirst"}_apply(e){if(e._queryParams.hasLimit())throw new Error("limitToFirst: Limit was already set (by another call to limitToFirst or limitToLast).");return new nt(e._repo,e._path,wS(e._queryParams,this._limit),e._orderByCalled)}};function Vy(n){if(typeof n!="number"||Math.floor(n)!==n||n<=0)throw new Error("limitToFirst: First argument must be a positive integer.");return new Ch(n)}var bh=class extends dt{constructor(e){super(),this._limit=e,this.type="limitToLast"}_apply(e){if(e._queryParams.hasLimit())throw new Error("limitToLast: Limit was already set (by another call to limitToFirst or limitToLast).");return new nt(e._repo,e._path,ES(e._queryParams,this._limit),e._orderByCalled)}};function My(n){if(typeof n!="number"||Math.floor(n)!==n||n<=0)throw new Error("limitToLast: First argument must be a positive integer.");return new bh(n)}var Rh=class extends dt{constructor(e){super(),this._path=e,this.type="orderByChild"}_apply(e){yl(e,"orderByChild");let t=new ue(this._path);if(X(t))throw new Error("orderByChild: cannot pass in empty path. Use orderByValue() instead.");let r=new Cs(t),i=sl(e._queryParams,r);return An(i),new nt(e._repo,e._path,i,!0)}};function Oy(n){if(n==="$key")throw new Error('orderByChild: "$key" is invalid.  Use orderByKey() instead.');if(n==="$priority")throw new Error('orderByChild: "$priority" is invalid.  Use orderByPriority() instead.');if(n==="$value")throw new Error('orderByChild: "$value" is invalid.  Use orderByValue() instead.');return ti("orderByChild","path",n,!1),new Rh(n)}var Ph=class extends dt{constructor(){super(...arguments),this.type="orderByKey"}_apply(e){yl(e,"orderByKey");let t=sl(e._queryParams,Vt);return An(t),new nt(e._repo,e._path,t,!0)}};function Fy(){return new Ph}var xh=class extends dt{constructor(){super(...arguments),this.type="orderByPriority"}_apply(e){yl(e,"orderByPriority");let t=sl(e._queryParams,pe);return An(t),new nt(e._repo,e._path,t,!0)}};function Ly(){return new xh}var Nh=class extends dt{constructor(){super(...arguments),this.type="orderByValue"}_apply(e){yl(e,"orderByValue");let t=sl(e._queryParams,zh);return An(t),new nt(e._repo,e._path,t,!0)}};function Uy(){return new Nh}var Dh=class extends dt{constructor(e,t){super(),this._value=e,this._key=t,this.type="equalTo"}_apply(e){if(Ft("equalTo",this._value,e._path,!1),e._queryParams.hasStart())throw new Error("equalTo: Starting point was already set (by another call to startAt/startAfter or equalTo).");if(e._queryParams.hasEnd())throw new Error("equalTo: Ending point was already set (by another call to endAt/endBefore or equalTo).");return new nl(this._value,this._key)._apply(new rl(this._value,this._key)._apply(e))}};function qy(n,e){return zs("equalTo","key",e,!0),new Dh(n,e)}function vt(n,...e){let t=ee(n);for(let r of e)t=r._apply(t);return t}iA(ht);uA(ht);var XA="FIREBASE_DATABASE_EMULATOR_HOST",kh={},ZA=!1;function eC(n,e,t,r){n.repoInfo_=new ka(`${e}:${t}`,!1,n.repoInfo_.namespace,n.repoInfo_.webSocketOnly,n.repoInfo_.nodeAdmin,n.repoInfo_.persistenceKey,n.repoInfo_.includeNamespaceInQueryParams,!0),r&&(n.authTokenProvider_=r)}function gd(n,e,t,r,i){let s=r||n.options.databaseURL;s===void 0&&(n.options.projectId||Mt("Can't determine Firebase Database URL. Be sure to include  a Project ID when calling firebase.initializeApp()."),Le("Using default host for project ",n.options.projectId),s=`${n.options.projectId}-default-rtdb.firebaseio.com`);let o=Th(s,i),l=o.repoInfo,u,c;typeof process<"u"&&process.env&&(c=process.env[XA]),c?(u=!0,s=`http://${c}?ns=${l.namespace}`,o=Th(s,i),l=o.repoInfo):u=!o.repoInfo.secure;let d=i&&u?new ws(ws.OWNER):new Fc(n.name,n.options,e);my("Invalid Firebase Database URL",o),X(o.path)||Mt("Database URL must point to the root of a Firebase Database (not including a child path).");let p=nC(l,n,d,new Oc(n.name,t));return new Vh(p,n)}function tC(n,e){let t=kh[e];(!t||t[n.key]!==n)&&Mt(`Database ${e}(${n.repoInfo_}) has already been deleted.`),wy(n),delete t[n.key]}function nC(n,e,t,r){let i=kh[e.name];i||(i={},kh[e.name]=i);let s=i[n.toURLString()];return s&&Mt("Database initialized multiple times. Please make sure the format of the database URL matches with each database() call."),s=new Eh(n,ZA,t,r),i[n.toURLString()]=s,s}var Vh=class{constructor(e,t){this._repoInternal=e,this.app=t,this.type="database",this._instanceStarted=!1}get _repo(){return this._instanceStarted||(MA(this._repoInternal,this.app.options.appId,this.app.options.databaseAuthVariableOverride),this._instanceStarted=!0),this._repoInternal}get _root(){return this._rootInternal||(this._rootInternal=new ht(this._repo,le())),this._rootInternal}_delete(){return this._rootInternal!==null&&(tC(this._repo,this.app.name),this._repoInternal=null,this._rootInternal=null),Promise.resolve()}_checkNotDeleted(e){this._rootInternal===null&&Mt("Cannot call "+e+" on a deleted database.")}};function By(){U_.IS_TRANSPORT_INITIALIZED&&$e("Transport has already been initialized. Please call this function before calling ref or setting up a listener")}function Gy(){By(),Ss.forceDisallow()}function jy(){By(),Br.forceDisallow(),Ss.forceAllow()}function zy(n,e,t,r={}){n=ee(n),n._checkNotDeleted("useEmulator"),n._instanceStarted&&Mt("Cannot call useEmulator() after instance has already been initialized.");let i=n._repoInternal,s;if(i.repoInfo_.nodeAdmin)r.mockUserToken&&Mt('mockUserToken is not supported by the Admin SDK. For client access with mock users, please use the "firebase" package instead of "firebase-admin".'),s=new ws(ws.OWNER);else if(r.mockUserToken){let o=typeof r.mockUserToken=="string"?r.mockUserToken:ca(r.mockUserToken,n.app.options.projectId);s=new ws(o)}eC(i,e,t,s)}function Ky(n){n=ee(n),n._checkNotDeleted("goOffline"),wy(n._repo)}function Wy(n){n=ee(n),n._checkNotDeleted("goOnline"),zA(n._repo)}function Qy(n,e){E_(n,e)}function rC(n){Fh(ma),pa(new Dt("database",(e,{instanceIdentifier:t})=>{let r=e.getProvider("app").getImmediate(),i=e.getProvider("auth-internal"),s=e.getProvider("app-check-internal");return gd(r,i,s,t)},"PUBLIC").setMultipleInstances(!0)),Ur(qg,Bg,n),Ur(qg,Bg,"esm2017")}var iC={".sv":"timestamp"};function $y(){return iC}function Hy(n){return{".sv":{increment:n}}}var Mh=class{constructor(e,t){this.committed=e,this.snapshot=t}toJSON(){return{committed:this.committed,snapshot:this.snapshot.toJSON()}}};function Yy(n,e,t){var r;if(n=ee(n),ut("Reference.transaction",n._path),n.key===".length"||n.key===".keys")throw"Reference.transaction failed: "+n.key+" is a read-only object.";let i=(r=t?.applyLocally)!==null&&r!==void 0?r:!0,s=new Ze,o=(u,c,d)=>{let p=null;u?s.reject(u):(p=new Jr(d,new ht(n._repo,n._path),pe),s.resolve(new Mh(c,p)))},l=El(n,()=>{});return KA(n._repo,n._path,e,o,l,i),s.promise}Gh.prototype.simpleListen=function(n,e){this.sendRequest("q",{p:n},e)};Gh.prototype.echo=function(n,e){this.sendRequest("echo",{d:n},e)};rC();var sC="@firebase/database-compat",oC="1.0.6";var aC=new Lr("@firebase/database-compat"),Jy=function(n){let e="FIREBASE WARNING: "+n;aC.warn(e)};var lC=function(n,e,t,r){if(!(r&&t===void 0)&&typeof t!="boolean")throw new Error(ot(n,e)+"must be a boolean.")},uC=function(n,e,t){if(!(t&&e===void 0))switch(e){case"value":case"child_added":case"child_removed":case"child_changed":case"child_moved":break;default:throw new Error(ot(n,"eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}};var _d=class{constructor(e){this._delegate=e}cancel(e){K("OnDisconnect.cancel",0,1,arguments.length),Ve("OnDisconnect.cancel","onComplete",e,!0);let t=this._delegate.cancel();return e&&t.then(()=>e(null),r=>e(r)),t}remove(e){K("OnDisconnect.remove",0,1,arguments.length),Ve("OnDisconnect.remove","onComplete",e,!0);let t=this._delegate.remove();return e&&t.then(()=>e(null),r=>e(r)),t}set(e,t){K("OnDisconnect.set",1,2,arguments.length),Ve("OnDisconnect.set","onComplete",t,!0);let r=this._delegate.set(e);return t&&r.then(()=>t(null),i=>t(i)),r}setWithPriority(e,t,r){K("OnDisconnect.setWithPriority",2,3,arguments.length),Ve("OnDisconnect.setWithPriority","onComplete",r,!0);let i=this._delegate.setWithPriority(e,t);return r&&i.then(()=>r(null),s=>r(s)),i}update(e,t){if(K("OnDisconnect.update",1,2,arguments.length),Array.isArray(e)){let i={};for(let s=0;s<e.length;++s)i[""+s]=e[s];e=i,Jy("Passing an Array to firebase.database.onDisconnect().update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}Ve("OnDisconnect.update","onComplete",t,!0);let r=this._delegate.update(e);return t&&r.then(()=>t(null),i=>t(i)),r}};var yd=class{constructor(e,t){this.committed=e,this.snapshot=t}toJSON(){return K("TransactionResult.toJSON",0,1,arguments.length),{committed:this.committed,snapshot:this.snapshot.toJSON()}}};var ir=class n{constructor(e,t){this._database=e,this._delegate=t}val(){return K("DataSnapshot.val",0,0,arguments.length),this._delegate.val()}exportVal(){return K("DataSnapshot.exportVal",0,0,arguments.length),this._delegate.exportVal()}toJSON(){return K("DataSnapshot.toJSON",0,1,arguments.length),this._delegate.toJSON()}exists(){return K("DataSnapshot.exists",0,0,arguments.length),this._delegate.exists()}child(e){return K("DataSnapshot.child",0,1,arguments.length),e=String(e),ti("DataSnapshot.child","path",e,!1),new n(this._database,this._delegate.child(e))}hasChild(e){return K("DataSnapshot.hasChild",1,1,arguments.length),ti("DataSnapshot.hasChild","path",e,!1),this._delegate.hasChild(e)}getPriority(){return K("DataSnapshot.getPriority",0,0,arguments.length),this._delegate.priority}forEach(e){return K("DataSnapshot.forEach",1,1,arguments.length),Ve("DataSnapshot.forEach","action",e,!1),this._delegate.forEach(t=>e(new n(this._database,t)))}hasChildren(){return K("DataSnapshot.hasChildren",0,0,arguments.length),this._delegate.hasChildren()}get key(){return this._delegate.key}numChildren(){return K("DataSnapshot.numChildren",0,0,arguments.length),this._delegate.size}getRef(){return K("DataSnapshot.ref",0,0,arguments.length),new Xt(this._database,this._delegate.ref)}get ref(){return this.getRef()}},Il=class n{constructor(e,t){this.database=e,this._delegate=t}on(e,t,r,i){var s;K("Query.on",2,4,arguments.length),Ve("Query.on","callback",t,!1);let o=n.getCancelAndContextArgs_("Query.on",r,i),l=(c,d)=>{t.call(o.context,new ir(this.database,c),d)};l.userCallback=t,l.context=o.context;let u=(s=o.cancel)===null||s===void 0?void 0:s.bind(o.context);switch(e){case"value":return El(this._delegate,l,u),t;case"child_added":return hd(this._delegate,l,u),t;case"child_removed":return pd(this._delegate,l,u),t;case"child_changed":return dd(this._delegate,l,u),t;case"child_moved":return fd(this._delegate,l,u),t;default:throw new Error(ot("Query.on","eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}}off(e,t,r){if(K("Query.off",0,3,arguments.length),uC("Query.off",e,!0),Ve("Query.off","callback",t,!0),Tc("Query.off","context",r,!0),t){let i=()=>{};i.userCallback=t,i.context=r,md(this._delegate,e,i)}else md(this._delegate,e)}get(){return Py(this._delegate).then(e=>new ir(this.database,e))}once(e,t,r,i){K("Query.once",1,4,arguments.length),Ve("Query.once","callback",t,!0);let s=n.getCancelAndContextArgs_("Query.once",r,i),o=new Ze,l=(c,d)=>{let p=new ir(this.database,c);t&&t.call(s.context,p,d),o.resolve(p)};l.userCallback=t,l.context=s.context;let u=c=>{s.cancel&&s.cancel.call(s.context,c),o.reject(c)};switch(e){case"value":El(this._delegate,l,u,{onlyOnce:!0});break;case"child_added":hd(this._delegate,l,u,{onlyOnce:!0});break;case"child_removed":pd(this._delegate,l,u,{onlyOnce:!0});break;case"child_changed":dd(this._delegate,l,u,{onlyOnce:!0});break;case"child_moved":fd(this._delegate,l,u,{onlyOnce:!0});break;default:throw new Error(ot("Query.once","eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}return o.promise}limitToFirst(e){return K("Query.limitToFirst",1,1,arguments.length),new n(this.database,vt(this._delegate,Vy(e)))}limitToLast(e){return K("Query.limitToLast",1,1,arguments.length),new n(this.database,vt(this._delegate,My(e)))}orderByChild(e){return K("Query.orderByChild",1,1,arguments.length),new n(this.database,vt(this._delegate,Oy(e)))}orderByKey(){return K("Query.orderByKey",0,0,arguments.length),new n(this.database,vt(this._delegate,Fy()))}orderByPriority(){return K("Query.orderByPriority",0,0,arguments.length),new n(this.database,vt(this._delegate,Ly()))}orderByValue(){return K("Query.orderByValue",0,0,arguments.length),new n(this.database,vt(this._delegate,Uy()))}startAt(e=null,t){return K("Query.startAt",0,2,arguments.length),new n(this.database,vt(this._delegate,Dy(e,t)))}startAfter(e=null,t){return K("Query.startAfter",0,2,arguments.length),new n(this.database,vt(this._delegate,ky(e,t)))}endAt(e=null,t){return K("Query.endAt",0,2,arguments.length),new n(this.database,vt(this._delegate,xy(e,t)))}endBefore(e=null,t){return K("Query.endBefore",0,2,arguments.length),new n(this.database,vt(this._delegate,Ny(e,t)))}equalTo(e,t){return K("Query.equalTo",1,2,arguments.length),new n(this.database,vt(this._delegate,qy(e,t)))}toString(){return K("Query.toString",0,0,arguments.length),this._delegate.toString()}toJSON(){return K("Query.toJSON",0,1,arguments.length),this._delegate.toJSON()}isEqual(e){if(K("Query.isEqual",1,1,arguments.length),!(e instanceof n)){let t="Query.isEqual failed: First argument must be an instance of firebase.database.Query.";throw new Error(t)}return this._delegate.isEqual(e._delegate)}static getCancelAndContextArgs_(e,t,r){let i={cancel:void 0,context:void 0};if(t&&r)i.cancel=t,Ve(e,"cancel",i.cancel,!0),i.context=r,Tc(e,"context",i.context,!0);else if(t)if(typeof t=="object"&&t!==null)i.context=t;else if(typeof t=="function")i.cancel=t;else throw new Error(ot(e,"cancelOrContext")+" must either be a cancel callback or a context object.");return i}get ref(){return new Xt(this.database,new ht(this._delegate._repo,this._delegate._path))}},Xt=class n extends Il{constructor(e,t){super(e,new nt(t._repo,t._path,new xs,!1)),this.database=e,this._delegate=t}getKey(){return K("Reference.key",0,0,arguments.length),this._delegate.key}child(e){return K("Reference.child",1,1,arguments.length),typeof e=="number"&&(e=String(e)),new n(this.database,Sn(this._delegate,e))}getParent(){K("Reference.parent",0,0,arguments.length);let e=this._delegate.parent;return e?new n(this.database,e):null}getRoot(){return K("Reference.root",0,0,arguments.length),new n(this.database,this._delegate.root)}set(e,t){K("Reference.set",1,2,arguments.length),Ve("Reference.set","onComplete",t,!0);let r=wl(this._delegate,e);return t&&r.then(()=>t(null),i=>t(i)),r}update(e,t){if(K("Reference.update",1,2,arguments.length),Array.isArray(e)){let i={};for(let s=0;s<e.length;++s)i[""+s]=e[s];e=i,Jy("Passing an Array to Firebase.update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}ut("Reference.update",this._delegate._path),Ve("Reference.update","onComplete",t,!0);let r=Ry(this._delegate,e);return t&&r.then(()=>t(null),i=>t(i)),r}setWithPriority(e,t,r){K("Reference.setWithPriority",2,3,arguments.length),Ve("Reference.setWithPriority","onComplete",r,!0);let i=by(this._delegate,e,t);return r&&i.then(()=>r(null),s=>r(s)),i}remove(e){K("Reference.remove",0,1,arguments.length),Ve("Reference.remove","onComplete",e,!0);let t=Ay(this._delegate);return e&&t.then(()=>e(null),r=>e(r)),t}transaction(e,t,r){K("Reference.transaction",1,3,arguments.length),Ve("Reference.transaction","transactionUpdate",e,!1),Ve("Reference.transaction","onComplete",t,!0),lC("Reference.transaction","applyLocally",r,!0);let i=Yy(this._delegate,e,{applyLocally:r}).then(s=>new yd(s.committed,new ir(this.database,s.snapshot)));return t&&i.then(s=>t(null,s.committed,s.snapshot),s=>t(s,!1,null)),i}setPriority(e,t){K("Reference.setPriority",1,2,arguments.length),Ve("Reference.setPriority","onComplete",t,!0);let r=Cy(this._delegate,e);return t&&r.then(()=>t(null),i=>t(i)),r}push(e,t){K("Reference.push",0,2,arguments.length),Ve("Reference.push","onComplete",t,!0);let r=Sy(this._delegate,e),i=r.then(o=>new n(this.database,o));t&&i.then(()=>t(null),o=>t(o));let s=new n(this.database,r);return s.then=i.then.bind(i),s.catch=i.catch.bind(i,void 0),s}onDisconnect(){return ut("Reference.onDisconnect",this._delegate._path),new _d(new el(this._delegate._repo,this._delegate._path))}get key(){return this.getKey()}get parent(){return this.getParent()}get root(){return this.getRoot()}};var sr=class{constructor(e,t){this._delegate=e,this.app=t,this.INTERNAL={delete:()=>this._delegate._delete(),forceWebSockets:Gy,forceLongPolling:jy}}useEmulator(e,t,r={}){zy(this._delegate,e,t,r)}ref(e){if(K("database.ref",0,1,arguments.length),e instanceof Xt){let t=cd(this._delegate,e.toString());return new Xt(this,t)}else{let t=ud(this._delegate,e);return new Xt(this,t)}}refFromURL(e){K("database.refFromURL",1,1,arguments.length);let r=cd(this._delegate,e);return new Xt(this,r)}goOffline(){return K("database.goOffline",0,0,arguments.length),Ky(this._delegate)}goOnline(){return K("database.goOnline",0,0,arguments.length),Wy(this._delegate)}};sr.ServerValue={TIMESTAMP:$y(),increment:n=>Hy(n)};function cC({app:n,url:e,version:t,customAuthImpl:r,customAppCheckImpl:i,namespace:s,nodeAdmin:o=!1}){Fh(t);let l=new Sc("database-standalone"),u=new fa("auth-internal",l);u.setComponent(new Dt("auth-internal",()=>r,"PRIVATE"));let c;return i&&(c=new fa("app-check-internal",l),c.setComponent(new Dt("app-check-internal",()=>i,"PRIVATE"))),{instance:new sr(gd(n,u,c,e,o),n),namespace:s}}var hC=Object.freeze({__proto__:null,initStandalone:cC});var dC=sr.ServerValue;function fC(n){n.INTERNAL.registerComponent(new Dt("database-compat",(e,{instanceIdentifier:t})=>{let r=e.getProvider("app-compat").getImmediate(),i=e.getProvider("database").getImmediate({identifier:t});return new sr(i,r)},"PUBLIC").setServiceProps({Reference:Xt,Query:Il,Database:sr,DataSnapshot:ir,enableLogging:Qy,INTERNAL:hC,ServerValue:dC}).setMultipleInstances(!0)),n.registerVersion(sC,oC)}fC(gn);function Qs(n,e,t="on",r=ta){return new ea(i=>{let s=null;return s=n[t](e,(o,l)=>{r.schedule(()=>{i.next({snapshot:o,prevKey:l})}),t==="once"&&r.schedule(()=>i.complete())},o=>{r.schedule(()=>i.error(o))}),t==="on"?{unsubscribe(){s!=null&&n.off(e,s)}}:{unsubscribe(){}}}).pipe(Fe(i=>{let{snapshot:s,prevKey:o}=i,l=null;return s.exists()&&(l=s.key),{type:e,payload:s,prevKey:o,key:l}}),Sg())}function yC(n){return typeof n=="string"}function vC(n){return typeof n.exportVal=="function"}function nv(n){return n==null}function rv(n){return typeof n.set=="function"}function Xy(n,e){return rv(e)?e:n.ref(e)}function iv(n,e){if(yC(n))return e.stringCase();if(rv(n))return e.firebaseCase();if(vC(n))return e.snapshotCase();throw new Error(`Expects a string, snapshot, or reference. Got: ${typeof n}`)}function sv(n){return(nv(n)||n.length===0)&&(n=["child_added","child_removed","child_changed","child_moved"]),n}function ov(n,e,t){e=sv(e);let r=e.map(i=>Qs(n,i,"on",t));return yc(...r)}function wC(n,e,t){let r=ov(n,e).pipe(Yn((i,s)=>[...i,s],[]));return IC(n,r,t)}function EC(n,e){return Qs(n,"value","on",e).pipe(Fe(t=>{let r;return t.payload.forEach(i=>(r=i.key,!1)),{data:t,lastKeyToLoad:r}}))}function IC(n,e,t){return EC(n,t).pipe(bg(e),Fe(([i,s])=>{let o=i.lastKeyToLoad,l=s.map(u=>u.key);return{actions:s,lastKeyToLoad:o,loadedKeys:l}}),Ag(i=>i.loadedKeys.indexOf(i.lastKeyToLoad)===-1),Fe(i=>i.actions))}function Zy(n,e){return function(r,i){return iv(r,{stringCase:()=>n.child(r)[e](i),firebaseCase:()=>r[e](i),snapshotCase:()=>r.ref[e](i)})}}function TC(n){return function(t){return t?iv(t,{stringCase:()=>n.child(t).remove(),firebaseCase:()=>t.remove(),snapshotCase:()=>t.ref.remove()}):n.remove()}}function SC(n,e,t){return Qs(n,"value","once",t).pipe(Cg(r=>{let i=[hs(r)];return e.forEach(s=>i.push(Qs(n,s,"on",t))),yc(...i).pipe(Yn(CC,[]))}),na())}function av(n,e){let t=n.length;for(let r=0;r<t;r++)if(n[r].payload.key===e)return r;return-1}function AC(n,e){if(nv(e))return 0;{let t=av(n,e);return t===-1?n.length:t+1}}function CC(n,e){let{payload:t,prevKey:r,key:i}=e,s=av(n,i),o=AC(n,r);switch(e.type){case"value":if(e.payload?.exists()){let l=null;e.payload.forEach(u=>{let c={payload:u,type:"value",prevKey:l,key:u.key};return l=u.key,n=[...n,c],!1})}return n;case"child_added":if(s>-1)(n[s-1]?.key||null)!==r&&(n=n.filter(u=>u.payload.key!==t.key),n.splice(o,0,e));else{if(r==null)return[e,...n];n=n.slice(),n.splice(o,0,e)}return n;case"child_removed":return n.filter(l=>l.payload.key!==t.key);case"child_changed":return n.map(l=>l.payload.key===i?e:l);case"child_moved":if(s>-1){let l=n.splice(s,1)[0];return n=n.slice(),n.splice(o,0,l),n}return n;default:return n}}function ev(n,e,t){return e=sv(e),SC(n,e,t)}function bC(n,e){let t=e.schedulers.outsideAngular,r=e.schedulers.ngZone.run(()=>n.ref);return{query:n,update:Zy(r,"update"),set:Zy(r,"set"),push:i=>r.push(i),remove:TC(r),snapshotChanges(i){return ev(n,i,t).pipe(Me)},stateChanges(i){return ov(n,i,t).pipe(Me)},auditTrail(i){return wC(n,i,t).pipe(Me)},valueChanges(i,s){return ev(n,i,t).pipe(Fe(l=>l.map(u=>s&&s.idField?us(Or({},u.payload.val()),{[s.idField]:u.key}):u.payload.val())),Me)}}}function tv(n,e){return function(){return Qs(n,"value","on",e)}}function RC(n,e){return{query:n,snapshotChanges(){return tv(n,e.schedulers.outsideAngular)().pipe(Me)},update(t){return n.ref.update(t)},set(t){return n.ref.set(t)},remove(){return n.ref.remove()},valueChanges(){return tv(n,e.schedulers.outsideAngular)().pipe(Me,Fe(r=>r.payload.exists()?r.payload.val():null))}}}var PC=new pn("angularfire2.realtimeDatabaseURL"),xC=new pn("angularfire2.database.use-emulator"),NC=(()=>{class n{schedulers;database;constructor(t,r,i,s,o,l,u,c,d,p,m,v,C,N,D){this.schedulers=l;let B=u,j=Ea(t,o,r);c&&Pa(j,o,d,m,v,C,p,N),this.database=Ia(`${j.name}.database.${i}`,"AngularFireDatabase",j.name,()=>{let q=o.runOutsideAngular(()=>j.database(i||void 0));return B&&q.useEmulator(...B),q},[B])}list(t,r){let i=this.schedulers.ngZone.runOutsideAngular(()=>Xy(this.database,t)),s=i;return r&&(s=r(i)),bC(s,this)}object(t){let r=this.schedulers.ngZone.runOutsideAngular(()=>Xy(this.database,t));return RC(r,this)}createPushId(){return this.schedulers.ngZone.runOutsideAngular(()=>this.database.ref()).push().key}static \u0275fac=function(r){return new(r||n)(re(va),re(wa,8),re(PC,8),re(la),re(ua),re(ya),re(xC,8),re(xa,8),re(Ta,8),re(Sa,8),re(Aa,8),re(Ca,8),re(ba,8),re(Ra,8),re(_a,8))};static \u0275prov=sa({token:n,factory:n.\u0275fac,providedIn:"any"})}return n})(),dR=(()=>{class n{constructor(){gn.registerVersion("angularfire",ga.full,"rtdb-compat")}static \u0275fac=function(r){return new(r||n)};static \u0275mod=aa({type:n});static \u0275inj=oa({providers:[NC]})}return n})();var lv=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},uv={};var Cn,vd;(function(){var n;function e(E,_){function w(){}w.prototype=_.prototype,E.D=_.prototype,E.prototype=new w,E.prototype.constructor=E,E.C=function(I,T,A){for(var y=Array(arguments.length-2),$t=2;$t<arguments.length;$t++)y[$t-2]=arguments[$t];return _.prototype[T].apply(I,y)}}function t(){this.blockSize=-1}function r(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.B=Array(this.blockSize),this.o=this.h=0,this.s()}e(r,t),r.prototype.s=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.o=this.h=0};function i(E,_,w){w||(w=0);var I=Array(16);if(typeof _=="string")for(var T=0;16>T;++T)I[T]=_.charCodeAt(w++)|_.charCodeAt(w++)<<8|_.charCodeAt(w++)<<16|_.charCodeAt(w++)<<24;else for(T=0;16>T;++T)I[T]=_[w++]|_[w++]<<8|_[w++]<<16|_[w++]<<24;_=E.g[0],w=E.g[1],T=E.g[2];var A=E.g[3],y=_+(A^w&(T^A))+I[0]+3614090360&4294967295;_=w+(y<<7&4294967295|y>>>25),y=A+(T^_&(w^T))+I[1]+3905402710&4294967295,A=_+(y<<12&4294967295|y>>>20),y=T+(w^A&(_^w))+I[2]+606105819&4294967295,T=A+(y<<17&4294967295|y>>>15),y=w+(_^T&(A^_))+I[3]+3250441966&4294967295,w=T+(y<<22&4294967295|y>>>10),y=_+(A^w&(T^A))+I[4]+4118548399&4294967295,_=w+(y<<7&4294967295|y>>>25),y=A+(T^_&(w^T))+I[5]+1200080426&4294967295,A=_+(y<<12&4294967295|y>>>20),y=T+(w^A&(_^w))+I[6]+2821735955&4294967295,T=A+(y<<17&4294967295|y>>>15),y=w+(_^T&(A^_))+I[7]+4249261313&4294967295,w=T+(y<<22&4294967295|y>>>10),y=_+(A^w&(T^A))+I[8]+1770035416&4294967295,_=w+(y<<7&4294967295|y>>>25),y=A+(T^_&(w^T))+I[9]+2336552879&4294967295,A=_+(y<<12&4294967295|y>>>20),y=T+(w^A&(_^w))+I[10]+4294925233&4294967295,T=A+(y<<17&4294967295|y>>>15),y=w+(_^T&(A^_))+I[11]+2304563134&4294967295,w=T+(y<<22&4294967295|y>>>10),y=_+(A^w&(T^A))+I[12]+1804603682&4294967295,_=w+(y<<7&4294967295|y>>>25),y=A+(T^_&(w^T))+I[13]+4254626195&4294967295,A=_+(y<<12&4294967295|y>>>20),y=T+(w^A&(_^w))+I[14]+2792965006&4294967295,T=A+(y<<17&4294967295|y>>>15),y=w+(_^T&(A^_))+I[15]+1236535329&4294967295,w=T+(y<<22&4294967295|y>>>10),y=_+(T^A&(w^T))+I[1]+4129170786&4294967295,_=w+(y<<5&4294967295|y>>>27),y=A+(w^T&(_^w))+I[6]+3225465664&4294967295,A=_+(y<<9&4294967295|y>>>23),y=T+(_^w&(A^_))+I[11]+643717713&4294967295,T=A+(y<<14&4294967295|y>>>18),y=w+(A^_&(T^A))+I[0]+3921069994&4294967295,w=T+(y<<20&4294967295|y>>>12),y=_+(T^A&(w^T))+I[5]+3593408605&4294967295,_=w+(y<<5&4294967295|y>>>27),y=A+(w^T&(_^w))+I[10]+38016083&4294967295,A=_+(y<<9&4294967295|y>>>23),y=T+(_^w&(A^_))+I[15]+3634488961&4294967295,T=A+(y<<14&4294967295|y>>>18),y=w+(A^_&(T^A))+I[4]+3889429448&4294967295,w=T+(y<<20&4294967295|y>>>12),y=_+(T^A&(w^T))+I[9]+568446438&4294967295,_=w+(y<<5&4294967295|y>>>27),y=A+(w^T&(_^w))+I[14]+3275163606&4294967295,A=_+(y<<9&4294967295|y>>>23),y=T+(_^w&(A^_))+I[3]+4107603335&4294967295,T=A+(y<<14&4294967295|y>>>18),y=w+(A^_&(T^A))+I[8]+1163531501&4294967295,w=T+(y<<20&4294967295|y>>>12),y=_+(T^A&(w^T))+I[13]+2850285829&4294967295,_=w+(y<<5&4294967295|y>>>27),y=A+(w^T&(_^w))+I[2]+4243563512&4294967295,A=_+(y<<9&4294967295|y>>>23),y=T+(_^w&(A^_))+I[7]+1735328473&4294967295,T=A+(y<<14&4294967295|y>>>18),y=w+(A^_&(T^A))+I[12]+2368359562&4294967295,w=T+(y<<20&4294967295|y>>>12),y=_+(w^T^A)+I[5]+4294588738&4294967295,_=w+(y<<4&4294967295|y>>>28),y=A+(_^w^T)+I[8]+2272392833&4294967295,A=_+(y<<11&4294967295|y>>>21),y=T+(A^_^w)+I[11]+1839030562&4294967295,T=A+(y<<16&4294967295|y>>>16),y=w+(T^A^_)+I[14]+4259657740&4294967295,w=T+(y<<23&4294967295|y>>>9),y=_+(w^T^A)+I[1]+2763975236&4294967295,_=w+(y<<4&4294967295|y>>>28),y=A+(_^w^T)+I[4]+1272893353&4294967295,A=_+(y<<11&4294967295|y>>>21),y=T+(A^_^w)+I[7]+4139469664&4294967295,T=A+(y<<16&4294967295|y>>>16),y=w+(T^A^_)+I[10]+3200236656&4294967295,w=T+(y<<23&4294967295|y>>>9),y=_+(w^T^A)+I[13]+681279174&4294967295,_=w+(y<<4&4294967295|y>>>28),y=A+(_^w^T)+I[0]+3936430074&4294967295,A=_+(y<<11&4294967295|y>>>21),y=T+(A^_^w)+I[3]+3572445317&4294967295,T=A+(y<<16&4294967295|y>>>16),y=w+(T^A^_)+I[6]+76029189&4294967295,w=T+(y<<23&4294967295|y>>>9),y=_+(w^T^A)+I[9]+3654602809&4294967295,_=w+(y<<4&4294967295|y>>>28),y=A+(_^w^T)+I[12]+3873151461&4294967295,A=_+(y<<11&4294967295|y>>>21),y=T+(A^_^w)+I[15]+530742520&4294967295,T=A+(y<<16&4294967295|y>>>16),y=w+(T^A^_)+I[2]+3299628645&4294967295,w=T+(y<<23&4294967295|y>>>9),y=_+(T^(w|~A))+I[0]+4096336452&4294967295,_=w+(y<<6&4294967295|y>>>26),y=A+(w^(_|~T))+I[7]+1126891415&4294967295,A=_+(y<<10&4294967295|y>>>22),y=T+(_^(A|~w))+I[14]+2878612391&4294967295,T=A+(y<<15&4294967295|y>>>17),y=w+(A^(T|~_))+I[5]+4237533241&4294967295,w=T+(y<<21&4294967295|y>>>11),y=_+(T^(w|~A))+I[12]+1700485571&4294967295,_=w+(y<<6&4294967295|y>>>26),y=A+(w^(_|~T))+I[3]+2399980690&4294967295,A=_+(y<<10&4294967295|y>>>22),y=T+(_^(A|~w))+I[10]+4293915773&4294967295,T=A+(y<<15&4294967295|y>>>17),y=w+(A^(T|~_))+I[1]+2240044497&4294967295,w=T+(y<<21&4294967295|y>>>11),y=_+(T^(w|~A))+I[8]+1873313359&4294967295,_=w+(y<<6&4294967295|y>>>26),y=A+(w^(_|~T))+I[15]+4264355552&4294967295,A=_+(y<<10&4294967295|y>>>22),y=T+(_^(A|~w))+I[6]+2734768916&4294967295,T=A+(y<<15&4294967295|y>>>17),y=w+(A^(T|~_))+I[13]+1309151649&4294967295,w=T+(y<<21&4294967295|y>>>11),y=_+(T^(w|~A))+I[4]+4149444226&4294967295,_=w+(y<<6&4294967295|y>>>26),y=A+(w^(_|~T))+I[11]+3174756917&4294967295,A=_+(y<<10&4294967295|y>>>22),y=T+(_^(A|~w))+I[2]+718787259&4294967295,T=A+(y<<15&4294967295|y>>>17),y=w+(A^(T|~_))+I[9]+3951481745&4294967295,E.g[0]=E.g[0]+_&4294967295,E.g[1]=E.g[1]+(T+(y<<21&4294967295|y>>>11))&4294967295,E.g[2]=E.g[2]+T&4294967295,E.g[3]=E.g[3]+A&4294967295}r.prototype.u=function(E,_){_===void 0&&(_=E.length);for(var w=_-this.blockSize,I=this.B,T=this.h,A=0;A<_;){if(T==0)for(;A<=w;)i(this,E,A),A+=this.blockSize;if(typeof E=="string"){for(;A<_;)if(I[T++]=E.charCodeAt(A++),T==this.blockSize){i(this,I),T=0;break}}else for(;A<_;)if(I[T++]=E[A++],T==this.blockSize){i(this,I),T=0;break}}this.h=T,this.o+=_},r.prototype.v=function(){var E=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);E[0]=128;for(var _=1;_<E.length-8;++_)E[_]=0;var w=8*this.o;for(_=E.length-8;_<E.length;++_)E[_]=w&255,w/=256;for(this.u(E),E=Array(16),_=w=0;4>_;++_)for(var I=0;32>I;I+=8)E[w++]=this.g[_]>>>I&255;return E};function s(E,_){var w=l;return Object.prototype.hasOwnProperty.call(w,E)?w[E]:w[E]=_(E)}function o(E,_){this.h=_;for(var w=[],I=!0,T=E.length-1;0<=T;T--){var A=E[T]|0;I&&A==_||(w[T]=A,I=!1)}this.g=w}var l={};function u(E){return-128<=E&&128>E?s(E,function(_){return new o([_|0],0>_?-1:0)}):new o([E|0],0>E?-1:0)}function c(E){if(isNaN(E)||!isFinite(E))return p;if(0>E)return D(c(-E));for(var _=[],w=1,I=0;E>=w;I++)_[I]=E/w|0,w*=4294967296;return new o(_,0)}function d(E,_){if(E.length==0)throw Error("number format error: empty string");if(_=_||10,2>_||36<_)throw Error("radix out of range: "+_);if(E.charAt(0)=="-")return D(d(E.substring(1),_));if(0<=E.indexOf("-"))throw Error('number format error: interior "-" character');for(var w=c(Math.pow(_,8)),I=p,T=0;T<E.length;T+=8){var A=Math.min(8,E.length-T),y=parseInt(E.substring(T,T+A),_);8>A?(A=c(Math.pow(_,A)),I=I.j(A).add(c(y))):(I=I.j(w),I=I.add(c(y)))}return I}var p=u(0),m=u(1),v=u(16777216);n=o.prototype,n.m=function(){if(N(this))return-D(this).m();for(var E=0,_=1,w=0;w<this.g.length;w++){var I=this.i(w);E+=(0<=I?I:4294967296+I)*_,_*=4294967296}return E},n.toString=function(E){if(E=E||10,2>E||36<E)throw Error("radix out of range: "+E);if(C(this))return"0";if(N(this))return"-"+D(this).toString(E);for(var _=c(Math.pow(E,6)),w=this,I="";;){var T=Y(w,_).g;w=B(w,T.j(_));var A=((0<w.g.length?w.g[0]:w.h)>>>0).toString(E);if(w=T,C(w))return A+I;for(;6>A.length;)A="0"+A;I=A+I}},n.i=function(E){return 0>E?0:E<this.g.length?this.g[E]:this.h};function C(E){if(E.h!=0)return!1;for(var _=0;_<E.g.length;_++)if(E.g[_]!=0)return!1;return!0}function N(E){return E.h==-1}n.l=function(E){return E=B(this,E),N(E)?-1:C(E)?0:1};function D(E){for(var _=E.g.length,w=[],I=0;I<_;I++)w[I]=~E.g[I];return new o(w,~E.h).add(m)}n.abs=function(){return N(this)?D(this):this},n.add=function(E){for(var _=Math.max(this.g.length,E.g.length),w=[],I=0,T=0;T<=_;T++){var A=I+(this.i(T)&65535)+(E.i(T)&65535),y=(A>>>16)+(this.i(T)>>>16)+(E.i(T)>>>16);I=y>>>16,A&=65535,y&=65535,w[T]=y<<16|A}return new o(w,w[w.length-1]&-2147483648?-1:0)};function B(E,_){return E.add(D(_))}n.j=function(E){if(C(this)||C(E))return p;if(N(this))return N(E)?D(this).j(D(E)):D(D(this).j(E));if(N(E))return D(this.j(D(E)));if(0>this.l(v)&&0>E.l(v))return c(this.m()*E.m());for(var _=this.g.length+E.g.length,w=[],I=0;I<2*_;I++)w[I]=0;for(I=0;I<this.g.length;I++)for(var T=0;T<E.g.length;T++){var A=this.i(I)>>>16,y=this.i(I)&65535,$t=E.i(T)>>>16,zi=E.i(T)&65535;w[2*I+2*T]+=y*zi,j(w,2*I+2*T),w[2*I+2*T+1]+=A*zi,j(w,2*I+2*T+1),w[2*I+2*T+1]+=y*$t,j(w,2*I+2*T+1),w[2*I+2*T+2]+=A*$t,j(w,2*I+2*T+2)}for(I=0;I<_;I++)w[I]=w[2*I+1]<<16|w[2*I];for(I=_;I<2*_;I++)w[I]=0;return new o(w,0)};function j(E,_){for(;(E[_]&65535)!=E[_];)E[_+1]+=E[_]>>>16,E[_]&=65535,_++}function q(E,_){this.g=E,this.h=_}function Y(E,_){if(C(_))throw Error("division by zero");if(C(E))return new q(p,p);if(N(E))return _=Y(D(E),_),new q(D(_.g),D(_.h));if(N(_))return _=Y(E,D(_)),new q(D(_.g),_.h);if(30<E.g.length){if(N(E)||N(_))throw Error("slowDivide_ only works with positive integers.");for(var w=m,I=_;0>=I.l(E);)w=ne(w),I=ne(I);var T=W(w,1),A=W(I,1);for(I=W(I,2),w=W(w,2);!C(I);){var y=A.add(I);0>=y.l(E)&&(T=T.add(w),A=y),I=W(I,1),w=W(w,1)}return _=B(E,T.j(_)),new q(T,_)}for(T=p;0<=E.l(_);){for(w=Math.max(1,Math.floor(E.m()/_.m())),I=Math.ceil(Math.log(w)/Math.LN2),I=48>=I?1:Math.pow(2,I-48),A=c(w),y=A.j(_);N(y)||0<y.l(E);)w-=I,A=c(w),y=A.j(_);C(A)&&(A=m),T=T.add(A),E=B(E,y)}return new q(T,E)}n.A=function(E){return Y(this,E).h},n.and=function(E){for(var _=Math.max(this.g.length,E.g.length),w=[],I=0;I<_;I++)w[I]=this.i(I)&E.i(I);return new o(w,this.h&E.h)},n.or=function(E){for(var _=Math.max(this.g.length,E.g.length),w=[],I=0;I<_;I++)w[I]=this.i(I)|E.i(I);return new o(w,this.h|E.h)},n.xor=function(E){for(var _=Math.max(this.g.length,E.g.length),w=[],I=0;I<_;I++)w[I]=this.i(I)^E.i(I);return new o(w,this.h^E.h)};function ne(E){for(var _=E.g.length+1,w=[],I=0;I<_;I++)w[I]=E.i(I)<<1|E.i(I-1)>>>31;return new o(w,E.h)}function W(E,_){var w=_>>5;_%=32;for(var I=E.g.length-w,T=[],A=0;A<I;A++)T[A]=0<_?E.i(A+w)>>>_|E.i(A+w+1)<<32-_:E.i(A+w);return new o(T,E.h)}r.prototype.digest=r.prototype.v,r.prototype.reset=r.prototype.s,r.prototype.update=r.prototype.u,vd=uv.Md5=r,o.prototype.add=o.prototype.add,o.prototype.multiply=o.prototype.j,o.prototype.modulo=o.prototype.A,o.prototype.compare=o.prototype.l,o.prototype.toNumber=o.prototype.m,o.prototype.toString=o.prototype.toString,o.prototype.getBits=o.prototype.i,o.fromNumber=c,o.fromString=d,Cn=uv.Integer=o}).apply(typeof lv<"u"?lv:typeof self<"u"?self:typeof window<"u"?window:{});var Tl=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},Zt={};var wd,Ed,ri,Id,$s,Sl,Td,Sd,Ad;(function(){var n,e=typeof Object.defineProperties=="function"?Object.defineProperty:function(a,h,f){return a==Array.prototype||a==Object.prototype||(a[h]=f.value),a};function t(a){a=[typeof globalThis=="object"&&globalThis,a,typeof window=="object"&&window,typeof self=="object"&&self,typeof Tl=="object"&&Tl];for(var h=0;h<a.length;++h){var f=a[h];if(f&&f.Math==Math)return f}throw Error("Cannot find global object")}var r=t(this);function i(a,h){if(h)e:{var f=r;a=a.split(".");for(var g=0;g<a.length-1;g++){var S=a[g];if(!(S in f))break e;f=f[S]}a=a[a.length-1],g=f[a],h=h(g),h!=g&&h!=null&&e(f,a,{configurable:!0,writable:!0,value:h})}}function s(a,h){a instanceof String&&(a+="");var f=0,g=!1,S={next:function(){if(!g&&f<a.length){var R=f++;return{value:h(R,a[R]),done:!1}}return g=!0,{done:!0,value:void 0}}};return S[Symbol.iterator]=function(){return S},S}i("Array.prototype.values",function(a){return a||function(){return s(this,function(h,f){return f})}});var o=o||{},l=this||self;function u(a){var h=typeof a;return h=h!="object"?h:a?Array.isArray(a)?"array":h:"null",h=="array"||h=="object"&&typeof a.length=="number"}function c(a){var h=typeof a;return h=="object"&&a!=null||h=="function"}function d(a,h,f){return a.call.apply(a.bind,arguments)}function p(a,h,f){if(!a)throw Error();if(2<arguments.length){var g=Array.prototype.slice.call(arguments,2);return function(){var S=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(S,g),a.apply(h,S)}}return function(){return a.apply(h,arguments)}}function m(a,h,f){return m=Function.prototype.bind&&Function.prototype.bind.toString().indexOf("native code")!=-1?d:p,m.apply(null,arguments)}function v(a,h){var f=Array.prototype.slice.call(arguments,1);return function(){var g=f.slice();return g.push.apply(g,arguments),a.apply(this,g)}}function C(a,h){function f(){}f.prototype=h.prototype,a.aa=h.prototype,a.prototype=new f,a.prototype.constructor=a,a.Qb=function(g,S,R){for(var O=Array(arguments.length-2),he=2;he<arguments.length;he++)O[he-2]=arguments[he];return h.prototype[S].apply(g,O)}}function N(a){let h=a.length;if(0<h){let f=Array(h);for(let g=0;g<h;g++)f[g]=a[g];return f}return[]}function D(a,h){for(let f=1;f<arguments.length;f++){let g=arguments[f];if(u(g)){let S=a.length||0,R=g.length||0;a.length=S+R;for(let O=0;O<R;O++)a[S+O]=g[O]}else a.push(g)}}class B{constructor(h,f){this.i=h,this.j=f,this.h=0,this.g=null}get(){let h;return 0<this.h?(this.h--,h=this.g,this.g=h.next,h.next=null):h=this.i(),h}}function j(a){return/^[\s\xa0]*$/.test(a)}function q(){var a=l.navigator;return a&&(a=a.userAgent)?a:""}function Y(a){return Y[" "](a),a}Y[" "]=function(){};var ne=q().indexOf("Gecko")!=-1&&!(q().toLowerCase().indexOf("webkit")!=-1&&q().indexOf("Edge")==-1)&&!(q().indexOf("Trident")!=-1||q().indexOf("MSIE")!=-1)&&q().indexOf("Edge")==-1;function W(a,h,f){for(let g in a)h.call(f,a[g],g,a)}function E(a,h){for(let f in a)h.call(void 0,a[f],f,a)}function _(a){let h={};for(let f in a)h[f]=a[f];return h}let w="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function I(a,h){let f,g;for(let S=1;S<arguments.length;S++){g=arguments[S];for(f in g)a[f]=g[f];for(let R=0;R<w.length;R++)f=w[R],Object.prototype.hasOwnProperty.call(g,f)&&(a[f]=g[f])}}function T(a){var h=1;a=a.split(":");let f=[];for(;0<h&&a.length;)f.push(a.shift()),h--;return a.length&&f.push(a.join(":")),f}function A(a){l.setTimeout(()=>{throw a},0)}function y(){var a=Wu;let h=null;return a.g&&(h=a.g,a.g=a.g.next,a.g||(a.h=null),h.next=null),h}class $t{constructor(){this.h=this.g=null}add(h,f){let g=zi.get();g.set(h,f),this.h?this.h.next=g:this.g=g,this.h=g}}var zi=new B(()=>new jI,a=>a.reset());class jI{constructor(){this.next=this.g=this.h=null}set(h,f){this.h=h,this.g=f,this.next=null}reset(){this.next=this.g=this.h=null}}let Ki,Wi=!1,Wu=new $t,Tm=()=>{let a=l.Promise.resolve(void 0);Ki=()=>{a.then(zI)}};var zI=()=>{for(var a;a=y();){try{a.h.call(a.g)}catch(f){A(f)}var h=zi;h.j(a),100>h.h&&(h.h++,a.next=h.g,h.g=a)}Wi=!1};function cn(){this.s=this.s,this.C=this.C}cn.prototype.s=!1,cn.prototype.ma=function(){this.s||(this.s=!0,this.N())},cn.prototype.N=function(){if(this.C)for(;this.C.length;)this.C.shift()()};function ze(a,h){this.type=a,this.g=this.target=h,this.defaultPrevented=!1}ze.prototype.h=function(){this.defaultPrevented=!0};var KI=function(){if(!l.addEventListener||!Object.defineProperty)return!1;var a=!1,h=Object.defineProperty({},"passive",{get:function(){a=!0}});try{let f=()=>{};l.addEventListener("test",f,h),l.removeEventListener("test",f,h)}catch{}return a}();function Qi(a,h){if(ze.call(this,a?a.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,a){var f=this.type=a.type,g=a.changedTouches&&a.changedTouches.length?a.changedTouches[0]:null;if(this.target=a.target||a.srcElement,this.g=h,h=a.relatedTarget){if(ne){e:{try{Y(h.nodeName);var S=!0;break e}catch{}S=!1}S||(h=null)}}else f=="mouseover"?h=a.fromElement:f=="mouseout"&&(h=a.toElement);this.relatedTarget=h,g?(this.clientX=g.clientX!==void 0?g.clientX:g.pageX,this.clientY=g.clientY!==void 0?g.clientY:g.pageY,this.screenX=g.screenX||0,this.screenY=g.screenY||0):(this.clientX=a.clientX!==void 0?a.clientX:a.pageX,this.clientY=a.clientY!==void 0?a.clientY:a.pageY,this.screenX=a.screenX||0,this.screenY=a.screenY||0),this.button=a.button,this.key=a.key||"",this.ctrlKey=a.ctrlKey,this.altKey=a.altKey,this.shiftKey=a.shiftKey,this.metaKey=a.metaKey,this.pointerId=a.pointerId||0,this.pointerType=typeof a.pointerType=="string"?a.pointerType:WI[a.pointerType]||"",this.state=a.state,this.i=a,a.defaultPrevented&&Qi.aa.h.call(this)}}C(Qi,ze);var WI={2:"touch",3:"pen",4:"mouse"};Qi.prototype.h=function(){Qi.aa.h.call(this);var a=this.i;a.preventDefault?a.preventDefault():a.returnValue=!1};var $i="closure_listenable_"+(1e6*Math.random()|0),QI=0;function $I(a,h,f,g,S){this.listener=a,this.proxy=null,this.src=h,this.type=f,this.capture=!!g,this.ha=S,this.key=++QI,this.da=this.fa=!1}function Fo(a){a.da=!0,a.listener=null,a.proxy=null,a.src=null,a.ha=null}function Lo(a){this.src=a,this.g={},this.h=0}Lo.prototype.add=function(a,h,f,g,S){var R=a.toString();a=this.g[R],a||(a=this.g[R]=[],this.h++);var O=$u(a,h,g,S);return-1<O?(h=a[O],f||(h.fa=!1)):(h=new $I(h,this.src,R,!!g,S),h.fa=f,a.push(h)),h};function Qu(a,h){var f=h.type;if(f in a.g){var g=a.g[f],S=Array.prototype.indexOf.call(g,h,void 0),R;(R=0<=S)&&Array.prototype.splice.call(g,S,1),R&&(Fo(h),a.g[f].length==0&&(delete a.g[f],a.h--))}}function $u(a,h,f,g){for(var S=0;S<a.length;++S){var R=a[S];if(!R.da&&R.listener==h&&R.capture==!!f&&R.ha==g)return S}return-1}var Hu="closure_lm_"+(1e6*Math.random()|0),Yu={};function Sm(a,h,f,g,S){if(g&&g.once)return Cm(a,h,f,g,S);if(Array.isArray(h)){for(var R=0;R<h.length;R++)Sm(a,h[R],f,g,S);return null}return f=ec(f),a&&a[$i]?a.K(h,f,c(g)?!!g.capture:!!g,S):Am(a,h,f,!1,g,S)}function Am(a,h,f,g,S,R){if(!h)throw Error("Invalid event type");var O=c(S)?!!S.capture:!!S,he=Xu(a);if(he||(a[Hu]=he=new Lo(a)),f=he.add(h,f,g,O,R),f.proxy)return f;if(g=HI(),f.proxy=g,g.src=a,g.listener=f,a.addEventListener)KI||(S=O),S===void 0&&(S=!1),a.addEventListener(h.toString(),g,S);else if(a.attachEvent)a.attachEvent(Rm(h.toString()),g);else if(a.addListener&&a.removeListener)a.addListener(g);else throw Error("addEventListener and attachEvent are unavailable.");return f}function HI(){function a(f){return h.call(a.src,a.listener,f)}let h=YI;return a}function Cm(a,h,f,g,S){if(Array.isArray(h)){for(var R=0;R<h.length;R++)Cm(a,h[R],f,g,S);return null}return f=ec(f),a&&a[$i]?a.L(h,f,c(g)?!!g.capture:!!g,S):Am(a,h,f,!0,g,S)}function bm(a,h,f,g,S){if(Array.isArray(h))for(var R=0;R<h.length;R++)bm(a,h[R],f,g,S);else g=c(g)?!!g.capture:!!g,f=ec(f),a&&a[$i]?(a=a.i,h=String(h).toString(),h in a.g&&(R=a.g[h],f=$u(R,f,g,S),-1<f&&(Fo(R[f]),Array.prototype.splice.call(R,f,1),R.length==0&&(delete a.g[h],a.h--)))):a&&(a=Xu(a))&&(h=a.g[h.toString()],a=-1,h&&(a=$u(h,f,g,S)),(f=-1<a?h[a]:null)&&Ju(f))}function Ju(a){if(typeof a!="number"&&a&&!a.da){var h=a.src;if(h&&h[$i])Qu(h.i,a);else{var f=a.type,g=a.proxy;h.removeEventListener?h.removeEventListener(f,g,a.capture):h.detachEvent?h.detachEvent(Rm(f),g):h.addListener&&h.removeListener&&h.removeListener(g),(f=Xu(h))?(Qu(f,a),f.h==0&&(f.src=null,h[Hu]=null)):Fo(a)}}}function Rm(a){return a in Yu?Yu[a]:Yu[a]="on"+a}function YI(a,h){if(a.da)a=!0;else{h=new Qi(h,this);var f=a.listener,g=a.ha||a.src;a.fa&&Ju(a),a=f.call(g,h)}return a}function Xu(a){return a=a[Hu],a instanceof Lo?a:null}var Zu="__closure_events_fn_"+(1e9*Math.random()>>>0);function ec(a){return typeof a=="function"?a:(a[Zu]||(a[Zu]=function(h){return a.handleEvent(h)}),a[Zu])}function Ke(){cn.call(this),this.i=new Lo(this),this.M=this,this.F=null}C(Ke,cn),Ke.prototype[$i]=!0,Ke.prototype.removeEventListener=function(a,h,f,g){bm(this,a,h,f,g)};function Je(a,h){var f,g=a.F;if(g)for(f=[];g;g=g.F)f.push(g);if(a=a.M,g=h.type||h,typeof h=="string")h=new ze(h,a);else if(h instanceof ze)h.target=h.target||a;else{var S=h;h=new ze(g,a),I(h,S)}if(S=!0,f)for(var R=f.length-1;0<=R;R--){var O=h.g=f[R];S=Uo(O,g,!0,h)&&S}if(O=h.g=a,S=Uo(O,g,!0,h)&&S,S=Uo(O,g,!1,h)&&S,f)for(R=0;R<f.length;R++)O=h.g=f[R],S=Uo(O,g,!1,h)&&S}Ke.prototype.N=function(){if(Ke.aa.N.call(this),this.i){var a=this.i,h;for(h in a.g){for(var f=a.g[h],g=0;g<f.length;g++)Fo(f[g]);delete a.g[h],a.h--}}this.F=null},Ke.prototype.K=function(a,h,f,g){return this.i.add(String(a),h,!1,f,g)},Ke.prototype.L=function(a,h,f,g){return this.i.add(String(a),h,!0,f,g)};function Uo(a,h,f,g){if(h=a.i.g[String(h)],!h)return!0;h=h.concat();for(var S=!0,R=0;R<h.length;++R){var O=h[R];if(O&&!O.da&&O.capture==f){var he=O.listener,Ge=O.ha||O.src;O.fa&&Qu(a.i,O),S=he.call(Ge,g)!==!1&&S}}return S&&!g.defaultPrevented}function Pm(a,h,f){if(typeof a=="function")f&&(a=m(a,f));else if(a&&typeof a.handleEvent=="function")a=m(a.handleEvent,a);else throw Error("Invalid listener argument");return 2147483647<Number(h)?-1:l.setTimeout(a,h||0)}function xm(a){a.g=Pm(()=>{a.g=null,a.i&&(a.i=!1,xm(a))},a.l);let h=a.h;a.h=null,a.m.apply(null,h)}class JI extends cn{constructor(h,f){super(),this.m=h,this.l=f,this.h=null,this.i=!1,this.g=null}j(h){this.h=arguments,this.g?this.i=!0:xm(this)}N(){super.N(),this.g&&(l.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function Hi(a){cn.call(this),this.h=a,this.g={}}C(Hi,cn);var Nm=[];function Dm(a){W(a.g,function(h,f){this.g.hasOwnProperty(f)&&Ju(h)},a),a.g={}}Hi.prototype.N=function(){Hi.aa.N.call(this),Dm(this)},Hi.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var tc=l.JSON.stringify,XI=l.JSON.parse,ZI=class{stringify(a){return l.JSON.stringify(a,void 0)}parse(a){return l.JSON.parse(a,void 0)}};function nc(){}nc.prototype.h=null;function km(a){return a.h||(a.h=a.i())}function Vm(){}var Yi={OPEN:"a",kb:"b",Ja:"c",wb:"d"};function rc(){ze.call(this,"d")}C(rc,ze);function ic(){ze.call(this,"c")}C(ic,ze);var Wn={},Mm=null;function qo(){return Mm=Mm||new Ke}Wn.La="serverreachability";function Om(a){ze.call(this,Wn.La,a)}C(Om,ze);function Ji(a){let h=qo();Je(h,new Om(h))}Wn.STAT_EVENT="statevent";function Fm(a,h){ze.call(this,Wn.STAT_EVENT,a),this.stat=h}C(Fm,ze);function Xe(a){let h=qo();Je(h,new Fm(h,a))}Wn.Ma="timingevent";function Lm(a,h){ze.call(this,Wn.Ma,a),this.size=h}C(Lm,ze);function Xi(a,h){if(typeof a!="function")throw Error("Fn must not be null and must be a function");return l.setTimeout(function(){a()},h)}function Zi(){this.g=!0}Zi.prototype.xa=function(){this.g=!1};function eT(a,h,f,g,S,R){a.info(function(){if(a.g)if(R)for(var O="",he=R.split("&"),Ge=0;Ge<he.length;Ge++){var ae=he[Ge].split("=");if(1<ae.length){var We=ae[0];ae=ae[1];var Qe=We.split("_");O=2<=Qe.length&&Qe[1]=="type"?O+(We+"="+ae+"&"):O+(We+"=redacted&")}}else O=null;else O=R;return"XMLHTTP REQ ("+g+") [attempt "+S+"]: "+h+`
`+f+`
`+O})}function tT(a,h,f,g,S,R,O){a.info(function(){return"XMLHTTP RESP ("+g+") [ attempt "+S+"]: "+h+`
`+f+`
`+R+" "+O})}function Dr(a,h,f,g){a.info(function(){return"XMLHTTP TEXT ("+h+"): "+rT(a,f)+(g?" "+g:"")})}function nT(a,h){a.info(function(){return"TIMEOUT: "+h})}Zi.prototype.info=function(){};function rT(a,h){if(!a.g)return h;if(!h)return null;try{var f=JSON.parse(h);if(f){for(a=0;a<f.length;a++)if(Array.isArray(f[a])){var g=f[a];if(!(2>g.length)){var S=g[1];if(Array.isArray(S)&&!(1>S.length)){var R=S[0];if(R!="noop"&&R!="stop"&&R!="close")for(var O=1;O<S.length;O++)S[O]=""}}}}return tc(f)}catch{return h}}var Bo={NO_ERROR:0,gb:1,tb:2,sb:3,nb:4,rb:5,ub:6,Ia:7,TIMEOUT:8,xb:9},Um={lb:"complete",Hb:"success",Ja:"error",Ia:"abort",zb:"ready",Ab:"readystatechange",TIMEOUT:"timeout",vb:"incrementaldata",yb:"progress",ob:"downloadprogress",Pb:"uploadprogress"},sc;function Go(){}C(Go,nc),Go.prototype.g=function(){return new XMLHttpRequest},Go.prototype.i=function(){return{}},sc=new Go;function hn(a,h,f,g){this.j=a,this.i=h,this.l=f,this.R=g||1,this.U=new Hi(this),this.I=45e3,this.H=null,this.o=!1,this.m=this.A=this.v=this.L=this.F=this.S=this.B=null,this.D=[],this.g=null,this.C=0,this.s=this.u=null,this.X=-1,this.J=!1,this.O=0,this.M=null,this.W=this.K=this.T=this.P=!1,this.h=new qm}function qm(){this.i=null,this.g="",this.h=!1}var Bm={},oc={};function ac(a,h,f){a.L=1,a.v=Wo(Ht(h)),a.m=f,a.P=!0,Gm(a,null)}function Gm(a,h){a.F=Date.now(),jo(a),a.A=Ht(a.v);var f=a.A,g=a.R;Array.isArray(g)||(g=[String(g)]),ng(f.i,"t",g),a.C=0,f=a.j.J,a.h=new qm,a.g=wg(a.j,f?h:null,!a.m),0<a.O&&(a.M=new JI(m(a.Y,a,a.g),a.O)),h=a.U,f=a.g,g=a.ca;var S="readystatechange";Array.isArray(S)||(S&&(Nm[0]=S.toString()),S=Nm);for(var R=0;R<S.length;R++){var O=Sm(f,S[R],g||h.handleEvent,!1,h.h||h);if(!O)break;h.g[O.key]=O}h=a.H?_(a.H):{},a.m?(a.u||(a.u="POST"),h["Content-Type"]="application/x-www-form-urlencoded",a.g.ea(a.A,a.u,a.m,h)):(a.u="GET",a.g.ea(a.A,a.u,null,h)),Ji(),eT(a.i,a.u,a.A,a.l,a.R,a.m)}hn.prototype.ca=function(a){a=a.target;let h=this.M;h&&Yt(a)==3?h.j():this.Y(a)},hn.prototype.Y=function(a){try{if(a==this.g)e:{let Qe=Yt(this.g);var h=this.g.Ba();let Mr=this.g.Z();if(!(3>Qe)&&(Qe!=3||this.g&&(this.h.h||this.g.oa()||ug(this.g)))){this.J||Qe!=4||h==7||(h==8||0>=Mr?Ji(3):Ji(2)),lc(this);var f=this.g.Z();this.X=f;t:if(jm(this)){var g=ug(this.g);a="";var S=g.length,R=Yt(this.g)==4;if(!this.h.i){if(typeof TextDecoder>"u"){Qn(this),es(this);var O="";break t}this.h.i=new l.TextDecoder}for(h=0;h<S;h++)this.h.h=!0,a+=this.h.i.decode(g[h],{stream:!(R&&h==S-1)});g.length=0,this.h.g+=a,this.C=0,O=this.h.g}else O=this.g.oa();if(this.o=f==200,tT(this.i,this.u,this.A,this.l,this.R,Qe,f),this.o){if(this.T&&!this.K){t:{if(this.g){var he,Ge=this.g;if((he=Ge.g?Ge.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!j(he)){var ae=he;break t}}ae=null}if(f=ae)Dr(this.i,this.l,f,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,uc(this,f);else{this.o=!1,this.s=3,Xe(12),Qn(this),es(this);break e}}if(this.P){f=!0;let St;for(;!this.J&&this.C<O.length;)if(St=iT(this,O),St==oc){Qe==4&&(this.s=4,Xe(14),f=!1),Dr(this.i,this.l,null,"[Incomplete Response]");break}else if(St==Bm){this.s=4,Xe(15),Dr(this.i,this.l,O,"[Invalid Chunk]"),f=!1;break}else Dr(this.i,this.l,St,null),uc(this,St);if(jm(this)&&this.C!=0&&(this.h.g=this.h.g.slice(this.C),this.C=0),Qe!=4||O.length!=0||this.h.h||(this.s=1,Xe(16),f=!1),this.o=this.o&&f,!f)Dr(this.i,this.l,O,"[Invalid Chunked Response]"),Qn(this),es(this);else if(0<O.length&&!this.W){this.W=!0;var We=this.j;We.g==this&&We.ba&&!We.M&&(We.j.info("Great, no buffering proxy detected. Bytes received: "+O.length),mc(We),We.M=!0,Xe(11))}}else Dr(this.i,this.l,O,null),uc(this,O);Qe==4&&Qn(this),this.o&&!this.J&&(Qe==4?gg(this.j,this):(this.o=!1,jo(this)))}else ET(this.g),f==400&&0<O.indexOf("Unknown SID")?(this.s=3,Xe(12)):(this.s=0,Xe(13)),Qn(this),es(this)}}}catch{}finally{}};function jm(a){return a.g?a.u=="GET"&&a.L!=2&&a.j.Ca:!1}function iT(a,h){var f=a.C,g=h.indexOf(`
`,f);return g==-1?oc:(f=Number(h.substring(f,g)),isNaN(f)?Bm:(g+=1,g+f>h.length?oc:(h=h.slice(g,g+f),a.C=g+f,h)))}hn.prototype.cancel=function(){this.J=!0,Qn(this)};function jo(a){a.S=Date.now()+a.I,zm(a,a.I)}function zm(a,h){if(a.B!=null)throw Error("WatchDog timer not null");a.B=Xi(m(a.ba,a),h)}function lc(a){a.B&&(l.clearTimeout(a.B),a.B=null)}hn.prototype.ba=function(){this.B=null;let a=Date.now();0<=a-this.S?(nT(this.i,this.A),this.L!=2&&(Ji(),Xe(17)),Qn(this),this.s=2,es(this)):zm(this,this.S-a)};function es(a){a.j.G==0||a.J||gg(a.j,a)}function Qn(a){lc(a);var h=a.M;h&&typeof h.ma=="function"&&h.ma(),a.M=null,Dm(a.U),a.g&&(h=a.g,a.g=null,h.abort(),h.ma())}function uc(a,h){try{var f=a.j;if(f.G!=0&&(f.g==a||cc(f.h,a))){if(!a.K&&cc(f.h,a)&&f.G==3){try{var g=f.Da.g.parse(h)}catch{g=null}if(Array.isArray(g)&&g.length==3){var S=g;if(S[0]==0){e:if(!f.u){if(f.g)if(f.g.F+3e3<a.F)Jo(f),Ho(f);else break e;pc(f),Xe(18)}}else f.za=S[1],0<f.za-f.T&&37500>S[2]&&f.F&&f.v==0&&!f.C&&(f.C=Xi(m(f.Za,f),6e3));if(1>=Qm(f.h)&&f.ca){try{f.ca()}catch{}f.ca=void 0}}else Hn(f,11)}else if((a.K||f.g==a)&&Jo(f),!j(h))for(S=f.Da.g.parse(h),h=0;h<S.length;h++){let ae=S[h];if(f.T=ae[0],ae=ae[1],f.G==2)if(ae[0]=="c"){f.K=ae[1],f.ia=ae[2];let We=ae[3];We!=null&&(f.la=We,f.j.info("VER="+f.la));let Qe=ae[4];Qe!=null&&(f.Aa=Qe,f.j.info("SVER="+f.Aa));let Mr=ae[5];Mr!=null&&typeof Mr=="number"&&0<Mr&&(g=1.5*Mr,f.L=g,f.j.info("backChannelRequestTimeoutMs_="+g)),g=f;let St=a.g;if(St){let Zo=St.g?St.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(Zo){var R=g.h;R.g||Zo.indexOf("spdy")==-1&&Zo.indexOf("quic")==-1&&Zo.indexOf("h2")==-1||(R.j=R.l,R.g=new Set,R.h&&(hc(R,R.h),R.h=null))}if(g.D){let gc=St.g?St.g.getResponseHeader("X-HTTP-Session-Id"):null;gc&&(g.ya=gc,ge(g.I,g.D,gc))}}f.G=3,f.l&&f.l.ua(),f.ba&&(f.R=Date.now()-a.F,f.j.info("Handshake RTT: "+f.R+"ms")),g=f;var O=a;if(g.qa=vg(g,g.J?g.ia:null,g.W),O.K){$m(g.h,O);var he=O,Ge=g.L;Ge&&(he.I=Ge),he.B&&(lc(he),jo(he)),g.g=O}else pg(g);0<f.i.length&&Yo(f)}else ae[0]!="stop"&&ae[0]!="close"||Hn(f,7);else f.G==3&&(ae[0]=="stop"||ae[0]=="close"?ae[0]=="stop"?Hn(f,7):fc(f):ae[0]!="noop"&&f.l&&f.l.ta(ae),f.v=0)}}Ji(4)}catch{}}var sT=class{constructor(a,h){this.g=a,this.map=h}};function Km(a){this.l=a||10,l.PerformanceNavigationTiming?(a=l.performance.getEntriesByType("navigation"),a=0<a.length&&(a[0].nextHopProtocol=="hq"||a[0].nextHopProtocol=="h2")):a=!!(l.chrome&&l.chrome.loadTimes&&l.chrome.loadTimes()&&l.chrome.loadTimes().wasFetchedViaSpdy),this.j=a?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function Wm(a){return a.h?!0:a.g?a.g.size>=a.j:!1}function Qm(a){return a.h?1:a.g?a.g.size:0}function cc(a,h){return a.h?a.h==h:a.g?a.g.has(h):!1}function hc(a,h){a.g?a.g.add(h):a.h=h}function $m(a,h){a.h&&a.h==h?a.h=null:a.g&&a.g.has(h)&&a.g.delete(h)}Km.prototype.cancel=function(){if(this.i=Hm(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&this.g.size!==0){for(let a of this.g.values())a.cancel();this.g.clear()}};function Hm(a){if(a.h!=null)return a.i.concat(a.h.D);if(a.g!=null&&a.g.size!==0){let h=a.i;for(let f of a.g.values())h=h.concat(f.D);return h}return N(a.i)}function oT(a){if(a.V&&typeof a.V=="function")return a.V();if(typeof Map<"u"&&a instanceof Map||typeof Set<"u"&&a instanceof Set)return Array.from(a.values());if(typeof a=="string")return a.split("");if(u(a)){for(var h=[],f=a.length,g=0;g<f;g++)h.push(a[g]);return h}h=[],f=0;for(g in a)h[f++]=a[g];return h}function aT(a){if(a.na&&typeof a.na=="function")return a.na();if(!a.V||typeof a.V!="function"){if(typeof Map<"u"&&a instanceof Map)return Array.from(a.keys());if(!(typeof Set<"u"&&a instanceof Set)){if(u(a)||typeof a=="string"){var h=[];a=a.length;for(var f=0;f<a;f++)h.push(f);return h}h=[],f=0;for(let g in a)h[f++]=g;return h}}}function Ym(a,h){if(a.forEach&&typeof a.forEach=="function")a.forEach(h,void 0);else if(u(a)||typeof a=="string")Array.prototype.forEach.call(a,h,void 0);else for(var f=aT(a),g=oT(a),S=g.length,R=0;R<S;R++)h.call(void 0,g[R],f&&f[R],a)}var Jm=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function lT(a,h){if(a){a=a.split("&");for(var f=0;f<a.length;f++){var g=a[f].indexOf("="),S=null;if(0<=g){var R=a[f].substring(0,g);S=a[f].substring(g+1)}else R=a[f];h(R,S?decodeURIComponent(S.replace(/\+/g," ")):"")}}}function $n(a){if(this.g=this.o=this.j="",this.s=null,this.m=this.l="",this.h=!1,a instanceof $n){this.h=a.h,zo(this,a.j),this.o=a.o,this.g=a.g,Ko(this,a.s),this.l=a.l;var h=a.i,f=new rs;f.i=h.i,h.g&&(f.g=new Map(h.g),f.h=h.h),Xm(this,f),this.m=a.m}else a&&(h=String(a).match(Jm))?(this.h=!1,zo(this,h[1]||"",!0),this.o=ts(h[2]||""),this.g=ts(h[3]||"",!0),Ko(this,h[4]),this.l=ts(h[5]||"",!0),Xm(this,h[6]||"",!0),this.m=ts(h[7]||"")):(this.h=!1,this.i=new rs(null,this.h))}$n.prototype.toString=function(){var a=[],h=this.j;h&&a.push(ns(h,Zm,!0),":");var f=this.g;return(f||h=="file")&&(a.push("//"),(h=this.o)&&a.push(ns(h,Zm,!0),"@"),a.push(encodeURIComponent(String(f)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),f=this.s,f!=null&&a.push(":",String(f))),(f=this.l)&&(this.g&&f.charAt(0)!="/"&&a.push("/"),a.push(ns(f,f.charAt(0)=="/"?hT:cT,!0))),(f=this.i.toString())&&a.push("?",f),(f=this.m)&&a.push("#",ns(f,fT)),a.join("")};function Ht(a){return new $n(a)}function zo(a,h,f){a.j=f?ts(h,!0):h,a.j&&(a.j=a.j.replace(/:$/,""))}function Ko(a,h){if(h){if(h=Number(h),isNaN(h)||0>h)throw Error("Bad port number "+h);a.s=h}else a.s=null}function Xm(a,h,f){h instanceof rs?(a.i=h,pT(a.i,a.h)):(f||(h=ns(h,dT)),a.i=new rs(h,a.h))}function ge(a,h,f){a.i.set(h,f)}function Wo(a){return ge(a,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),a}function ts(a,h){return a?h?decodeURI(a.replace(/%25/g,"%2525")):decodeURIComponent(a):""}function ns(a,h,f){return typeof a=="string"?(a=encodeURI(a).replace(h,uT),f&&(a=a.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),a):null}function uT(a){return a=a.charCodeAt(0),"%"+(a>>4&15).toString(16)+(a&15).toString(16)}var Zm=/[#\/\?@]/g,cT=/[#\?:]/g,hT=/[#\?]/g,dT=/[#\?@]/g,fT=/#/g;function rs(a,h){this.h=this.g=null,this.i=a||null,this.j=!!h}function dn(a){a.g||(a.g=new Map,a.h=0,a.i&&lT(a.i,function(h,f){a.add(decodeURIComponent(h.replace(/\+/g," ")),f)}))}n=rs.prototype,n.add=function(a,h){dn(this),this.i=null,a=kr(this,a);var f=this.g.get(a);return f||this.g.set(a,f=[]),f.push(h),this.h+=1,this};function eg(a,h){dn(a),h=kr(a,h),a.g.has(h)&&(a.i=null,a.h-=a.g.get(h).length,a.g.delete(h))}function tg(a,h){return dn(a),h=kr(a,h),a.g.has(h)}n.forEach=function(a,h){dn(this),this.g.forEach(function(f,g){f.forEach(function(S){a.call(h,S,g,this)},this)},this)},n.na=function(){dn(this);let a=Array.from(this.g.values()),h=Array.from(this.g.keys()),f=[];for(let g=0;g<h.length;g++){let S=a[g];for(let R=0;R<S.length;R++)f.push(h[g])}return f},n.V=function(a){dn(this);let h=[];if(typeof a=="string")tg(this,a)&&(h=h.concat(this.g.get(kr(this,a))));else{a=Array.from(this.g.values());for(let f=0;f<a.length;f++)h=h.concat(a[f])}return h},n.set=function(a,h){return dn(this),this.i=null,a=kr(this,a),tg(this,a)&&(this.h-=this.g.get(a).length),this.g.set(a,[h]),this.h+=1,this},n.get=function(a,h){return a?(a=this.V(a),0<a.length?String(a[0]):h):h};function ng(a,h,f){eg(a,h),0<f.length&&(a.i=null,a.g.set(kr(a,h),N(f)),a.h+=f.length)}n.toString=function(){if(this.i)return this.i;if(!this.g)return"";let a=[],h=Array.from(this.g.keys());for(var f=0;f<h.length;f++){var g=h[f];let R=encodeURIComponent(String(g)),O=this.V(g);for(g=0;g<O.length;g++){var S=R;O[g]!==""&&(S+="="+encodeURIComponent(String(O[g]))),a.push(S)}}return this.i=a.join("&")};function kr(a,h){return h=String(h),a.j&&(h=h.toLowerCase()),h}function pT(a,h){h&&!a.j&&(dn(a),a.i=null,a.g.forEach(function(f,g){var S=g.toLowerCase();g!=S&&(eg(this,g),ng(this,S,f))},a)),a.j=h}function mT(a,h){let f=new Zi;if(l.Image){let g=new Image;g.onload=v(fn,f,"TestLoadImage: loaded",!0,h,g),g.onerror=v(fn,f,"TestLoadImage: error",!1,h,g),g.onabort=v(fn,f,"TestLoadImage: abort",!1,h,g),g.ontimeout=v(fn,f,"TestLoadImage: timeout",!1,h,g),l.setTimeout(function(){g.ontimeout&&g.ontimeout()},1e4),g.src=a}else h(!1)}function gT(a,h){let f=new Zi,g=new AbortController,S=setTimeout(()=>{g.abort(),fn(f,"TestPingServer: timeout",!1,h)},1e4);fetch(a,{signal:g.signal}).then(R=>{clearTimeout(S),R.ok?fn(f,"TestPingServer: ok",!0,h):fn(f,"TestPingServer: server error",!1,h)}).catch(()=>{clearTimeout(S),fn(f,"TestPingServer: error",!1,h)})}function fn(a,h,f,g,S){try{S&&(S.onload=null,S.onerror=null,S.onabort=null,S.ontimeout=null),g(f)}catch{}}function _T(){this.g=new ZI}function yT(a,h,f){let g=f||"";try{Ym(a,function(S,R){let O=S;c(S)&&(O=tc(S)),h.push(g+R+"="+encodeURIComponent(O))})}catch(S){throw h.push(g+"type="+encodeURIComponent("_badmap")),S}}function is(a){this.l=a.Ub||null,this.j=a.eb||!1}C(is,nc),is.prototype.g=function(){return new Qo(this.l,this.j)},is.prototype.i=function(a){return function(){return a}}({});function Qo(a,h){Ke.call(this),this.D=a,this.o=h,this.m=void 0,this.status=this.readyState=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.u=new Headers,this.h=null,this.B="GET",this.A="",this.g=!1,this.v=this.j=this.l=null}C(Qo,Ke),n=Qo.prototype,n.open=function(a,h){if(this.readyState!=0)throw this.abort(),Error("Error reopening a connection");this.B=a,this.A=h,this.readyState=1,os(this)},n.send=function(a){if(this.readyState!=1)throw this.abort(),Error("need to call open() first. ");this.g=!0;let h={headers:this.u,method:this.B,credentials:this.m,cache:void 0};a&&(h.body=a),(this.D||l).fetch(new Request(this.A,h)).then(this.Sa.bind(this),this.ga.bind(this))},n.abort=function(){this.response=this.responseText="",this.u=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&this.readyState!=4&&(this.g=!1,ss(this)),this.readyState=0},n.Sa=function(a){if(this.g&&(this.l=a,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=a.headers,this.readyState=2,os(this)),this.g&&(this.readyState=3,os(this),this.g)))if(this.responseType==="arraybuffer")a.arrayBuffer().then(this.Qa.bind(this),this.ga.bind(this));else if(typeof l.ReadableStream<"u"&&"body"in a){if(this.j=a.body.getReader(),this.o){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.v=new TextDecoder;rg(this)}else a.text().then(this.Ra.bind(this),this.ga.bind(this))};function rg(a){a.j.read().then(a.Pa.bind(a)).catch(a.ga.bind(a))}n.Pa=function(a){if(this.g){if(this.o&&a.value)this.response.push(a.value);else if(!this.o){var h=a.value?a.value:new Uint8Array(0);(h=this.v.decode(h,{stream:!a.done}))&&(this.response=this.responseText+=h)}a.done?ss(this):os(this),this.readyState==3&&rg(this)}},n.Ra=function(a){this.g&&(this.response=this.responseText=a,ss(this))},n.Qa=function(a){this.g&&(this.response=a,ss(this))},n.ga=function(){this.g&&ss(this)};function ss(a){a.readyState=4,a.l=null,a.j=null,a.v=null,os(a)}n.setRequestHeader=function(a,h){this.u.append(a,h)},n.getResponseHeader=function(a){return this.h&&this.h.get(a.toLowerCase())||""},n.getAllResponseHeaders=function(){if(!this.h)return"";let a=[],h=this.h.entries();for(var f=h.next();!f.done;)f=f.value,a.push(f[0]+": "+f[1]),f=h.next();return a.join(`\r
`)};function os(a){a.onreadystatechange&&a.onreadystatechange.call(a)}Object.defineProperty(Qo.prototype,"withCredentials",{get:function(){return this.m==="include"},set:function(a){this.m=a?"include":"same-origin"}});function ig(a){let h="";return W(a,function(f,g){h+=g,h+=":",h+=f,h+=`\r
`}),h}function dc(a,h,f){e:{for(g in f){var g=!1;break e}g=!0}g||(f=ig(f),typeof a=="string"?f!=null&&encodeURIComponent(String(f)):ge(a,h,f))}function Ie(a){Ke.call(this),this.headers=new Map,this.o=a||null,this.h=!1,this.v=this.g=null,this.D="",this.m=0,this.l="",this.j=this.B=this.u=this.A=!1,this.I=null,this.H="",this.J=!1}C(Ie,Ke);var vT=/^https?$/i,wT=["POST","PUT"];n=Ie.prototype,n.Ha=function(a){this.J=a},n.ea=function(a,h,f,g){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.D+"; newUri="+a);h=h?h.toUpperCase():"GET",this.D=a,this.l="",this.m=0,this.A=!1,this.h=!0,this.g=this.o?this.o.g():sc.g(),this.v=this.o?km(this.o):km(sc),this.g.onreadystatechange=m(this.Ea,this);try{this.B=!0,this.g.open(h,String(a),!0),this.B=!1}catch(R){sg(this,R);return}if(a=f||"",f=new Map(this.headers),g)if(Object.getPrototypeOf(g)===Object.prototype)for(var S in g)f.set(S,g[S]);else if(typeof g.keys=="function"&&typeof g.get=="function")for(let R of g.keys())f.set(R,g.get(R));else throw Error("Unknown input type for opt_headers: "+String(g));g=Array.from(f.keys()).find(R=>R.toLowerCase()=="content-type"),S=l.FormData&&a instanceof l.FormData,!(0<=Array.prototype.indexOf.call(wT,h,void 0))||g||S||f.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(let[R,O]of f)this.g.setRequestHeader(R,O);this.H&&(this.g.responseType=this.H),"withCredentials"in this.g&&this.g.withCredentials!==this.J&&(this.g.withCredentials=this.J);try{lg(this),this.u=!0,this.g.send(a),this.u=!1}catch(R){sg(this,R)}};function sg(a,h){a.h=!1,a.g&&(a.j=!0,a.g.abort(),a.j=!1),a.l=h,a.m=5,og(a),$o(a)}function og(a){a.A||(a.A=!0,Je(a,"complete"),Je(a,"error"))}n.abort=function(a){this.g&&this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1,this.m=a||7,Je(this,"complete"),Je(this,"abort"),$o(this))},n.N=function(){this.g&&(this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1),$o(this,!0)),Ie.aa.N.call(this)},n.Ea=function(){this.s||(this.B||this.u||this.j?ag(this):this.bb())},n.bb=function(){ag(this)};function ag(a){if(a.h&&typeof o<"u"&&(!a.v[1]||Yt(a)!=4||a.Z()!=2)){if(a.u&&Yt(a)==4)Pm(a.Ea,0,a);else if(Je(a,"readystatechange"),Yt(a)==4){a.h=!1;try{let O=a.Z();e:switch(O){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var h=!0;break e;default:h=!1}var f;if(!(f=h)){var g;if(g=O===0){var S=String(a.D).match(Jm)[1]||null;!S&&l.self&&l.self.location&&(S=l.self.location.protocol.slice(0,-1)),g=!vT.test(S?S.toLowerCase():"")}f=g}if(f)Je(a,"complete"),Je(a,"success");else{a.m=6;try{var R=2<Yt(a)?a.g.statusText:""}catch{R=""}a.l=R+" ["+a.Z()+"]",og(a)}}finally{$o(a)}}}}function $o(a,h){if(a.g){lg(a);let f=a.g,g=a.v[0]?()=>{}:null;a.g=null,a.v=null,h||Je(a,"ready");try{f.onreadystatechange=g}catch{}}}function lg(a){a.I&&(l.clearTimeout(a.I),a.I=null)}n.isActive=function(){return!!this.g};function Yt(a){return a.g?a.g.readyState:0}n.Z=function(){try{return 2<Yt(this)?this.g.status:-1}catch{return-1}},n.oa=function(){try{return this.g?this.g.responseText:""}catch{return""}},n.Oa=function(a){if(this.g){var h=this.g.responseText;return a&&h.indexOf(a)==0&&(h=h.substring(a.length)),XI(h)}};function ug(a){try{if(!a.g)return null;if("response"in a.g)return a.g.response;switch(a.H){case"":case"text":return a.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in a.g)return a.g.mozResponseArrayBuffer}return null}catch{return null}}function ET(a){let h={};a=(a.g&&2<=Yt(a)&&a.g.getAllResponseHeaders()||"").split(`\r
`);for(let g=0;g<a.length;g++){if(j(a[g]))continue;var f=T(a[g]);let S=f[0];if(f=f[1],typeof f!="string")continue;f=f.trim();let R=h[S]||[];h[S]=R,R.push(f)}E(h,function(g){return g.join(", ")})}n.Ba=function(){return this.m},n.Ka=function(){return typeof this.l=="string"?this.l:String(this.l)};function as(a,h,f){return f&&f.internalChannelParams&&f.internalChannelParams[a]||h}function cg(a){this.Aa=0,this.i=[],this.j=new Zi,this.ia=this.qa=this.I=this.W=this.g=this.ya=this.D=this.H=this.m=this.S=this.o=null,this.Ya=this.U=0,this.Va=as("failFast",!1,a),this.F=this.C=this.u=this.s=this.l=null,this.X=!0,this.za=this.T=-1,this.Y=this.v=this.B=0,this.Ta=as("baseRetryDelayMs",5e3,a),this.cb=as("retryDelaySeedMs",1e4,a),this.Wa=as("forwardChannelMaxRetries",2,a),this.wa=as("forwardChannelRequestTimeoutMs",2e4,a),this.pa=a&&a.xmlHttpFactory||void 0,this.Xa=a&&a.Tb||void 0,this.Ca=a&&a.useFetchStreams||!1,this.L=void 0,this.J=a&&a.supportsCrossDomainXhr||!1,this.K="",this.h=new Km(a&&a.concurrentRequestLimit),this.Da=new _T,this.P=a&&a.fastHandshake||!1,this.O=a&&a.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.Ua=a&&a.Rb||!1,a&&a.xa&&this.j.xa(),a&&a.forceLongPolling&&(this.X=!1),this.ba=!this.P&&this.X&&a&&a.detectBufferingProxy||!1,this.ja=void 0,a&&a.longPollingTimeout&&0<a.longPollingTimeout&&(this.ja=a.longPollingTimeout),this.ca=void 0,this.R=0,this.M=!1,this.ka=this.A=null}n=cg.prototype,n.la=8,n.G=1,n.connect=function(a,h,f,g){Xe(0),this.W=a,this.H=h||{},f&&g!==void 0&&(this.H.OSID=f,this.H.OAID=g),this.F=this.X,this.I=vg(this,null,this.W),Yo(this)};function fc(a){if(hg(a),a.G==3){var h=a.U++,f=Ht(a.I);if(ge(f,"SID",a.K),ge(f,"RID",h),ge(f,"TYPE","terminate"),ls(a,f),h=new hn(a,a.j,h),h.L=2,h.v=Wo(Ht(f)),f=!1,l.navigator&&l.navigator.sendBeacon)try{f=l.navigator.sendBeacon(h.v.toString(),"")}catch{}!f&&l.Image&&(new Image().src=h.v,f=!0),f||(h.g=wg(h.j,null),h.g.ea(h.v)),h.F=Date.now(),jo(h)}yg(a)}function Ho(a){a.g&&(mc(a),a.g.cancel(),a.g=null)}function hg(a){Ho(a),a.u&&(l.clearTimeout(a.u),a.u=null),Jo(a),a.h.cancel(),a.s&&(typeof a.s=="number"&&l.clearTimeout(a.s),a.s=null)}function Yo(a){if(!Wm(a.h)&&!a.s){a.s=!0;var h=a.Ga;Ki||Tm(),Wi||(Ki(),Wi=!0),Wu.add(h,a),a.B=0}}function IT(a,h){return Qm(a.h)>=a.h.j-(a.s?1:0)?!1:a.s?(a.i=h.D.concat(a.i),!0):a.G==1||a.G==2||a.B>=(a.Va?0:a.Wa)?!1:(a.s=Xi(m(a.Ga,a,h),_g(a,a.B)),a.B++,!0)}n.Ga=function(a){if(this.s)if(this.s=null,this.G==1){if(!a){this.U=Math.floor(1e5*Math.random()),a=this.U++;let S=new hn(this,this.j,a),R=this.o;if(this.S&&(R?(R=_(R),I(R,this.S)):R=this.S),this.m!==null||this.O||(S.H=R,R=null),this.P)e:{for(var h=0,f=0;f<this.i.length;f++){t:{var g=this.i[f];if("__data__"in g.map&&(g=g.map.__data__,typeof g=="string")){g=g.length;break t}g=void 0}if(g===void 0)break;if(h+=g,4096<h){h=f;break e}if(h===4096||f===this.i.length-1){h=f+1;break e}}h=1e3}else h=1e3;h=fg(this,S,h),f=Ht(this.I),ge(f,"RID",a),ge(f,"CVER",22),this.D&&ge(f,"X-HTTP-Session-Id",this.D),ls(this,f),R&&(this.O?h="headers="+encodeURIComponent(String(ig(R)))+"&"+h:this.m&&dc(f,this.m,R)),hc(this.h,S),this.Ua&&ge(f,"TYPE","init"),this.P?(ge(f,"$req",h),ge(f,"SID","null"),S.T=!0,ac(S,f,null)):ac(S,f,h),this.G=2}}else this.G==3&&(a?dg(this,a):this.i.length==0||Wm(this.h)||dg(this))};function dg(a,h){var f;h?f=h.l:f=a.U++;let g=Ht(a.I);ge(g,"SID",a.K),ge(g,"RID",f),ge(g,"AID",a.T),ls(a,g),a.m&&a.o&&dc(g,a.m,a.o),f=new hn(a,a.j,f,a.B+1),a.m===null&&(f.H=a.o),h&&(a.i=h.D.concat(a.i)),h=fg(a,f,1e3),f.I=Math.round(.5*a.wa)+Math.round(.5*a.wa*Math.random()),hc(a.h,f),ac(f,g,h)}function ls(a,h){a.H&&W(a.H,function(f,g){ge(h,g,f)}),a.l&&Ym({},function(f,g){ge(h,g,f)})}function fg(a,h,f){f=Math.min(a.i.length,f);var g=a.l?m(a.l.Na,a.l,a):null;e:{var S=a.i;let R=-1;for(;;){let O=["count="+f];R==-1?0<f?(R=S[0].g,O.push("ofs="+R)):R=0:O.push("ofs="+R);let he=!0;for(let Ge=0;Ge<f;Ge++){let ae=S[Ge].g,We=S[Ge].map;if(ae-=R,0>ae)R=Math.max(0,S[Ge].g-100),he=!1;else try{yT(We,O,"req"+ae+"_")}catch{g&&g(We)}}if(he){g=O.join("&");break e}}}return a=a.i.splice(0,f),h.D=a,g}function pg(a){if(!a.g&&!a.u){a.Y=1;var h=a.Fa;Ki||Tm(),Wi||(Ki(),Wi=!0),Wu.add(h,a),a.v=0}}function pc(a){return a.g||a.u||3<=a.v?!1:(a.Y++,a.u=Xi(m(a.Fa,a),_g(a,a.v)),a.v++,!0)}n.Fa=function(){if(this.u=null,mg(this),this.ba&&!(this.M||this.g==null||0>=this.R)){var a=2*this.R;this.j.info("BP detection timer enabled: "+a),this.A=Xi(m(this.ab,this),a)}},n.ab=function(){this.A&&(this.A=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.F=!1,this.M=!0,Xe(10),Ho(this),mg(this))};function mc(a){a.A!=null&&(l.clearTimeout(a.A),a.A=null)}function mg(a){a.g=new hn(a,a.j,"rpc",a.Y),a.m===null&&(a.g.H=a.o),a.g.O=0;var h=Ht(a.qa);ge(h,"RID","rpc"),ge(h,"SID",a.K),ge(h,"AID",a.T),ge(h,"CI",a.F?"0":"1"),!a.F&&a.ja&&ge(h,"TO",a.ja),ge(h,"TYPE","xmlhttp"),ls(a,h),a.m&&a.o&&dc(h,a.m,a.o),a.L&&(a.g.I=a.L);var f=a.g;a=a.ia,f.L=1,f.v=Wo(Ht(h)),f.m=null,f.P=!0,Gm(f,a)}n.Za=function(){this.C!=null&&(this.C=null,Ho(this),pc(this),Xe(19))};function Jo(a){a.C!=null&&(l.clearTimeout(a.C),a.C=null)}function gg(a,h){var f=null;if(a.g==h){Jo(a),mc(a),a.g=null;var g=2}else if(cc(a.h,h))f=h.D,$m(a.h,h),g=1;else return;if(a.G!=0){if(h.o)if(g==1){f=h.m?h.m.length:0,h=Date.now()-h.F;var S=a.B;g=qo(),Je(g,new Lm(g,f)),Yo(a)}else pg(a);else if(S=h.s,S==3||S==0&&0<h.X||!(g==1&&IT(a,h)||g==2&&pc(a)))switch(f&&0<f.length&&(h=a.h,h.i=h.i.concat(f)),S){case 1:Hn(a,5);break;case 4:Hn(a,10);break;case 3:Hn(a,6);break;default:Hn(a,2)}}}function _g(a,h){let f=a.Ta+Math.floor(Math.random()*a.cb);return a.isActive()||(f*=2),f*h}function Hn(a,h){if(a.j.info("Error code "+h),h==2){var f=m(a.fb,a),g=a.Xa;let S=!g;g=new $n(g||"//www.google.com/images/cleardot.gif"),l.location&&l.location.protocol=="http"||zo(g,"https"),Wo(g),S?mT(g.toString(),f):gT(g.toString(),f)}else Xe(2);a.G=0,a.l&&a.l.sa(h),yg(a),hg(a)}n.fb=function(a){a?(this.j.info("Successfully pinged google.com"),Xe(2)):(this.j.info("Failed to ping google.com"),Xe(1))};function yg(a){if(a.G=0,a.ka=[],a.l){let h=Hm(a.h);(h.length!=0||a.i.length!=0)&&(D(a.ka,h),D(a.ka,a.i),a.h.i.length=0,N(a.i),a.i.length=0),a.l.ra()}}function vg(a,h,f){var g=f instanceof $n?Ht(f):new $n(f);if(g.g!="")h&&(g.g=h+"."+g.g),Ko(g,g.s);else{var S=l.location;g=S.protocol,h=h?h+"."+S.hostname:S.hostname,S=+S.port;var R=new $n(null);g&&zo(R,g),h&&(R.g=h),S&&Ko(R,S),f&&(R.l=f),g=R}return f=a.D,h=a.ya,f&&h&&ge(g,f,h),ge(g,"VER",a.la),ls(a,g),g}function wg(a,h,f){if(h&&!a.J)throw Error("Can't create secondary domain capable XhrIo object.");return h=a.Ca&&!a.pa?new Ie(new is({eb:f})):new Ie(a.pa),h.Ha(a.J),h}n.isActive=function(){return!!this.l&&this.l.isActive(this)};function Eg(){}n=Eg.prototype,n.ua=function(){},n.ta=function(){},n.sa=function(){},n.ra=function(){},n.isActive=function(){return!0},n.Na=function(){};function Xo(){}Xo.prototype.g=function(a,h){return new lt(a,h)};function lt(a,h){Ke.call(this),this.g=new cg(h),this.l=a,this.h=h&&h.messageUrlParams||null,a=h&&h.messageHeaders||null,h&&h.clientProtocolHeaderRequired&&(a?a["X-Client-Protocol"]="webchannel":a={"X-Client-Protocol":"webchannel"}),this.g.o=a,a=h&&h.initMessageHeaders||null,h&&h.messageContentType&&(a?a["X-WebChannel-Content-Type"]=h.messageContentType:a={"X-WebChannel-Content-Type":h.messageContentType}),h&&h.va&&(a?a["X-WebChannel-Client-Profile"]=h.va:a={"X-WebChannel-Client-Profile":h.va}),this.g.S=a,(a=h&&h.Sb)&&!j(a)&&(this.g.m=a),this.v=h&&h.supportsCrossDomainXhr||!1,this.u=h&&h.sendRawJson||!1,(h=h&&h.httpSessionIdParam)&&!j(h)&&(this.g.D=h,a=this.h,a!==null&&h in a&&(a=this.h,h in a&&delete a[h])),this.j=new Vr(this)}C(lt,Ke),lt.prototype.m=function(){this.g.l=this.j,this.v&&(this.g.J=!0),this.g.connect(this.l,this.h||void 0)},lt.prototype.close=function(){fc(this.g)},lt.prototype.o=function(a){var h=this.g;if(typeof a=="string"){var f={};f.__data__=a,a=f}else this.u&&(f={},f.__data__=tc(a),a=f);h.i.push(new sT(h.Ya++,a)),h.G==3&&Yo(h)},lt.prototype.N=function(){this.g.l=null,delete this.j,fc(this.g),delete this.g,lt.aa.N.call(this)};function Ig(a){rc.call(this),a.__headers__&&(this.headers=a.__headers__,this.statusCode=a.__status__,delete a.__headers__,delete a.__status__);var h=a.__sm__;if(h){e:{for(let f in h){a=f;break e}a=void 0}(this.i=a)&&(a=this.i,h=h!==null&&a in h?h[a]:void 0),this.data=h}else this.data=a}C(Ig,rc);function Tg(){ic.call(this),this.status=1}C(Tg,ic);function Vr(a){this.g=a}C(Vr,Eg),Vr.prototype.ua=function(){Je(this.g,"a")},Vr.prototype.ta=function(a){Je(this.g,new Ig(a))},Vr.prototype.sa=function(a){Je(this.g,new Tg)},Vr.prototype.ra=function(){Je(this.g,"b")},Xo.prototype.createWebChannel=Xo.prototype.g,lt.prototype.send=lt.prototype.o,lt.prototype.open=lt.prototype.m,lt.prototype.close=lt.prototype.close,Ad=Zt.createWebChannelTransport=function(){return new Xo},Sd=Zt.getStatEventTarget=function(){return qo()},Td=Zt.Event=Wn,Sl=Zt.Stat={mb:0,pb:1,qb:2,Jb:3,Ob:4,Lb:5,Mb:6,Kb:7,Ib:8,Nb:9,PROXY:10,NOPROXY:11,Gb:12,Cb:13,Db:14,Bb:15,Eb:16,Fb:17,ib:18,hb:19,jb:20},Bo.NO_ERROR=0,Bo.TIMEOUT=8,Bo.HTTP_ERROR=6,$s=Zt.ErrorCode=Bo,Um.COMPLETE="complete",Id=Zt.EventType=Um,Vm.EventType=Yi,Yi.OPEN="a",Yi.CLOSE="b",Yi.ERROR="c",Yi.MESSAGE="d",Ke.prototype.listen=Ke.prototype.K,ri=Zt.WebChannel=Vm,Ed=Zt.FetchXmlHttpFactory=is,Ie.prototype.listenOnce=Ie.prototype.L,Ie.prototype.getLastError=Ie.prototype.Ka,Ie.prototype.getLastErrorCode=Ie.prototype.Ba,Ie.prototype.getStatus=Ie.prototype.Z,Ie.prototype.getResponseJson=Ie.prototype.Oa,Ie.prototype.getResponseText=Ie.prototype.oa,Ie.prototype.send=Ie.prototype.ea,Ie.prototype.setWithCredentials=Ie.prototype.Ha,wd=Zt.XhrIo=Ie}).apply(typeof Tl<"u"?Tl:typeof self<"u"?self:typeof window<"u"?window:{});var cv="@firebase/firestore";var Ne=class{constructor(e){this.uid=e}isAuthenticated(){return this.uid!=null}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}};Ne.UNAUTHENTICATED=new Ne(null),Ne.GOOGLE_CREDENTIALS=new Ne("google-credentials-uid"),Ne.FIRST_PARTY=new Ne("first-party-uid"),Ne.MOCK_USER=new Ne("mock-user");var Vi="10.12.3";var kn=new Lr("@firebase/firestore");function li(){return kn.logLevel}function cw(n){kn.setLogLevel(n)}function V(n,...e){if(kn.logLevel<=gt.DEBUG){let t=e.map(Pp);kn.debug(`Firestore (${Vi}): ${n}`,...t)}}function Ae(n,...e){if(kn.logLevel<=gt.ERROR){let t=e.map(Pp);kn.error(`Firestore (${Vi}): ${n}`,...t)}}function Et(n,...e){if(kn.logLevel<=gt.WARN){let t=e.map(Pp);kn.warn(`Firestore (${Vi}): ${n}`,...t)}}function Pp(n){if(typeof n=="string")return n;try{return function(t){return JSON.stringify(t)}(n)}catch{return n}}function U(n="Unexpected state"){let e=`FIRESTORE (${Vi}) INTERNAL ASSERTION FAILED: `+n;throw Ae(e),new Error(e)}function G(n,e){n||U()}function hw(n,e){n||U()}function L(n,e){return n}var P={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},k=class extends Vg{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}};var De=class{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}};var Ml=class{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}},xd=class{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(Ne.UNAUTHENTICATED))}shutdown(){}},Nd=class{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}},Dd=class{constructor(e){this.t=e,this.currentUser=Ne.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){let r=this.i,i=u=>this.i!==r?(r=this.i,t(u)):Promise.resolve(),s=new De;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new De,e.enqueueRetryable(()=>i(this.currentUser))};let o=()=>{let u=s;e.enqueueRetryable(()=>x(this,null,function*(){yield u.promise,yield i(this.currentUser)}))},l=u=>{V("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=u,this.auth.addAuthTokenListener(this.o),o()};this.t.onInit(u=>l(u)),setTimeout(()=>{if(!this.auth){let u=this.t.getImmediate({optional:!0});u?l(u):(V("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new De)}},0),o()}getToken(){let e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then(r=>this.i!==e?(V("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):r?(G(typeof r.accessToken=="string"),new Ml(r.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){let e=this.auth&&this.auth.getUid();return G(e===null||typeof e=="string"),new Ne(e)}},kd=class{constructor(e,t,r){this.l=e,this.h=t,this.P=r,this.type="FirstParty",this.user=Ne.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);let e=this.T();return e&&this.I.set("Authorization",e),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}},Vd=class{constructor(e,t,r){this.l=e,this.h=t,this.P=r}getToken(){return Promise.resolve(new kd(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable(()=>t(Ne.FIRST_PARTY))}shutdown(){}invalidateToken(){}},Md=class{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}},Od=class{constructor(e){this.A=e,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(e,t){let r=s=>{s.error!=null&&V("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${s.error.message}`);let o=s.token!==this.R;return this.R=s.token,V("FirebaseAppCheckTokenProvider",`Received ${o?"new":"existing"} token.`),o?t(s.token):Promise.resolve()};this.o=s=>{e.enqueueRetryable(()=>r(s))};let i=s=>{V("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=s,this.appCheck.addTokenListener(this.o)};this.A.onInit(s=>i(s)),setTimeout(()=>{if(!this.appCheck){let s=this.A.getImmediate({optional:!0});s?i(s):V("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){let e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(t=>t?(G(typeof t.token=="string"),this.R=t.token,new Md(t.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}};function DC(n){let e=typeof self<"u"&&(self.crypto||self.msCrypto),t=new Uint8Array(n);if(e&&typeof e.getRandomValues=="function")e.getRandomValues(t);else for(let r=0;r<n;r++)t[r]=Math.floor(256*Math.random());return t}var Ol=class{static newId(){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=Math.floor(256/e.length)*e.length,r="";for(;r.length<20;){let i=DC(40);for(let s=0;s<i.length;++s)r.length<20&&i[s]<t&&(r+=e.charAt(i[s]%e.length))}return r}};function $(n,e){return n<e?-1:n>e?1:0}function _i(n,e,t){return n.length===e.length&&n.every((r,i)=>t(r,e[i]))}function dw(n){return n+"\0"}var Ee=class n{constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new k(P.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new k(P.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new k(P.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new k(P.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return n.fromMillis(Date.now())}static fromDate(e){return n.fromMillis(e.getTime())}static fromMillis(e){let t=Math.floor(e/1e3),r=Math.floor(1e6*(e-1e3*t));return new n(t,r)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?$(this.nanoseconds,e.nanoseconds):$(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){let e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}};var z=class n{constructor(e){this.timestamp=e}static fromTimestamp(e){return new n(e)}static min(){return new n(new Ee(0,0))}static max(){return new n(new Ee(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}};var Fl=class n{constructor(e,t,r){t===void 0?t=0:t>e.length&&U(),r===void 0?r=e.length-t:r>e.length-t&&U(),this.segments=e,this.offset=t,this.len=r}get length(){return this.len}isEqual(e){return n.comparator(this,e)===0}child(e){let t=this.segments.slice(this.offset,this.limit());return e instanceof n?e.forEach(r=>{t.push(r)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=e===void 0?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return this.length===0}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,r=this.limit();t<r;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){let r=Math.min(e.length,t.length);for(let i=0;i<r;i++){let s=e.get(i),o=t.get(i);if(s<o)return-1;if(s>o)return 1}return e.length<t.length?-1:e.length>t.length?1:0}},se=class n extends Fl{construct(e,t,r){return new n(e,t,r)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){let t=[];for(let r of e){if(r.indexOf("//")>=0)throw new k(P.INVALID_ARGUMENT,`Invalid segment (${r}). Paths must not contain // in them.`);t.push(...r.split("/").filter(i=>i.length>0))}return new n(t)}static emptyPath(){return new n([])}},kC=/^[_a-zA-Z][_a-zA-Z0-9]*$/,Ce=class n extends Fl{construct(e,t,r){return new n(e,t,r)}static isValidIdentifier(e){return kC.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),n.isValidIdentifier(e)||(e="`"+e+"`"),e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return this.length===1&&this.get(0)==="__name__"}static keyField(){return new n(["__name__"])}static fromServerFormat(e){let t=[],r="",i=0,s=()=>{if(r.length===0)throw new k(P.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(r),r=""},o=!1;for(;i<e.length;){let l=e[i];if(l==="\\"){if(i+1===e.length)throw new k(P.INVALID_ARGUMENT,"Path has trailing escape character: "+e);let u=e[i+1];if(u!=="\\"&&u!=="."&&u!=="`")throw new k(P.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);r+=u,i+=2}else l==="`"?(o=!o,i++):l!=="."||o?(r+=l,i++):(s(),i++)}if(s(),o)throw new k(P.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new n(t)}static emptyPath(){return new n([])}};var F=class n{constructor(e){this.path=e}static fromPath(e){return new n(se.fromString(e))}static fromName(e){return new n(se.fromString(e).popFirst(5))}static empty(){return new n(se.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return e!==null&&se.comparator(this.path,e.path)===0}toString(){return this.path.toString()}static comparator(e,t){return se.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new n(new se(e.slice()))}};var yi=class{constructor(e,t,r,i){this.indexId=e,this.collectionGroup=t,this.fields=r,this.indexState=i}};function Fd(n){return n.fields.find(e=>e.kind===2)}function ar(n){return n.fields.filter(e=>e.kind!==2)}yi.UNKNOWN_ID=-1;var pi=class{constructor(e,t){this.fieldPath=e,this.kind=t}};var oo=class n{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new n(0,It.min())}};function fw(n,e){let t=n.toTimestamp().seconds,r=n.toTimestamp().nanoseconds+1,i=z.fromTimestamp(r===1e9?new Ee(t+1,0):new Ee(t,r));return new It(i,F.empty(),e)}function pw(n){return new It(n.readTime,n.key,-1)}var It=class n{constructor(e,t,r){this.readTime=e,this.documentKey=t,this.largestBatchId=r}static min(){return new n(z.min(),F.empty(),-1)}static max(){return new n(z.max(),F.empty(),-1)}};function xp(n,e){let t=n.readTime.compareTo(e.readTime);return t!==0?t:(t=F.comparator(n.documentKey,e.documentKey),t!==0?t:$(n.largestBatchId,e.largestBatchId))}var mw="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",Ll=class{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}};function jn(n){return x(this,null,function*(){if(n.code!==P.FAILED_PRECONDITION||n.message!==mw)throw n;V("LocalStore","Unexpectedly lost primary lease")})}var b=class n{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)},t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)})}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&U(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new n((r,i)=>{this.nextCallback=s=>{this.wrapSuccess(e,s).next(r,i)},this.catchCallback=s=>{this.wrapFailure(t,s).next(r,i)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{let t=e();return t instanceof n?t:n.resolve(t)}catch(t){return n.reject(t)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):n.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):n.reject(t)}static resolve(e){return new n((t,r)=>{t(e)})}static reject(e){return new n((t,r)=>{r(e)})}static waitFor(e){return new n((t,r)=>{let i=0,s=0,o=!1;e.forEach(l=>{++i,l.next(()=>{++s,o&&s===i&&t()},u=>r(u))}),o=!0,s===i&&t()})}static or(e){let t=n.resolve(!1);for(let r of e)t=t.next(i=>i?n.resolve(i):r());return t}static forEach(e,t){let r=[];return e.forEach((i,s)=>{r.push(t.call(this,i,s))}),this.waitFor(r)}static mapArray(e,t){return new n((r,i)=>{let s=e.length,o=new Array(s),l=0;for(let u=0;u<s;u++){let c=u;t(e[c]).next(d=>{o[c]=d,++l,l===s&&r(o)},d=>i(d))}})}static doWhile(e,t){return new n((r,i)=>{let s=()=>{e()===!0?t().next(()=>{s()},i):r()};s()})}};var Ul=class n{constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.V=new De,this.transaction.oncomplete=()=>{this.V.resolve()},this.transaction.onabort=()=>{t.error?this.V.reject(new fr(e,t.error)):this.V.resolve()},this.transaction.onerror=r=>{let i=Np(r.target.error);this.V.reject(new fr(e,i))}}static open(e,t,r,i){try{return new n(t,e.transaction(i,r))}catch(s){throw new fr(t,s)}}get m(){return this.V.promise}abort(e){e&&this.V.reject(e),this.aborted||(V("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}g(){let e=this.transaction;this.aborted||typeof e.commit!="function"||e.commit()}store(e){let t=this.transaction.objectStore(e);return new Ud(t)}},Vn=class n{constructor(e,t,r){this.name=e,this.version=t,this.p=r,n.S(ds())===12.2&&Ae("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return V("SimpleDb","Removing database:",e),lr(window.indexedDB.deleteDatabase(e)).toPromise()}static D(){if(!kg())return!1;if(n.C())return!0;let e=ds(),t=n.S(e),r=0<t&&t<10,i=gw(e),s=0<i&&i<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||r||s)}static C(){var e;return typeof process<"u"&&((e=process.__PRIVATE_env)===null||e===void 0?void 0:e.v)==="YES"}static F(e,t){return e.store(t)}static S(e){let t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),r=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(r)}M(e){return x(this,null,function*(){return this.db||(V("SimpleDb","Opening database:",this.name),this.db=yield new Promise((t,r)=>{let i=indexedDB.open(this.name,this.version);i.onsuccess=s=>{let o=s.target.result;t(o)},i.onblocked=()=>{r(new fr(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},i.onerror=s=>{let o=s.target.error;o.name==="VersionError"?r(new k(P.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):o.name==="InvalidStateError"?r(new k(P.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+o)):r(new fr(e,o))},i.onupgradeneeded=s=>{V("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',s.oldVersion);let o=s.target.result;this.p.O(o,i.transaction,s.oldVersion,this.version).next(()=>{V("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.N&&(this.db.onversionchange=t=>this.N(t)),this.db})}L(e){this.N=e,this.db&&(this.db.onversionchange=t=>e(t))}runTransaction(e,t,r,i){return x(this,null,function*(){let s=t==="readonly",o=0;for(;;){++o;try{this.db=yield this.M(e);let l=Ul.open(this.db,e,s?"readonly":"readwrite",r),u=i(l).next(c=>(l.g(),c)).catch(c=>(l.abort(c),b.reject(c))).toPromise();return u.catch(()=>{}),yield l.m,u}catch(l){let u=l,c=u.name!=="FirebaseError"&&o<3;if(V("SimpleDb","Transaction failed with error:",u.message,"Retrying:",c),this.close(),!c)return Promise.reject(u)}}})}close(){this.db&&this.db.close(),this.db=void 0}};function gw(n){let e=n.match(/Android ([\d.]+)/i),t=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(t)}var Ld=class{constructor(e){this.B=e,this.k=!1,this.q=null}get isDone(){return this.k}get K(){return this.q}set cursor(e){this.B=e}done(){this.k=!0}$(e){this.q=e}delete(){return lr(this.B.delete())}},fr=class extends k{constructor(e,t){super(P.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}};function zn(n){return n.name==="IndexedDbTransactionError"}var Ud=class{constructor(e){this.store=e}put(e,t){let r;return t!==void 0?(V("SimpleDb","PUT",this.store.name,e,t),r=this.store.put(t,e)):(V("SimpleDb","PUT",this.store.name,"<auto-key>",e),r=this.store.put(e)),lr(r)}add(e){return V("SimpleDb","ADD",this.store.name,e,e),lr(this.store.add(e))}get(e){return lr(this.store.get(e)).next(t=>(t===void 0&&(t=null),V("SimpleDb","GET",this.store.name,e,t),t))}delete(e){return V("SimpleDb","DELETE",this.store.name,e),lr(this.store.delete(e))}count(){return V("SimpleDb","COUNT",this.store.name),lr(this.store.count())}U(e,t){let r=this.options(e,t),i=r.index?this.store.index(r.index):this.store;if(typeof i.getAll=="function"){let s=i.getAll(r.range);return new b((o,l)=>{s.onerror=u=>{l(u.target.error)},s.onsuccess=u=>{o(u.target.result)}})}{let s=this.cursor(r),o=[];return this.W(s,(l,u)=>{o.push(u)}).next(()=>o)}}G(e,t){let r=this.store.getAll(e,t===null?void 0:t);return new b((i,s)=>{r.onerror=o=>{s(o.target.error)},r.onsuccess=o=>{i(o.target.result)}})}j(e,t){V("SimpleDb","DELETE ALL",this.store.name);let r=this.options(e,t);r.H=!1;let i=this.cursor(r);return this.W(i,(s,o,l)=>l.delete())}J(e,t){let r;t?r=e:(r={},t=e);let i=this.cursor(r);return this.W(i,t)}Y(e){let t=this.cursor({});return new b((r,i)=>{t.onerror=s=>{let o=Np(s.target.error);i(o)},t.onsuccess=s=>{let o=s.target.result;o?e(o.primaryKey,o.value).next(l=>{l?o.continue():r()}):r()}})}W(e,t){let r=[];return new b((i,s)=>{e.onerror=o=>{s(o.target.error)},e.onsuccess=o=>{let l=o.target.result;if(!l)return void i();let u=new Ld(l),c=t(l.primaryKey,l.value,u);if(c instanceof b){let d=c.catch(p=>(u.done(),b.reject(p)));r.push(d)}u.isDone?i():u.K===null?l.continue():l.continue(u.K)}}).next(()=>b.waitFor(r))}options(e,t){let r;return e!==void 0&&(typeof e=="string"?r=e:t=e),{index:r,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){let r=this.store.index(e.index);return e.H?r.openKeyCursor(e.range,t):r.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}};function lr(n){return new b((e,t)=>{n.onsuccess=r=>{let i=r.target.result;e(i)},n.onerror=r=>{let i=Np(r.target.error);t(i)}})}var hv=!1;function Np(n){let e=Vn.S(ds());if(e>=12.2&&e<13){let t="An internal error was encountered in the Indexed Database server";if(n.message.indexOf(t)>=0){let r=new k("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return hv||(hv=!0,setTimeout(()=>{throw r},0)),r}}return n}var qd=class{constructor(e,t){this.asyncQueue=e,this.Z=t,this.task=null}start(){this.X(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return this.task!==null}X(e){V("IndexBackfiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,()=>x(this,null,function*(){this.task=null;try{V("IndexBackfiller",`Documents written: ${yield this.Z.ee()}`)}catch(t){zn(t)?V("IndexBackfiller","Ignoring IndexedDB error during index backfill: ",t):yield jn(t)}yield this.X(6e4)}))}},Bd=class{constructor(e,t){this.localStore=e,this.persistence=t}ee(e=50){return x(this,null,function*(){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",t=>this.te(t,e))})}te(e,t){let r=new Set,i=t,s=!0;return b.doWhile(()=>s===!0&&i>0,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(o=>{if(o!==null&&!r.has(o))return V("IndexBackfiller",`Processing collection: ${o}`),this.ne(e,o,i).next(l=>{i-=l,r.add(o)});s=!1})).next(()=>t-i)}ne(e,t,r){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next(i=>this.localStore.localDocuments.getNextDocuments(e,t,i,r).next(s=>{let o=s.changes;return this.localStore.indexManager.updateIndexEntries(e,o).next(()=>this.re(i,s)).next(l=>(V("IndexBackfiller",`Updating offset: ${l}`),this.localStore.indexManager.updateCollectionGroup(e,t,l))).next(()=>o.size)}))}re(e,t){let r=e;return t.changes.forEach((i,s)=>{let o=pw(s);xp(o,r)>0&&(r=o)}),new It(r.readTime,r.documentKey,Math.max(t.batchId,e.largestBatchId))}};var ft=(()=>{class n{constructor(t,r){this.previousValue=t,r&&(r.sequenceNumberHandler=i=>this.ie(i),this.se=i=>r.writeSequenceNumber(i))}ie(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){let t=++this.previousValue;return this.se&&this.se(t),t}}return n.oe=-1,n})();function Po(n){return n==null}function ao(n){return n===0&&1/n==-1/0}function _w(n){return typeof n=="number"&&Number.isInteger(n)&&!ao(n)&&n<=Number.MAX_SAFE_INTEGER&&n>=Number.MIN_SAFE_INTEGER}function rt(n){let e="";for(let t=0;t<n.length;t++)e.length>0&&(e=dv(e)),e=VC(n.get(t),e);return dv(e)}function VC(n,e){let t=e,r=n.length;for(let i=0;i<r;i++){let s=n.charAt(i);switch(s){case"\0":t+="";break;case"":t+="";break;default:t+=s}}return t}function dv(n){return n+""}function Lt(n){let e=n.length;if(G(e>=2),e===2)return G(n.charAt(0)===""&&n.charAt(1)===""),se.emptyPath();let t=e-2,r=[],i="";for(let s=0;s<e;){let o=n.indexOf("",s);switch((o<0||o>t)&&U(),n.charAt(o+1)){case"":let l=n.substring(s,o),u;i.length===0?u=l:(i+=l,u=i,i=""),r.push(u);break;case"":i+=n.substring(s,o),i+="\0";break;case"":i+=n.substring(s,o+1);break;default:U()}s=o+2}return new se(r)}var fv=["userId","batchId"];function Pl(n,e){return[n,rt(e)]}function yw(n,e,t){return[n,rt(e),t]}var MC={},OC=["prefixPath","collectionGroup","readTime","documentId"],FC=["prefixPath","collectionGroup","documentId"],LC=["collectionGroup","readTime","prefixPath","documentId"],UC=["canonicalId","targetId"],qC=["targetId","path"],BC=["path","targetId"],GC=["collectionId","parent"],jC=["indexId","uid"],zC=["uid","sequenceNumber"],KC=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],WC=["indexId","uid","orderedDocumentKey"],QC=["userId","collectionPath","documentId"],$C=["userId","collectionPath","largestBatchId"],HC=["userId","collectionGroup","largestBatchId"],vw=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],YC=[...vw,"documentOverlays"],ww=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],Ew=ww,Iw=[...Ew,"indexConfiguration","indexState","indexEntries"],JC=Iw;var lo=class extends Ll{constructor(e,t){super(),this._e=e,this.currentSequenceNumber=t}};function Be(n,e){let t=L(n);return Vn.F(t._e,e)}function pv(n){let e=0;for(let t in n)Object.prototype.hasOwnProperty.call(n,t)&&e++;return e}function Ar(n,e){for(let t in n)Object.prototype.hasOwnProperty.call(n,t)&&e(t,n[t])}function Tw(n){for(let e in n)if(Object.prototype.hasOwnProperty.call(n,e))return!1;return!0}var _e=class n{constructor(e,t){this.comparator=e,this.root=t||qt.EMPTY}insert(e,t){return new n(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,qt.BLACK,null,null))}remove(e){return new n(this.comparator,this.root.remove(e,this.comparator).copy(null,null,qt.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){let r=this.comparator(e,t.key);if(r===0)return t.value;r<0?t=t.left:r>0&&(t=t.right)}return null}indexOf(e){let t=0,r=this.root;for(;!r.isEmpty();){let i=this.comparator(e,r.key);if(i===0)return t+r.left.size;i<0?r=r.left:(t+=r.left.size+1,r=r.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal((t,r)=>(e(t,r),!1))}toString(){let e=[];return this.inorderTraversal((t,r)=>(e.push(`${t}:${r}`),!1)),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new fi(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new fi(this.root,e,this.comparator,!1)}getReverseIterator(){return new fi(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new fi(this.root,e,this.comparator,!0)}},fi=class{constructor(e,t,r,i){this.isReverse=i,this.nodeStack=[];let s=1;for(;!e.isEmpty();)if(s=t?r(e.key,t):1,t&&i&&(s*=-1),s<0)e=this.isReverse?e.left:e.right;else{if(s===0){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop(),t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(this.nodeStack.length===0)return null;let e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}},qt=class n{constructor(e,t,r,i,s){this.key=e,this.value=t,this.color=r??n.RED,this.left=i??n.EMPTY,this.right=s??n.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,r,i,s){return new n(e??this.key,t??this.value,r??this.color,i??this.left,s??this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,r){let i=this,s=r(e,i.key);return i=s<0?i.copy(null,null,null,i.left.insert(e,t,r),null):s===0?i.copy(null,t,null,null,null):i.copy(null,null,null,null,i.right.insert(e,t,r)),i.fixUp()}removeMin(){if(this.left.isEmpty())return n.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let r,i=this;if(t(e,i.key)<0)i.left.isEmpty()||i.left.isRed()||i.left.left.isRed()||(i=i.moveRedLeft()),i=i.copy(null,null,null,i.left.remove(e,t),null);else{if(i.left.isRed()&&(i=i.rotateRight()),i.right.isEmpty()||i.right.isRed()||i.right.left.isRed()||(i=i.moveRedRight()),t(e,i.key)===0){if(i.right.isEmpty())return n.EMPTY;r=i.right.min(),i=i.copy(r.key,r.value,null,null,i.right.removeMin())}i=i.copy(null,null,null,null,i.right.remove(e,t))}return i.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){let e=this.copy(null,null,n.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){let e=this.copy(null,null,n.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){let e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){let e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed()||this.right.isRed())throw U();let e=this.left.check();if(e!==this.right.check())throw U();return e+(this.isRed()?0:1)}};qt.EMPTY=null,qt.RED=!0,qt.BLACK=!1;qt.EMPTY=new class{constructor(){this.size=0}get key(){throw U()}get value(){throw U()}get color(){throw U()}get left(){throw U()}get right(){throw U()}copy(e,t,r,i,s){return this}insert(e,t,r){return new qt(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};var fe=class n{constructor(e){this.comparator=e,this.data=new _e(this.comparator)}has(e){return this.data.get(e)!==null}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal((t,r)=>(e(t),!1))}forEachInRange(e,t){let r=this.data.getIteratorFrom(e[0]);for(;r.hasNext();){let i=r.getNext();if(this.comparator(i.key,e[1])>=0)return;t(i.key)}}forEachWhile(e,t){let r;for(r=t!==void 0?this.data.getIteratorFrom(t):this.data.getIterator();r.hasNext();)if(!e(r.getNext().key))return}firstAfterOrEqual(e){let t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new ql(this.data.getIterator())}getIteratorFrom(e){return new ql(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(r=>{t=t.add(r)}),t}isEqual(e){if(!(e instanceof n)||this.size!==e.size)return!1;let t=this.data.getIterator(),r=e.data.getIterator();for(;t.hasNext();){let i=t.getNext().key,s=r.getNext().key;if(this.comparator(i,s)!==0)return!1}return!0}toArray(){let e=[];return this.forEach(t=>{e.push(t)}),e}toString(){let e=[];return this.forEach(t=>e.push(t)),"SortedSet("+e.toString()+")"}copy(e){let t=new n(this.comparator);return t.data=e,t}},ql=class{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}};function ii(n){return n.hasNext()?n.getNext():void 0}var pt=class n{constructor(e){this.fields=e,e.sort(Ce.comparator)}static empty(){return new n([])}unionWith(e){let t=new fe(Ce.comparator);for(let r of this.fields)t=t.add(r);for(let r of e)t=t.add(r);return new n(t.toArray())}covers(e){for(let t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return _i(this.fields,e.fields,(t,r)=>t.isEqual(r))}};var Bl=class extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}};function Sw(){return typeof atob<"u"}var qe=class n{constructor(e){this.binaryString=e}static fromBase64String(e){let t=function(i){try{return atob(i)}catch(s){throw typeof DOMException<"u"&&s instanceof DOMException?new Bl("Invalid base64 string: "+s):s}}(e);return new n(t)}static fromUint8Array(e){let t=function(i){let s="";for(let o=0;o<i.length;++o)s+=String.fromCharCode(i[o]);return s}(e);return new n(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return function(t){return btoa(t)}(this.binaryString)}toUint8Array(){return function(t){let r=new Uint8Array(t.length);for(let i=0;i<t.length;i++)r[i]=t.charCodeAt(i);return r}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return $(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}};qe.EMPTY_BYTE_STRING=new qe("");var XC=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function nn(n){if(G(!!n),typeof n=="string"){let e=0,t=XC.exec(n);if(G(!!t),t[1]){let i=t[1];i=(i+"000000000").substr(0,9),e=Number(i)}let r=new Date(n);return{seconds:Math.floor(r.getTime()/1e3),nanos:e}}return{seconds:Te(n.seconds),nanos:Te(n.nanos)}}function Te(n){return typeof n=="number"?n:typeof n=="string"?Number(n):0}function Mn(n){return typeof n=="string"?qe.fromBase64String(n):qe.fromUint8Array(n)}function Nu(n){var e,t;return((t=(((e=n?.mapValue)===null||e===void 0?void 0:e.fields)||{}).__type__)===null||t===void 0?void 0:t.stringValue)==="server_timestamp"}function Dp(n){let e=n.mapValue.fields.__previous_value__;return Nu(e)?Dp(e):e}function uo(n){let e=nn(n.mapValue.fields.__local_write_time__.timestampValue);return new Ee(e.seconds,e.nanos)}var Gd=class{constructor(e,t,r,i,s,o,l,u,c){this.databaseId=e,this.appId=t,this.persistenceKey=r,this.host=i,this.ssl=s,this.forceLongPolling=o,this.autoDetectLongPolling=l,this.longPollingOptions=u,this.useFetchStreams=c}},On=class n{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new n("","")}get isDefaultDatabase(){return this.database==="(default)"}isEqual(e){return e instanceof n&&e.projectId===this.projectId&&e.database===this.database}};var Nn={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},xl={nullValue:"NULL_VALUE"};function pr(n){return"nullValue"in n?0:"booleanValue"in n?1:"integerValue"in n||"doubleValue"in n?2:"timestampValue"in n?3:"stringValue"in n?5:"bytesValue"in n?6:"referenceValue"in n?7:"geoPointValue"in n?8:"arrayValue"in n?9:"mapValue"in n?Nu(n)?4:Aw(n)?9007199254740991:10:U()}function jt(n,e){if(n===e)return!0;let t=pr(n);if(t!==pr(e))return!1;switch(t){case 0:case 9007199254740991:return!0;case 1:return n.booleanValue===e.booleanValue;case 4:return uo(n).isEqual(uo(e));case 3:return function(i,s){if(typeof i.timestampValue=="string"&&typeof s.timestampValue=="string"&&i.timestampValue.length===s.timestampValue.length)return i.timestampValue===s.timestampValue;let o=nn(i.timestampValue),l=nn(s.timestampValue);return o.seconds===l.seconds&&o.nanos===l.nanos}(n,e);case 5:return n.stringValue===e.stringValue;case 6:return function(i,s){return Mn(i.bytesValue).isEqual(Mn(s.bytesValue))}(n,e);case 7:return n.referenceValue===e.referenceValue;case 8:return function(i,s){return Te(i.geoPointValue.latitude)===Te(s.geoPointValue.latitude)&&Te(i.geoPointValue.longitude)===Te(s.geoPointValue.longitude)}(n,e);case 2:return function(i,s){if("integerValue"in i&&"integerValue"in s)return Te(i.integerValue)===Te(s.integerValue);if("doubleValue"in i&&"doubleValue"in s){let o=Te(i.doubleValue),l=Te(s.doubleValue);return o===l?ao(o)===ao(l):isNaN(o)&&isNaN(l)}return!1}(n,e);case 9:return _i(n.arrayValue.values||[],e.arrayValue.values||[],jt);case 10:return function(i,s){let o=i.mapValue.fields||{},l=s.mapValue.fields||{};if(pv(o)!==pv(l))return!1;for(let u in o)if(o.hasOwnProperty(u)&&(l[u]===void 0||!jt(o[u],l[u])))return!1;return!0}(n,e);default:return U()}}function co(n,e){return(n.values||[]).find(t=>jt(t,e))!==void 0}function Fn(n,e){if(n===e)return 0;let t=pr(n),r=pr(e);if(t!==r)return $(t,r);switch(t){case 0:case 9007199254740991:return 0;case 1:return $(n.booleanValue,e.booleanValue);case 2:return function(s,o){let l=Te(s.integerValue||s.doubleValue),u=Te(o.integerValue||o.doubleValue);return l<u?-1:l>u?1:l===u?0:isNaN(l)?isNaN(u)?0:-1:1}(n,e);case 3:return mv(n.timestampValue,e.timestampValue);case 4:return mv(uo(n),uo(e));case 5:return $(n.stringValue,e.stringValue);case 6:return function(s,o){let l=Mn(s),u=Mn(o);return l.compareTo(u)}(n.bytesValue,e.bytesValue);case 7:return function(s,o){let l=s.split("/"),u=o.split("/");for(let c=0;c<l.length&&c<u.length;c++){let d=$(l[c],u[c]);if(d!==0)return d}return $(l.length,u.length)}(n.referenceValue,e.referenceValue);case 8:return function(s,o){let l=$(Te(s.latitude),Te(o.latitude));return l!==0?l:$(Te(s.longitude),Te(o.longitude))}(n.geoPointValue,e.geoPointValue);case 9:return function(s,o){let l=s.values||[],u=o.values||[];for(let c=0;c<l.length&&c<u.length;++c){let d=Fn(l[c],u[c]);if(d)return d}return $(l.length,u.length)}(n.arrayValue,e.arrayValue);case 10:return function(s,o){if(s===Nn.mapValue&&o===Nn.mapValue)return 0;if(s===Nn.mapValue)return 1;if(o===Nn.mapValue)return-1;let l=s.fields||{},u=Object.keys(l),c=o.fields||{},d=Object.keys(c);u.sort(),d.sort();for(let p=0;p<u.length&&p<d.length;++p){let m=$(u[p],d[p]);if(m!==0)return m;let v=Fn(l[u[p]],c[d[p]]);if(v!==0)return v}return $(u.length,d.length)}(n.mapValue,e.mapValue);default:throw U()}}function mv(n,e){if(typeof n=="string"&&typeof e=="string"&&n.length===e.length)return $(n,e);let t=nn(n),r=nn(e),i=$(t.seconds,r.seconds);return i!==0?i:$(t.nanos,r.nanos)}function vi(n){return jd(n)}function jd(n){return"nullValue"in n?"null":"booleanValue"in n?""+n.booleanValue:"integerValue"in n?""+n.integerValue:"doubleValue"in n?""+n.doubleValue:"timestampValue"in n?function(t){let r=nn(t);return`time(${r.seconds},${r.nanos})`}(n.timestampValue):"stringValue"in n?n.stringValue:"bytesValue"in n?function(t){return Mn(t).toBase64()}(n.bytesValue):"referenceValue"in n?function(t){return F.fromName(t).toString()}(n.referenceValue):"geoPointValue"in n?function(t){return`geo(${t.latitude},${t.longitude})`}(n.geoPointValue):"arrayValue"in n?function(t){let r="[",i=!0;for(let s of t.values||[])i?i=!1:r+=",",r+=jd(s);return r+"]"}(n.arrayValue):"mapValue"in n?function(t){let r=Object.keys(t.fields||{}).sort(),i="{",s=!0;for(let o of r)s?s=!1:i+=",",i+=`${o}:${jd(t.fields[o])}`;return i+"}"}(n.mapValue):U()}function mr(n,e){return{referenceValue:`projects/${n.projectId}/databases/${n.database}/documents/${e.path.canonicalString()}`}}function zd(n){return!!n&&"integerValue"in n}function ho(n){return!!n&&"arrayValue"in n}function gv(n){return!!n&&"nullValue"in n}function _v(n){return!!n&&"doubleValue"in n&&isNaN(Number(n.doubleValue))}function Nl(n){return!!n&&"mapValue"in n}function to(n){if(n.geoPointValue)return{geoPointValue:Object.assign({},n.geoPointValue)};if(n.timestampValue&&typeof n.timestampValue=="object")return{timestampValue:Object.assign({},n.timestampValue)};if(n.mapValue){let e={mapValue:{fields:{}}};return Ar(n.mapValue.fields,(t,r)=>e.mapValue.fields[t]=to(r)),e}if(n.arrayValue){let e={arrayValue:{values:[]}};for(let t=0;t<(n.arrayValue.values||[]).length;++t)e.arrayValue.values[t]=to(n.arrayValue.values[t]);return e}return Object.assign({},n)}function Aw(n){return(((n.mapValue||{}).fields||{}).__type__||{}).stringValue==="__max__"}function ZC(n){return"nullValue"in n?xl:"booleanValue"in n?{booleanValue:!1}:"integerValue"in n||"doubleValue"in n?{doubleValue:NaN}:"timestampValue"in n?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in n?{stringValue:""}:"bytesValue"in n?{bytesValue:""}:"referenceValue"in n?mr(On.empty(),F.empty()):"geoPointValue"in n?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in n?{arrayValue:{}}:"mapValue"in n?{mapValue:{}}:U()}function e0(n){return"nullValue"in n?{booleanValue:!1}:"booleanValue"in n?{doubleValue:NaN}:"integerValue"in n||"doubleValue"in n?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in n?{stringValue:""}:"stringValue"in n?{bytesValue:""}:"bytesValue"in n?mr(On.empty(),F.empty()):"referenceValue"in n?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in n?{arrayValue:{}}:"arrayValue"in n?{mapValue:{}}:"mapValue"in n?Nn:U()}function yv(n,e){let t=Fn(n.value,e.value);return t!==0?t:n.inclusive&&!e.inclusive?-1:!n.inclusive&&e.inclusive?1:0}function vv(n,e){let t=Fn(n.value,e.value);return t!==0?t:n.inclusive&&!e.inclusive?1:!n.inclusive&&e.inclusive?-1:0}var Ye=class n{constructor(e){this.value=e}static empty(){return new n({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let r=0;r<e.length-1;++r)if(t=(t.mapValue.fields||{})[e.get(r)],!Nl(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=to(t)}setAll(e){let t=Ce.emptyPath(),r={},i=[];e.forEach((o,l)=>{if(!t.isImmediateParentOf(l)){let u=this.getFieldsMap(t);this.applyChanges(u,r,i),r={},i=[],t=l.popLast()}o?r[l.lastSegment()]=to(o):i.push(l.lastSegment())});let s=this.getFieldsMap(t);this.applyChanges(s,r,i)}delete(e){let t=this.field(e.popLast());Nl(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return jt(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let r=0;r<e.length;++r){let i=t.mapValue.fields[e.get(r)];Nl(i)&&i.mapValue.fields||(i={mapValue:{fields:{}}},t.mapValue.fields[e.get(r)]=i),t=i}return t.mapValue.fields}applyChanges(e,t,r){Ar(t,(i,s)=>e[i]=s);for(let i of r)delete e[i]}clone(){return new n(to(this.value))}};function Cw(n){let e=[];return Ar(n.fields,(t,r)=>{let i=new Ce([t]);if(Nl(r)){let s=Cw(r.mapValue).fields;if(s.length===0)e.push(i);else for(let o of s)e.push(i.child(o))}else e.push(i)}),new pt(e)}var ke=class n{constructor(e,t,r,i,s,o,l){this.key=e,this.documentType=t,this.version=r,this.readTime=i,this.createTime=s,this.data=o,this.documentState=l}static newInvalidDocument(e){return new n(e,0,z.min(),z.min(),z.min(),Ye.empty(),0)}static newFoundDocument(e,t,r,i){return new n(e,1,t,z.min(),r,i,0)}static newNoDocument(e,t){return new n(e,2,t,z.min(),z.min(),Ye.empty(),0)}static newUnknownDocument(e,t){return new n(e,3,t,z.min(),z.min(),Ye.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(z.min())||this.documentType!==2&&this.documentType!==0||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=Ye.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=Ye.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=z.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return this.documentState===1}get hasCommittedMutations(){return this.documentState===2}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return this.documentType!==0}isFoundDocument(){return this.documentType===1}isNoDocument(){return this.documentType===2}isUnknownDocument(){return this.documentType===3}isEqual(e){return e instanceof n&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new n(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}};var zt=class{constructor(e,t){this.position=e,this.inclusive=t}};function wv(n,e,t){let r=0;for(let i=0;i<n.position.length;i++){let s=e[i],o=n.position[i];if(s.field.isKeyField()?r=F.comparator(F.fromName(o.referenceValue),t.key):r=Fn(o,t.data.field(s.field)),s.dir==="desc"&&(r*=-1),r!==0)break}return r}function Ev(n,e){if(n===null)return e===null;if(e===null||n.inclusive!==e.inclusive||n.position.length!==e.position.length)return!1;for(let t=0;t<n.position.length;t++)if(!jt(n.position[t],e.position[t]))return!1;return!0}var gr=class{constructor(e,t="asc"){this.field=e,this.dir=t}};function t0(n,e){return n.dir===e.dir&&n.field.isEqual(e.field)}var Gl=class{},te=class n extends Gl{constructor(e,t,r){super(),this.field=e,this.op=t,this.value=r}static create(e,t,r){return e.isKeyField()?t==="in"||t==="not-in"?this.createKeyFieldInFilter(e,t,r):new Qd(e,t,r):t==="array-contains"?new Yd(e,r):t==="in"?new jl(e,r):t==="not-in"?new Jd(e,r):t==="array-contains-any"?new Xd(e,r):new n(e,t,r)}static createKeyFieldInFilter(e,t,r){return t==="in"?new $d(e,r):new Hd(e,r)}matches(e){let t=e.data.field(this.field);return this.op==="!="?t!==null&&this.matchesComparison(Fn(t,this.value)):t!==null&&pr(this.value)===pr(t)&&this.matchesComparison(Fn(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return e===0;case"!=":return e!==0;case">":return e>0;case">=":return e>=0;default:return U()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}},ce=class n extends Gl{constructor(e,t){super(),this.filters=e,this.op=t,this.ae=null}static create(e,t){return new n(e,t)}matches(e){return wi(this)?this.filters.find(t=>!t.matches(e))===void 0:this.filters.find(t=>t.matches(e))!==void 0}getFlattenedFilters(){return this.ae!==null||(this.ae=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.ae}getFilters(){return Object.assign([],this.filters)}};function wi(n){return n.op==="and"}function Kd(n){return n.op==="or"}function kp(n){return bw(n)&&wi(n)}function bw(n){for(let e of n.filters)if(e instanceof ce)return!1;return!0}function Wd(n){if(n instanceof te)return n.field.canonicalString()+n.op.toString()+vi(n.value);if(kp(n))return n.filters.map(e=>Wd(e)).join(",");{let e=n.filters.map(t=>Wd(t)).join(",");return`${n.op}(${e})`}}function Rw(n,e){return n instanceof te?function(r,i){return i instanceof te&&r.op===i.op&&r.field.isEqual(i.field)&&jt(r.value,i.value)}(n,e):n instanceof ce?function(r,i){return i instanceof ce&&r.op===i.op&&r.filters.length===i.filters.length?r.filters.reduce((s,o,l)=>s&&Rw(o,i.filters[l]),!0):!1}(n,e):void U()}function Pw(n,e){let t=n.filters.concat(e);return ce.create(t,n.op)}function xw(n){return n instanceof te?function(t){return`${t.field.canonicalString()} ${t.op} ${vi(t.value)}`}(n):n instanceof ce?function(t){return t.op.toString()+" {"+t.getFilters().map(xw).join(" ,")+"}"}(n):"Filter"}var Qd=class extends te{constructor(e,t,r){super(e,t,r),this.key=F.fromName(r.referenceValue)}matches(e){let t=F.comparator(e.key,this.key);return this.matchesComparison(t)}},$d=class extends te{constructor(e,t){super(e,"in",t),this.keys=Nw("in",t)}matches(e){return this.keys.some(t=>t.isEqual(e.key))}},Hd=class extends te{constructor(e,t){super(e,"not-in",t),this.keys=Nw("not-in",t)}matches(e){return!this.keys.some(t=>t.isEqual(e.key))}};function Nw(n,e){var t;return(((t=e.arrayValue)===null||t===void 0?void 0:t.values)||[]).map(r=>F.fromName(r.referenceValue))}var Yd=class extends te{constructor(e,t){super(e,"array-contains",t)}matches(e){let t=e.data.field(this.field);return ho(t)&&co(t.arrayValue,this.value)}},jl=class extends te{constructor(e,t){super(e,"in",t)}matches(e){let t=e.data.field(this.field);return t!==null&&co(this.value.arrayValue,t)}},Jd=class extends te{constructor(e,t){super(e,"not-in",t)}matches(e){if(co(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;let t=e.data.field(this.field);return t!==null&&!co(this.value.arrayValue,t)}},Xd=class extends te{constructor(e,t){super(e,"array-contains-any",t)}matches(e){let t=e.data.field(this.field);return!(!ho(t)||!t.arrayValue.values)&&t.arrayValue.values.some(r=>co(this.value.arrayValue,r))}};var Zd=class{constructor(e,t=null,r=[],i=[],s=null,o=null,l=null){this.path=e,this.collectionGroup=t,this.orderBy=r,this.filters=i,this.limit=s,this.startAt=o,this.endAt=l,this.ue=null}};function ef(n,e=null,t=[],r=[],i=null,s=null,o=null){return new Zd(n,e,t,r,i,s,o)}function _r(n){let e=L(n);if(e.ue===null){let t=e.path.canonicalString();e.collectionGroup!==null&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map(r=>Wd(r)).join(","),t+="|ob:",t+=e.orderBy.map(r=>function(s){return s.field.canonicalString()+s.dir}(r)).join(","),Po(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(r=>vi(r)).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(r=>vi(r)).join(",")),e.ue=t}return e.ue}function xo(n,e){if(n.limit!==e.limit||n.orderBy.length!==e.orderBy.length)return!1;for(let t=0;t<n.orderBy.length;t++)if(!t0(n.orderBy[t],e.orderBy[t]))return!1;if(n.filters.length!==e.filters.length)return!1;for(let t=0;t<n.filters.length;t++)if(!Rw(n.filters[t],e.filters[t]))return!1;return n.collectionGroup===e.collectionGroup&&!!n.path.isEqual(e.path)&&!!Ev(n.startAt,e.startAt)&&Ev(n.endAt,e.endAt)}function zl(n){return F.isDocumentKey(n.path)&&n.collectionGroup===null&&n.filters.length===0}function Kl(n,e){return n.filters.filter(t=>t instanceof te&&t.field.isEqual(e))}function Iv(n,e,t){let r=xl,i=!0;for(let s of Kl(n,e)){let o=xl,l=!0;switch(s.op){case"<":case"<=":o=ZC(s.value);break;case"==":case"in":case">=":o=s.value;break;case">":o=s.value,l=!1;break;case"!=":case"not-in":o=xl}yv({value:r,inclusive:i},{value:o,inclusive:l})<0&&(r=o,i=l)}if(t!==null){for(let s=0;s<n.orderBy.length;++s)if(n.orderBy[s].field.isEqual(e)){let o=t.position[s];yv({value:r,inclusive:i},{value:o,inclusive:t.inclusive})<0&&(r=o,i=t.inclusive);break}}return{value:r,inclusive:i}}function Tv(n,e,t){let r=Nn,i=!0;for(let s of Kl(n,e)){let o=Nn,l=!0;switch(s.op){case">=":case">":o=e0(s.value),l=!1;break;case"==":case"in":case"<=":o=s.value;break;case"<":o=s.value,l=!1;break;case"!=":case"not-in":o=Nn}vv({value:r,inclusive:i},{value:o,inclusive:l})>0&&(r=o,i=l)}if(t!==null){for(let s=0;s<n.orderBy.length;++s)if(n.orderBy[s].field.isEqual(e)){let o=t.position[s];vv({value:r,inclusive:i},{value:o,inclusive:t.inclusive})>0&&(r=o,i=t.inclusive);break}}return{value:r,inclusive:i}}var bt=class{constructor(e,t=null,r=[],i=[],s=null,o="F",l=null,u=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=r,this.filters=i,this.limit=s,this.limitType=o,this.startAt=l,this.endAt=u,this.ce=null,this.le=null,this.he=null,this.startAt,this.endAt}};function Dw(n,e,t,r,i,s,o,l){return new bt(n,e,t,r,i,s,o,l)}function Mi(n){return new bt(n)}function Sv(n){return n.filters.length===0&&n.limit===null&&n.startAt==null&&n.endAt==null&&(n.explicitOrderBy.length===0||n.explicitOrderBy.length===1&&n.explicitOrderBy[0].field.isKeyField())}function Vp(n){return n.collectionGroup!==null}function mi(n){let e=L(n);if(e.ce===null){e.ce=[];let t=new Set;for(let s of e.explicitOrderBy)e.ce.push(s),t.add(s.field.canonicalString());let r=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";(function(o){let l=new fe(Ce.comparator);return o.filters.forEach(u=>{u.getFlattenedFilters().forEach(c=>{c.isInequality()&&(l=l.add(c.field))})}),l})(e).forEach(s=>{t.has(s.canonicalString())||s.isKeyField()||e.ce.push(new gr(s,r))}),t.has(Ce.keyField().canonicalString())||e.ce.push(new gr(Ce.keyField(),r))}return e.ce}function it(n){let e=L(n);return e.le||(e.le=n0(e,mi(n))),e.le}function n0(n,e){if(n.limitType==="F")return ef(n.path,n.collectionGroup,e,n.filters,n.limit,n.startAt,n.endAt);{e=e.map(i=>{let s=i.dir==="desc"?"asc":"desc";return new gr(i.field,s)});let t=n.endAt?new zt(n.endAt.position,n.endAt.inclusive):null,r=n.startAt?new zt(n.startAt.position,n.startAt.inclusive):null;return ef(n.path,n.collectionGroup,e,n.filters,n.limit,t,r)}}function tf(n,e){let t=n.filters.concat([e]);return new bt(n.path,n.collectionGroup,n.explicitOrderBy.slice(),t,n.limit,n.limitType,n.startAt,n.endAt)}function Wl(n,e,t){return new bt(n.path,n.collectionGroup,n.explicitOrderBy.slice(),n.filters.slice(),e,t,n.startAt,n.endAt)}function No(n,e){return xo(it(n),it(e))&&n.limitType===e.limitType}function kw(n){return`${_r(it(n))}|lt:${n.limitType}`}function ui(n){return`Query(target=${function(t){let r=t.path.canonicalString();return t.collectionGroup!==null&&(r+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(r+=`, filters: [${t.filters.map(i=>xw(i)).join(", ")}]`),Po(t.limit)||(r+=", limit: "+t.limit),t.orderBy.length>0&&(r+=`, orderBy: [${t.orderBy.map(i=>function(o){return`${o.field.canonicalString()} (${o.dir})`}(i)).join(", ")}]`),t.startAt&&(r+=", startAt: ",r+=t.startAt.inclusive?"b:":"a:",r+=t.startAt.position.map(i=>vi(i)).join(",")),t.endAt&&(r+=", endAt: ",r+=t.endAt.inclusive?"a:":"b:",r+=t.endAt.position.map(i=>vi(i)).join(",")),`Target(${r})`}(it(n))}; limitType=${n.limitType})`}function Do(n,e){return e.isFoundDocument()&&function(r,i){let s=i.key.path;return r.collectionGroup!==null?i.key.hasCollectionId(r.collectionGroup)&&r.path.isPrefixOf(s):F.isDocumentKey(r.path)?r.path.isEqual(s):r.path.isImmediateParentOf(s)}(n,e)&&function(r,i){for(let s of mi(r))if(!s.field.isKeyField()&&i.data.field(s.field)===null)return!1;return!0}(n,e)&&function(r,i){for(let s of r.filters)if(!s.matches(i))return!1;return!0}(n,e)&&function(r,i){return!(r.startAt&&!function(o,l,u){let c=wv(o,l,u);return o.inclusive?c<=0:c<0}(r.startAt,mi(r),i)||r.endAt&&!function(o,l,u){let c=wv(o,l,u);return o.inclusive?c>=0:c>0}(r.endAt,mi(r),i))}(n,e)}function Vw(n){return n.collectionGroup||(n.path.length%2==1?n.path.lastSegment():n.path.get(n.path.length-2))}function Mw(n){return(e,t)=>{let r=!1;for(let i of mi(n)){let s=r0(i,e,t);if(s!==0)return s;r=r||i.field.isKeyField()}return 0}}function r0(n,e,t){let r=n.field.isKeyField()?F.comparator(e.key,t.key):function(s,o,l){let u=o.data.field(s),c=l.data.field(s);return u!==null&&c!==null?Fn(u,c):U()}(n.field,e,t);switch(n.dir){case"asc":return r;case"desc":return-1*r;default:return U()}}var Kt=class{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){let t=this.mapKeyFn(e),r=this.inner[t];if(r!==void 0){for(let[i,s]of r)if(this.equalsFn(i,e))return s}}has(e){return this.get(e)!==void 0}set(e,t){let r=this.mapKeyFn(e),i=this.inner[r];if(i===void 0)return this.inner[r]=[[e,t]],void this.innerSize++;for(let s=0;s<i.length;s++)if(this.equalsFn(i[s][0],e))return void(i[s]=[e,t]);i.push([e,t]),this.innerSize++}delete(e){let t=this.mapKeyFn(e),r=this.inner[t];if(r===void 0)return!1;for(let i=0;i<r.length;i++)if(this.equalsFn(r[i][0],e))return r.length===1?delete this.inner[t]:r.splice(i,1),this.innerSize--,!0;return!1}forEach(e){Ar(this.inner,(t,r)=>{for(let[i,s]of r)e(i,s)})}isEmpty(){return Tw(this.inner)}size(){return this.innerSize}};var i0=new _e(F.comparator);function at(){return i0}var Ow=new _e(F.comparator);function Zs(...n){let e=Ow;for(let t of n)e=e.insert(t.key,t);return e}function Fw(n){let e=Ow;return n.forEach((t,r)=>e=e.insert(t,r.overlayedDocument)),e}function Ut(){return no()}function Lw(){return no()}function no(){return new Kt(n=>n.toString(),(n,e)=>n.isEqual(e))}var s0=new _e(F.comparator),o0=new fe(F.comparator);function H(...n){let e=o0;for(let t of n)e=e.add(t);return e}var a0=new fe($);function Mp(){return a0}function Uw(n,e){if(n.useProto3Json){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:ao(e)?"-0":e}}function qw(n){return{integerValue:""+n}}function Bw(n,e){return _w(e)?qw(e):Uw(n,e)}var Ei=class{constructor(){this._=void 0}};function l0(n,e,t){return n instanceof Ln?function(i,s){let o={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:i.seconds,nanos:i.nanoseconds}}}};return s&&Nu(s)&&(s=Dp(s)),s&&(o.fields.__previous_value__=s),{mapValue:o}}(t,e):n instanceof rn?jw(n,e):n instanceof sn?zw(n,e):function(i,s){let o=Gw(i,s),l=Av(o)+Av(i.Pe);return zd(o)&&zd(i.Pe)?qw(l):Uw(i.serializer,l)}(n,e)}function u0(n,e,t){return n instanceof rn?jw(n,e):n instanceof sn?zw(n,e):t}function Gw(n,e){return n instanceof Un?function(r){return zd(r)||function(s){return!!s&&"doubleValue"in s}(r)}(e)?e:{integerValue:0}:null}var Ln=class extends Ei{},rn=class extends Ei{constructor(e){super(),this.elements=e}};function jw(n,e){let t=Kw(e);for(let r of n.elements)t.some(i=>jt(i,r))||t.push(r);return{arrayValue:{values:t}}}var sn=class extends Ei{constructor(e){super(),this.elements=e}};function zw(n,e){let t=Kw(e);for(let r of n.elements)t=t.filter(i=>!jt(i,r));return{arrayValue:{values:t}}}var Un=class extends Ei{constructor(e,t){super(),this.serializer=e,this.Pe=t}};function Av(n){return Te(n.integerValue||n.doubleValue)}function Kw(n){return ho(n)&&n.arrayValue.values?n.arrayValue.values.slice():[]}var yr=class{constructor(e,t){this.field=e,this.transform=t}};function c0(n,e){return n.field.isEqual(e.field)&&function(r,i){return r instanceof rn&&i instanceof rn||r instanceof sn&&i instanceof sn?_i(r.elements,i.elements,jt):r instanceof Un&&i instanceof Un?jt(r.Pe,i.Pe):r instanceof Ln&&i instanceof Ln}(n.transform,e.transform)}var nf=class{constructor(e,t){this.version=e,this.transformResults=t}},Se=class n{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new n}static exists(e){return new n(void 0,e)}static updateTime(e){return new n(e)}get isNone(){return this.updateTime===void 0&&this.exists===void 0}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}};function Dl(n,e){return n.updateTime!==void 0?e.isFoundDocument()&&e.version.isEqual(n.updateTime):n.exists===void 0||n.exists===e.isFoundDocument()}var Ii=class{};function Ww(n,e){if(!n.hasLocalMutations||e&&e.fields.length===0)return null;if(e===null)return n.isNoDocument()?new Bn(n.key,Se.none()):new qn(n.key,n.data,Se.none());{let t=n.data,r=Ye.empty(),i=new fe(Ce.comparator);for(let s of e.fields)if(!i.has(s)){let o=t.field(s);o===null&&s.length>1&&(s=s.popLast(),o=t.field(s)),o===null?r.delete(s):r.set(s,o),i=i.add(s)}return new Rt(n.key,r,new pt(i.toArray()),Se.none())}}function h0(n,e,t){n instanceof qn?function(i,s,o){let l=i.value.clone(),u=bv(i.fieldTransforms,s,o.transformResults);l.setAll(u),s.convertToFoundDocument(o.version,l).setHasCommittedMutations()}(n,e,t):n instanceof Rt?function(i,s,o){if(!Dl(i.precondition,s))return void s.convertToUnknownDocument(o.version);let l=bv(i.fieldTransforms,s,o.transformResults),u=s.data;u.setAll(Qw(i)),u.setAll(l),s.convertToFoundDocument(o.version,u).setHasCommittedMutations()}(n,e,t):function(i,s,o){s.convertToNoDocument(o.version).setHasCommittedMutations()}(0,e,t)}function ro(n,e,t,r){return n instanceof qn?function(s,o,l,u){if(!Dl(s.precondition,o))return l;let c=s.value.clone(),d=Rv(s.fieldTransforms,u,o);return c.setAll(d),o.convertToFoundDocument(o.version,c).setHasLocalMutations(),null}(n,e,t,r):n instanceof Rt?function(s,o,l,u){if(!Dl(s.precondition,o))return l;let c=Rv(s.fieldTransforms,u,o),d=o.data;return d.setAll(Qw(s)),d.setAll(c),o.convertToFoundDocument(o.version,d).setHasLocalMutations(),l===null?null:l.unionWith(s.fieldMask.fields).unionWith(s.fieldTransforms.map(p=>p.field))}(n,e,t,r):function(s,o,l){return Dl(s.precondition,o)?(o.convertToNoDocument(o.version).setHasLocalMutations(),null):l}(n,e,t)}function d0(n,e){let t=null;for(let r of n.fieldTransforms){let i=e.data.field(r.field),s=Gw(r.transform,i||null);s!=null&&(t===null&&(t=Ye.empty()),t.set(r.field,s))}return t||null}function Cv(n,e){return n.type===e.type&&!!n.key.isEqual(e.key)&&!!n.precondition.isEqual(e.precondition)&&!!function(r,i){return r===void 0&&i===void 0||!(!r||!i)&&_i(r,i,(s,o)=>c0(s,o))}(n.fieldTransforms,e.fieldTransforms)&&(n.type===0?n.value.isEqual(e.value):n.type!==1||n.data.isEqual(e.data)&&n.fieldMask.isEqual(e.fieldMask))}var qn=class extends Ii{constructor(e,t,r,i=[]){super(),this.key=e,this.value=t,this.precondition=r,this.fieldTransforms=i,this.type=0}getFieldMask(){return null}},Rt=class extends Ii{constructor(e,t,r,i,s=[]){super(),this.key=e,this.data=t,this.fieldMask=r,this.precondition=i,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}};function Qw(n){let e=new Map;return n.fieldMask.fields.forEach(t=>{if(!t.isEmpty()){let r=n.data.field(t);e.set(t,r)}}),e}function bv(n,e,t){let r=new Map;G(n.length===t.length);for(let i=0;i<t.length;i++){let s=n[i],o=s.transform,l=e.data.field(s.field);r.set(s.field,u0(o,l,t[i]))}return r}function Rv(n,e,t){let r=new Map;for(let i of n){let s=i.transform,o=t.data.field(i.field);r.set(i.field,l0(s,o,e))}return r}var Bn=class extends Ii{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}},fo=class extends Ii{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}};var po=class{constructor(e,t,r,i){this.batchId=e,this.localWriteTime=t,this.baseMutations=r,this.mutations=i}applyToRemoteDocument(e,t){let r=t.mutationResults;for(let i=0;i<this.mutations.length;i++){let s=this.mutations[i];s.key.isEqual(e.key)&&h0(s,e,r[i])}}applyToLocalView(e,t){for(let r of this.baseMutations)r.key.isEqual(e.key)&&(t=ro(r,e,t,this.localWriteTime));for(let r of this.mutations)r.key.isEqual(e.key)&&(t=ro(r,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){let r=Lw();return this.mutations.forEach(i=>{let s=e.get(i.key),o=s.overlayedDocument,l=this.applyToLocalView(o,s.mutatedFields);l=t.has(i.key)?null:l;let u=Ww(o,l);u!==null&&r.set(i.key,u),o.isValidDocument()||o.convertToNoDocument(z.min())}),r}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),H())}isEqual(e){return this.batchId===e.batchId&&_i(this.mutations,e.mutations,(t,r)=>Cv(t,r))&&_i(this.baseMutations,e.baseMutations,(t,r)=>Cv(t,r))}},rf=class n{constructor(e,t,r,i){this.batch=e,this.commitVersion=t,this.mutationResults=r,this.docVersions=i}static from(e,t,r){G(e.mutations.length===r.length);let i=function(){return s0}(),s=e.mutations;for(let o=0;o<s.length;o++)i=i.insert(s[o].key,r[o].version);return new n(e,t,r,i)}};var mo=class{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return e!==null&&this.mutation===e.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}};var sf=class{constructor(e,t){this.count=e,this.unchangedNames=t}};var Pe,ie;function $w(n){switch(n){default:return U();case P.CANCELLED:case P.UNKNOWN:case P.DEADLINE_EXCEEDED:case P.RESOURCE_EXHAUSTED:case P.INTERNAL:case P.UNAVAILABLE:case P.UNAUTHENTICATED:return!1;case P.INVALID_ARGUMENT:case P.NOT_FOUND:case P.ALREADY_EXISTS:case P.PERMISSION_DENIED:case P.FAILED_PRECONDITION:case P.ABORTED:case P.OUT_OF_RANGE:case P.UNIMPLEMENTED:case P.DATA_LOSS:return!0}}function Hw(n){if(n===void 0)return Ae("GRPC error has no .code"),P.UNKNOWN;switch(n){case Pe.OK:return P.OK;case Pe.CANCELLED:return P.CANCELLED;case Pe.UNKNOWN:return P.UNKNOWN;case Pe.DEADLINE_EXCEEDED:return P.DEADLINE_EXCEEDED;case Pe.RESOURCE_EXHAUSTED:return P.RESOURCE_EXHAUSTED;case Pe.INTERNAL:return P.INTERNAL;case Pe.UNAVAILABLE:return P.UNAVAILABLE;case Pe.UNAUTHENTICATED:return P.UNAUTHENTICATED;case Pe.INVALID_ARGUMENT:return P.INVALID_ARGUMENT;case Pe.NOT_FOUND:return P.NOT_FOUND;case Pe.ALREADY_EXISTS:return P.ALREADY_EXISTS;case Pe.PERMISSION_DENIED:return P.PERMISSION_DENIED;case Pe.FAILED_PRECONDITION:return P.FAILED_PRECONDITION;case Pe.ABORTED:return P.ABORTED;case Pe.OUT_OF_RANGE:return P.OUT_OF_RANGE;case Pe.UNIMPLEMENTED:return P.UNIMPLEMENTED;case Pe.DATA_LOSS:return P.DATA_LOSS;default:return U()}}(ie=Pe||(Pe={}))[ie.OK=0]="OK",ie[ie.CANCELLED=1]="CANCELLED",ie[ie.UNKNOWN=2]="UNKNOWN",ie[ie.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",ie[ie.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",ie[ie.NOT_FOUND=5]="NOT_FOUND",ie[ie.ALREADY_EXISTS=6]="ALREADY_EXISTS",ie[ie.PERMISSION_DENIED=7]="PERMISSION_DENIED",ie[ie.UNAUTHENTICATED=16]="UNAUTHENTICATED",ie[ie.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",ie[ie.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",ie[ie.ABORTED=10]="ABORTED",ie[ie.OUT_OF_RANGE=11]="OUT_OF_RANGE",ie[ie.UNIMPLEMENTED=12]="UNIMPLEMENTED",ie[ie.INTERNAL=13]="INTERNAL",ie[ie.UNAVAILABLE=14]="UNAVAILABLE",ie[ie.DATA_LOSS=15]="DATA_LOSS";var Pv=null;function Yw(){return new TextEncoder}var f0=new Cn([4294967295,4294967295],0);function xv(n){let e=Yw().encode(n),t=new vd;return t.update(e),new Uint8Array(t.digest())}function Nv(n){let e=new DataView(n.buffer),t=e.getUint32(0,!0),r=e.getUint32(4,!0),i=e.getUint32(8,!0),s=e.getUint32(12,!0);return[new Cn([t,r],0),new Cn([i,s],0)]}var of=class n{constructor(e,t,r){if(this.bitmap=e,this.padding=t,this.hashCount=r,t<0||t>=8)throw new dr(`Invalid padding: ${t}`);if(r<0)throw new dr(`Invalid hash count: ${r}`);if(e.length>0&&this.hashCount===0)throw new dr(`Invalid hash count: ${r}`);if(e.length===0&&t!==0)throw new dr(`Invalid padding when bitmap length is 0: ${t}`);this.Ie=8*e.length-t,this.Te=Cn.fromNumber(this.Ie)}Ee(e,t,r){let i=e.add(t.multiply(Cn.fromNumber(r)));return i.compare(f0)===1&&(i=new Cn([i.getBits(0),i.getBits(1)],0)),i.modulo(this.Te).toNumber()}de(e){return(this.bitmap[Math.floor(e/8)]&1<<e%8)!=0}mightContain(e){if(this.Ie===0)return!1;let t=xv(e),[r,i]=Nv(t);for(let s=0;s<this.hashCount;s++){let o=this.Ee(r,i,s);if(!this.de(o))return!1}return!0}static create(e,t,r){let i=e%8==0?0:8-e%8,s=new Uint8Array(Math.ceil(e/8)),o=new n(s,i,t);return r.forEach(l=>o.insert(l)),o}insert(e){if(this.Ie===0)return;let t=xv(e),[r,i]=Nv(t);for(let s=0;s<this.hashCount;s++){let o=this.Ee(r,i,s);this.Ae(o)}}Ae(e){let t=Math.floor(e/8),r=e%8;this.bitmap[t]|=1<<r}},dr=class extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}};var go=class n{constructor(e,t,r,i,s){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=r,this.documentUpdates=i,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(e,t,r){let i=new Map;return i.set(e,_o.createSynthesizedTargetChangeForCurrentChange(e,t,r)),new n(z.min(),i,new _e($),at(),H())}},_o=class n{constructor(e,t,r,i,s){this.resumeToken=e,this.current=t,this.addedDocuments=r,this.modifiedDocuments=i,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(e,t,r){return new n(r,t,H(),H(),H())}};var gi=class{constructor(e,t,r,i){this.Re=e,this.removedTargetIds=t,this.key=r,this.Ve=i}},Ql=class{constructor(e,t){this.targetId=e,this.me=t}},$l=class{constructor(e,t,r=qe.EMPTY_BYTE_STRING,i=null){this.state=e,this.targetIds=t,this.resumeToken=r,this.cause=i}},Hl=class{constructor(){this.fe=0,this.ge=kv(),this.pe=qe.EMPTY_BYTE_STRING,this.ye=!1,this.we=!0}get current(){return this.ye}get resumeToken(){return this.pe}get Se(){return this.fe!==0}get be(){return this.we}De(e){e.approximateByteSize()>0&&(this.we=!0,this.pe=e)}Ce(){let e=H(),t=H(),r=H();return this.ge.forEach((i,s)=>{switch(s){case 0:e=e.add(i);break;case 2:t=t.add(i);break;case 1:r=r.add(i);break;default:U()}}),new _o(this.pe,this.ye,e,t,r)}ve(){this.we=!1,this.ge=kv()}Fe(e,t){this.we=!0,this.ge=this.ge.insert(e,t)}Me(e){this.we=!0,this.ge=this.ge.remove(e)}xe(){this.fe+=1}Oe(){this.fe-=1,G(this.fe>=0)}Ne(){this.we=!0,this.ye=!0}},af=class{constructor(e){this.Le=e,this.Be=new Map,this.ke=at(),this.qe=Dv(),this.Qe=new _e($)}Ke(e){for(let t of e.Re)e.Ve&&e.Ve.isFoundDocument()?this.$e(t,e.Ve):this.Ue(t,e.key,e.Ve);for(let t of e.removedTargetIds)this.Ue(t,e.key,e.Ve)}We(e){this.forEachTarget(e,t=>{let r=this.Ge(t);switch(e.state){case 0:this.ze(t)&&r.De(e.resumeToken);break;case 1:r.Oe(),r.Se||r.ve(),r.De(e.resumeToken);break;case 2:r.Oe(),r.Se||this.removeTarget(t);break;case 3:this.ze(t)&&(r.Ne(),r.De(e.resumeToken));break;case 4:this.ze(t)&&(this.je(t),r.De(e.resumeToken));break;default:U()}})}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.Be.forEach((r,i)=>{this.ze(i)&&t(i)})}He(e){let t=e.targetId,r=e.me.count,i=this.Je(t);if(i){let s=i.target;if(zl(s))if(r===0){let o=new F(s.path);this.Ue(t,o,ke.newNoDocument(o,z.min()))}else G(r===1);else{let o=this.Ye(t);if(o!==r){let l=this.Ze(e),u=l?this.Xe(l,e,o):1;if(u!==0){this.je(t);let c=u===2?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Qe=this.Qe.insert(t,c)}Pv?.et(function(d,p,m,v,C){var N,D,B,j,q,Y;let ne={localCacheCount:d,existenceFilterCount:p.count,databaseId:m.database,projectId:m.projectId},W=p.unchangedNames;return W&&(ne.bloomFilter={applied:C===0,hashCount:(N=W?.hashCount)!==null&&N!==void 0?N:0,bitmapLength:(j=(B=(D=W?.bits)===null||D===void 0?void 0:D.bitmap)===null||B===void 0?void 0:B.length)!==null&&j!==void 0?j:0,padding:(Y=(q=W?.bits)===null||q===void 0?void 0:q.padding)!==null&&Y!==void 0?Y:0,mightContain:E=>{var _;return(_=v?.mightContain(E))!==null&&_!==void 0&&_}}),ne}(o,e.me,this.Le.tt(),l,u))}}}}Ze(e){let t=e.me.unchangedNames;if(!t||!t.bits)return null;let{bits:{bitmap:r="",padding:i=0},hashCount:s=0}=t,o,l;try{o=Mn(r).toUint8Array()}catch(u){if(u instanceof Bl)return Et("Decoding the base64 bloom filter in existence filter failed ("+u.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw u}try{l=new of(o,i,s)}catch(u){return Et(u instanceof dr?"BloomFilter error: ":"Applying bloom filter failed: ",u),null}return l.Ie===0?null:l}Xe(e,t,r){return t.me.count===r-this.nt(e,t.targetId)?0:2}nt(e,t){let r=this.Le.getRemoteKeysForTarget(t),i=0;return r.forEach(s=>{let o=this.Le.tt(),l=`projects/${o.projectId}/databases/${o.database}/documents/${s.path.canonicalString()}`;e.mightContain(l)||(this.Ue(t,s,null),i++)}),i}rt(e){let t=new Map;this.Be.forEach((s,o)=>{let l=this.Je(o);if(l){if(s.current&&zl(l.target)){let u=new F(l.target.path);this.ke.get(u)!==null||this.it(o,u)||this.Ue(o,u,ke.newNoDocument(u,e))}s.be&&(t.set(o,s.Ce()),s.ve())}});let r=H();this.qe.forEach((s,o)=>{let l=!0;o.forEachWhile(u=>{let c=this.Je(u);return!c||c.purpose==="TargetPurposeLimboResolution"||(l=!1,!1)}),l&&(r=r.add(s))}),this.ke.forEach((s,o)=>o.setReadTime(e));let i=new go(e,t,this.Qe,this.ke,r);return this.ke=at(),this.qe=Dv(),this.Qe=new _e($),i}$e(e,t){if(!this.ze(e))return;let r=this.it(e,t.key)?2:0;this.Ge(e).Fe(t.key,r),this.ke=this.ke.insert(t.key,t),this.qe=this.qe.insert(t.key,this.st(t.key).add(e))}Ue(e,t,r){if(!this.ze(e))return;let i=this.Ge(e);this.it(e,t)?i.Fe(t,1):i.Me(t),this.qe=this.qe.insert(t,this.st(t).delete(e)),r&&(this.ke=this.ke.insert(t,r))}removeTarget(e){this.Be.delete(e)}Ye(e){let t=this.Ge(e).Ce();return this.Le.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}xe(e){this.Ge(e).xe()}Ge(e){let t=this.Be.get(e);return t||(t=new Hl,this.Be.set(e,t)),t}st(e){let t=this.qe.get(e);return t||(t=new fe($),this.qe=this.qe.insert(e,t)),t}ze(e){let t=this.Je(e)!==null;return t||V("WatchChangeAggregator","Detected inactive target",e),t}Je(e){let t=this.Be.get(e);return t&&t.Se?null:this.Le.ot(e)}je(e){this.Be.set(e,new Hl),this.Le.getRemoteKeysForTarget(e).forEach(t=>{this.Ue(e,t,null)})}it(e,t){return this.Le.getRemoteKeysForTarget(e).has(t)}};function Dv(){return new _e(F.comparator)}function kv(){return new _e(F.comparator)}var p0={asc:"ASCENDING",desc:"DESCENDING"},m0={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},g0={and:"AND",or:"OR"},lf=class{constructor(e,t){this.databaseId=e,this.useProto3Json=t}};function uf(n,e){return n.useProto3Json||Po(e)?e:{value:e}}function Ti(n,e){return n.useProto3Json?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function Jw(n,e){return n.useProto3Json?e.toBase64():e.toUint8Array()}function _0(n,e){return Ti(n,e.toTimestamp())}function be(n){return G(!!n),z.fromTimestamp(function(t){let r=nn(t);return new Ee(r.seconds,r.nanos)}(n))}function Op(n,e){return cf(n,e).canonicalString()}function cf(n,e){let t=function(i){return new se(["projects",i.projectId,"databases",i.database])}(n).child("documents");return e===void 0?t:t.child(e)}function Xw(n){let e=se.fromString(n);return G(lE(e)),e}function yo(n,e){return Op(n.databaseId,e.path)}function Bt(n,e){let t=Xw(e);if(t.get(1)!==n.databaseId.projectId)throw new k(P.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+t.get(1)+" vs "+n.databaseId.projectId);if(t.get(3)!==n.databaseId.database)throw new k(P.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+t.get(3)+" vs "+n.databaseId.database);return new F(tE(t))}function Zw(n,e){return Op(n.databaseId,e)}function eE(n){let e=Xw(n);return e.length===4?se.emptyPath():tE(e)}function hf(n){return new se(["projects",n.databaseId.projectId,"databases",n.databaseId.database]).canonicalString()}function tE(n){return G(n.length>4&&n.get(4)==="documents"),n.popFirst(5)}function Vv(n,e,t){return{name:yo(n,e),fields:t.value.mapValue.fields}}function nE(n,e,t){let r=Bt(n,e.name),i=be(e.updateTime),s=e.createTime?be(e.createTime):z.min(),o=new Ye({mapValue:{fields:e.fields}}),l=ke.newFoundDocument(r,i,s,o);return t&&l.setHasCommittedMutations(),t?l.setHasCommittedMutations():l}function y0(n,e){return"found"in e?function(r,i){G(!!i.found),i.found.name,i.found.updateTime;let s=Bt(r,i.found.name),o=be(i.found.updateTime),l=i.found.createTime?be(i.found.createTime):z.min(),u=new Ye({mapValue:{fields:i.found.fields}});return ke.newFoundDocument(s,o,l,u)}(n,e):"missing"in e?function(r,i){G(!!i.missing),G(!!i.readTime);let s=Bt(r,i.missing),o=be(i.readTime);return ke.newNoDocument(s,o)}(n,e):U()}function v0(n,e){let t;if("targetChange"in e){e.targetChange;let r=function(c){return c==="NO_CHANGE"?0:c==="ADD"?1:c==="REMOVE"?2:c==="CURRENT"?3:c==="RESET"?4:U()}(e.targetChange.targetChangeType||"NO_CHANGE"),i=e.targetChange.targetIds||[],s=function(c,d){return c.useProto3Json?(G(d===void 0||typeof d=="string"),qe.fromBase64String(d||"")):(G(d===void 0||d instanceof Buffer||d instanceof Uint8Array),qe.fromUint8Array(d||new Uint8Array))}(n,e.targetChange.resumeToken),o=e.targetChange.cause,l=o&&function(c){let d=c.code===void 0?P.UNKNOWN:Hw(c.code);return new k(d,c.message||"")}(o);t=new $l(r,i,s,l||null)}else if("documentChange"in e){e.documentChange;let r=e.documentChange;r.document,r.document.name,r.document.updateTime;let i=Bt(n,r.document.name),s=be(r.document.updateTime),o=r.document.createTime?be(r.document.createTime):z.min(),l=new Ye({mapValue:{fields:r.document.fields}}),u=ke.newFoundDocument(i,s,o,l),c=r.targetIds||[],d=r.removedTargetIds||[];t=new gi(c,d,u.key,u)}else if("documentDelete"in e){e.documentDelete;let r=e.documentDelete;r.document;let i=Bt(n,r.document),s=r.readTime?be(r.readTime):z.min(),o=ke.newNoDocument(i,s),l=r.removedTargetIds||[];t=new gi([],l,o.key,o)}else if("documentRemove"in e){e.documentRemove;let r=e.documentRemove;r.document;let i=Bt(n,r.document),s=r.removedTargetIds||[];t=new gi([],s,i,null)}else{if(!("filter"in e))return U();{e.filter;let r=e.filter;r.targetId;let{count:i=0,unchangedNames:s}=r,o=new sf(i,s),l=r.targetId;t=new Ql(l,o)}}return t}function vo(n,e){let t;if(e instanceof qn)t={update:Vv(n,e.key,e.value)};else if(e instanceof Bn)t={delete:yo(n,e.key)};else if(e instanceof Rt)t={update:Vv(n,e.key,e.data),updateMask:A0(e.fieldMask)};else{if(!(e instanceof fo))return U();t={verify:yo(n,e.key)}}return e.fieldTransforms.length>0&&(t.updateTransforms=e.fieldTransforms.map(r=>function(s,o){let l=o.transform;if(l instanceof Ln)return{fieldPath:o.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(l instanceof rn)return{fieldPath:o.field.canonicalString(),appendMissingElements:{values:l.elements}};if(l instanceof sn)return{fieldPath:o.field.canonicalString(),removeAllFromArray:{values:l.elements}};if(l instanceof Un)return{fieldPath:o.field.canonicalString(),increment:l.Pe};throw U()}(0,r))),e.precondition.isNone||(t.currentDocument=function(i,s){return s.updateTime!==void 0?{updateTime:_0(i,s.updateTime)}:s.exists!==void 0?{exists:s.exists}:U()}(n,e.precondition)),t}function df(n,e){let t=e.currentDocument?function(s){return s.updateTime!==void 0?Se.updateTime(be(s.updateTime)):s.exists!==void 0?Se.exists(s.exists):Se.none()}(e.currentDocument):Se.none(),r=e.updateTransforms?e.updateTransforms.map(i=>function(o,l){let u=null;if("setToServerValue"in l)G(l.setToServerValue==="REQUEST_TIME"),u=new Ln;else if("appendMissingElements"in l){let d=l.appendMissingElements.values||[];u=new rn(d)}else if("removeAllFromArray"in l){let d=l.removeAllFromArray.values||[];u=new sn(d)}else"increment"in l?u=new Un(o,l.increment):U();let c=Ce.fromServerFormat(l.fieldPath);return new yr(c,u)}(n,i)):[];if(e.update){e.update.name;let i=Bt(n,e.update.name),s=new Ye({mapValue:{fields:e.update.fields}});if(e.updateMask){let o=function(u){let c=u.fieldPaths||[];return new pt(c.map(d=>Ce.fromServerFormat(d)))}(e.updateMask);return new Rt(i,s,o,t,r)}return new qn(i,s,t,r)}if(e.delete){let i=Bt(n,e.delete);return new Bn(i,t)}if(e.verify){let i=Bt(n,e.verify);return new fo(i,t)}return U()}function w0(n,e){return n&&n.length>0?(G(e!==void 0),n.map(t=>function(i,s){let o=i.updateTime?be(i.updateTime):be(s);return o.isEqual(z.min())&&(o=be(s)),new nf(o,i.transformResults||[])}(t,e))):[]}function rE(n,e){return{documents:[Zw(n,e.path)]}}function iE(n,e){let t={structuredQuery:{}},r=e.path,i;e.collectionGroup!==null?(i=r,t.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(i=r.popLast(),t.structuredQuery.from=[{collectionId:r.lastSegment()}]),t.parent=Zw(n,i);let s=function(c){if(c.length!==0)return aE(ce.create(c,"and"))}(e.filters);s&&(t.structuredQuery.where=s);let o=function(c){if(c.length!==0)return c.map(d=>function(m){return{field:ci(m.field),direction:I0(m.dir)}}(d))}(e.orderBy);o&&(t.structuredQuery.orderBy=o);let l=uf(n,e.limit);return l!==null&&(t.structuredQuery.limit=l),e.startAt&&(t.structuredQuery.startAt=function(c){return{before:c.inclusive,values:c.position}}(e.startAt)),e.endAt&&(t.structuredQuery.endAt=function(c){return{before:!c.inclusive,values:c.position}}(e.endAt)),{_t:t,parent:i}}function sE(n){let e=eE(n.parent),t=n.structuredQuery,r=t.from?t.from.length:0,i=null;if(r>0){G(r===1);let d=t.from[0];d.allDescendants?i=d.collectionId:e=e.child(d.collectionId)}let s=[];t.where&&(s=function(p){let m=oE(p);return m instanceof ce&&kp(m)?m.getFilters():[m]}(t.where));let o=[];t.orderBy&&(o=function(p){return p.map(m=>function(C){return new gr(hi(C.field),function(D){switch(D){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(C.direction))}(m))}(t.orderBy));let l=null;t.limit&&(l=function(p){let m;return m=typeof p=="object"?p.value:p,Po(m)?null:m}(t.limit));let u=null;t.startAt&&(u=function(p){let m=!!p.before,v=p.values||[];return new zt(v,m)}(t.startAt));let c=null;return t.endAt&&(c=function(p){let m=!p.before,v=p.values||[];return new zt(v,m)}(t.endAt)),Dw(e,i,o,s,l,"F",u,c)}function E0(n,e){let t=function(i){switch(i){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return U()}}(e.purpose);return t==null?null:{"goog-listen-tags":t}}function oE(n){return n.unaryFilter!==void 0?function(t){switch(t.unaryFilter.op){case"IS_NAN":let r=hi(t.unaryFilter.field);return te.create(r,"==",{doubleValue:NaN});case"IS_NULL":let i=hi(t.unaryFilter.field);return te.create(i,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":let s=hi(t.unaryFilter.field);return te.create(s,"!=",{doubleValue:NaN});case"IS_NOT_NULL":let o=hi(t.unaryFilter.field);return te.create(o,"!=",{nullValue:"NULL_VALUE"});default:return U()}}(n):n.fieldFilter!==void 0?function(t){return te.create(hi(t.fieldFilter.field),function(i){switch(i){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return U()}}(t.fieldFilter.op),t.fieldFilter.value)}(n):n.compositeFilter!==void 0?function(t){return ce.create(t.compositeFilter.filters.map(r=>oE(r)),function(i){switch(i){case"AND":return"and";case"OR":return"or";default:return U()}}(t.compositeFilter.op))}(n):U()}function I0(n){return p0[n]}function T0(n){return m0[n]}function S0(n){return g0[n]}function ci(n){return{fieldPath:n.canonicalString()}}function hi(n){return Ce.fromServerFormat(n.fieldPath)}function aE(n){return n instanceof te?function(t){if(t.op==="=="){if(_v(t.value))return{unaryFilter:{field:ci(t.field),op:"IS_NAN"}};if(gv(t.value))return{unaryFilter:{field:ci(t.field),op:"IS_NULL"}}}else if(t.op==="!="){if(_v(t.value))return{unaryFilter:{field:ci(t.field),op:"IS_NOT_NAN"}};if(gv(t.value))return{unaryFilter:{field:ci(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:ci(t.field),op:T0(t.op),value:t.value}}}(n):n instanceof ce?function(t){let r=t.getFilters().map(i=>aE(i));return r.length===1?r[0]:{compositeFilter:{op:S0(t.op),filters:r}}}(n):U()}function A0(n){let e=[];return n.fields.forEach(t=>e.push(t.canonicalString())),{fieldPaths:e}}function lE(n){return n.length>=4&&n.get(0)==="projects"&&n.get(2)==="databases"}var Si=class n{constructor(e,t,r,i,s=z.min(),o=z.min(),l=qe.EMPTY_BYTE_STRING,u=null){this.target=e,this.targetId=t,this.purpose=r,this.sequenceNumber=i,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=o,this.resumeToken=l,this.expectedCount=u}withSequenceNumber(e){return new n(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new n(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new n(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new n(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}};var Yl=class{constructor(e){this.ct=e}};function C0(n,e){let t;if(e.document)t=nE(n.ct,e.document,!!e.hasCommittedMutations);else if(e.noDocument){let r=F.fromSegments(e.noDocument.path),i=wr(e.noDocument.readTime);t=ke.newNoDocument(r,i),e.hasCommittedMutations&&t.setHasCommittedMutations()}else{if(!e.unknownDocument)return U();{let r=F.fromSegments(e.unknownDocument.path),i=wr(e.unknownDocument.version);t=ke.newUnknownDocument(r,i)}}return e.readTime&&t.setReadTime(function(i){let s=new Ee(i[0],i[1]);return z.fromTimestamp(s)}(e.readTime)),t}function Mv(n,e){let t=e.key,r={prefixPath:t.getCollectionPath().popLast().toArray(),collectionGroup:t.collectionGroup,documentId:t.path.lastSegment(),readTime:Jl(e.readTime),hasCommittedMutations:e.hasCommittedMutations};if(e.isFoundDocument())r.document=function(s,o){return{name:yo(s,o.key),fields:o.data.value.mapValue.fields,updateTime:Ti(s,o.version.toTimestamp()),createTime:Ti(s,o.createTime.toTimestamp())}}(n.ct,e);else if(e.isNoDocument())r.noDocument={path:t.path.toArray(),readTime:vr(e.version)};else{if(!e.isUnknownDocument())return U();r.unknownDocument={path:t.path.toArray(),version:vr(e.version)}}return r}function Jl(n){let e=n.toTimestamp();return[e.seconds,e.nanoseconds]}function vr(n){let e=n.toTimestamp();return{seconds:e.seconds,nanoseconds:e.nanoseconds}}function wr(n){let e=new Ee(n.seconds,n.nanoseconds);return z.fromTimestamp(e)}function ur(n,e){let t=(e.baseMutations||[]).map(s=>df(n.ct,s));for(let s=0;s<e.mutations.length-1;++s){let o=e.mutations[s];if(s+1<e.mutations.length&&e.mutations[s+1].transform!==void 0){let l=e.mutations[s+1];o.updateTransforms=l.transform.fieldTransforms,e.mutations.splice(s+1,1),++s}}let r=e.mutations.map(s=>df(n.ct,s)),i=Ee.fromMillis(e.localWriteTimeMs);return new po(e.batchId,i,t,r)}function eo(n){let e=wr(n.readTime),t=n.lastLimboFreeSnapshotVersion!==void 0?wr(n.lastLimboFreeSnapshotVersion):z.min(),r;return r=function(s){return s.documents!==void 0}(n.query)?function(s){return G(s.documents.length===1),it(Mi(eE(s.documents[0])))}(n.query):function(s){return it(sE(s))}(n.query),new Si(r,n.targetId,"TargetPurposeListen",n.lastListenSequenceNumber,e,t,qe.fromBase64String(n.resumeToken))}function uE(n,e){let t=vr(e.snapshotVersion),r=vr(e.lastLimboFreeSnapshotVersion),i;i=zl(e.target)?rE(n.ct,e.target):iE(n.ct,e.target)._t;let s=e.resumeToken.toBase64();return{targetId:e.targetId,canonicalId:_r(e.target),readTime:t,resumeToken:s,lastListenSequenceNumber:e.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:i}}function Fp(n){let e=sE({parent:n.parent,structuredQuery:n.structuredQuery});return n.limitType==="LAST"?Wl(e,e.limit,"L"):e}function Cd(n,e){return new mo(e.largestBatchId,df(n.ct,e.overlayMutation))}function Ov(n,e){let t=e.path.lastSegment();return[n,rt(e.path.popLast()),t]}function Fv(n,e,t,r){return{indexId:n,uid:e,sequenceNumber:t,readTime:vr(r.readTime),documentKey:rt(r.documentKey.path),largestBatchId:r.largestBatchId}}var ff=class{getBundleMetadata(e,t){return Lv(e).get(t).next(r=>{if(r)return function(s){return{id:s.bundleId,createTime:wr(s.createTime),version:s.version}}(r)})}saveBundleMetadata(e,t){return Lv(e).put(function(i){return{bundleId:i.id,createTime:vr(be(i.createTime)),version:i.version}}(t))}getNamedQuery(e,t){return Uv(e).get(t).next(r=>{if(r)return function(s){return{name:s.name,query:Fp(s.bundledQuery),readTime:wr(s.readTime)}}(r)})}saveNamedQuery(e,t){return Uv(e).put(function(i){return{name:i.name,readTime:vr(be(i.readTime)),bundledQuery:i.bundledQuery}}(t))}};function Lv(n){return Be(n,"bundles")}function Uv(n){return Be(n,"namedQueries")}var Xl=class n{constructor(e,t){this.serializer=e,this.userId=t}static lt(e,t){let r=t.uid||"";return new n(e,r)}getOverlay(e,t){return Hs(e).get(Ov(this.userId,t)).next(r=>r?Cd(this.serializer,r):null)}getOverlays(e,t){let r=Ut();return b.forEach(t,i=>this.getOverlay(e,i).next(s=>{s!==null&&r.set(i,s)})).next(()=>r)}saveOverlays(e,t,r){let i=[];return r.forEach((s,o)=>{let l=new mo(t,o);i.push(this.ht(e,l))}),b.waitFor(i)}removeOverlaysForBatchId(e,t,r){let i=new Set;t.forEach(o=>i.add(rt(o.getCollectionPath())));let s=[];return i.forEach(o=>{let l=IDBKeyRange.bound([this.userId,o,r],[this.userId,o,r+1],!1,!0);s.push(Hs(e).j("collectionPathOverlayIndex",l))}),b.waitFor(s)}getOverlaysForCollection(e,t,r){let i=Ut(),s=rt(t),o=IDBKeyRange.bound([this.userId,s,r],[this.userId,s,Number.POSITIVE_INFINITY],!0);return Hs(e).U("collectionPathOverlayIndex",o).next(l=>{for(let u of l){let c=Cd(this.serializer,u);i.set(c.getKey(),c)}return i})}getOverlaysForCollectionGroup(e,t,r,i){let s=Ut(),o,l=IDBKeyRange.bound([this.userId,t,r],[this.userId,t,Number.POSITIVE_INFINITY],!0);return Hs(e).J({index:"collectionGroupOverlayIndex",range:l},(u,c,d)=>{let p=Cd(this.serializer,c);s.size()<i||p.largestBatchId===o?(s.set(p.getKey(),p),o=p.largestBatchId):d.done()}).next(()=>s)}ht(e,t){return Hs(e).put(function(i,s,o){let[l,u,c]=Ov(s,o.mutation.key);return{userId:s,collectionPath:u,documentId:c,collectionGroup:o.mutation.key.getCollectionGroup(),largestBatchId:o.largestBatchId,overlayMutation:vo(i.ct,o.mutation)}}(this.serializer,this.userId,t))}};function Hs(n){return Be(n,"documentOverlays")}var en=class{constructor(){}Pt(e,t){this.It(e,t),t.Tt()}It(e,t){if("nullValue"in e)this.Et(t,5);else if("booleanValue"in e)this.Et(t,10),t.dt(e.booleanValue?1:0);else if("integerValue"in e)this.Et(t,15),t.dt(Te(e.integerValue));else if("doubleValue"in e){let r=Te(e.doubleValue);isNaN(r)?this.Et(t,13):(this.Et(t,15),ao(r)?t.dt(0):t.dt(r))}else if("timestampValue"in e){let r=e.timestampValue;this.Et(t,20),typeof r=="string"&&(r=nn(r)),t.At(`${r.seconds||""}`),t.dt(r.nanos||0)}else if("stringValue"in e)this.Rt(e.stringValue,t),this.Vt(t);else if("bytesValue"in e)this.Et(t,30),t.ft(Mn(e.bytesValue)),this.Vt(t);else if("referenceValue"in e)this.gt(e.referenceValue,t);else if("geoPointValue"in e){let r=e.geoPointValue;this.Et(t,45),t.dt(r.latitude||0),t.dt(r.longitude||0)}else"mapValue"in e?Aw(e)?this.Et(t,Number.MAX_SAFE_INTEGER):(this.yt(e.mapValue,t),this.Vt(t)):"arrayValue"in e?(this.wt(e.arrayValue,t),this.Vt(t)):U()}Rt(e,t){this.Et(t,25),this.St(e,t)}St(e,t){t.At(e)}yt(e,t){let r=e.fields||{};this.Et(t,55);for(let i of Object.keys(r))this.Rt(i,t),this.It(r[i],t)}wt(e,t){let r=e.values||[];this.Et(t,50);for(let i of r)this.It(i,t)}gt(e,t){this.Et(t,37),F.fromName(e).path.forEach(r=>{this.Et(t,60),this.St(r,t)})}Et(e,t){e.dt(t)}Vt(e){e.dt(2)}};en.bt=new en;function b0(n){if(n===0)return 8;let e=0;return!(n>>4)&&(e+=4,n<<=4),!(n>>6)&&(e+=2,n<<=2),!(n>>7)&&(e+=1),e}function qv(n){let e=64-function(r){let i=0;for(let s=0;s<8;++s){let o=b0(255&r[s]);if(i+=o,o!==8)break}return i}(n);return Math.ceil(e/8)}var pf=class{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Dt(e){let t=e[Symbol.iterator](),r=t.next();for(;!r.done;)this.Ct(r.value),r=t.next();this.vt()}Ft(e){let t=e[Symbol.iterator](),r=t.next();for(;!r.done;)this.Mt(r.value),r=t.next();this.xt()}Ot(e){for(let t of e){let r=t.charCodeAt(0);if(r<128)this.Ct(r);else if(r<2048)this.Ct(960|r>>>6),this.Ct(128|63&r);else if(t<"\uD800"||"\uDBFF"<t)this.Ct(480|r>>>12),this.Ct(128|63&r>>>6),this.Ct(128|63&r);else{let i=t.codePointAt(0);this.Ct(240|i>>>18),this.Ct(128|63&i>>>12),this.Ct(128|63&i>>>6),this.Ct(128|63&i)}}this.vt()}Nt(e){for(let t of e){let r=t.charCodeAt(0);if(r<128)this.Mt(r);else if(r<2048)this.Mt(960|r>>>6),this.Mt(128|63&r);else if(t<"\uD800"||"\uDBFF"<t)this.Mt(480|r>>>12),this.Mt(128|63&r>>>6),this.Mt(128|63&r);else{let i=t.codePointAt(0);this.Mt(240|i>>>18),this.Mt(128|63&i>>>12),this.Mt(128|63&i>>>6),this.Mt(128|63&i)}}this.xt()}Lt(e){let t=this.Bt(e),r=qv(t);this.kt(1+r),this.buffer[this.position++]=255&r;for(let i=t.length-r;i<t.length;++i)this.buffer[this.position++]=255&t[i]}qt(e){let t=this.Bt(e),r=qv(t);this.kt(1+r),this.buffer[this.position++]=~(255&r);for(let i=t.length-r;i<t.length;++i)this.buffer[this.position++]=~(255&t[i])}Qt(){this.Kt(255),this.Kt(255)}$t(){this.Ut(255),this.Ut(255)}reset(){this.position=0}seed(e){this.kt(e.length),this.buffer.set(e,this.position),this.position+=e.length}Wt(){return this.buffer.slice(0,this.position)}Bt(e){let t=function(s){let o=new DataView(new ArrayBuffer(8));return o.setFloat64(0,s,!1),new Uint8Array(o.buffer)}(e),r=(128&t[0])!=0;t[0]^=r?255:128;for(let i=1;i<t.length;++i)t[i]^=r?255:0;return t}Ct(e){let t=255&e;t===0?(this.Kt(0),this.Kt(255)):t===255?(this.Kt(255),this.Kt(0)):this.Kt(t)}Mt(e){let t=255&e;t===0?(this.Ut(0),this.Ut(255)):t===255?(this.Ut(255),this.Ut(0)):this.Ut(e)}vt(){this.Kt(0),this.Kt(1)}xt(){this.Ut(0),this.Ut(1)}Kt(e){this.kt(1),this.buffer[this.position++]=e}Ut(e){this.kt(1),this.buffer[this.position++]=~e}kt(e){let t=e+this.position;if(t<=this.buffer.length)return;let r=2*this.buffer.length;r<t&&(r=t);let i=new Uint8Array(r);i.set(this.buffer),this.buffer=i}},mf=class{constructor(e){this.Gt=e}ft(e){this.Gt.Dt(e)}At(e){this.Gt.Ot(e)}dt(e){this.Gt.Lt(e)}Tt(){this.Gt.Qt()}},gf=class{constructor(e){this.Gt=e}ft(e){this.Gt.Ft(e)}At(e){this.Gt.Nt(e)}dt(e){this.Gt.qt(e)}Tt(){this.Gt.$t()}},cr=class{constructor(){this.Gt=new pf,this.zt=new mf(this.Gt),this.jt=new gf(this.Gt)}seed(e){this.Gt.seed(e)}Ht(e){return e===0?this.zt:this.jt}Wt(){return this.Gt.Wt()}reset(){this.Gt.reset()}};var hr=class n{constructor(e,t,r,i){this.indexId=e,this.documentKey=t,this.arrayValue=r,this.directionalValue=i}Jt(){let e=this.directionalValue.length,t=e===0||this.directionalValue[e-1]===255?e+1:e,r=new Uint8Array(t);return r.set(this.directionalValue,0),t!==e?r.set([0],this.directionalValue.length):++r[r.length-1],new n(this.indexId,this.documentKey,this.arrayValue,r)}};function bn(n,e){let t=n.indexId-e.indexId;return t!==0?t:(t=Bv(n.arrayValue,e.arrayValue),t!==0?t:(t=Bv(n.directionalValue,e.directionalValue),t!==0?t:F.comparator(n.documentKey,e.documentKey)))}function Bv(n,e){for(let t=0;t<n.length&&t<e.length;++t){let r=n[t]-e[t];if(r!==0)return r}return n.length-e.length}var Zl=class{constructor(e){this.Yt=new fe((t,r)=>Ce.comparator(t.field,r.field)),this.collectionId=e.collectionGroup!=null?e.collectionGroup:e.path.lastSegment(),this.Zt=e.orderBy,this.Xt=[];for(let t of e.filters){let r=t;r.isInequality()?this.Yt=this.Yt.add(r):this.Xt.push(r)}}get en(){return this.Yt.size>1}tn(e){if(G(e.collectionGroup===this.collectionId),this.en)return!1;let t=Fd(e);if(t!==void 0&&!this.nn(t))return!1;let r=ar(e),i=new Set,s=0,o=0;for(;s<r.length&&this.nn(r[s]);++s)i=i.add(r[s].fieldPath.canonicalString());if(s===r.length)return!0;if(this.Yt.size>0){let l=this.Yt.getIterator().getNext();if(!i.has(l.field.canonicalString())){let u=r[s];if(!this.rn(l,u)||!this.sn(this.Zt[o++],u))return!1}++s}for(;s<r.length;++s){let l=r[s];if(o>=this.Zt.length||!this.sn(this.Zt[o++],l))return!1}return!0}on(){if(this.en)return null;let e=new fe(Ce.comparator),t=[];for(let r of this.Xt)if(!r.field.isKeyField())if(r.op==="array-contains"||r.op==="array-contains-any")t.push(new pi(r.field,2));else{if(e.has(r.field))continue;e=e.add(r.field),t.push(new pi(r.field,0))}for(let r of this.Zt)r.field.isKeyField()||e.has(r.field)||(e=e.add(r.field),t.push(new pi(r.field,r.dir==="asc"?0:1)));return new yi(yi.UNKNOWN_ID,this.collectionId,t,oo.empty())}nn(e){for(let t of this.Xt)if(this.rn(t,e))return!0;return!1}rn(e,t){if(e===void 0||!e.field.isEqual(t.fieldPath))return!1;let r=e.op==="array-contains"||e.op==="array-contains-any";return t.kind===2===r}sn(e,t){return!!e.field.isEqual(t.fieldPath)&&(t.kind===0&&e.dir==="asc"||t.kind===1&&e.dir==="desc")}};function cE(n){var e,t;if(G(n instanceof te||n instanceof ce),n instanceof te){if(n instanceof jl){let i=((t=(e=n.value.arrayValue)===null||e===void 0?void 0:e.values)===null||t===void 0?void 0:t.map(s=>te.create(n.field,"==",s)))||[];return ce.create(i,"or")}return n}let r=n.filters.map(i=>cE(i));return ce.create(r,n.op)}function R0(n){if(n.getFilters().length===0)return[];let e=vf(cE(n));return G(hE(e)),_f(e)||yf(e)?[e]:e.getFilters()}function _f(n){return n instanceof te}function yf(n){return n instanceof ce&&kp(n)}function hE(n){return _f(n)||yf(n)||function(t){if(t instanceof ce&&Kd(t)){for(let r of t.getFilters())if(!_f(r)&&!yf(r))return!1;return!0}return!1}(n)}function vf(n){if(G(n instanceof te||n instanceof ce),n instanceof te)return n;if(n.filters.length===1)return vf(n.filters[0]);let e=n.filters.map(r=>vf(r)),t=ce.create(e,n.op);return t=eu(t),hE(t)?t:(G(t instanceof ce),G(wi(t)),G(t.filters.length>1),t.filters.reduce((r,i)=>Lp(r,i)))}function Lp(n,e){let t;return G(n instanceof te||n instanceof ce),G(e instanceof te||e instanceof ce),t=n instanceof te?e instanceof te?function(i,s){return ce.create([i,s],"and")}(n,e):Gv(n,e):e instanceof te?Gv(e,n):function(i,s){if(G(i.filters.length>0&&s.filters.length>0),wi(i)&&wi(s))return Pw(i,s.getFilters());let o=Kd(i)?i:s,l=Kd(i)?s:i,u=o.filters.map(c=>Lp(c,l));return ce.create(u,"or")}(n,e),eu(t)}function Gv(n,e){if(wi(e))return Pw(e,n.getFilters());{let t=e.filters.map(r=>Lp(n,r));return ce.create(t,"or")}}function eu(n){if(G(n instanceof te||n instanceof ce),n instanceof te)return n;let e=n.getFilters();if(e.length===1)return eu(e[0]);if(bw(n))return n;let t=e.map(i=>eu(i)),r=[];return t.forEach(i=>{i instanceof te?r.push(i):i instanceof ce&&(i.op===n.op?r.push(...i.filters):r.push(i))}),r.length===1?r[0]:ce.create(r,n.op)}var wf=class{constructor(){this._n=new wo}addToCollectionParentIndex(e,t){return this._n.add(t),b.resolve()}getCollectionParents(e,t){return b.resolve(this._n.getEntries(t))}addFieldIndex(e,t){return b.resolve()}deleteFieldIndex(e,t){return b.resolve()}deleteAllFieldIndexes(e){return b.resolve()}createTargetIndexes(e,t){return b.resolve()}getDocumentsMatchingTarget(e,t){return b.resolve(null)}getIndexType(e,t){return b.resolve(0)}getFieldIndexes(e,t){return b.resolve([])}getNextCollectionGroupToUpdate(e){return b.resolve(null)}getMinOffset(e,t){return b.resolve(It.min())}getMinOffsetFromCollectionGroup(e,t){return b.resolve(It.min())}updateCollectionGroup(e,t,r){return b.resolve()}updateIndexEntries(e,t){return b.resolve()}},wo=class{constructor(){this.index={}}add(e){let t=e.lastSegment(),r=e.popLast(),i=this.index[t]||new fe(se.comparator),s=!i.has(r);return this.index[t]=i.add(r),s}has(e){let t=e.lastSegment(),r=e.popLast(),i=this.index[t];return i&&i.has(r)}getEntries(e){return(this.index[e]||new fe(se.comparator)).toArray()}};var Al=new Uint8Array(0),Ef=class{constructor(e,t){this.databaseId=t,this.an=new wo,this.un=new Kt(r=>_r(r),(r,i)=>xo(r,i)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.an.has(t)){let r=t.lastSegment(),i=t.popLast();e.addOnCommittedListener(()=>{this.an.add(t)});let s={collectionId:r,parent:rt(i)};return jv(e).put(s)}return b.resolve()}getCollectionParents(e,t){let r=[],i=IDBKeyRange.bound([t,""],[dw(t),""],!1,!0);return jv(e).U(i).next(s=>{for(let o of s){if(o.collectionId!==t)break;r.push(Lt(o.parent))}return r})}addFieldIndex(e,t){let r=Ys(e),i=function(l){return{indexId:l.indexId,collectionGroup:l.collectionGroup,fields:l.fields.map(u=>[u.fieldPath.canonicalString(),u.kind])}}(t);delete i.indexId;let s=r.add(i);if(t.indexState){let o=oi(e);return s.next(l=>{o.put(Fv(l,this.uid,t.indexState.sequenceNumber,t.indexState.offset))})}return s.next()}deleteFieldIndex(e,t){let r=Ys(e),i=oi(e),s=si(e);return r.delete(t.indexId).next(()=>i.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}deleteAllFieldIndexes(e){let t=Ys(e),r=si(e),i=oi(e);return t.j().next(()=>r.j()).next(()=>i.j())}createTargetIndexes(e,t){return b.forEach(this.cn(t),r=>this.getIndexType(e,r).next(i=>{if(i===0||i===1){let s=new Zl(r).on();if(s!=null)return this.addFieldIndex(e,s)}}))}getDocumentsMatchingTarget(e,t){let r=si(e),i=!0,s=new Map;return b.forEach(this.cn(t),o=>this.ln(e,o).next(l=>{i&&(i=!!l),s.set(o,l)})).next(()=>{if(i){let o=H(),l=[];return b.forEach(s,(u,c)=>{V("IndexedDbIndexManager",`Using index ${function(q){return`id=${q.indexId}|cg=${q.collectionGroup}|f=${q.fields.map(Y=>`${Y.fieldPath}:${Y.kind}`).join(",")}`}(u)} to execute ${_r(t)}`);let d=function(q,Y){let ne=Fd(Y);if(ne===void 0)return null;for(let W of Kl(q,ne.fieldPath))switch(W.op){case"array-contains-any":return W.value.arrayValue.values||[];case"array-contains":return[W.value]}return null}(c,u),p=function(q,Y){let ne=new Map;for(let W of ar(Y))for(let E of Kl(q,W.fieldPath))switch(E.op){case"==":case"in":ne.set(W.fieldPath.canonicalString(),E.value);break;case"not-in":case"!=":return ne.set(W.fieldPath.canonicalString(),E.value),Array.from(ne.values())}return null}(c,u),m=function(q,Y){let ne=[],W=!0;for(let E of ar(Y)){let _=E.kind===0?Iv(q,E.fieldPath,q.startAt):Tv(q,E.fieldPath,q.startAt);ne.push(_.value),W&&(W=_.inclusive)}return new zt(ne,W)}(c,u),v=function(q,Y){let ne=[],W=!0;for(let E of ar(Y)){let _=E.kind===0?Tv(q,E.fieldPath,q.endAt):Iv(q,E.fieldPath,q.endAt);ne.push(_.value),W&&(W=_.inclusive)}return new zt(ne,W)}(c,u),C=this.hn(u,c,m),N=this.hn(u,c,v),D=this.Pn(u,c,p),B=this.In(u.indexId,d,C,m.inclusive,N,v.inclusive,D);return b.forEach(B,j=>r.G(j,t.limit).next(q=>{q.forEach(Y=>{let ne=F.fromSegments(Y.documentKey);o.has(ne)||(o=o.add(ne),l.push(ne))})}))}).next(()=>l)}return b.resolve(null)})}cn(e){let t=this.un.get(e);return t||(e.filters.length===0?t=[e]:t=R0(ce.create(e.filters,"and")).map(r=>ef(e.path,e.collectionGroup,e.orderBy,r.getFilters(),e.limit,e.startAt,e.endAt)),this.un.set(e,t),t)}In(e,t,r,i,s,o,l){let u=(t!=null?t.length:1)*Math.max(r.length,s.length),c=u/(t!=null?t.length:1),d=[];for(let p=0;p<u;++p){let m=t?this.Tn(t[p/c]):Al,v=this.En(e,m,r[p%c],i),C=this.dn(e,m,s[p%c],o),N=l.map(D=>this.En(e,m,D,!0));d.push(...this.createRange(v,C,N))}return d}En(e,t,r,i){let s=new hr(e,F.empty(),t,r);return i?s:s.Jt()}dn(e,t,r,i){let s=new hr(e,F.empty(),t,r);return i?s.Jt():s}ln(e,t){let r=new Zl(t),i=t.collectionGroup!=null?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,i).next(s=>{let o=null;for(let l of s)r.tn(l)&&(!o||l.fields.length>o.fields.length)&&(o=l);return o})}getIndexType(e,t){let r=2,i=this.cn(t);return b.forEach(i,s=>this.ln(e,s).next(o=>{o?r!==0&&o.fields.length<function(u){let c=new fe(Ce.comparator),d=!1;for(let p of u.filters)for(let m of p.getFlattenedFilters())m.field.isKeyField()||(m.op==="array-contains"||m.op==="array-contains-any"?d=!0:c=c.add(m.field));for(let p of u.orderBy)p.field.isKeyField()||(c=c.add(p.field));return c.size+(d?1:0)}(s)&&(r=1):r=0})).next(()=>function(o){return o.limit!==null}(t)&&i.length>1&&r===2?1:r)}An(e,t){let r=new cr;for(let i of ar(e)){let s=t.data.field(i.fieldPath);if(s==null)return null;let o=r.Ht(i.kind);en.bt.Pt(s,o)}return r.Wt()}Tn(e){let t=new cr;return en.bt.Pt(e,t.Ht(0)),t.Wt()}Rn(e,t){let r=new cr;return en.bt.Pt(mr(this.databaseId,t),r.Ht(function(s){let o=ar(s);return o.length===0?0:o[o.length-1].kind}(e))),r.Wt()}Pn(e,t,r){if(r===null)return[];let i=[];i.push(new cr);let s=0;for(let o of ar(e)){let l=r[s++];for(let u of i)if(this.Vn(t,o.fieldPath)&&ho(l))i=this.mn(i,o,l);else{let c=u.Ht(o.kind);en.bt.Pt(l,c)}}return this.fn(i)}hn(e,t,r){return this.Pn(e,t,r.position)}fn(e){let t=[];for(let r=0;r<e.length;++r)t[r]=e[r].Wt();return t}mn(e,t,r){let i=[...e],s=[];for(let o of r.arrayValue.values||[])for(let l of i){let u=new cr;u.seed(l.Wt()),en.bt.Pt(o,u.Ht(t.kind)),s.push(u)}return s}Vn(e,t){return!!e.filters.find(r=>r instanceof te&&r.field.isEqual(t)&&(r.op==="in"||r.op==="not-in"))}getFieldIndexes(e,t){let r=Ys(e),i=oi(e);return(t?r.U("collectionGroupIndex",IDBKeyRange.bound(t,t)):r.U()).next(s=>{let o=[];return b.forEach(s,l=>i.get([l.indexId,this.uid]).next(u=>{o.push(function(d,p){let m=p?new oo(p.sequenceNumber,new It(wr(p.readTime),new F(Lt(p.documentKey)),p.largestBatchId)):oo.empty(),v=d.fields.map(([C,N])=>new pi(Ce.fromServerFormat(C),N));return new yi(d.indexId,d.collectionGroup,v,m)}(l,u))})).next(()=>o)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(t=>t.length===0?null:(t.sort((r,i)=>{let s=r.indexState.sequenceNumber-i.indexState.sequenceNumber;return s!==0?s:$(r.collectionGroup,i.collectionGroup)}),t[0].collectionGroup))}updateCollectionGroup(e,t,r){let i=Ys(e),s=oi(e);return this.gn(e).next(o=>i.U("collectionGroupIndex",IDBKeyRange.bound(t,t)).next(l=>b.forEach(l,u=>s.put(Fv(u.indexId,this.uid,o,r)))))}updateIndexEntries(e,t){let r=new Map;return b.forEach(t,(i,s)=>{let o=r.get(i.collectionGroup);return(o?b.resolve(o):this.getFieldIndexes(e,i.collectionGroup)).next(l=>(r.set(i.collectionGroup,l),b.forEach(l,u=>this.pn(e,i,u).next(c=>{let d=this.yn(s,u);return c.isEqual(d)?b.resolve():this.wn(e,s,u,c,d)}))))})}Sn(e,t,r,i){return si(e).put({indexId:i.indexId,uid:this.uid,arrayValue:i.arrayValue,directionalValue:i.directionalValue,orderedDocumentKey:this.Rn(r,t.key),documentKey:t.key.path.toArray()})}bn(e,t,r,i){return si(e).delete([i.indexId,this.uid,i.arrayValue,i.directionalValue,this.Rn(r,t.key),t.key.path.toArray()])}pn(e,t,r){let i=si(e),s=new fe(bn);return i.J({index:"documentKeyIndex",range:IDBKeyRange.only([r.indexId,this.uid,this.Rn(r,t)])},(o,l)=>{s=s.add(new hr(r.indexId,t,l.arrayValue,l.directionalValue))}).next(()=>s)}yn(e,t){let r=new fe(bn),i=this.An(t,e);if(i==null)return r;let s=Fd(t);if(s!=null){let o=e.data.field(s.fieldPath);if(ho(o))for(let l of o.arrayValue.values||[])r=r.add(new hr(t.indexId,e.key,this.Tn(l),i))}else r=r.add(new hr(t.indexId,e.key,Al,i));return r}wn(e,t,r,i,s){V("IndexedDbIndexManager","Updating index entries for document '%s'",t.key);let o=[];return function(u,c,d,p,m){let v=u.getIterator(),C=c.getIterator(),N=ii(v),D=ii(C);for(;N||D;){let B=!1,j=!1;if(N&&D){let q=d(N,D);q<0?j=!0:q>0&&(B=!0)}else N!=null?j=!0:B=!0;B?(p(D),D=ii(C)):j?(m(N),N=ii(v)):(N=ii(v),D=ii(C))}}(i,s,bn,l=>{o.push(this.Sn(e,t,r,l))},l=>{o.push(this.bn(e,t,r,l))}),b.waitFor(o)}gn(e){let t=1;return oi(e).J({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(r,i,s)=>{s.done(),t=i.sequenceNumber+1}).next(()=>t)}createRange(e,t,r){r=r.sort((o,l)=>bn(o,l)).filter((o,l,u)=>!l||bn(o,u[l-1])!==0);let i=[];i.push(e);for(let o of r){let l=bn(o,e),u=bn(o,t);if(l===0)i[0]=e.Jt();else if(l>0&&u<0)i.push(o),i.push(o.Jt());else if(u>0)break}i.push(t);let s=[];for(let o=0;o<i.length;o+=2){if(this.Dn(i[o],i[o+1]))return[];let l=[i[o].indexId,this.uid,i[o].arrayValue,i[o].directionalValue,Al,[]],u=[i[o+1].indexId,this.uid,i[o+1].arrayValue,i[o+1].directionalValue,Al,[]];s.push(IDBKeyRange.bound(l,u))}return s}Dn(e,t){return bn(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(zv)}getMinOffset(e,t){return b.mapArray(this.cn(t),r=>this.ln(e,r).next(i=>i||U())).next(zv)}};function jv(n){return Be(n,"collectionParents")}function si(n){return Be(n,"indexEntries")}function Ys(n){return Be(n,"indexConfiguration")}function oi(n){return Be(n,"indexState")}function zv(n){G(n.length!==0);let e=n[0].indexState.offset,t=e.largestBatchId;for(let r=1;r<n.length;r++){let i=n[r].indexState.offset;xp(i,e)<0&&(e=i),t<i.largestBatchId&&(t=i.largestBatchId)}return new It(e.readTime,e.documentKey,t)}var Kv={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},wt=class n{constructor(e,t,r){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=r}static withCacheSize(e){return new n(e,n.DEFAULT_COLLECTION_PERCENTILE,n.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}};function dE(n,e,t){let r=n.store("mutations"),i=n.store("documentMutations"),s=[],o=IDBKeyRange.only(t.batchId),l=0,u=r.J({range:o},(d,p,m)=>(l++,m.delete()));s.push(u.next(()=>{G(l===1)}));let c=[];for(let d of t.mutations){let p=yw(e,d.key.path,t.batchId);s.push(i.delete(p)),c.push(d.key)}return b.waitFor(s).next(()=>c)}function tu(n){if(!n)return 0;let e;if(n.document)e=n.document;else if(n.unknownDocument)e=n.unknownDocument;else{if(!n.noDocument)throw U();e=n.noDocument}return JSON.stringify(e).length}wt.DEFAULT_COLLECTION_PERCENTILE=10,wt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,wt.DEFAULT=new wt(41943040,wt.DEFAULT_COLLECTION_PERCENTILE,wt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),wt.DISABLED=new wt(-1,0,0);var nu=class n{constructor(e,t,r,i){this.userId=e,this.serializer=t,this.indexManager=r,this.referenceDelegate=i,this.Cn={}}static lt(e,t,r,i){G(e.uid!=="");let s=e.isAuthenticated()?e.uid:"";return new n(s,t,r,i)}checkEmpty(e){let t=!0,r=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Rn(e).J({index:"userMutationsIndex",range:r},(i,s,o)=>{t=!1,o.done()}).next(()=>t)}addMutationBatch(e,t,r,i){let s=di(e),o=Rn(e);return o.add({}).next(l=>{G(typeof l=="number");let u=new po(l,t,r,i),c=function(v,C,N){let D=N.baseMutations.map(j=>vo(v.ct,j)),B=N.mutations.map(j=>vo(v.ct,j));return{userId:C,batchId:N.batchId,localWriteTimeMs:N.localWriteTime.toMillis(),baseMutations:D,mutations:B}}(this.serializer,this.userId,u),d=[],p=new fe((m,v)=>$(m.canonicalString(),v.canonicalString()));for(let m of i){let v=yw(this.userId,m.key.path,l);p=p.add(m.key.path.popLast()),d.push(o.put(c)),d.push(s.put(v,MC))}return p.forEach(m=>{d.push(this.indexManager.addToCollectionParentIndex(e,m))}),e.addOnCommittedListener(()=>{this.Cn[l]=u.keys()}),b.waitFor(d).next(()=>u)})}lookupMutationBatch(e,t){return Rn(e).get(t).next(r=>r?(G(r.userId===this.userId),ur(this.serializer,r)):null)}vn(e,t){return this.Cn[t]?b.resolve(this.Cn[t]):this.lookupMutationBatch(e,t).next(r=>{if(r){let i=r.keys();return this.Cn[t]=i,i}return null})}getNextMutationBatchAfterBatchId(e,t){let r=t+1,i=IDBKeyRange.lowerBound([this.userId,r]),s=null;return Rn(e).J({index:"userMutationsIndex",range:i},(o,l,u)=>{l.userId===this.userId&&(G(l.batchId>=r),s=ur(this.serializer,l)),u.done()}).next(()=>s)}getHighestUnacknowledgedBatchId(e){let t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),r=-1;return Rn(e).J({index:"userMutationsIndex",range:t,reverse:!0},(i,s,o)=>{r=s.batchId,o.done()}).next(()=>r)}getAllMutationBatches(e){let t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Rn(e).U("userMutationsIndex",t).next(r=>r.map(i=>ur(this.serializer,i)))}getAllMutationBatchesAffectingDocumentKey(e,t){let r=Pl(this.userId,t.path),i=IDBKeyRange.lowerBound(r),s=[];return di(e).J({range:i},(o,l,u)=>{let[c,d,p]=o,m=Lt(d);if(c===this.userId&&t.path.isEqual(m))return Rn(e).get(p).next(v=>{if(!v)throw U();G(v.userId===this.userId),s.push(ur(this.serializer,v))});u.done()}).next(()=>s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let r=new fe($),i=[];return t.forEach(s=>{let o=Pl(this.userId,s.path),l=IDBKeyRange.lowerBound(o),u=di(e).J({range:l},(c,d,p)=>{let[m,v,C]=c,N=Lt(v);m===this.userId&&s.path.isEqual(N)?r=r.add(C):p.done()});i.push(u)}),b.waitFor(i).next(()=>this.Fn(e,r))}getAllMutationBatchesAffectingQuery(e,t){let r=t.path,i=r.length+1,s=Pl(this.userId,r),o=IDBKeyRange.lowerBound(s),l=new fe($);return di(e).J({range:o},(u,c,d)=>{let[p,m,v]=u,C=Lt(m);p===this.userId&&r.isPrefixOf(C)?C.length===i&&(l=l.add(v)):d.done()}).next(()=>this.Fn(e,l))}Fn(e,t){let r=[],i=[];return t.forEach(s=>{i.push(Rn(e).get(s).next(o=>{if(o===null)throw U();G(o.userId===this.userId),r.push(ur(this.serializer,o))}))}),b.waitFor(i).next(()=>r)}removeMutationBatch(e,t){return dE(e._e,this.userId,t).next(r=>(e.addOnCommittedListener(()=>{this.Mn(t.batchId)}),b.forEach(r,i=>this.referenceDelegate.markPotentiallyOrphaned(e,i))))}Mn(e){delete this.Cn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next(t=>{if(!t)return b.resolve();let r=IDBKeyRange.lowerBound(function(o){return[o]}(this.userId)),i=[];return di(e).J({range:r},(s,o,l)=>{if(s[0]===this.userId){let u=Lt(s[1]);i.push(u)}else l.done()}).next(()=>{G(i.length===0)})})}containsKey(e,t){return fE(e,this.userId,t)}xn(e){return pE(e).get(this.userId).next(t=>t||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}};function fE(n,e,t){let r=Pl(e,t.path),i=r[1],s=IDBKeyRange.lowerBound(r),o=!1;return di(n).J({range:s,H:!0},(l,u,c)=>{let[d,p,m]=l;d===e&&p===i&&(o=!0),c.done()}).next(()=>o)}function Rn(n){return Be(n,"mutations")}function di(n){return Be(n,"documentMutations")}function pE(n){return Be(n,"mutationQueues")}var Ai=class n{constructor(e){this.On=e}next(){return this.On+=2,this.On}static Nn(){return new n(0)}static Ln(){return new n(-1)}};var If=class{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.Bn(e).next(t=>{let r=new Ai(t.highestTargetId);return t.highestTargetId=r.next(),this.kn(e,t).next(()=>t.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.Bn(e).next(t=>z.fromTimestamp(new Ee(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.Bn(e).next(t=>t.highestListenSequenceNumber)}setTargetsMetadata(e,t,r){return this.Bn(e).next(i=>(i.highestListenSequenceNumber=t,r&&(i.lastRemoteSnapshotVersion=r.toTimestamp()),t>i.highestListenSequenceNumber&&(i.highestListenSequenceNumber=t),this.kn(e,i)))}addTargetData(e,t){return this.qn(e,t).next(()=>this.Bn(e).next(r=>(r.targetCount+=1,this.Qn(t,r),this.kn(e,r))))}updateTargetData(e,t){return this.qn(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next(()=>ai(e).delete(t.targetId)).next(()=>this.Bn(e)).next(r=>(G(r.targetCount>0),r.targetCount-=1,this.kn(e,r)))}removeTargets(e,t,r){let i=0,s=[];return ai(e).J((o,l)=>{let u=eo(l);u.sequenceNumber<=t&&r.get(u.targetId)===null&&(i++,s.push(this.removeTargetData(e,u)))}).next(()=>b.waitFor(s)).next(()=>i)}forEachTarget(e,t){return ai(e).J((r,i)=>{let s=eo(i);t(s)})}Bn(e){return Wv(e).get("targetGlobalKey").next(t=>(G(t!==null),t))}kn(e,t){return Wv(e).put("targetGlobalKey",t)}qn(e,t){return ai(e).put(uE(this.serializer,t))}Qn(e,t){let r=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,r=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,r=!0),r}getTargetCount(e){return this.Bn(e).next(t=>t.targetCount)}getTargetData(e,t){let r=_r(t),i=IDBKeyRange.bound([r,Number.NEGATIVE_INFINITY],[r,Number.POSITIVE_INFINITY]),s=null;return ai(e).J({range:i,index:"queryTargetsIndex"},(o,l,u)=>{let c=eo(l);xo(t,c.target)&&(s=c,u.done())}).next(()=>s)}addMatchingKeys(e,t,r){let i=[],s=Pn(e);return t.forEach(o=>{let l=rt(o.path);i.push(s.put({targetId:r,path:l})),i.push(this.referenceDelegate.addReference(e,r,o))}),b.waitFor(i)}removeMatchingKeys(e,t,r){let i=Pn(e);return b.forEach(t,s=>{let o=rt(s.path);return b.waitFor([i.delete([r,o]),this.referenceDelegate.removeReference(e,r,s)])})}removeMatchingKeysForTargetId(e,t){let r=Pn(e),i=IDBKeyRange.bound([t],[t+1],!1,!0);return r.delete(i)}getMatchingKeysForTargetId(e,t){let r=IDBKeyRange.bound([t],[t+1],!1,!0),i=Pn(e),s=H();return i.J({range:r,H:!0},(o,l,u)=>{let c=Lt(o[1]),d=new F(c);s=s.add(d)}).next(()=>s)}containsKey(e,t){let r=rt(t.path),i=IDBKeyRange.bound([r],[dw(r)],!1,!0),s=0;return Pn(e).J({index:"documentTargetsIndex",H:!0,range:i},([o,l],u,c)=>{o!==0&&(s++,c.done())}).next(()=>s>0)}ot(e,t){return ai(e).get(t).next(r=>r?eo(r):null)}};function ai(n){return Be(n,"targets")}function Wv(n){return Be(n,"targetGlobal")}function Pn(n){return Be(n,"targetDocuments")}function Qv([n,e],[t,r]){let i=$(n,t);return i===0?$(e,r):i}var Tf=class{constructor(e){this.Kn=e,this.buffer=new fe(Qv),this.$n=0}Un(){return++this.$n}Wn(e){let t=[e,this.Un()];if(this.buffer.size<this.Kn)this.buffer=this.buffer.add(t);else{let r=this.buffer.last();Qv(t,r)<0&&(this.buffer=this.buffer.delete(r).add(t))}}get maxValue(){return this.buffer.last()[0]}},Sf=class{constructor(e,t,r){this.garbageCollector=e,this.asyncQueue=t,this.localStore=r,this.Gn=null}start(){this.garbageCollector.params.cacheSizeCollectionThreshold!==-1&&this.zn(6e4)}stop(){this.Gn&&(this.Gn.cancel(),this.Gn=null)}get started(){return this.Gn!==null}zn(e){V("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.Gn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,()=>x(this,null,function*(){this.Gn=null;try{yield this.localStore.collectGarbage(this.garbageCollector)}catch(t){zn(t)?V("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",t):yield jn(t)}yield this.zn(3e5)}))}},Af=class{constructor(e,t){this.jn=e,this.params=t}calculateTargetCount(e,t){return this.jn.Hn(e).next(r=>Math.floor(t/100*r))}nthSequenceNumber(e,t){if(t===0)return b.resolve(ft.oe);let r=new Tf(t);return this.jn.forEachTarget(e,i=>r.Wn(i.sequenceNumber)).next(()=>this.jn.Jn(e,i=>r.Wn(i))).next(()=>r.maxValue)}removeTargets(e,t,r){return this.jn.removeTargets(e,t,r)}removeOrphanedDocuments(e,t){return this.jn.removeOrphanedDocuments(e,t)}collect(e,t){return this.params.cacheSizeCollectionThreshold===-1?(V("LruGarbageCollector","Garbage collection skipped; disabled"),b.resolve(Kv)):this.getCacheSize(e).next(r=>r<this.params.cacheSizeCollectionThreshold?(V("LruGarbageCollector",`Garbage collection skipped; Cache size ${r} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Kv):this.Yn(e,t))}getCacheSize(e){return this.jn.getCacheSize(e)}Yn(e,t){let r,i,s,o,l,u,c,d=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(p=>(p>this.params.maximumSequenceNumbersToCollect?(V("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${p}`),i=this.params.maximumSequenceNumbersToCollect):i=p,o=Date.now(),this.nthSequenceNumber(e,i))).next(p=>(r=p,l=Date.now(),this.removeTargets(e,r,t))).next(p=>(s=p,u=Date.now(),this.removeOrphanedDocuments(e,r))).next(p=>(c=Date.now(),li()<=gt.DEBUG&&V("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${o-d}ms
	Determined least recently used ${i} in `+(l-o)+`ms
	Removed ${s} targets in `+(u-l)+`ms
	Removed ${p} documents in `+(c-u)+`ms
Total Duration: ${c-d}ms`),b.resolve({didRun:!0,sequenceNumbersCollected:i,targetsRemoved:s,documentsRemoved:p})))}};function P0(n,e){return new Af(n,e)}var Cf=class{constructor(e,t){this.db=e,this.garbageCollector=P0(this,t)}Hn(e){let t=this.Zn(e);return this.db.getTargetCache().getTargetCount(e).next(r=>t.next(i=>r+i))}Zn(e){let t=0;return this.Jn(e,r=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Jn(e,t){return this.Xn(e,(r,i)=>t(i))}addReference(e,t,r){return Cl(e,r)}removeReference(e,t,r){return Cl(e,r)}removeTargets(e,t,r){return this.db.getTargetCache().removeTargets(e,t,r)}markPotentiallyOrphaned(e,t){return Cl(e,t)}er(e,t){return function(i,s){let o=!1;return pE(i).Y(l=>fE(i,l,s).next(u=>(u&&(o=!0),b.resolve(!u)))).next(()=>o)}(e,t)}removeOrphanedDocuments(e,t){let r=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[],s=0;return this.Xn(e,(o,l)=>{if(l<=t){let u=this.er(e,o).next(c=>{if(!c)return s++,r.getEntry(e,o).next(()=>(r.removeEntry(o,z.min()),Pn(e).delete(function(p){return[0,rt(p.path)]}(o))))});i.push(u)}}).next(()=>b.waitFor(i)).next(()=>r.apply(e)).next(()=>s)}removeTarget(e,t){let r=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,r)}updateLimboDocument(e,t){return Cl(e,t)}Xn(e,t){let r=Pn(e),i,s=ft.oe;return r.J({index:"documentTargetsIndex"},([o,l],{path:u,sequenceNumber:c})=>{o===0?(s!==ft.oe&&t(new F(Lt(i)),s),s=c,i=u):s=ft.oe}).next(()=>{s!==ft.oe&&t(new F(Lt(i)),s)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}};function Cl(n,e){return Pn(n).put(function(r,i){return{targetId:0,path:rt(r.path),sequenceNumber:i}}(e,n.currentSequenceNumber))}var ru=class{constructor(){this.changes=new Kt(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,ke.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();let r=this.changes.get(t);return r!==void 0?b.resolve(r):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}};var bf=class{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,r){return or(e).put(r)}removeEntry(e,t,r){return or(e).delete(function(s,o){let l=s.path.toArray();return[l.slice(0,l.length-2),l[l.length-2],Jl(o),l[l.length-1]]}(t,r))}updateMetadata(e,t){return this.getMetadata(e).next(r=>(r.byteSize+=t,this.tr(e,r)))}getEntry(e,t){let r=ke.newInvalidDocument(t);return or(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(Js(t))},(i,s)=>{r=this.nr(t,s)}).next(()=>r)}rr(e,t){let r={size:0,document:ke.newInvalidDocument(t)};return or(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(Js(t))},(i,s)=>{r={document:this.nr(t,s),size:tu(s)}}).next(()=>r)}getEntries(e,t){let r=at();return this.ir(e,t,(i,s)=>{let o=this.nr(i,s);r=r.insert(i,o)}).next(()=>r)}sr(e,t){let r=at(),i=new _e(F.comparator);return this.ir(e,t,(s,o)=>{let l=this.nr(s,o);r=r.insert(s,l),i=i.insert(s,tu(o))}).next(()=>({documents:r,_r:i}))}ir(e,t,r){if(t.isEmpty())return b.resolve();let i=new fe(Yv);t.forEach(u=>i=i.add(u));let s=IDBKeyRange.bound(Js(i.first()),Js(i.last())),o=i.getIterator(),l=o.getNext();return or(e).J({index:"documentKeyIndex",range:s},(u,c,d)=>{let p=F.fromSegments([...c.prefixPath,c.collectionGroup,c.documentId]);for(;l&&Yv(l,p)<0;)r(l,null),l=o.getNext();l&&l.isEqual(p)&&(r(l,c),l=o.hasNext()?o.getNext():null),l?d.$(Js(l)):d.done()}).next(()=>{for(;l;)r(l,null),l=o.hasNext()?o.getNext():null})}getDocumentsMatchingQuery(e,t,r,i,s){let o=t.path,l=[o.popLast().toArray(),o.lastSegment(),Jl(r.readTime),r.documentKey.path.isEmpty()?"":r.documentKey.path.lastSegment()],u=[o.popLast().toArray(),o.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return or(e).U(IDBKeyRange.bound(l,u,!0)).next(c=>{s?.incrementDocumentReadCount(c.length);let d=at();for(let p of c){let m=this.nr(F.fromSegments(p.prefixPath.concat(p.collectionGroup,p.documentId)),p);m.isFoundDocument()&&(Do(t,m)||i.has(m.key))&&(d=d.insert(m.key,m))}return d})}getAllFromCollectionGroup(e,t,r,i){let s=at(),o=Hv(t,r),l=Hv(t,It.max());return or(e).J({index:"collectionGroupIndex",range:IDBKeyRange.bound(o,l,!0)},(u,c,d)=>{let p=this.nr(F.fromSegments(c.prefixPath.concat(c.collectionGroup,c.documentId)),c);s=s.insert(p.key,p),s.size===i&&d.done()}).next(()=>s)}newChangeBuffer(e){return new Rf(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(t=>t.byteSize)}getMetadata(e){return $v(e).get("remoteDocumentGlobalKey").next(t=>(G(!!t),t))}tr(e,t){return $v(e).put("remoteDocumentGlobalKey",t)}nr(e,t){if(t){let r=C0(this.serializer,t);if(!(r.isNoDocument()&&r.version.isEqual(z.min())))return r}return ke.newInvalidDocument(e)}};function mE(n){return new bf(n)}var Rf=class extends ru{constructor(e,t){super(),this.ar=e,this.trackRemovals=t,this.ur=new Kt(r=>r.toString(),(r,i)=>r.isEqual(i))}applyChanges(e){let t=[],r=0,i=new fe((s,o)=>$(s.canonicalString(),o.canonicalString()));return this.changes.forEach((s,o)=>{let l=this.ur.get(s);if(t.push(this.ar.removeEntry(e,s,l.readTime)),o.isValidDocument()){let u=Mv(this.ar.serializer,o);i=i.add(s.path.popLast());let c=tu(u);r+=c-l.size,t.push(this.ar.addEntry(e,s,u))}else if(r-=l.size,this.trackRemovals){let u=Mv(this.ar.serializer,o.convertToNoDocument(z.min()));t.push(this.ar.addEntry(e,s,u))}}),i.forEach(s=>{t.push(this.ar.indexManager.addToCollectionParentIndex(e,s))}),t.push(this.ar.updateMetadata(e,r)),b.waitFor(t)}getFromCache(e,t){return this.ar.rr(e,t).next(r=>(this.ur.set(t,{size:r.size,readTime:r.document.readTime}),r.document))}getAllFromCache(e,t){return this.ar.sr(e,t).next(({documents:r,_r:i})=>(i.forEach((s,o)=>{this.ur.set(s,{size:o,readTime:r.get(s).readTime})}),r))}};function $v(n){return Be(n,"remoteDocumentGlobal")}function or(n){return Be(n,"remoteDocumentsV14")}function Js(n){let e=n.path.toArray();return[e.slice(0,e.length-2),e[e.length-2],e[e.length-1]]}function Hv(n,e){let t=e.documentKey.path.toArray();return[n,Jl(e.readTime),t.slice(0,t.length-2),t.length>0?t[t.length-1]:""]}function Yv(n,e){let t=n.path.toArray(),r=e.path.toArray(),i=0;for(let s=0;s<t.length-2&&s<r.length-2;++s)if(i=$(t[s],r[s]),i)return i;return i=$(t.length,r.length),i||(i=$(t[t.length-2],r[r.length-2]),i||$(t[t.length-1],r[r.length-1]))}var Pf=class{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}};var iu=class{constructor(e,t,r,i){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=r,this.indexManager=i}getDocument(e,t){let r=null;return this.documentOverlayCache.getOverlay(e,t).next(i=>(r=i,this.remoteDocumentCache.getEntry(e,t))).next(i=>(r!==null&&ro(r.mutation,i,pt.empty(),Ee.now()),i))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next(r=>this.getLocalViewOfDocuments(e,r,H()).next(()=>r))}getLocalViewOfDocuments(e,t,r=H()){let i=Ut();return this.populateOverlays(e,i,t).next(()=>this.computeViews(e,t,i,r).next(s=>{let o=Zs();return s.forEach((l,u)=>{o=o.insert(l,u.overlayedDocument)}),o}))}getOverlayedDocuments(e,t){let r=Ut();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,H()))}populateOverlays(e,t,r){let i=[];return r.forEach(s=>{t.has(s)||i.push(s)}),this.documentOverlayCache.getOverlays(e,i).next(s=>{s.forEach((o,l)=>{t.set(o,l)})})}computeViews(e,t,r,i){let s=at(),o=no(),l=function(){return no()}();return t.forEach((u,c)=>{let d=r.get(c.key);i.has(c.key)&&(d===void 0||d.mutation instanceof Rt)?s=s.insert(c.key,c):d!==void 0?(o.set(c.key,d.mutation.getFieldMask()),ro(d.mutation,c,d.mutation.getFieldMask(),Ee.now())):o.set(c.key,pt.empty())}),this.recalculateAndSaveOverlays(e,s).next(u=>(u.forEach((c,d)=>o.set(c,d)),t.forEach((c,d)=>{var p;return l.set(c,new Pf(d,(p=o.get(c))!==null&&p!==void 0?p:null))}),l))}recalculateAndSaveOverlays(e,t){let r=no(),i=new _e((o,l)=>o-l),s=H();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next(o=>{for(let l of o)l.keys().forEach(u=>{let c=t.get(u);if(c===null)return;let d=r.get(u)||pt.empty();d=l.applyToLocalView(c,d),r.set(u,d);let p=(i.get(l.batchId)||H()).add(u);i=i.insert(l.batchId,p)})}).next(()=>{let o=[],l=i.getReverseIterator();for(;l.hasNext();){let u=l.getNext(),c=u.key,d=u.value,p=Lw();d.forEach(m=>{if(!s.has(m)){let v=Ww(t.get(m),r.get(m));v!==null&&p.set(m,v),s=s.add(m)}}),o.push(this.documentOverlayCache.saveOverlays(e,c,p))}return b.waitFor(o)}).next(()=>r)}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next(r=>this.recalculateAndSaveOverlays(e,r))}getDocumentsMatchingQuery(e,t,r,i){return function(o){return F.isDocumentKey(o.path)&&o.collectionGroup===null&&o.filters.length===0}(t)?this.getDocumentsMatchingDocumentQuery(e,t.path):Vp(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,r,i):this.getDocumentsMatchingCollectionQuery(e,t,r,i)}getNextDocuments(e,t,r,i){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,r,i).next(s=>{let o=i-s.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,r.largestBatchId,i-s.size):b.resolve(Ut()),l=-1,u=s;return o.next(c=>b.forEach(c,(d,p)=>(l<p.largestBatchId&&(l=p.largestBatchId),s.get(d)?b.resolve():this.remoteDocumentCache.getEntry(e,d).next(m=>{u=u.insert(d,m)}))).next(()=>this.populateOverlays(e,c,s)).next(()=>this.computeViews(e,u,c,H())).next(d=>({batchId:l,changes:Fw(d)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new F(t)).next(r=>{let i=Zs();return r.isFoundDocument()&&(i=i.insert(r.key,r)),i})}getDocumentsMatchingCollectionGroupQuery(e,t,r,i){let s=t.collectionGroup,o=Zs();return this.indexManager.getCollectionParents(e,s).next(l=>b.forEach(l,u=>{let c=function(p,m){return new bt(m,null,p.explicitOrderBy.slice(),p.filters.slice(),p.limit,p.limitType,p.startAt,p.endAt)}(t,u.child(s));return this.getDocumentsMatchingCollectionQuery(e,c,r,i).next(d=>{d.forEach((p,m)=>{o=o.insert(p,m)})})}).next(()=>o))}getDocumentsMatchingCollectionQuery(e,t,r,i){let s;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,r.largestBatchId).next(o=>(s=o,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,r,s,i))).next(o=>{s.forEach((u,c)=>{let d=c.getKey();o.get(d)===null&&(o=o.insert(d,ke.newInvalidDocument(d)))});let l=Zs();return o.forEach((u,c)=>{let d=s.get(u);d!==void 0&&ro(d.mutation,c,pt.empty(),Ee.now()),Do(t,c)&&(l=l.insert(u,c))}),l})}};var xf=class{constructor(e){this.serializer=e,this.cr=new Map,this.lr=new Map}getBundleMetadata(e,t){return b.resolve(this.cr.get(t))}saveBundleMetadata(e,t){return this.cr.set(t.id,function(i){return{id:i.id,version:i.version,createTime:be(i.createTime)}}(t)),b.resolve()}getNamedQuery(e,t){return b.resolve(this.lr.get(t))}saveNamedQuery(e,t){return this.lr.set(t.name,function(i){return{name:i.name,query:Fp(i.bundledQuery),readTime:be(i.readTime)}}(t)),b.resolve()}};var Nf=class{constructor(){this.overlays=new _e(F.comparator),this.hr=new Map}getOverlay(e,t){return b.resolve(this.overlays.get(t))}getOverlays(e,t){let r=Ut();return b.forEach(t,i=>this.getOverlay(e,i).next(s=>{s!==null&&r.set(i,s)})).next(()=>r)}saveOverlays(e,t,r){return r.forEach((i,s)=>{this.ht(e,t,s)}),b.resolve()}removeOverlaysForBatchId(e,t,r){let i=this.hr.get(r);return i!==void 0&&(i.forEach(s=>this.overlays=this.overlays.remove(s)),this.hr.delete(r)),b.resolve()}getOverlaysForCollection(e,t,r){let i=Ut(),s=t.length+1,o=new F(t.child("")),l=this.overlays.getIteratorFrom(o);for(;l.hasNext();){let u=l.getNext().value,c=u.getKey();if(!t.isPrefixOf(c.path))break;c.path.length===s&&u.largestBatchId>r&&i.set(u.getKey(),u)}return b.resolve(i)}getOverlaysForCollectionGroup(e,t,r,i){let s=new _e((c,d)=>c-d),o=this.overlays.getIterator();for(;o.hasNext();){let c=o.getNext().value;if(c.getKey().getCollectionGroup()===t&&c.largestBatchId>r){let d=s.get(c.largestBatchId);d===null&&(d=Ut(),s=s.insert(c.largestBatchId,d)),d.set(c.getKey(),c)}}let l=Ut(),u=s.getIterator();for(;u.hasNext()&&(u.getNext().value.forEach((c,d)=>l.set(c,d)),!(l.size()>=i)););return b.resolve(l)}ht(e,t,r){let i=this.overlays.get(r.key);if(i!==null){let o=this.hr.get(i.largestBatchId).delete(r.key);this.hr.set(i.largestBatchId,o)}this.overlays=this.overlays.insert(r.key,new mo(t,r));let s=this.hr.get(t);s===void 0&&(s=H(),this.hr.set(t,s)),this.hr.set(t,s.add(r.key))}};var Eo=class{constructor(){this.Pr=new fe(xe.Ir),this.Tr=new fe(xe.Er)}isEmpty(){return this.Pr.isEmpty()}addReference(e,t){let r=new xe(e,t);this.Pr=this.Pr.add(r),this.Tr=this.Tr.add(r)}dr(e,t){e.forEach(r=>this.addReference(r,t))}removeReference(e,t){this.Ar(new xe(e,t))}Rr(e,t){e.forEach(r=>this.removeReference(r,t))}Vr(e){let t=new F(new se([])),r=new xe(t,e),i=new xe(t,e+1),s=[];return this.Tr.forEachInRange([r,i],o=>{this.Ar(o),s.push(o.key)}),s}mr(){this.Pr.forEach(e=>this.Ar(e))}Ar(e){this.Pr=this.Pr.delete(e),this.Tr=this.Tr.delete(e)}gr(e){let t=new F(new se([])),r=new xe(t,e),i=new xe(t,e+1),s=H();return this.Tr.forEachInRange([r,i],o=>{s=s.add(o.key)}),s}containsKey(e){let t=new xe(e,0),r=this.Pr.firstAfterOrEqual(t);return r!==null&&e.isEqual(r.key)}},xe=class{constructor(e,t){this.key=e,this.pr=t}static Ir(e,t){return F.comparator(e.key,t.key)||$(e.pr,t.pr)}static Er(e,t){return $(e.pr,t.pr)||F.comparator(e.key,t.key)}};var Df=class{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.yr=1,this.wr=new fe(xe.Ir)}checkEmpty(e){return b.resolve(this.mutationQueue.length===0)}addMutationBatch(e,t,r,i){let s=this.yr;this.yr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];let o=new po(s,t,r,i);this.mutationQueue.push(o);for(let l of i)this.wr=this.wr.add(new xe(l.key,s)),this.indexManager.addToCollectionParentIndex(e,l.key.path.popLast());return b.resolve(o)}lookupMutationBatch(e,t){return b.resolve(this.Sr(t))}getNextMutationBatchAfterBatchId(e,t){let r=t+1,i=this.br(r),s=i<0?0:i;return b.resolve(this.mutationQueue.length>s?this.mutationQueue[s]:null)}getHighestUnacknowledgedBatchId(){return b.resolve(this.mutationQueue.length===0?-1:this.yr-1)}getAllMutationBatches(e){return b.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){let r=new xe(t,0),i=new xe(t,Number.POSITIVE_INFINITY),s=[];return this.wr.forEachInRange([r,i],o=>{let l=this.Sr(o.pr);s.push(l)}),b.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let r=new fe($);return t.forEach(i=>{let s=new xe(i,0),o=new xe(i,Number.POSITIVE_INFINITY);this.wr.forEachInRange([s,o],l=>{r=r.add(l.pr)})}),b.resolve(this.Dr(r))}getAllMutationBatchesAffectingQuery(e,t){let r=t.path,i=r.length+1,s=r;F.isDocumentKey(s)||(s=s.child(""));let o=new xe(new F(s),0),l=new fe($);return this.wr.forEachWhile(u=>{let c=u.key.path;return!!r.isPrefixOf(c)&&(c.length===i&&(l=l.add(u.pr)),!0)},o),b.resolve(this.Dr(l))}Dr(e){let t=[];return e.forEach(r=>{let i=this.Sr(r);i!==null&&t.push(i)}),t}removeMutationBatch(e,t){G(this.Cr(t.batchId,"removed")===0),this.mutationQueue.shift();let r=this.wr;return b.forEach(t.mutations,i=>{let s=new xe(i.key,t.batchId);return r=r.delete(s),this.referenceDelegate.markPotentiallyOrphaned(e,i.key)}).next(()=>{this.wr=r})}Mn(e){}containsKey(e,t){let r=new xe(t,0),i=this.wr.firstAfterOrEqual(r);return b.resolve(t.isEqual(i&&i.key))}performConsistencyCheck(e){return this.mutationQueue.length,b.resolve()}Cr(e,t){return this.br(e)}br(e){return this.mutationQueue.length===0?0:e-this.mutationQueue[0].batchId}Sr(e){let t=this.br(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}};var kf=class{constructor(e){this.vr=e,this.docs=function(){return new _e(F.comparator)}(),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){let r=t.key,i=this.docs.get(r),s=i?i.size:0,o=this.vr(t);return this.docs=this.docs.insert(r,{document:t.mutableCopy(),size:o}),this.size+=o-s,this.indexManager.addToCollectionParentIndex(e,r.path.popLast())}removeEntry(e){let t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){let r=this.docs.get(t);return b.resolve(r?r.document.mutableCopy():ke.newInvalidDocument(t))}getEntries(e,t){let r=at();return t.forEach(i=>{let s=this.docs.get(i);r=r.insert(i,s?s.document.mutableCopy():ke.newInvalidDocument(i))}),b.resolve(r)}getDocumentsMatchingQuery(e,t,r,i){let s=at(),o=t.path,l=new F(o.child("")),u=this.docs.getIteratorFrom(l);for(;u.hasNext();){let{key:c,value:{document:d}}=u.getNext();if(!o.isPrefixOf(c.path))break;c.path.length>o.length+1||xp(pw(d),r)<=0||(i.has(d.key)||Do(t,d))&&(s=s.insert(d.key,d.mutableCopy()))}return b.resolve(s)}getAllFromCollectionGroup(e,t,r,i){U()}Fr(e,t){return b.forEach(this.docs,r=>t(r))}newChangeBuffer(e){return new Vf(this)}getSize(e){return b.resolve(this.size)}},Vf=class extends ru{constructor(e){super(),this.ar=e}applyChanges(e){let t=[];return this.changes.forEach((r,i)=>{i.isValidDocument()?t.push(this.ar.addEntry(e,i)):this.ar.removeEntry(r)}),b.waitFor(t)}getFromCache(e,t){return this.ar.getEntry(e,t)}getAllFromCache(e,t){return this.ar.getEntries(e,t)}};var Mf=class{constructor(e){this.persistence=e,this.Mr=new Kt(t=>_r(t),xo),this.lastRemoteSnapshotVersion=z.min(),this.highestTargetId=0,this.Or=0,this.Nr=new Eo,this.targetCount=0,this.Lr=Ai.Nn()}forEachTarget(e,t){return this.Mr.forEach((r,i)=>t(i)),b.resolve()}getLastRemoteSnapshotVersion(e){return b.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return b.resolve(this.Or)}allocateTargetId(e){return this.highestTargetId=this.Lr.next(),b.resolve(this.highestTargetId)}setTargetsMetadata(e,t,r){return r&&(this.lastRemoteSnapshotVersion=r),t>this.Or&&(this.Or=t),b.resolve()}qn(e){this.Mr.set(e.target,e);let t=e.targetId;t>this.highestTargetId&&(this.Lr=new Ai(t),this.highestTargetId=t),e.sequenceNumber>this.Or&&(this.Or=e.sequenceNumber)}addTargetData(e,t){return this.qn(t),this.targetCount+=1,b.resolve()}updateTargetData(e,t){return this.qn(t),b.resolve()}removeTargetData(e,t){return this.Mr.delete(t.target),this.Nr.Vr(t.targetId),this.targetCount-=1,b.resolve()}removeTargets(e,t,r){let i=0,s=[];return this.Mr.forEach((o,l)=>{l.sequenceNumber<=t&&r.get(l.targetId)===null&&(this.Mr.delete(o),s.push(this.removeMatchingKeysForTargetId(e,l.targetId)),i++)}),b.waitFor(s).next(()=>i)}getTargetCount(e){return b.resolve(this.targetCount)}getTargetData(e,t){let r=this.Mr.get(t)||null;return b.resolve(r)}addMatchingKeys(e,t,r){return this.Nr.dr(t,r),b.resolve()}removeMatchingKeys(e,t,r){this.Nr.Rr(t,r);let i=this.persistence.referenceDelegate,s=[];return i&&t.forEach(o=>{s.push(i.markPotentiallyOrphaned(e,o))}),b.waitFor(s)}removeMatchingKeysForTargetId(e,t){return this.Nr.Vr(t),b.resolve()}getMatchingKeysForTargetId(e,t){let r=this.Nr.gr(t);return b.resolve(r)}containsKey(e,t){return b.resolve(this.Nr.containsKey(t))}};var su=class{constructor(e,t){this.Br={},this.overlays={},this.kr=new ft(0),this.qr=!1,this.qr=!0,this.referenceDelegate=e(this),this.Qr=new Mf(this),this.indexManager=new wf,this.remoteDocumentCache=function(i){return new kf(i)}(r=>this.referenceDelegate.Kr(r)),this.serializer=new Yl(t),this.$r=new xf(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.qr=!1,Promise.resolve()}get started(){return this.qr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new Nf,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let r=this.Br[e.toKey()];return r||(r=new Df(t,this.referenceDelegate),this.Br[e.toKey()]=r),r}getTargetCache(){return this.Qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.$r}runTransaction(e,t,r){V("MemoryPersistence","Starting transaction:",e);let i=new Of(this.kr.next());return this.referenceDelegate.Ur(),r(i).next(s=>this.referenceDelegate.Wr(i).next(()=>s)).toPromise().then(s=>(i.raiseOnCommittedEvent(),s))}Gr(e,t){return b.or(Object.values(this.Br).map(r=>()=>r.containsKey(e,t)))}},Of=class extends Ll{constructor(e){super(),this.currentSequenceNumber=e}},ou=class n{constructor(e){this.persistence=e,this.zr=new Eo,this.jr=null}static Hr(e){return new n(e)}get Jr(){if(this.jr)return this.jr;throw U()}addReference(e,t,r){return this.zr.addReference(r,t),this.Jr.delete(r.toString()),b.resolve()}removeReference(e,t,r){return this.zr.removeReference(r,t),this.Jr.add(r.toString()),b.resolve()}markPotentiallyOrphaned(e,t){return this.Jr.add(t.toString()),b.resolve()}removeTarget(e,t){this.zr.Vr(t.targetId).forEach(i=>this.Jr.add(i.toString()));let r=this.persistence.getTargetCache();return r.getMatchingKeysForTargetId(e,t.targetId).next(i=>{i.forEach(s=>this.Jr.add(s.toString()))}).next(()=>r.removeTargetData(e,t))}Ur(){this.jr=new Set}Wr(e){let t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return b.forEach(this.Jr,r=>{let i=F.fromPath(r);return this.Yr(e,i).next(s=>{s||t.removeEntry(i,z.min())})}).next(()=>(this.jr=null,t.apply(e)))}updateLimboDocument(e,t){return this.Yr(e,t).next(r=>{r?this.Jr.delete(t.toString()):this.Jr.add(t.toString())})}Kr(e){return 0}Yr(e,t){return b.or([()=>b.resolve(this.zr.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Gr(e,t)])}};var Ff=class{constructor(e){this.serializer=e}O(e,t,r,i){let s=new Ul("createOrUpgrade",t);r<1&&i>=1&&(function(u){u.createObjectStore("owner")}(e),function(u){u.createObjectStore("mutationQueues",{keyPath:"userId"}),u.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",fv,{unique:!0}),u.createObjectStore("documentMutations")}(e),Jv(e),function(u){u.createObjectStore("remoteDocuments")}(e));let o=b.resolve();return r<3&&i>=3&&(r!==0&&(function(u){u.deleteObjectStore("targetDocuments"),u.deleteObjectStore("targets"),u.deleteObjectStore("targetGlobal")}(e),Jv(e)),o=o.next(()=>function(u){let c=u.store("targetGlobal"),d={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:z.min().toTimestamp(),targetCount:0};return c.put("targetGlobalKey",d)}(s))),r<4&&i>=4&&(r!==0&&(o=o.next(()=>function(u,c){return c.store("mutations").U().next(d=>{u.deleteObjectStore("mutations"),u.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",fv,{unique:!0});let p=c.store("mutations"),m=d.map(v=>p.put(v));return b.waitFor(m)})}(e,s))),o=o.next(()=>{(function(u){u.createObjectStore("clientMetadata",{keyPath:"clientId"})})(e)})),r<5&&i>=5&&(o=o.next(()=>this.Xr(s))),r<6&&i>=6&&(o=o.next(()=>(function(u){u.createObjectStore("remoteDocumentGlobal")}(e),this.ei(s)))),r<7&&i>=7&&(o=o.next(()=>this.ti(s))),r<8&&i>=8&&(o=o.next(()=>this.ni(e,s))),r<9&&i>=9&&(o=o.next(()=>{(function(u){u.objectStoreNames.contains("remoteDocumentChanges")&&u.deleteObjectStore("remoteDocumentChanges")})(e)})),r<10&&i>=10&&(o=o.next(()=>this.ri(s))),r<11&&i>=11&&(o=o.next(()=>{(function(u){u.createObjectStore("bundles",{keyPath:"bundleId"})})(e),function(u){u.createObjectStore("namedQueries",{keyPath:"name"})}(e)})),r<12&&i>=12&&(o=o.next(()=>{(function(u){let c=u.createObjectStore("documentOverlays",{keyPath:QC});c.createIndex("collectionPathOverlayIndex",$C,{unique:!1}),c.createIndex("collectionGroupOverlayIndex",HC,{unique:!1})})(e)})),r<13&&i>=13&&(o=o.next(()=>function(u){let c=u.createObjectStore("remoteDocumentsV14",{keyPath:OC});c.createIndex("documentKeyIndex",FC),c.createIndex("collectionGroupIndex",LC)}(e)).next(()=>this.ii(e,s)).next(()=>e.deleteObjectStore("remoteDocuments"))),r<14&&i>=14&&(o=o.next(()=>this.si(e,s))),r<15&&i>=15&&(o=o.next(()=>function(u){u.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),u.createObjectStore("indexState",{keyPath:jC}).createIndex("sequenceNumberIndex",zC,{unique:!1}),u.createObjectStore("indexEntries",{keyPath:KC}).createIndex("documentKeyIndex",WC,{unique:!1})}(e))),r<16&&i>=16&&(o=o.next(()=>{t.objectStore("indexState").clear()}).next(()=>{t.objectStore("indexEntries").clear()})),o}ei(e){let t=0;return e.store("remoteDocuments").J((r,i)=>{t+=tu(i)}).next(()=>{let r={byteSize:t};return e.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",r)})}Xr(e){let t=e.store("mutationQueues"),r=e.store("mutations");return t.U().next(i=>b.forEach(i,s=>{let o=IDBKeyRange.bound([s.userId,-1],[s.userId,s.lastAcknowledgedBatchId]);return r.U("userMutationsIndex",o).next(l=>b.forEach(l,u=>{G(u.userId===s.userId);let c=ur(this.serializer,u);return dE(e,s.userId,c).next(()=>{})}))}))}ti(e){let t=e.store("targetDocuments"),r=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next(i=>{let s=[];return r.J((o,l)=>{let u=new se(o),c=function(p){return[0,rt(p)]}(u);s.push(t.get(c).next(d=>d?b.resolve():(p=>t.put({targetId:0,path:rt(p),sequenceNumber:i.highestListenSequenceNumber}))(u)))}).next(()=>b.waitFor(s))})}ni(e,t){e.createObjectStore("collectionParents",{keyPath:GC});let r=t.store("collectionParents"),i=new wo,s=o=>{if(i.add(o)){let l=o.lastSegment(),u=o.popLast();return r.put({collectionId:l,parent:rt(u)})}};return t.store("remoteDocuments").J({H:!0},(o,l)=>{let u=new se(o);return s(u.popLast())}).next(()=>t.store("documentMutations").J({H:!0},([o,l,u],c)=>{let d=Lt(l);return s(d.popLast())}))}ri(e){let t=e.store("targets");return t.J((r,i)=>{let s=eo(i),o=uE(this.serializer,s);return t.put(o)})}ii(e,t){let r=t.store("remoteDocuments"),i=[];return r.J((s,o)=>{let l=t.store("remoteDocumentsV14"),u=function(p){return p.document?new F(se.fromString(p.document.name).popFirst(5)):p.noDocument?F.fromSegments(p.noDocument.path):p.unknownDocument?F.fromSegments(p.unknownDocument.path):U()}(o).path.toArray(),c={prefixPath:u.slice(0,u.length-2),collectionGroup:u[u.length-2],documentId:u[u.length-1],readTime:o.readTime||[0,0],unknownDocument:o.unknownDocument,noDocument:o.noDocument,document:o.document,hasCommittedMutations:!!o.hasCommittedMutations};i.push(l.put(c))}).next(()=>b.waitFor(i))}si(e,t){let r=t.store("mutations"),i=mE(this.serializer),s=new su(ou.Hr,this.serializer.ct);return r.U().next(o=>{let l=new Map;return o.forEach(u=>{var c;let d=(c=l.get(u.userId))!==null&&c!==void 0?c:H();ur(this.serializer,u).keys().forEach(p=>d=d.add(p)),l.set(u.userId,d)}),b.forEach(l,(u,c)=>{let d=new Ne(c),p=Xl.lt(this.serializer,d),m=s.getIndexManager(d),v=nu.lt(d,this.serializer,m,s.referenceDelegate);return new iu(i,v,p,m).recalculateAndSaveOverlaysForDocumentKeys(new lo(t,ft.oe),u).next()})})}};function Jv(n){n.createObjectStore("targetDocuments",{keyPath:qC}).createIndex("documentTargetsIndex",BC,{unique:!0}),n.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",UC,{unique:!0}),n.createObjectStore("targetGlobal")}var bd="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.",Lf=class n{constructor(e,t,r,i,s,o,l,u,c,d,p=16){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=r,this.oi=s,this.window=o,this.document=l,this._i=c,this.ai=d,this.ui=p,this.kr=null,this.qr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.ci=null,this.inForeground=!1,this.li=null,this.hi=null,this.Pi=Number.NEGATIVE_INFINITY,this.Ii=m=>Promise.resolve(),!n.D())throw new k(P.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Cf(this,i),this.Ti=t+"main",this.serializer=new Yl(u),this.Ei=new Vn(this.Ti,this.ui,new Ff(this.serializer)),this.Qr=new If(this.referenceDelegate,this.serializer),this.remoteDocumentCache=mE(this.serializer),this.$r=new ff,this.window&&this.window.localStorage?this.di=this.window.localStorage:(this.di=null,d===!1&&Ae("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.Ai().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new k(P.FAILED_PRECONDITION,bd);return this.Ri(),this.Vi(),this.mi(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.Qr.getHighestSequenceNumber(e))}).then(e=>{this.kr=new ft(e,this._i)}).then(()=>{this.qr=!0}).catch(e=>(this.Ei&&this.Ei.close(),Promise.reject(e)))}fi(e){return this.Ii=t=>x(this,null,function*(){if(this.started)return e(t)}),e(this.isPrimary)}setDatabaseDeletedListener(e){this.Ei.L(t=>x(this,null,function*(){t.newVersion===null&&(yield e())}))}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.oi.enqueueAndForget(()=>x(this,null,function*(){this.started&&(yield this.Ai())})))}Ai(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",e=>bl(e).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.gi(e).next(t=>{t||(this.isPrimary=!1,this.oi.enqueueRetryable(()=>this.Ii(!1)))})}).next(()=>this.pi(e)).next(t=>this.isPrimary&&!t?this.yi(e).next(()=>!1):!!t&&this.wi(e).next(()=>!0))).catch(e=>{if(zn(e))return V("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return V("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.oi.enqueueRetryable(()=>this.Ii(e)),this.isPrimary=e})}gi(e){return Xs(e).get("owner").next(t=>b.resolve(this.Si(t)))}bi(e){return bl(e).delete(this.clientId)}Di(){return x(this,null,function*(){if(this.isPrimary&&!this.Ci(this.Pi,18e5)){this.Pi=Date.now();let e=yield this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",t=>{let r=Be(t,"clientMetadata");return r.U().next(i=>{let s=this.vi(i,18e5),o=i.filter(l=>s.indexOf(l)===-1);return b.forEach(o,l=>r.delete(l.clientId)).next(()=>o)})}).catch(()=>[]);if(this.di)for(let t of e)this.di.removeItem(this.Fi(t.clientId))}})}mi(){this.hi=this.oi.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.Ai().then(()=>this.Di()).then(()=>this.mi()))}Si(e){return!!e&&e.ownerId===this.clientId}pi(e){return this.ai?b.resolve(!0):Xs(e).get("owner").next(t=>{if(t!==null&&this.Ci(t.leaseTimestampMs,5e3)&&!this.Mi(t.ownerId)){if(this.Si(t)&&this.networkEnabled)return!0;if(!this.Si(t)){if(!t.allowTabSynchronization)throw new k(P.FAILED_PRECONDITION,bd);return!1}}return!(!this.networkEnabled||!this.inForeground)||bl(e).U().next(r=>this.vi(r,5e3).find(i=>{if(this.clientId!==i.clientId){let s=!this.networkEnabled&&i.networkEnabled,o=!this.inForeground&&i.inForeground,l=this.networkEnabled===i.networkEnabled;if(s||o&&l)return!0}return!1})===void 0)}).next(t=>(this.isPrimary!==t&&V("IndexedDbPersistence",`Client ${t?"is":"is not"} eligible for a primary lease.`),t))}shutdown(){return x(this,null,function*(){this.qr=!1,this.xi(),this.hi&&(this.hi.cancel(),this.hi=null),this.Oi(),this.Ni(),yield this.Ei.runTransaction("shutdown","readwrite",["owner","clientMetadata"],e=>{let t=new lo(e,ft.oe);return this.yi(t).next(()=>this.bi(t))}),this.Ei.close(),this.Li()})}vi(e,t){return e.filter(r=>this.Ci(r.updateTimeMs,t)&&!this.Mi(r.clientId))}Bi(){return this.runTransaction("getActiveClients","readonly",e=>bl(e).U().next(t=>this.vi(t,18e5).map(r=>r.clientId)))}get started(){return this.qr}getMutationQueue(e,t){return nu.lt(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new Ef(e,this.serializer.ct.databaseId)}getDocumentOverlayCache(e){return Xl.lt(this.serializer,e)}getBundleCache(){return this.$r}runTransaction(e,t,r){V("IndexedDbPersistence","Starting transaction:",e);let i=t==="readonly"?"readonly":"readwrite",s=function(u){return u===16?JC:u===15?Iw:u===14?Ew:u===13?ww:u===12?YC:u===11?vw:void U()}(this.ui),o;return this.Ei.runTransaction(e,i,s,l=>(o=new lo(l,this.kr?this.kr.next():ft.oe),t==="readwrite-primary"?this.gi(o).next(u=>!!u||this.pi(o)).next(u=>{if(!u)throw Ae(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.oi.enqueueRetryable(()=>this.Ii(!1)),new k(P.FAILED_PRECONDITION,mw);return r(o)}).next(u=>this.wi(o).next(()=>u)):this.ki(o).next(()=>r(o)))).then(l=>(o.raiseOnCommittedEvent(),l))}ki(e){return Xs(e).get("owner").next(t=>{if(t!==null&&this.Ci(t.leaseTimestampMs,5e3)&&!this.Mi(t.ownerId)&&!this.Si(t)&&!(this.ai||this.allowTabSynchronization&&t.allowTabSynchronization))throw new k(P.FAILED_PRECONDITION,bd)})}wi(e){let t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return Xs(e).put("owner",t)}static D(){return Vn.D()}yi(e){let t=Xs(e);return t.get("owner").next(r=>this.Si(r)?(V("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):b.resolve())}Ci(e,t){let r=Date.now();return!(e<r-t)&&(!(e>r)||(Ae(`Detected an update time that is in the future: ${e} > ${r}`),!1))}Ri(){this.document!==null&&typeof this.document.addEventListener=="function"&&(this.li=()=>{this.oi.enqueueAndForget(()=>(this.inForeground=this.document.visibilityState==="visible",this.Ai()))},this.document.addEventListener("visibilitychange",this.li),this.inForeground=this.document.visibilityState==="visible")}Oi(){this.li&&(this.document.removeEventListener("visibilitychange",this.li),this.li=null)}Vi(){var e;typeof((e=this.window)===null||e===void 0?void 0:e.addEventListener)=="function"&&(this.ci=()=>{this.xi();let t=/(?:Version|Mobile)\/1[456]/;Ec()&&(navigator.appVersion.match(t)||navigator.userAgent.match(t))&&this.oi.enterRestrictedMode(!0),this.oi.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.ci))}Ni(){this.ci&&(this.window.removeEventListener("pagehide",this.ci),this.ci=null)}Mi(e){var t;try{let r=((t=this.di)===null||t===void 0?void 0:t.getItem(this.Fi(e)))!==null;return V("IndexedDbPersistence",`Client '${e}' ${r?"is":"is not"} zombied in LocalStorage`),r}catch(r){return Ae("IndexedDbPersistence","Failed to get zombied client id.",r),!1}}xi(){if(this.di)try{this.di.setItem(this.Fi(this.clientId),String(Date.now()))}catch(e){Ae("Failed to set zombie client id.",e)}}Li(){if(this.di)try{this.di.removeItem(this.Fi(this.clientId))}catch{}}Fi(e){return`firestore_zombie_${this.persistenceKey}_${e}`}};function Xs(n){return Be(n,"owner")}function bl(n){return Be(n,"clientMetadata")}function Up(n,e){let t=n.projectId;return n.isDefaultDatabase||(t+="."+n.database),"firestore/"+e+"/"+t+"/"}var Uf=class n{constructor(e,t,r,i){this.targetId=e,this.fromCache=t,this.qi=r,this.Qi=i}static Ki(e,t){let r=H(),i=H();for(let s of t.docChanges)switch(s.type){case 0:r=r.add(s.doc.key);break;case 1:i=i.add(s.doc.key)}return new n(e,t.fromCache,r,i)}};var qf=class{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}};var au=class{constructor(){this.$i=!1,this.Ui=!1,this.Wi=100,this.Gi=function(){return Ec()?8:gw(ds())>0?6:4}()}initialize(e,t){this.zi=e,this.indexManager=t,this.$i=!0}getDocumentsMatchingQuery(e,t,r,i){let s={result:null};return this.ji(e,t).next(o=>{s.result=o}).next(()=>{if(!s.result)return this.Hi(e,t,i,r).next(o=>{s.result=o})}).next(()=>{if(s.result)return;let o=new qf;return this.Ji(e,t,o).next(l=>{if(s.result=l,this.Ui)return this.Yi(e,t,o,l.size)})}).next(()=>s.result)}Yi(e,t,r,i){return r.documentReadCount<this.Wi?(li()<=gt.DEBUG&&V("QueryEngine","SDK will not create cache indexes for query:",ui(t),"since it only creates cache indexes for collection contains","more than or equal to",this.Wi,"documents"),b.resolve()):(li()<=gt.DEBUG&&V("QueryEngine","Query:",ui(t),"scans",r.documentReadCount,"local documents and returns",i,"documents as results."),r.documentReadCount>this.Gi*i?(li()<=gt.DEBUG&&V("QueryEngine","The SDK decides to create cache indexes for query:",ui(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,it(t))):b.resolve())}ji(e,t){if(Sv(t))return b.resolve(null);let r=it(t);return this.indexManager.getIndexType(e,r).next(i=>i===0?null:(t.limit!==null&&i===1&&(t=Wl(t,null,"F"),r=it(t)),this.indexManager.getDocumentsMatchingTarget(e,r).next(s=>{let o=H(...s);return this.zi.getDocuments(e,o).next(l=>this.indexManager.getMinOffset(e,r).next(u=>{let c=this.Zi(t,l);return this.Xi(t,c,o,u.readTime)?this.ji(e,Wl(t,null,"F")):this.es(e,c,t,u)}))})))}Hi(e,t,r,i){return Sv(t)||i.isEqual(z.min())?b.resolve(null):this.zi.getDocuments(e,r).next(s=>{let o=this.Zi(t,s);return this.Xi(t,o,r,i)?b.resolve(null):(li()<=gt.DEBUG&&V("QueryEngine","Re-using previous result from %s to execute query: %s",i.toString(),ui(t)),this.es(e,o,t,fw(i,-1)).next(l=>l))})}Zi(e,t){let r=new fe(Mw(e));return t.forEach((i,s)=>{Do(e,s)&&(r=r.add(s))}),r}Xi(e,t,r,i){if(e.limit===null)return!1;if(r.size!==t.size)return!0;let s=e.limitType==="F"?t.last():t.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(i)>0)}Ji(e,t,r){return li()<=gt.DEBUG&&V("QueryEngine","Using full collection scan to execute query:",ui(t)),this.zi.getDocumentsMatchingQuery(e,t,It.min(),r)}es(e,t,r,i){return this.zi.getDocumentsMatchingQuery(e,r,i).next(s=>(t.forEach(o=>{s=s.insert(o.key,o)}),s))}};var Bf=class{constructor(e,t,r,i){this.persistence=e,this.ts=t,this.serializer=i,this.ns=new _e($),this.rs=new Kt(s=>_r(s),xo),this.ss=new Map,this.os=e.getRemoteDocumentCache(),this.Qr=e.getTargetCache(),this.$r=e.getBundleCache(),this._s(r)}_s(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new iu(this.os,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.os.setIndexManager(this.indexManager),this.ts.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",t=>e.collect(t,this.ns))}};function gE(n,e,t,r){return new Bf(n,e,t,r)}function _E(n,e){return x(this,null,function*(){let t=L(n);return yield t.persistence.runTransaction("Handle user change","readonly",r=>{let i;return t.mutationQueue.getAllMutationBatches(r).next(s=>(i=s,t._s(e),t.mutationQueue.getAllMutationBatches(r))).next(s=>{let o=[],l=[],u=H();for(let c of i){o.push(c.batchId);for(let d of c.mutations)u=u.add(d.key)}for(let c of s){l.push(c.batchId);for(let d of c.mutations)u=u.add(d.key)}return t.localDocuments.getDocuments(r,u).next(c=>({us:c,removedBatchIds:o,addedBatchIds:l}))})})})}function x0(n,e){let t=L(n);return t.persistence.runTransaction("Acknowledge batch","readwrite-primary",r=>{let i=e.batch.keys(),s=t.os.newChangeBuffer({trackRemovals:!0});return function(l,u,c,d){let p=c.batch,m=p.keys(),v=b.resolve();return m.forEach(C=>{v=v.next(()=>d.getEntry(u,C)).next(N=>{let D=c.docVersions.get(C);G(D!==null),N.version.compareTo(D)<0&&(p.applyToRemoteDocument(N,c),N.isValidDocument()&&(N.setReadTime(c.commitVersion),d.addEntry(N)))})}),v.next(()=>l.mutationQueue.removeMutationBatch(u,p))}(t,r,e,s).next(()=>s.apply(r)).next(()=>t.mutationQueue.performConsistencyCheck(r)).next(()=>t.documentOverlayCache.removeOverlaysForBatchId(r,i,e.batch.batchId)).next(()=>t.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(r,function(l){let u=H();for(let c=0;c<l.mutationResults.length;++c)l.mutationResults[c].transformResults.length>0&&(u=u.add(l.batch.mutations[c].key));return u}(e))).next(()=>t.localDocuments.getDocuments(r,i))})}function yE(n){let e=L(n);return e.persistence.runTransaction("Get last remote snapshot version","readonly",t=>e.Qr.getLastRemoteSnapshotVersion(t))}function N0(n,e){let t=L(n),r=e.snapshotVersion,i=t.ns;return t.persistence.runTransaction("Apply remote event","readwrite-primary",s=>{let o=t.os.newChangeBuffer({trackRemovals:!0});i=t.ns;let l=[];e.targetChanges.forEach((d,p)=>{let m=i.get(p);if(!m)return;l.push(t.Qr.removeMatchingKeys(s,d.removedDocuments,p).next(()=>t.Qr.addMatchingKeys(s,d.addedDocuments,p)));let v=m.withSequenceNumber(s.currentSequenceNumber);e.targetMismatches.get(p)!==null?v=v.withResumeToken(qe.EMPTY_BYTE_STRING,z.min()).withLastLimboFreeSnapshotVersion(z.min()):d.resumeToken.approximateByteSize()>0&&(v=v.withResumeToken(d.resumeToken,r)),i=i.insert(p,v),function(N,D,B){return N.resumeToken.approximateByteSize()===0||D.snapshotVersion.toMicroseconds()-N.snapshotVersion.toMicroseconds()>=3e8?!0:B.addedDocuments.size+B.modifiedDocuments.size+B.removedDocuments.size>0}(m,v,d)&&l.push(t.Qr.updateTargetData(s,v))});let u=at(),c=H();if(e.documentUpdates.forEach(d=>{e.resolvedLimboDocuments.has(d)&&l.push(t.persistence.referenceDelegate.updateLimboDocument(s,d))}),l.push(vE(s,o,e.documentUpdates).next(d=>{u=d.cs,c=d.ls})),!r.isEqual(z.min())){let d=t.Qr.getLastRemoteSnapshotVersion(s).next(p=>t.Qr.setTargetsMetadata(s,s.currentSequenceNumber,r));l.push(d)}return b.waitFor(l).next(()=>o.apply(s)).next(()=>t.localDocuments.getLocalViewOfDocuments(s,u,c)).next(()=>u)}).then(s=>(t.ns=i,s))}function vE(n,e,t){let r=H(),i=H();return t.forEach(s=>r=r.add(s)),e.getEntries(n,r).next(s=>{let o=at();return t.forEach((l,u)=>{let c=s.get(l);u.isFoundDocument()!==c.isFoundDocument()&&(i=i.add(l)),u.isNoDocument()&&u.version.isEqual(z.min())?(e.removeEntry(l,u.readTime),o=o.insert(l,u)):!c.isValidDocument()||u.version.compareTo(c.version)>0||u.version.compareTo(c.version)===0&&c.hasPendingWrites?(e.addEntry(u),o=o.insert(l,u)):V("LocalStore","Ignoring outdated watch update for ",l,". Current version:",c.version," Watch version:",u.version)}),{cs:o,ls:i}})}function D0(n,e){let t=L(n);return t.persistence.runTransaction("Get next mutation batch","readonly",r=>(e===void 0&&(e=-1),t.mutationQueue.getNextMutationBatchAfterBatchId(r,e)))}function Ci(n,e){let t=L(n);return t.persistence.runTransaction("Allocate target","readwrite",r=>{let i;return t.Qr.getTargetData(r,e).next(s=>s?(i=s,b.resolve(i)):t.Qr.allocateTargetId(r).next(o=>(i=new Si(e,o,"TargetPurposeListen",r.currentSequenceNumber),t.Qr.addTargetData(r,i).next(()=>i))))}).then(r=>{let i=t.ns.get(r.targetId);return(i===null||r.snapshotVersion.compareTo(i.snapshotVersion)>0)&&(t.ns=t.ns.insert(r.targetId,r),t.rs.set(e,r.targetId)),r})}function bi(n,e,t){return x(this,null,function*(){let r=L(n),i=r.ns.get(e),s=t?"readwrite":"readwrite-primary";try{t||(yield r.persistence.runTransaction("Release target",s,o=>r.persistence.referenceDelegate.removeTarget(o,i)))}catch(o){if(!zn(o))throw o;V("LocalStore",`Failed to update sequence numbers for target ${e}: ${o}`)}r.ns=r.ns.remove(e),r.rs.delete(i.target)})}function lu(n,e,t){let r=L(n),i=z.min(),s=H();return r.persistence.runTransaction("Execute query","readwrite",o=>function(u,c,d){let p=L(u),m=p.rs.get(d);return m!==void 0?b.resolve(p.ns.get(m)):p.Qr.getTargetData(c,d)}(r,o,it(e)).next(l=>{if(l)return i=l.lastLimboFreeSnapshotVersion,r.Qr.getMatchingKeysForTargetId(o,l.targetId).next(u=>{s=u})}).next(()=>r.ts.getDocumentsMatchingQuery(o,e,t?i:z.min(),t?s:H())).next(l=>(IE(r,Vw(e),l),{documents:l,hs:s})))}function wE(n,e){let t=L(n),r=L(t.Qr),i=t.ns.get(e);return i?Promise.resolve(i.target):t.persistence.runTransaction("Get target data","readonly",s=>r.ot(s,e).next(o=>o?o.target:null))}function EE(n,e){let t=L(n),r=t.ss.get(e)||z.min();return t.persistence.runTransaction("Get new document changes","readonly",i=>t.os.getAllFromCollectionGroup(i,e,fw(r,-1),Number.MAX_SAFE_INTEGER)).then(i=>(IE(t,e,i),i))}function IE(n,e,t){let r=n.ss.get(e)||z.min();t.forEach((i,s)=>{s.readTime.compareTo(r)>0&&(r=s.readTime)}),n.ss.set(e,r)}function k0(n,e,t,r){return x(this,null,function*(){let i=L(n),s=H(),o=at();for(let c of t){let d=e.Ps(c.metadata.name);c.document&&(s=s.add(d));let p=e.Is(c);p.setReadTime(e.Ts(c.metadata.readTime)),o=o.insert(d,p)}let l=i.os.newChangeBuffer({trackRemovals:!0}),u=yield Ci(i,function(d){return it(Mi(se.fromString(`__bundle__/docs/${d}`)))}(r));return i.persistence.runTransaction("Apply bundle documents","readwrite",c=>vE(c,l,o).next(d=>(l.apply(c),d)).next(d=>i.Qr.removeMatchingKeysForTargetId(c,u.targetId).next(()=>i.Qr.addMatchingKeys(c,s,u.targetId)).next(()=>i.localDocuments.getLocalViewOfDocuments(c,d.cs,d.ls)).next(()=>d.cs)))})}function V0(r,i){return x(this,arguments,function*(n,e,t=H()){let s=yield Ci(n,it(Fp(e.bundledQuery))),o=L(n);return o.persistence.runTransaction("Save named query","readwrite",l=>{let u=be(e.readTime);if(s.snapshotVersion.compareTo(u)>=0)return o.$r.saveNamedQuery(l,e);let c=s.withResumeToken(qe.EMPTY_BYTE_STRING,u);return o.ns=o.ns.insert(c.targetId,c),o.Qr.updateTargetData(l,c).next(()=>o.Qr.removeMatchingKeysForTargetId(l,s.targetId)).next(()=>o.Qr.addMatchingKeys(l,t,s.targetId)).next(()=>o.$r.saveNamedQuery(l,e))})})}function Xv(n,e){return`firestore_clients_${n}_${e}`}function Zv(n,e,t){let r=`firestore_mutations_${n}_${t}`;return e.isAuthenticated()&&(r+=`_${e.uid}`),r}function Rd(n,e){return`firestore_targets_${n}_${e}`}var uu=class n{constructor(e,t,r,i){this.user=e,this.batchId=t,this.state=r,this.error=i}static Es(e,t,r){let i=JSON.parse(r),s,o=typeof i=="object"&&["pending","acknowledged","rejected"].indexOf(i.state)!==-1&&(i.error===void 0||typeof i.error=="object");return o&&i.error&&(o=typeof i.error.message=="string"&&typeof i.error.code=="string",o&&(s=new k(i.error.code,i.error.message))),o?new n(e,t,i.state,s):(Ae("SharedClientState",`Failed to parse mutation state for ID '${t}': ${r}`),null)}ds(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}},io=class n{constructor(e,t,r){this.targetId=e,this.state=t,this.error=r}static Es(e,t){let r=JSON.parse(t),i,s=typeof r=="object"&&["not-current","current","rejected"].indexOf(r.state)!==-1&&(r.error===void 0||typeof r.error=="object");return s&&r.error&&(s=typeof r.error.message=="string"&&typeof r.error.code=="string",s&&(i=new k(r.error.code,r.error.message))),s?new n(e,r.state,i):(Ae("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}ds(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}},cu=class n{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Es(e,t){let r=JSON.parse(t),i=typeof r=="object"&&r.activeTargetIds instanceof Array,s=Mp();for(let o=0;i&&o<r.activeTargetIds.length;++o)i=_w(r.activeTargetIds[o]),s=s.add(r.activeTargetIds[o]);return i?new n(e,s):(Ae("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}},Gf=class n{constructor(e,t){this.clientId=e,this.onlineState=t}static Es(e){let t=JSON.parse(e);return typeof t=="object"&&["Unknown","Online","Offline"].indexOf(t.onlineState)!==-1&&typeof t.clientId=="string"?new n(t.clientId,t.onlineState):(Ae("SharedClientState",`Failed to parse online state: ${e}`),null)}},Io=class{constructor(){this.activeTargetIds=Mp()}As(e){this.activeTargetIds=this.activeTargetIds.add(e)}Rs(e){this.activeTargetIds=this.activeTargetIds.delete(e)}ds(){let e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}},so=class{constructor(e,t,r,i,s){this.window=e,this.oi=t,this.persistenceKey=r,this.Vs=i,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.fs=this.gs.bind(this),this.ps=new _e($),this.started=!1,this.ys=[];let o=r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.ws=Xv(this.persistenceKey,this.Vs),this.Ss=function(u){return`firestore_sequence_number_${u}`}(this.persistenceKey),this.ps=this.ps.insert(this.Vs,new Io),this.bs=new RegExp(`^firestore_clients_${o}_([^_]*)$`),this.Ds=new RegExp(`^firestore_mutations_${o}_(\\d+)(?:_(.*))?$`),this.Cs=new RegExp(`^firestore_targets_${o}_(\\d+)$`),this.vs=function(u){return`firestore_online_state_${u}`}(this.persistenceKey),this.Fs=function(u){return`firestore_bundle_loaded_v2_${u}`}(this.persistenceKey),this.window.addEventListener("storage",this.fs)}static D(e){return!(!e||!e.localStorage)}start(){return x(this,null,function*(){let e=yield this.syncEngine.Bi();for(let r of e){if(r===this.Vs)continue;let i=this.getItem(Xv(this.persistenceKey,r));if(i){let s=cu.Es(r,i);s&&(this.ps=this.ps.insert(s.clientId,s))}}this.Ms();let t=this.storage.getItem(this.vs);if(t){let r=this.xs(t);r&&this.Os(r)}for(let r of this.ys)this.gs(r);this.ys=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0})}writeSequenceNumber(e){this.setItem(this.Ss,JSON.stringify(e))}getAllActiveQueryTargets(){return this.Ns(this.ps)}isActiveQueryTarget(e){let t=!1;return this.ps.forEach((r,i)=>{i.activeTargetIds.has(e)&&(t=!0)}),t}addPendingMutation(e){this.Ls(e,"pending")}updateMutationState(e,t,r){this.Ls(e,t,r),this.Bs(e)}addLocalQueryTarget(e){let t="not-current";if(this.isActiveQueryTarget(e)){let r=this.storage.getItem(Rd(this.persistenceKey,e));if(r){let i=io.Es(e,r);i&&(t=i.state)}}return this.ks.As(e),this.Ms(),t}removeLocalQueryTarget(e){this.ks.Rs(e),this.Ms()}isLocalQueryTarget(e){return this.ks.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(Rd(this.persistenceKey,e))}updateQueryState(e,t,r){this.qs(e,t,r)}handleUserChange(e,t,r){t.forEach(i=>{this.Bs(i)}),this.currentUser=e,r.forEach(i=>{this.addPendingMutation(i)})}setOnlineState(e){this.Qs(e)}notifyBundleLoaded(e){this.Ks(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.fs),this.removeItem(this.ws),this.started=!1)}getItem(e){let t=this.storage.getItem(e);return V("SharedClientState","READ",e,t),t}setItem(e,t){V("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){V("SharedClientState","REMOVE",e),this.storage.removeItem(e)}gs(e){let t=e;if(t.storageArea===this.storage){if(V("SharedClientState","EVENT",t.key,t.newValue),t.key===this.ws)return void Ae("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.oi.enqueueRetryable(()=>x(this,null,function*(){if(this.started){if(t.key!==null){if(this.bs.test(t.key)){if(t.newValue==null){let r=this.$s(t.key);return this.Us(r,null)}{let r=this.Ws(t.key,t.newValue);if(r)return this.Us(r.clientId,r)}}else if(this.Ds.test(t.key)){if(t.newValue!==null){let r=this.Gs(t.key,t.newValue);if(r)return this.zs(r)}}else if(this.Cs.test(t.key)){if(t.newValue!==null){let r=this.js(t.key,t.newValue);if(r)return this.Hs(r)}}else if(t.key===this.vs){if(t.newValue!==null){let r=this.xs(t.newValue);if(r)return this.Os(r)}}else if(t.key===this.Ss){let r=function(s){let o=ft.oe;if(s!=null)try{let l=JSON.parse(s);G(typeof l=="number"),o=l}catch(l){Ae("SharedClientState","Failed to read sequence number from WebStorage",l)}return o}(t.newValue);r!==ft.oe&&this.sequenceNumberHandler(r)}else if(t.key===this.Fs){let r=this.Js(t.newValue);yield Promise.all(r.map(i=>this.syncEngine.Ys(i)))}}}else this.ys.push(t)}))}}get ks(){return this.ps.get(this.Vs)}Ms(){this.setItem(this.ws,this.ks.ds())}Ls(e,t,r){let i=new uu(this.currentUser,e,t,r),s=Zv(this.persistenceKey,this.currentUser,e);this.setItem(s,i.ds())}Bs(e){let t=Zv(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Qs(e){let t={clientId:this.Vs,onlineState:e};this.storage.setItem(this.vs,JSON.stringify(t))}qs(e,t,r){let i=Rd(this.persistenceKey,e),s=new io(e,t,r);this.setItem(i,s.ds())}Ks(e){let t=JSON.stringify(Array.from(e));this.setItem(this.Fs,t)}$s(e){let t=this.bs.exec(e);return t?t[1]:null}Ws(e,t){let r=this.$s(e);return cu.Es(r,t)}Gs(e,t){let r=this.Ds.exec(e),i=Number(r[1]),s=r[2]!==void 0?r[2]:null;return uu.Es(new Ne(s),i,t)}js(e,t){let r=this.Cs.exec(e),i=Number(r[1]);return io.Es(i,t)}xs(e){return Gf.Es(e)}Js(e){return JSON.parse(e)}zs(e){return x(this,null,function*(){if(e.user.uid===this.currentUser.uid)return this.syncEngine.Zs(e.batchId,e.state,e.error);V("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)})}Hs(e){return this.syncEngine.Xs(e.targetId,e.state,e.error)}Us(e,t){let r=t?this.ps.insert(e,t):this.ps.remove(e),i=this.Ns(this.ps),s=this.Ns(r),o=[],l=[];return s.forEach(u=>{i.has(u)||o.push(u)}),i.forEach(u=>{s.has(u)||l.push(u)}),this.syncEngine.eo(o,l).then(()=>{this.ps=r})}Os(e){this.ps.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}Ns(e){let t=Mp();return e.forEach((r,i)=>{t=t.unionWith(i.activeTargetIds)}),t}},hu=class{constructor(){this.no=new Io,this.ro={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,r){}addLocalQueryTarget(e){return this.no.As(e),this.ro[e]||"not-current"}updateQueryState(e,t,r){this.ro[e]=t}removeLocalQueryTarget(e){this.no.Rs(e)}isLocalQueryTarget(e){return this.no.activeTargetIds.has(e)}clearQueryState(e){delete this.ro[e]}getAllActiveQueryTargets(){return this.no.activeTargetIds}isActiveQueryTarget(e){return this.no.activeTargetIds.has(e)}start(){return this.no=new Io,Promise.resolve()}handleUserChange(e,t,r){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}};var jf=class{io(e){}shutdown(){}};var du=class{constructor(){this.so=()=>this.oo(),this._o=()=>this.ao(),this.uo=[],this.co()}io(e){this.uo.push(e)}shutdown(){window.removeEventListener("online",this.so),window.removeEventListener("offline",this._o)}co(){window.addEventListener("online",this.so),window.addEventListener("offline",this._o)}oo(){V("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(let e of this.uo)e(0)}ao(){V("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(let e of this.uo)e(1)}static D(){return typeof window<"u"&&window.addEventListener!==void 0&&window.removeEventListener!==void 0}};var Rl=null;function Pd(){return Rl===null?Rl=function(){return 268435456+Math.round(2147483648*Math.random())}():Rl++,"0x"+Rl.toString(16)}var M0={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};var zf=class{constructor(e){this.lo=e.lo,this.ho=e.ho}Po(e){this.Io=e}To(e){this.Eo=e}Ao(e){this.Ro=e}onMessage(e){this.Vo=e}close(){this.ho()}send(e){this.lo(e)}mo(){this.Io()}fo(){this.Eo()}po(e){this.Ro(e)}yo(e){this.Vo(e)}};var He="WebChannelConnection",Kf=class extends class{constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;let r=t.ssl?"https":"http",i=encodeURIComponent(this.databaseId.projectId),s=encodeURIComponent(this.databaseId.database);this.wo=r+"://"+t.host,this.So=`projects/${i}/databases/${s}`,this.bo=this.databaseId.database==="(default)"?`project_id=${i}`:`project_id=${i}&database_id=${s}`}get Do(){return!1}Co(t,r,i,s,o){let l=Pd(),u=this.vo(t,r.toUriEncodedString());V("RestConnection",`Sending RPC '${t}' ${l}:`,u,i);let c={"google-cloud-resource-prefix":this.So,"x-goog-request-params":this.bo};return this.Fo(c,s,o),this.Mo(t,u,c,i).then(d=>(V("RestConnection",`Received RPC '${t}' ${l}: `,d),d),d=>{throw Et("RestConnection",`RPC '${t}' ${l} failed with error: `,d,"url: ",u,"request:",i),d})}xo(t,r,i,s,o,l){return this.Co(t,r,i,s,o)}Fo(t,r,i){t["X-Goog-Api-Client"]=function(){return"gl-js/ fire/"+Vi}(),t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),r&&r.headers.forEach((s,o)=>t[o]=s),i&&i.headers.forEach((s,o)=>t[o]=s)}vo(t,r){let i=M0[t];return`${this.wo}/v1/${r}:${i}`}terminate(){}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}Mo(e,t,r,i){let s=Pd();return new Promise((o,l)=>{let u=new wd;u.setWithCredentials(!0),u.listenOnce(Id.COMPLETE,()=>{try{switch(u.getLastErrorCode()){case $s.NO_ERROR:let d=u.getResponseJson();V(He,`XHR for RPC '${e}' ${s} received:`,JSON.stringify(d)),o(d);break;case $s.TIMEOUT:V(He,`RPC '${e}' ${s} timed out`),l(new k(P.DEADLINE_EXCEEDED,"Request time out"));break;case $s.HTTP_ERROR:let p=u.getStatus();if(V(He,`RPC '${e}' ${s} failed with status:`,p,"response text:",u.getResponseText()),p>0){let m=u.getResponseJson();Array.isArray(m)&&(m=m[0]);let v=m?.error;if(v&&v.status&&v.message){let C=function(D){let B=D.toLowerCase().replace(/_/g,"-");return Object.values(P).indexOf(B)>=0?B:P.UNKNOWN}(v.status);l(new k(C,v.message))}else l(new k(P.UNKNOWN,"Server responded with status "+u.getStatus()))}else l(new k(P.UNAVAILABLE,"Connection failed."));break;default:U()}}finally{V(He,`RPC '${e}' ${s} completed.`)}});let c=JSON.stringify(i);V(He,`RPC '${e}' ${s} sending request:`,i),u.send(t,"POST",c,r,15)})}Oo(e,t,r){let i=Pd(),s=[this.wo,"/","google.firestore.v1.Firestore","/",e,"/channel"],o=Ad(),l=Sd(),u={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},c=this.longPollingOptions.timeoutSeconds;c!==void 0&&(u.longPollingTimeout=Math.round(1e3*c)),this.useFetchStreams&&(u.xmlHttpFactory=new Ed({})),this.Fo(u.initMessageHeaders,t,r),u.encodeInitMessageHeaders=!0;let d=s.join("");V(He,`Creating RPC '${e}' stream ${i}: ${d}`,u);let p=o.createWebChannel(d,u),m=!1,v=!1,C=new zf({lo:D=>{v?V(He,`Not sending because RPC '${e}' stream ${i} is closed:`,D):(m||(V(He,`Opening RPC '${e}' stream ${i} transport.`),p.open(),m=!0),V(He,`RPC '${e}' stream ${i} sending:`,D),p.send(D))},ho:()=>p.close()}),N=(D,B,j)=>{D.listen(B,q=>{try{j(q)}catch(Y){setTimeout(()=>{throw Y},0)}})};return N(p,ri.EventType.OPEN,()=>{v||(V(He,`RPC '${e}' stream ${i} transport opened.`),C.mo())}),N(p,ri.EventType.CLOSE,()=>{v||(v=!0,V(He,`RPC '${e}' stream ${i} transport closed`),C.po())}),N(p,ri.EventType.ERROR,D=>{v||(v=!0,Et(He,`RPC '${e}' stream ${i} transport errored:`,D),C.po(new k(P.UNAVAILABLE,"The operation could not be completed")))}),N(p,ri.EventType.MESSAGE,D=>{var B;if(!v){let j=D.data[0];G(!!j);let q=j,Y=q.error||((B=q[0])===null||B===void 0?void 0:B.error);if(Y){V(He,`RPC '${e}' stream ${i} received error:`,Y);let ne=Y.status,W=function(w){let I=Pe[w];if(I!==void 0)return Hw(I)}(ne),E=Y.message;W===void 0&&(W=P.INTERNAL,E="Unknown error status: "+ne+" with message "+Y.message),v=!0,C.po(new k(W,E)),p.close()}else V(He,`RPC '${e}' stream ${i} received:`,j),C.yo(j)}}),N(l,Td.STAT_EVENT,D=>{D.stat===Sl.PROXY?V(He,`RPC '${e}' stream ${i} detected buffering proxy`):D.stat===Sl.NOPROXY&&V(He,`RPC '${e}' stream ${i} detected no buffering proxy`)}),setTimeout(()=>{C.fo()},0),C}};function TE(){return typeof window<"u"?window:null}function kl(){return typeof document<"u"?document:null}function ko(n){return new lf(n,!0)}var To=class{constructor(e,t,r=1e3,i=1.5,s=6e4){this.oi=e,this.timerId=t,this.No=r,this.Lo=i,this.Bo=s,this.ko=0,this.qo=null,this.Qo=Date.now(),this.reset()}reset(){this.ko=0}Ko(){this.ko=this.Bo}$o(e){this.cancel();let t=Math.floor(this.ko+this.Uo()),r=Math.max(0,Date.now()-this.Qo),i=Math.max(0,t-r);i>0&&V("ExponentialBackoff",`Backing off for ${i} ms (base delay: ${this.ko} ms, delay with jitter: ${t} ms, last attempt: ${r} ms ago)`),this.qo=this.oi.enqueueAfterDelay(this.timerId,i,()=>(this.Qo=Date.now(),e())),this.ko*=this.Lo,this.ko<this.No&&(this.ko=this.No),this.ko>this.Bo&&(this.ko=this.Bo)}Wo(){this.qo!==null&&(this.qo.skipDelay(),this.qo=null)}cancel(){this.qo!==null&&(this.qo.cancel(),this.qo=null)}Uo(){return(Math.random()-.5)*this.ko}};var fu=class{constructor(e,t,r,i,s,o,l,u){this.oi=e,this.Go=r,this.zo=i,this.connection=s,this.authCredentialsProvider=o,this.appCheckCredentialsProvider=l,this.listener=u,this.state=0,this.jo=0,this.Ho=null,this.Jo=null,this.stream=null,this.Yo=new To(e,t)}Zo(){return this.state===1||this.state===5||this.Xo()}Xo(){return this.state===2||this.state===3}start(){this.state!==4?this.auth():this.e_()}stop(){return x(this,null,function*(){this.Zo()&&(yield this.close(0))})}t_(){this.state=0,this.Yo.reset()}n_(){this.Xo()&&this.Ho===null&&(this.Ho=this.oi.enqueueAfterDelay(this.Go,6e4,()=>this.r_()))}i_(e){this.s_(),this.stream.send(e)}r_(){return x(this,null,function*(){if(this.Xo())return this.close(0)})}s_(){this.Ho&&(this.Ho.cancel(),this.Ho=null)}o_(){this.Jo&&(this.Jo.cancel(),this.Jo=null)}close(e,t){return x(this,null,function*(){this.s_(),this.o_(),this.Yo.cancel(),this.jo++,e!==4?this.Yo.reset():t&&t.code===P.RESOURCE_EXHAUSTED?(Ae(t.toString()),Ae("Using maximum backoff delay to prevent overloading the backend."),this.Yo.Ko()):t&&t.code===P.UNAUTHENTICATED&&this.state!==3&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),this.stream!==null&&(this.__(),this.stream.close(),this.stream=null),this.state=e,yield this.listener.Ao(t)})}__(){}auth(){this.state=1;let e=this.a_(this.jo),t=this.jo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([r,i])=>{this.jo===t&&this.u_(r,i)},r=>{e(()=>{let i=new k(P.UNKNOWN,"Fetching auth token failed: "+r.message);return this.c_(i)})})}u_(e,t){let r=this.a_(this.jo);this.stream=this.l_(e,t),this.stream.Po(()=>{r(()=>this.listener.Po())}),this.stream.To(()=>{r(()=>(this.state=2,this.Jo=this.oi.enqueueAfterDelay(this.zo,1e4,()=>(this.Xo()&&(this.state=3),Promise.resolve())),this.listener.To()))}),this.stream.Ao(i=>{r(()=>this.c_(i))}),this.stream.onMessage(i=>{r(()=>this.onMessage(i))})}e_(){this.state=5,this.Yo.$o(()=>x(this,null,function*(){this.state=0,this.start()}))}c_(e){return V("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}a_(e){return t=>{this.oi.enqueueAndForget(()=>this.jo===e?t():(V("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}},Wf=class extends fu{constructor(e,t,r,i,s,o){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,r,i,o),this.serializer=s}l_(e,t){return this.connection.Oo("Listen",e,t)}onMessage(e){this.Yo.reset();let t=v0(this.serializer,e),r=function(s){if(!("targetChange"in s))return z.min();let o=s.targetChange;return o.targetIds&&o.targetIds.length?z.min():o.readTime?be(o.readTime):z.min()}(e);return this.listener.h_(t,r)}P_(e){let t={};t.database=hf(this.serializer),t.addTarget=function(s,o){let l,u=o.target;if(l=zl(u)?{documents:rE(s,u)}:{query:iE(s,u)._t},l.targetId=o.targetId,o.resumeToken.approximateByteSize()>0){l.resumeToken=Jw(s,o.resumeToken);let c=uf(s,o.expectedCount);c!==null&&(l.expectedCount=c)}else if(o.snapshotVersion.compareTo(z.min())>0){l.readTime=Ti(s,o.snapshotVersion.toTimestamp());let c=uf(s,o.expectedCount);c!==null&&(l.expectedCount=c)}return l}(this.serializer,e);let r=E0(this.serializer,e);r&&(t.labels=r),this.i_(t)}I_(e){let t={};t.database=hf(this.serializer),t.removeTarget=e,this.i_(t)}},Qf=class extends fu{constructor(e,t,r,i,s,o){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,r,i,o),this.serializer=s,this.T_=!1}get E_(){return this.T_}start(){this.T_=!1,this.lastStreamToken=void 0,super.start()}__(){this.T_&&this.d_([])}l_(e,t){return this.connection.Oo("Write",e,t)}onMessage(e){if(G(!!e.streamToken),this.lastStreamToken=e.streamToken,this.T_){this.Yo.reset();let t=w0(e.writeResults,e.commitTime),r=be(e.commitTime);return this.listener.A_(r,t)}return G(!e.writeResults||e.writeResults.length===0),this.T_=!0,this.listener.R_()}V_(){let e={};e.database=hf(this.serializer),this.i_(e)}d_(e){let t={streamToken:this.lastStreamToken,writes:e.map(r=>vo(this.serializer,r))};this.i_(t)}};var $f=class extends class{}{constructor(e,t,r,i){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=r,this.serializer=i,this.m_=!1}f_(){if(this.m_)throw new k(P.FAILED_PRECONDITION,"The client has already been terminated.")}Co(e,t,r,i){return this.f_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([s,o])=>this.connection.Co(e,cf(t,r),i,s,o)).catch(s=>{throw s.name==="FirebaseError"?(s.code===P.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),s):new k(P.UNKNOWN,s.toString())})}xo(e,t,r,i,s){return this.f_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([o,l])=>this.connection.xo(e,cf(t,r),i,o,l,s)).catch(o=>{throw o.name==="FirebaseError"?(o.code===P.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),o):new k(P.UNKNOWN,o.toString())})}terminate(){this.m_=!0,this.connection.terminate()}},Hf=class{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.g_=0,this.p_=null,this.y_=!0}w_(){this.g_===0&&(this.S_("Unknown"),this.p_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.p_=null,this.b_("Backend didn't respond within 10 seconds."),this.S_("Offline"),Promise.resolve())))}D_(e){this.state==="Online"?this.S_("Unknown"):(this.g_++,this.g_>=1&&(this.C_(),this.b_(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.S_("Offline")))}set(e){this.C_(),this.g_=0,e==="Online"&&(this.y_=!1),this.S_(e)}S_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}b_(e){let t=`Could not reach Cloud Firestore backend. ${e}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.y_?(Ae(t),this.y_=!1):V("OnlineStateTracker",t)}C_(){this.p_!==null&&(this.p_.cancel(),this.p_=null)}};var Yf=class{constructor(e,t,r,i,s){this.localStore=e,this.datastore=t,this.asyncQueue=r,this.remoteSyncer={},this.v_=[],this.F_=new Map,this.M_=new Set,this.x_=[],this.O_=s,this.O_.io(o=>{r.enqueueAndForget(()=>x(this,null,function*(){Kn(this)&&(V("RemoteStore","Restarting streams for network reachability change."),yield function(u){return x(this,null,function*(){let c=L(u);c.M_.add(4),yield Oi(c),c.N_.set("Unknown"),c.M_.delete(4),yield Vo(c)})}(this))}))}),this.N_=new Hf(r,i)}};function Vo(n){return x(this,null,function*(){if(Kn(n))for(let e of n.x_)yield e(!0)})}function Oi(n){return x(this,null,function*(){for(let e of n.x_)yield e(!1)})}function Du(n,e){let t=L(n);t.F_.has(e.targetId)||(t.F_.set(e.targetId,e),Gp(t)?Bp(t):Li(t).Xo()&&qp(t,e))}function Ri(n,e){let t=L(n),r=Li(t);t.F_.delete(e),r.Xo()&&SE(t,e),t.F_.size===0&&(r.Xo()?r.n_():Kn(t)&&t.N_.set("Unknown"))}function qp(n,e){if(n.L_.xe(e.targetId),e.resumeToken.approximateByteSize()>0||e.snapshotVersion.compareTo(z.min())>0){let t=n.remoteSyncer.getRemoteKeysForTarget(e.targetId).size;e=e.withExpectedCount(t)}Li(n).P_(e)}function SE(n,e){n.L_.xe(e),Li(n).I_(e)}function Bp(n){n.L_=new af({getRemoteKeysForTarget:e=>n.remoteSyncer.getRemoteKeysForTarget(e),ot:e=>n.F_.get(e)||null,tt:()=>n.datastore.serializer.databaseId}),Li(n).start(),n.N_.w_()}function Gp(n){return Kn(n)&&!Li(n).Zo()&&n.F_.size>0}function Kn(n){return L(n).M_.size===0}function AE(n){n.L_=void 0}function O0(n){return x(this,null,function*(){n.N_.set("Online")})}function F0(n){return x(this,null,function*(){n.F_.forEach((e,t)=>{qp(n,e)})})}function L0(n,e){return x(this,null,function*(){AE(n),Gp(n)?(n.N_.D_(e),Bp(n)):n.N_.set("Unknown")})}function U0(n,e,t){return x(this,null,function*(){if(n.N_.set("Online"),e instanceof $l&&e.state===2&&e.cause)try{yield function(i,s){return x(this,null,function*(){let o=s.cause;for(let l of s.targetIds)i.F_.has(l)&&(yield i.remoteSyncer.rejectListen(l,o),i.F_.delete(l),i.L_.removeTarget(l))})}(n,e)}catch(r){V("RemoteStore","Failed to remove targets %s: %s ",e.targetIds.join(","),r),yield pu(n,r)}else if(e instanceof gi?n.L_.Ke(e):e instanceof Ql?n.L_.He(e):n.L_.We(e),!t.isEqual(z.min()))try{let r=yield yE(n.localStore);t.compareTo(r)>=0&&(yield function(s,o){let l=s.L_.rt(o);return l.targetChanges.forEach((u,c)=>{if(u.resumeToken.approximateByteSize()>0){let d=s.F_.get(c);d&&s.F_.set(c,d.withResumeToken(u.resumeToken,o))}}),l.targetMismatches.forEach((u,c)=>{let d=s.F_.get(u);if(!d)return;s.F_.set(u,d.withResumeToken(qe.EMPTY_BYTE_STRING,d.snapshotVersion)),SE(s,u);let p=new Si(d.target,u,c,d.sequenceNumber);qp(s,p)}),s.remoteSyncer.applyRemoteEvent(l)}(n,t))}catch(r){V("RemoteStore","Failed to raise snapshot:",r),yield pu(n,r)}})}function pu(n,e,t){return x(this,null,function*(){if(!zn(e))throw e;n.M_.add(1),yield Oi(n),n.N_.set("Offline"),t||(t=()=>yE(n.localStore)),n.asyncQueue.enqueueRetryable(()=>x(this,null,function*(){V("RemoteStore","Retrying IndexedDB access"),yield t(),n.M_.delete(1),yield Vo(n)}))})}function CE(n,e){return e().catch(t=>pu(n,t,e))}function Fi(n){return x(this,null,function*(){let e=L(n),t=Gn(e),r=e.v_.length>0?e.v_[e.v_.length-1].batchId:-1;for(;q0(e);)try{let i=yield D0(e.localStore,r);if(i===null){e.v_.length===0&&t.n_();break}r=i.batchId,B0(e,i)}catch(i){yield pu(e,i)}bE(e)&&RE(e)})}function q0(n){return Kn(n)&&n.v_.length<10}function B0(n,e){n.v_.push(e);let t=Gn(n);t.Xo()&&t.E_&&t.d_(e.mutations)}function bE(n){return Kn(n)&&!Gn(n).Zo()&&n.v_.length>0}function RE(n){Gn(n).start()}function G0(n){return x(this,null,function*(){Gn(n).V_()})}function j0(n){return x(this,null,function*(){let e=Gn(n);for(let t of n.v_)e.d_(t.mutations)})}function z0(n,e,t){return x(this,null,function*(){let r=n.v_.shift(),i=rf.from(r,e,t);yield CE(n,()=>n.remoteSyncer.applySuccessfulWrite(i)),yield Fi(n)})}function K0(n,e){return x(this,null,function*(){e&&Gn(n).E_&&(yield function(r,i){return x(this,null,function*(){if(function(o){return $w(o)&&o!==P.ABORTED}(i.code)){let s=r.v_.shift();Gn(r).t_(),yield CE(r,()=>r.remoteSyncer.rejectFailedWrite(s.batchId,i)),yield Fi(r)}})}(n,e)),bE(n)&&RE(n)})}function ew(n,e){return x(this,null,function*(){let t=L(n);t.asyncQueue.verifyOperationInProgress(),V("RemoteStore","RemoteStore received new credentials");let r=Kn(t);t.M_.add(3),yield Oi(t),r&&t.N_.set("Unknown"),yield t.remoteSyncer.handleCredentialChange(e),t.M_.delete(3),yield Vo(t)})}function Jf(n,e){return x(this,null,function*(){let t=L(n);e?(t.M_.delete(2),yield Vo(t)):e||(t.M_.add(2),yield Oi(t),t.N_.set("Unknown"))})}function Li(n){return n.B_||(n.B_=function(t,r,i){let s=L(t);return s.f_(),new Wf(r,s.connection,s.authCredentials,s.appCheckCredentials,s.serializer,i)}(n.datastore,n.asyncQueue,{Po:O0.bind(null,n),To:F0.bind(null,n),Ao:L0.bind(null,n),h_:U0.bind(null,n)}),n.x_.push(e=>x(this,null,function*(){e?(n.B_.t_(),Gp(n)?Bp(n):n.N_.set("Unknown")):(yield n.B_.stop(),AE(n))}))),n.B_}function Gn(n){return n.k_||(n.k_=function(t,r,i){let s=L(t);return s.f_(),new Qf(r,s.connection,s.authCredentials,s.appCheckCredentials,s.serializer,i)}(n.datastore,n.asyncQueue,{Po:()=>Promise.resolve(),To:G0.bind(null,n),Ao:K0.bind(null,n),R_:j0.bind(null,n),A_:z0.bind(null,n)}),n.x_.push(e=>x(this,null,function*(){e?(n.k_.t_(),yield Fi(n)):(yield n.k_.stop(),n.v_.length>0&&(V("RemoteStore",`Stopping write stream with ${n.v_.length} pending writes`),n.v_=[]))}))),n.k_}var Xf=class n{constructor(e,t,r,i,s){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=r,this.op=i,this.removalCallback=s,this.deferred=new De,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(o=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,t,r,i,s){let o=Date.now()+r,l=new n(e,t,o,i,s);return l.start(r),l}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){this.timerHandle!==null&&(this.clearTimeout(),this.deferred.reject(new k(P.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>this.timerHandle!==null?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){this.timerHandle!==null&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}};function Ui(n,e){if(Ae("AsyncQueue",`${e}: ${n}`),zn(n))return new k(P.UNAVAILABLE,`${e}: ${n}`);throw n}var mu=class n{constructor(e){this.comparator=e?(t,r)=>e(t,r)||F.comparator(t.key,r.key):(t,r)=>F.comparator(t.key,r.key),this.keyedMap=Zs(),this.sortedSet=new _e(this.comparator)}static emptySet(e){return new n(e.comparator)}has(e){return this.keyedMap.get(e)!=null}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){let t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal((t,r)=>(e(t),!1))}add(e){let t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){let t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof n)||this.size!==e.size)return!1;let t=this.sortedSet.getIterator(),r=e.sortedSet.getIterator();for(;t.hasNext();){let i=t.getNext().key,s=r.getNext().key;if(!i.isEqual(s))return!1}return!0}toString(){let e=[];return this.forEach(t=>{e.push(t.toString())}),e.length===0?"DocumentSet ()":`DocumentSet (
  `+e.join(`  
`)+`
)`}copy(e,t){let r=new n;return r.comparator=this.comparator,r.keyedMap=e,r.sortedSet=t,r}};var gu=class{constructor(){this.q_=new _e(F.comparator)}track(e){let t=e.doc.key,r=this.q_.get(t);r?e.type!==0&&r.type===3?this.q_=this.q_.insert(t,e):e.type===3&&r.type!==1?this.q_=this.q_.insert(t,{type:r.type,doc:e.doc}):e.type===2&&r.type===2?this.q_=this.q_.insert(t,{type:2,doc:e.doc}):e.type===2&&r.type===0?this.q_=this.q_.insert(t,{type:0,doc:e.doc}):e.type===1&&r.type===0?this.q_=this.q_.remove(t):e.type===1&&r.type===2?this.q_=this.q_.insert(t,{type:1,doc:r.doc}):e.type===0&&r.type===1?this.q_=this.q_.insert(t,{type:2,doc:e.doc}):U():this.q_=this.q_.insert(t,e)}Q_(){let e=[];return this.q_.inorderTraversal((t,r)=>{e.push(r)}),e}},Pi=class n{constructor(e,t,r,i,s,o,l,u,c){this.query=e,this.docs=t,this.oldDocs=r,this.docChanges=i,this.mutatedKeys=s,this.fromCache=o,this.syncStateChanged=l,this.excludesMetadataChanges=u,this.hasCachedResults=c}static fromInitialDocuments(e,t,r,i,s){let o=[];return t.forEach(l=>{o.push({type:0,doc:l})}),new n(e,t,mu.emptySet(t),o,r,i,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&No(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;let t=this.docChanges,r=e.docChanges;if(t.length!==r.length)return!1;for(let i=0;i<t.length;i++)if(t[i].type!==r[i].type||!t[i].doc.isEqual(r[i].doc))return!1;return!0}};var Zf=class{constructor(){this.K_=void 0,this.U_=[]}W_(){return this.U_.some(e=>e.G_())}},ep=class{constructor(){this.queries=new Kt(e=>kw(e),No),this.onlineState="Unknown",this.z_=new Set}};function jp(n,e){return x(this,null,function*(){let t=L(n),r=3,i=e.query,s=t.queries.get(i);s?!s.W_()&&e.G_()&&(r=2):(s=new Zf,r=e.G_()?0:1);try{switch(r){case 0:s.K_=yield t.onListen(i,!0);break;case 1:s.K_=yield t.onListen(i,!1);break;case 2:yield t.onFirstRemoteStoreListen(i)}}catch(o){let l=Ui(o,`Initialization of query '${ui(e.query)}' failed`);return void e.onError(l)}t.queries.set(i,s),s.U_.push(e),e.j_(t.onlineState),s.K_&&e.H_(s.K_)&&Kp(t)})}function zp(n,e){return x(this,null,function*(){let t=L(n),r=e.query,i=3,s=t.queries.get(r);if(s){let o=s.U_.indexOf(e);o>=0&&(s.U_.splice(o,1),s.U_.length===0?i=e.G_()?0:1:!s.W_()&&e.G_()&&(i=2))}switch(i){case 0:return t.queries.delete(r),t.onUnlisten(r,!0);case 1:return t.queries.delete(r),t.onUnlisten(r,!1);case 2:return t.onLastRemoteStoreUnlisten(r);default:return}})}function W0(n,e){let t=L(n),r=!1;for(let i of e){let s=i.query,o=t.queries.get(s);if(o){for(let l of o.U_)l.H_(i)&&(r=!0);o.K_=i}}r&&Kp(t)}function Q0(n,e,t){let r=L(n),i=r.queries.get(e);if(i)for(let s of i.U_)s.onError(t);r.queries.delete(e)}function Kp(n){n.z_.forEach(e=>{e.next()})}var tp,tw;(tw=tp||(tp={})).J_="default",tw.Cache="cache";var So=class{constructor(e,t,r){this.query=e,this.Y_=t,this.Z_=!1,this.X_=null,this.onlineState="Unknown",this.options=r||{}}H_(e){if(!this.options.includeMetadataChanges){let r=[];for(let i of e.docChanges)i.type!==3&&r.push(i);e=new Pi(e.query,e.docs,e.oldDocs,r,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.Z_?this.ea(e)&&(this.Y_.next(e),t=!0):this.ta(e,this.onlineState)&&(this.na(e),t=!0),this.X_=e,t}onError(e){this.Y_.error(e)}j_(e){this.onlineState=e;let t=!1;return this.X_&&!this.Z_&&this.ta(this.X_,e)&&(this.na(this.X_),t=!0),t}ta(e,t){if(!e.fromCache||!this.G_())return!0;let r=t!=="Offline";return(!this.options.ra||!r)&&(!e.docs.isEmpty()||e.hasCachedResults||t==="Offline")}ea(e){if(e.docChanges.length>0)return!0;let t=this.X_&&this.X_.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&this.options.includeMetadataChanges===!0}na(e){e=Pi.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.Z_=!0,this.Y_.next(e)}G_(){return this.options.source!==tp.Cache}};var np=class{constructor(e,t){this.ia=e,this.byteLength=t}sa(){return"metadata"in this.ia}};var _u=class{constructor(e){this.serializer=e}Ps(e){return Bt(this.serializer,e)}Is(e){return e.metadata.exists?nE(this.serializer,e.document,!1):ke.newNoDocument(this.Ps(e.metadata.name),this.Ts(e.metadata.readTime))}Ts(e){return be(e)}},rp=class{constructor(e,t,r){this.oa=e,this.localStore=t,this.serializer=r,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=PE(e)}_a(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.ia.namedQuery)this.queries.push(e.ia.namedQuery);else if(e.ia.documentMetadata){this.documents.push({metadata:e.ia.documentMetadata}),e.ia.documentMetadata.exists||++t;let r=se.fromString(e.ia.documentMetadata.name);this.collectionGroups.add(r.get(r.length-2))}else e.ia.document&&(this.documents[this.documents.length-1].document=e.ia.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}aa(e){let t=new Map,r=new _u(this.serializer);for(let i of e)if(i.metadata.queries){let s=r.Ps(i.metadata.name);for(let o of i.metadata.queries){let l=(t.get(o)||H()).add(s);t.set(o,l)}}return t}complete(){return x(this,null,function*(){let e=yield k0(this.localStore,new _u(this.serializer),this.documents,this.oa.id),t=this.aa(this.documents);for(let r of this.queries)yield V0(this.localStore,r,t.get(r.name));return this.progress.taskState="Success",{progress:this.progress,ua:this.collectionGroups,ca:e}})}};function PE(n){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:n.totalDocuments,totalBytes:n.totalBytes}}var yu=class{constructor(e){this.key=e}},vu=class{constructor(e){this.key=e}},wu=class{constructor(e,t){this.query=e,this.la=t,this.ha=null,this.hasCachedResults=!1,this.current=!1,this.Pa=H(),this.mutatedKeys=H(),this.Ia=Mw(e),this.Ta=new mu(this.Ia)}get Ea(){return this.la}da(e,t){let r=t?t.Aa:new gu,i=t?t.Ta:this.Ta,s=t?t.mutatedKeys:this.mutatedKeys,o=i,l=!1,u=this.query.limitType==="F"&&i.size===this.query.limit?i.last():null,c=this.query.limitType==="L"&&i.size===this.query.limit?i.first():null;if(e.inorderTraversal((d,p)=>{let m=i.get(d),v=Do(this.query,p)?p:null,C=!!m&&this.mutatedKeys.has(m.key),N=!!v&&(v.hasLocalMutations||this.mutatedKeys.has(v.key)&&v.hasCommittedMutations),D=!1;m&&v?m.data.isEqual(v.data)?C!==N&&(r.track({type:3,doc:v}),D=!0):this.Ra(m,v)||(r.track({type:2,doc:v}),D=!0,(u&&this.Ia(v,u)>0||c&&this.Ia(v,c)<0)&&(l=!0)):!m&&v?(r.track({type:0,doc:v}),D=!0):m&&!v&&(r.track({type:1,doc:m}),D=!0,(u||c)&&(l=!0)),D&&(v?(o=o.add(v),s=N?s.add(d):s.delete(d)):(o=o.delete(d),s=s.delete(d)))}),this.query.limit!==null)for(;o.size>this.query.limit;){let d=this.query.limitType==="F"?o.last():o.first();o=o.delete(d.key),s=s.delete(d.key),r.track({type:1,doc:d})}return{Ta:o,Aa:r,Xi:l,mutatedKeys:s}}Ra(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,r,i){let s=this.Ta;this.Ta=e.Ta,this.mutatedKeys=e.mutatedKeys;let o=e.Aa.Q_();o.sort((d,p)=>function(v,C){let N=D=>{switch(D){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return U()}};return N(v)-N(C)}(d.type,p.type)||this.Ia(d.doc,p.doc)),this.Va(r),i=i!=null&&i;let l=t&&!i?this.ma():[],u=this.Pa.size===0&&this.current&&!i?1:0,c=u!==this.ha;return this.ha=u,o.length!==0||c?{snapshot:new Pi(this.query,e.Ta,s,o,e.mutatedKeys,u===0,c,!1,!!r&&r.resumeToken.approximateByteSize()>0),fa:l}:{fa:l}}j_(e){return this.current&&e==="Offline"?(this.current=!1,this.applyChanges({Ta:this.Ta,Aa:new gu,mutatedKeys:this.mutatedKeys,Xi:!1},!1)):{fa:[]}}ga(e){return!this.la.has(e)&&!!this.Ta.has(e)&&!this.Ta.get(e).hasLocalMutations}Va(e){e&&(e.addedDocuments.forEach(t=>this.la=this.la.add(t)),e.modifiedDocuments.forEach(t=>{}),e.removedDocuments.forEach(t=>this.la=this.la.delete(t)),this.current=e.current)}ma(){if(!this.current)return[];let e=this.Pa;this.Pa=H(),this.Ta.forEach(r=>{this.ga(r.key)&&(this.Pa=this.Pa.add(r.key))});let t=[];return e.forEach(r=>{this.Pa.has(r)||t.push(new vu(r))}),this.Pa.forEach(r=>{e.has(r)||t.push(new yu(r))}),t}pa(e){this.la=e.hs,this.Pa=H();let t=this.da(e.documents);return this.applyChanges(t,!0)}ya(){return Pi.fromInitialDocuments(this.query,this.Ta,this.mutatedKeys,this.ha===0,this.hasCachedResults)}},ip=class{constructor(e,t,r){this.query=e,this.targetId=t,this.view=r}},sp=class{constructor(e){this.key=e,this.wa=!1}},op=class{constructor(e,t,r,i,s,o){this.localStore=e,this.remoteStore=t,this.eventManager=r,this.sharedClientState=i,this.currentUser=s,this.maxConcurrentLimboResolutions=o,this.Sa={},this.ba=new Kt(l=>kw(l),No),this.Da=new Map,this.Ca=new Set,this.va=new _e(F.comparator),this.Fa=new Map,this.Ma=new Eo,this.xa={},this.Oa=new Map,this.Na=Ai.Ln(),this.onlineState="Unknown",this.La=void 0}get isPrimaryClient(){return this.La===!0}};function $0(n,e,t=!0){return x(this,null,function*(){let r=ku(n),i,s=r.ba.get(e);return s?(r.sharedClientState.addLocalQueryTarget(s.targetId),i=s.view.ya()):i=yield xE(r,e,t,!0),i})}function H0(n,e){return x(this,null,function*(){let t=ku(n);yield xE(t,e,!0,!1)})}function xE(n,e,t,r){return x(this,null,function*(){let i=yield Ci(n.localStore,it(e)),s=i.targetId,o=t?n.sharedClientState.addLocalQueryTarget(s):"not-current",l;return r&&(l=yield Wp(n,e,s,o==="current",i.resumeToken)),n.isPrimaryClient&&t&&Du(n.remoteStore,i),l})}function Wp(n,e,t,r,i){return x(this,null,function*(){n.Ba=(p,m,v)=>function(N,D,B,j){return x(this,null,function*(){let q=D.view.da(B);q.Xi&&(q=yield lu(N.localStore,D.query,!1).then(({documents:E})=>D.view.da(E,q)));let Y=j&&j.targetChanges.get(D.targetId),ne=j&&j.targetMismatches.get(D.targetId)!=null,W=D.view.applyChanges(q,N.isPrimaryClient,Y,ne);return ap(N,D.targetId,W.fa),W.snapshot})}(n,p,m,v);let s=yield lu(n.localStore,e,!0),o=new wu(e,s.hs),l=o.da(s.documents),u=_o.createSynthesizedTargetChangeForCurrentChange(t,r&&n.onlineState!=="Offline",i),c=o.applyChanges(l,n.isPrimaryClient,u);ap(n,t,c.fa);let d=new ip(e,t,o);return n.ba.set(e,d),n.Da.has(t)?n.Da.get(t).push(e):n.Da.set(t,[e]),c.snapshot})}function Y0(n,e,t){return x(this,null,function*(){let r=L(n),i=r.ba.get(e),s=r.Da.get(i.targetId);if(s.length>1)return r.Da.set(i.targetId,s.filter(o=>!No(o,e))),void r.ba.delete(e);r.isPrimaryClient?(r.sharedClientState.removeLocalQueryTarget(i.targetId),r.sharedClientState.isActiveQueryTarget(i.targetId)||(yield bi(r.localStore,i.targetId,!1).then(()=>{r.sharedClientState.clearQueryState(i.targetId),t&&Ri(r.remoteStore,i.targetId),xi(r,i.targetId)}).catch(jn))):(xi(r,i.targetId),yield bi(r.localStore,i.targetId,!0))})}function J0(n,e){return x(this,null,function*(){let t=L(n),r=t.ba.get(e),i=t.Da.get(r.targetId);t.isPrimaryClient&&i.length===1&&(t.sharedClientState.removeLocalQueryTarget(r.targetId),Ri(t.remoteStore,r.targetId))})}function X0(n,e,t){return x(this,null,function*(){let r=Yp(n);try{let i=yield function(o,l){let u=L(o),c=Ee.now(),d=l.reduce((v,C)=>v.add(C.key),H()),p,m;return u.persistence.runTransaction("Locally write mutations","readwrite",v=>{let C=at(),N=H();return u.os.getEntries(v,d).next(D=>{C=D,C.forEach((B,j)=>{j.isValidDocument()||(N=N.add(B))})}).next(()=>u.localDocuments.getOverlayedDocuments(v,C)).next(D=>{p=D;let B=[];for(let j of l){let q=d0(j,p.get(j.key).overlayedDocument);q!=null&&B.push(new Rt(j.key,q,Cw(q.value.mapValue),Se.exists(!0)))}return u.mutationQueue.addMutationBatch(v,c,B,l)}).next(D=>{m=D;let B=D.applyToLocalDocumentSet(p,N);return u.documentOverlayCache.saveOverlays(v,D.batchId,B)})}).then(()=>({batchId:m.batchId,changes:Fw(p)}))}(r.localStore,e);r.sharedClientState.addPendingMutation(i.batchId),function(o,l,u){let c=o.xa[o.currentUser.toKey()];c||(c=new _e($)),c=c.insert(l,u),o.xa[o.currentUser.toKey()]=c}(r,i.batchId,t),yield ln(r,i.changes),yield Fi(r.remoteStore)}catch(i){let s=Ui(i,"Failed to persist write");t.reject(s)}})}function NE(n,e){return x(this,null,function*(){let t=L(n);try{let r=yield N0(t.localStore,e);e.targetChanges.forEach((i,s)=>{let o=t.Fa.get(s);o&&(G(i.addedDocuments.size+i.modifiedDocuments.size+i.removedDocuments.size<=1),i.addedDocuments.size>0?o.wa=!0:i.modifiedDocuments.size>0?G(o.wa):i.removedDocuments.size>0&&(G(o.wa),o.wa=!1))}),yield ln(t,r,e)}catch(r){yield jn(r)}})}function nw(n,e,t){let r=L(n);if(r.isPrimaryClient&&t===0||!r.isPrimaryClient&&t===1){let i=[];r.ba.forEach((s,o)=>{let l=o.view.j_(e);l.snapshot&&i.push(l.snapshot)}),function(o,l){let u=L(o);u.onlineState=l;let c=!1;u.queries.forEach((d,p)=>{for(let m of p.U_)m.j_(l)&&(c=!0)}),c&&Kp(u)}(r.eventManager,e),i.length&&r.Sa.h_(i),r.onlineState=e,r.isPrimaryClient&&r.sharedClientState.setOnlineState(e)}}function Z0(n,e,t){return x(this,null,function*(){let r=L(n);r.sharedClientState.updateQueryState(e,"rejected",t);let i=r.Fa.get(e),s=i&&i.key;if(s){let o=new _e(F.comparator);o=o.insert(s,ke.newNoDocument(s,z.min()));let l=H().add(s),u=new go(z.min(),new Map,new _e($),o,l);yield NE(r,u),r.va=r.va.remove(s),r.Fa.delete(e),Hp(r)}else yield bi(r.localStore,e,!1).then(()=>xi(r,e,t)).catch(jn)})}function eb(n,e){return x(this,null,function*(){let t=L(n),r=e.batch.batchId;try{let i=yield x0(t.localStore,e);$p(t,r,null),Qp(t,r),t.sharedClientState.updateMutationState(r,"acknowledged"),yield ln(t,i)}catch(i){yield jn(i)}})}function tb(n,e,t){return x(this,null,function*(){let r=L(n);try{let i=yield function(o,l){let u=L(o);return u.persistence.runTransaction("Reject batch","readwrite-primary",c=>{let d;return u.mutationQueue.lookupMutationBatch(c,l).next(p=>(G(p!==null),d=p.keys(),u.mutationQueue.removeMutationBatch(c,p))).next(()=>u.mutationQueue.performConsistencyCheck(c)).next(()=>u.documentOverlayCache.removeOverlaysForBatchId(c,d,l)).next(()=>u.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(c,d)).next(()=>u.localDocuments.getDocuments(c,d))})}(r.localStore,e);$p(r,e,t),Qp(r,e),r.sharedClientState.updateMutationState(e,"rejected",t),yield ln(r,i)}catch(i){yield jn(i)}})}function nb(n,e){return x(this,null,function*(){let t=L(n);Kn(t.remoteStore)||V("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{let r=yield function(o){let l=L(o);return l.persistence.runTransaction("Get highest unacknowledged batch id","readonly",u=>l.mutationQueue.getHighestUnacknowledgedBatchId(u))}(t.localStore);if(r===-1)return void e.resolve();let i=t.Oa.get(r)||[];i.push(e),t.Oa.set(r,i)}catch(r){let i=Ui(r,"Initialization of waitForPendingWrites() operation failed");e.reject(i)}})}function Qp(n,e){(n.Oa.get(e)||[]).forEach(t=>{t.resolve()}),n.Oa.delete(e)}function $p(n,e,t){let r=L(n),i=r.xa[r.currentUser.toKey()];if(i){let s=i.get(e);s&&(t?s.reject(t):s.resolve(),i=i.remove(e)),r.xa[r.currentUser.toKey()]=i}}function xi(n,e,t=null){n.sharedClientState.removeLocalQueryTarget(e);for(let r of n.Da.get(e))n.ba.delete(r),t&&n.Sa.ka(r,t);n.Da.delete(e),n.isPrimaryClient&&n.Ma.Vr(e).forEach(r=>{n.Ma.containsKey(r)||DE(n,r)})}function DE(n,e){n.Ca.delete(e.path.canonicalString());let t=n.va.get(e);t!==null&&(Ri(n.remoteStore,t),n.va=n.va.remove(e),n.Fa.delete(t),Hp(n))}function ap(n,e,t){for(let r of t)r instanceof yu?(n.Ma.addReference(r.key,e),rb(n,r)):r instanceof vu?(V("SyncEngine","Document no longer in limbo: "+r.key),n.Ma.removeReference(r.key,e),n.Ma.containsKey(r.key)||DE(n,r.key)):U()}function rb(n,e){let t=e.key,r=t.path.canonicalString();n.va.get(t)||n.Ca.has(r)||(V("SyncEngine","New document in limbo: "+t),n.Ca.add(r),Hp(n))}function Hp(n){for(;n.Ca.size>0&&n.va.size<n.maxConcurrentLimboResolutions;){let e=n.Ca.values().next().value;n.Ca.delete(e);let t=new F(se.fromString(e)),r=n.Na.next();n.Fa.set(r,new sp(t)),n.va=n.va.insert(t,r),Du(n.remoteStore,new Si(it(Mi(t.path)),r,"TargetPurposeLimboResolution",ft.oe))}}function ln(n,e,t){return x(this,null,function*(){let r=L(n),i=[],s=[],o=[];r.ba.isEmpty()||(r.ba.forEach((l,u)=>{o.push(r.Ba(u,e,t).then(c=>{var d;if((c||t)&&r.isPrimaryClient){let p=c?!c.fromCache:(d=t?.targetChanges.get(u.targetId))===null||d===void 0?void 0:d.current;r.sharedClientState.updateQueryState(u.targetId,p?"current":"not-current")}if(c){i.push(c);let p=Uf.Ki(u.targetId,c);s.push(p)}}))}),yield Promise.all(o),r.Sa.h_(i),yield function(u,c){return x(this,null,function*(){let d=L(u);try{yield d.persistence.runTransaction("notifyLocalViewChanges","readwrite",p=>b.forEach(c,m=>b.forEach(m.qi,v=>d.persistence.referenceDelegate.addReference(p,m.targetId,v)).next(()=>b.forEach(m.Qi,v=>d.persistence.referenceDelegate.removeReference(p,m.targetId,v)))))}catch(p){if(!zn(p))throw p;V("LocalStore","Failed to update sequence numbers: "+p)}for(let p of c){let m=p.targetId;if(!p.fromCache){let v=d.ns.get(m),C=v.snapshotVersion,N=v.withLastLimboFreeSnapshotVersion(C);d.ns=d.ns.insert(m,N)}}})}(r.localStore,s))})}function ib(n,e){return x(this,null,function*(){let t=L(n);if(!t.currentUser.isEqual(e)){V("SyncEngine","User change. New user:",e.toKey());let r=yield _E(t.localStore,e);t.currentUser=e,function(s,o){s.Oa.forEach(l=>{l.forEach(u=>{u.reject(new k(P.CANCELLED,o))})}),s.Oa.clear()}(t,"'waitForPendingWrites' promise is rejected due to a user change."),t.sharedClientState.handleUserChange(e,r.removedBatchIds,r.addedBatchIds),yield ln(t,r.us)}})}function sb(n,e){let t=L(n),r=t.Fa.get(e);if(r&&r.wa)return H().add(r.key);{let i=H(),s=t.Da.get(e);if(!s)return i;for(let o of s){let l=t.ba.get(o);i=i.unionWith(l.view.Ea)}return i}}function ob(n,e){return x(this,null,function*(){let t=L(n),r=yield lu(t.localStore,e.query,!0),i=e.view.pa(r);return t.isPrimaryClient&&ap(t,e.targetId,i.fa),i})}function ab(n,e){return x(this,null,function*(){let t=L(n);return EE(t.localStore,e).then(r=>ln(t,r))})}function lb(n,e,t,r){return x(this,null,function*(){let i=L(n),s=yield function(l,u){let c=L(l),d=L(c.mutationQueue);return c.persistence.runTransaction("Lookup mutation documents","readonly",p=>d.vn(p,u).next(m=>m?c.localDocuments.getDocuments(p,m):b.resolve(null)))}(i.localStore,e);s!==null?(t==="pending"?yield Fi(i.remoteStore):t==="acknowledged"||t==="rejected"?($p(i,e,r||null),Qp(i,e),function(l,u){L(L(l).mutationQueue).Mn(u)}(i.localStore,e)):U(),yield ln(i,s)):V("SyncEngine","Cannot apply mutation batch with id: "+e)})}function ub(n,e){return x(this,null,function*(){let t=L(n);if(ku(t),Yp(t),e===!0&&t.La!==!0){let r=t.sharedClientState.getAllActiveQueryTargets(),i=yield rw(t,r.toArray());t.La=!0,yield Jf(t.remoteStore,!0);for(let s of i)Du(t.remoteStore,s)}else if(e===!1&&t.La!==!1){let r=[],i=Promise.resolve();t.Da.forEach((s,o)=>{t.sharedClientState.isLocalQueryTarget(o)?r.push(o):i=i.then(()=>(xi(t,o),bi(t.localStore,o,!0))),Ri(t.remoteStore,o)}),yield i,yield rw(t,r),function(o){let l=L(o);l.Fa.forEach((u,c)=>{Ri(l.remoteStore,c)}),l.Ma.mr(),l.Fa=new Map,l.va=new _e(F.comparator)}(t),t.La=!1,yield Jf(t.remoteStore,!1)}})}function rw(n,e,t){return x(this,null,function*(){let r=L(n),i=[],s=[];for(let o of e){let l,u=r.Da.get(o);if(u&&u.length!==0){l=yield Ci(r.localStore,it(u[0]));for(let c of u){let d=r.ba.get(c),p=yield ob(r,d);p.snapshot&&s.push(p.snapshot)}}else{let c=yield wE(r.localStore,o);l=yield Ci(r.localStore,c),yield Wp(r,kE(c),o,!1,l.resumeToken)}i.push(l)}return r.Sa.h_(s),i})}function kE(n){return Dw(n.path,n.collectionGroup,n.orderBy,n.filters,n.limit,"F",n.startAt,n.endAt)}function cb(n){return function(t){return L(L(t).persistence).Bi()}(L(n).localStore)}function hb(n,e,t,r){return x(this,null,function*(){let i=L(n);if(i.La)return void V("SyncEngine","Ignoring unexpected query state notification.");let s=i.Da.get(e);if(s&&s.length>0)switch(t){case"current":case"not-current":{let o=yield EE(i.localStore,Vw(s[0])),l=go.createSynthesizedRemoteEventForCurrentChange(e,t==="current",qe.EMPTY_BYTE_STRING);yield ln(i,o,l);break}case"rejected":yield bi(i.localStore,e,!0),xi(i,e,r);break;default:U()}})}function db(n,e,t){return x(this,null,function*(){let r=ku(n);if(r.La){for(let i of e){if(r.Da.has(i)&&r.sharedClientState.isActiveQueryTarget(i)){V("SyncEngine","Adding an already active target "+i);continue}let s=yield wE(r.localStore,i),o=yield Ci(r.localStore,s);yield Wp(r,kE(s),o.targetId,!1,o.resumeToken),Du(r.remoteStore,o)}for(let i of t)r.Da.has(i)&&(yield bi(r.localStore,i,!1).then(()=>{Ri(r.remoteStore,i),xi(r,i)}).catch(jn))}})}function ku(n){let e=L(n);return e.remoteStore.remoteSyncer.applyRemoteEvent=NE.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=sb.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=Z0.bind(null,e),e.Sa.h_=W0.bind(null,e.eventManager),e.Sa.ka=Q0.bind(null,e.eventManager),e}function Yp(n){let e=L(n);return e.remoteStore.remoteSyncer.applySuccessfulWrite=eb.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=tb.bind(null,e),e}function fb(n,e,t){let r=L(n);(function(s,o,l){return x(this,null,function*(){try{let u=yield o.getMetadata();if(yield function(v,C){let N=L(v),D=be(C.createTime);return N.persistence.runTransaction("hasNewerBundle","readonly",B=>N.$r.getBundleMetadata(B,C.id)).then(B=>!!B&&B.createTime.compareTo(D)>=0)}(s.localStore,u))return yield o.close(),l._completeWith(function(v){return{taskState:"Success",documentsLoaded:v.totalDocuments,bytesLoaded:v.totalBytes,totalDocuments:v.totalDocuments,totalBytes:v.totalBytes}}(u)),Promise.resolve(new Set);l._updateProgress(PE(u));let c=new rp(u,s.localStore,o.serializer),d=yield o.qa();for(;d;){let m=yield c._a(d);m&&l._updateProgress(m),d=yield o.qa()}let p=yield c.complete();return yield ln(s,p.ca,void 0),yield function(v,C){let N=L(v);return N.persistence.runTransaction("Save bundle","readwrite",D=>N.$r.saveBundleMetadata(D,C))}(s.localStore,u),l._completeWith(p.progress),Promise.resolve(p.ua)}catch(u){return Et("SyncEngine",`Loading bundle failed with ${u}`),l._failWith(u),Promise.resolve(new Set)}})})(r,e,t).then(i=>{r.sharedClientState.notifyBundleLoaded(i)})}var Ao=class{constructor(){this.synchronizeTabs=!1}initialize(e){return x(this,null,function*(){this.serializer=ko(e.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(e),this.persistence=this.createPersistence(e),yield this.persistence.start(),this.localStore=this.createLocalStore(e),this.gcScheduler=this.createGarbageCollectionScheduler(e,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(e,this.localStore)})}createGarbageCollectionScheduler(e,t){return null}createIndexBackfillerScheduler(e,t){return null}createLocalStore(e){return gE(this.persistence,new au,e.initialUser,this.serializer)}createPersistence(e){return new su(ou.Hr,this.serializer)}createSharedClientState(e){return new hu}terminate(){return x(this,null,function*(){var e,t;(e=this.gcScheduler)===null||e===void 0||e.stop(),(t=this.indexBackfillerScheduler)===null||t===void 0||t.stop(),this.sharedClientState.shutdown(),yield this.persistence.shutdown()})}};var Eu=class n extends Ao{constructor(e,t,r){super(),this.Qa=e,this.cacheSizeBytes=t,this.forceOwnership=r,this.synchronizeTabs=!1}initialize(e){return x(this,null,function*(){yield _c(n.prototype,this,"initialize").call(this,e),yield this.Qa.initialize(this,e),yield Yp(this.Qa.syncEngine),yield Fi(this.Qa.remoteStore),yield this.persistence.fi(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))})}createLocalStore(e){return gE(this.persistence,new au,e.initialUser,this.serializer)}createGarbageCollectionScheduler(e,t){let r=this.persistence.referenceDelegate.garbageCollector;return new Sf(r,e.asyncQueue,t)}createIndexBackfillerScheduler(e,t){let r=new Bd(t,this.persistence);return new qd(e.asyncQueue,r)}createPersistence(e){let t=Up(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),r=this.cacheSizeBytes!==void 0?wt.withCacheSize(this.cacheSizeBytes):wt.DEFAULT;return new Lf(this.synchronizeTabs,t,e.clientId,r,e.asyncQueue,TE(),kl(),this.serializer,this.sharedClientState,!!this.forceOwnership)}createSharedClientState(e){return new hu}},lp=class n extends Eu{constructor(e,t){super(e,t,!1),this.Qa=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}initialize(e){return x(this,null,function*(){yield _c(n.prototype,this,"initialize").call(this,e);let t=this.Qa.syncEngine;this.sharedClientState instanceof so&&(this.sharedClientState.syncEngine={Zs:lb.bind(null,t),Xs:hb.bind(null,t),eo:db.bind(null,t),Bi:cb.bind(null,t),Ys:ab.bind(null,t)},yield this.sharedClientState.start()),yield this.persistence.fi(r=>x(this,null,function*(){yield ub(this.Qa.syncEngine,r),this.gcScheduler&&(r&&!this.gcScheduler.started?this.gcScheduler.start():r||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(r&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():r||this.indexBackfillerScheduler.stop())}))})}createSharedClientState(e){let t=TE();if(!so.D(t))throw new k(P.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");let r=Up(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new so(t,e.asyncQueue,r,e.clientId,e.initialUser)}},Co=class{initialize(e,t){return x(this,null,function*(){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=r=>nw(this.syncEngine,r,1),this.remoteStore.remoteSyncer.handleCredentialChange=ib.bind(null,this.syncEngine),yield Jf(this.remoteStore,this.syncEngine.isPrimaryClient))})}createEventManager(e){return function(){return new ep}()}createDatastore(e){let t=ko(e.databaseInfo.databaseId),r=function(s){return new Kf(s)}(e.databaseInfo);return function(s,o,l,u){return new $f(s,o,l,u)}(e.authCredentials,e.appCheckCredentials,r,t)}createRemoteStore(e){return function(r,i,s,o,l){return new Yf(r,i,s,o,l)}(this.localStore,this.datastore,e.asyncQueue,t=>nw(this.syncEngine,t,0),function(){return du.D()?new du:new jf}())}createSyncEngine(e,t){return function(i,s,o,l,u,c,d){let p=new op(i,s,o,l,u,c);return d&&(p.La=!0),p}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}terminate(){return x(this,null,function*(){var e;yield function(r){return x(this,null,function*(){let i=L(r);V("RemoteStore","RemoteStore shutting down."),i.M_.add(5),yield Oi(i),i.O_.shutdown(),i.N_.set("Unknown")})}(this.remoteStore),(e=this.datastore)===null||e===void 0||e.terminate()})}};function iw(n,e=10240){let t=0;return{read(){return x(this,null,function*(){if(t<n.byteLength){let i={value:n.slice(t,t+e),done:!1};return t+=e,i}return{done:!0}})},cancel(){return x(this,null,function*(){})},releaseLock(){},closed:Promise.resolve()}}var Ni=class{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Ka(this.observer.next,e)}error(e){this.observer.error?this.Ka(this.observer.error,e):Ae("Uncaught Error in snapshot listener:",e.toString())}$a(){this.muted=!0}Ka(e,t){this.muted||setTimeout(()=>{this.muted||e(t)},0)}};var up=class{constructor(e,t){this.Ua=e,this.serializer=t,this.metadata=new De,this.buffer=new Uint8Array,this.Wa=function(){return new TextDecoder("utf-8")}(),this.Ga().then(r=>{r&&r.sa()?this.metadata.resolve(r.ia.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is
             ${JSON.stringify(r?.ia)}`))},r=>this.metadata.reject(r))}close(){return this.Ua.cancel()}getMetadata(){return x(this,null,function*(){return this.metadata.promise})}qa(){return x(this,null,function*(){return yield this.getMetadata(),this.Ga()})}Ga(){return x(this,null,function*(){let e=yield this.za();if(e===null)return null;let t=this.Wa.decode(e),r=Number(t);isNaN(r)&&this.ja(`length string (${t}) is not valid number`);let i=yield this.Ha(r);return new np(JSON.parse(i),e.length+r)})}Ja(){return this.buffer.findIndex(e=>e===123)}za(){return x(this,null,function*(){for(;this.Ja()<0&&!(yield this.Ya()););if(this.buffer.length===0)return null;let e=this.Ja();e<0&&this.ja("Reached the end of bundle when a length string is expected.");let t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t})}Ha(e){return x(this,null,function*(){for(;this.buffer.length<e;)(yield this.Ya())&&this.ja("Reached the end of bundle when more is expected.");let t=this.Wa.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t})}ja(e){throw this.Ua.cancel(),new Error(`Invalid bundle format: ${e}`)}Ya(){return x(this,null,function*(){let e=yield this.Ua.read();if(!e.done){let t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done})}};var cp=class{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}lookup(e){return x(this,null,function*(){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw this.lastTransactionError=new k(P.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;let t=yield function(i,s){return x(this,null,function*(){let o=L(i),l={documents:s.map(p=>yo(o.serializer,p))},u=yield o.xo("BatchGetDocuments",o.serializer.databaseId,se.emptyPath(),l,s.length),c=new Map;u.forEach(p=>{let m=y0(o.serializer,p);c.set(m.key.toString(),m)});let d=[];return s.forEach(p=>{let m=c.get(p.toString());G(!!m),d.push(m)}),d})}(this.datastore,e);return t.forEach(r=>this.recordVersion(r)),t})}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(r){this.lastTransactionError=r}this.writtenDocs.add(e.toString())}delete(e){this.write(new Bn(e,this.precondition(e))),this.writtenDocs.add(e.toString())}commit(){return x(this,null,function*(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;let e=this.readVersions;this.mutations.forEach(t=>{e.delete(t.key.toString())}),e.forEach((t,r)=>{let i=F.fromPath(r);this.mutations.push(new fo(i,this.precondition(i)))}),yield function(r,i){return x(this,null,function*(){let s=L(r),o={writes:i.map(l=>vo(s.serializer,l))};yield s.Co("Commit",s.serializer.databaseId,se.emptyPath(),o)})}(this.datastore,this.mutations),this.committed=!0})}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw U();t=z.min()}let r=this.readVersions.get(e.key.toString());if(r){if(!t.isEqual(r))throw new k(P.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){let t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(z.min())?Se.exists(!1):Se.updateTime(t):Se.none()}preconditionForUpdate(e){let t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(z.min()))throw new k(P.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Se.updateTime(t)}return Se.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}};var hp=class{constructor(e,t,r,i,s){this.asyncQueue=e,this.datastore=t,this.options=r,this.updateFunction=i,this.deferred=s,this.Za=r.maxAttempts,this.Yo=new To(this.asyncQueue,"transaction_retry")}Xa(){this.Za-=1,this.eu()}eu(){this.Yo.$o(()=>x(this,null,function*(){let e=new cp(this.datastore),t=this.tu(e);t&&t.then(r=>{this.asyncQueue.enqueueAndForget(()=>e.commit().then(()=>{this.deferred.resolve(r)}).catch(i=>{this.nu(i)}))}).catch(r=>{this.nu(r)})}))}tu(e){try{let t=this.updateFunction(e);return!Po(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}}nu(e){this.Za>0&&this.ru(e)?(this.Za-=1,this.asyncQueue.enqueueAndForget(()=>(this.eu(),Promise.resolve()))):this.deferred.reject(e)}ru(e){if(e.name==="FirebaseError"){let t=e.code;return t==="aborted"||t==="failed-precondition"||t==="already-exists"||!$w(t)}return!1}};var dp=class{constructor(e,t,r,i){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=r,this.databaseInfo=i,this.user=Ne.UNAUTHENTICATED,this.clientId=Ol.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(r,s=>x(this,null,function*(){V("FirestoreClient","Received user=",s.uid),yield this.authCredentialListener(s),this.user=s})),this.appCheckCredentials.start(r,s=>(V("FirestoreClient","Received new app check token=",s),this.appCheckCredentialListener(s,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new k(P.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();let e=new De;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(()=>x(this,null,function*(){try{this._onlineComponents&&(yield this._onlineComponents.terminate()),this._offlineComponents&&(yield this._offlineComponents.terminate()),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(t){let r=Ui(t,"Failed to shutdown persistence");e.reject(r)}})),e.promise}};function Vl(n,e){return x(this,null,function*(){n.asyncQueue.verifyOperationInProgress(),V("FirestoreClient","Initializing OfflineComponentProvider");let t=n.configuration;yield e.initialize(t);let r=t.initialUser;n.setCredentialChangeListener(i=>x(this,null,function*(){r.isEqual(i)||(yield _E(e.localStore,i),r=i)})),e.persistence.setDatabaseDeletedListener(()=>n.terminate()),n._offlineComponents=e})}function fp(n,e){return x(this,null,function*(){n.asyncQueue.verifyOperationInProgress();let t=yield Jp(n);V("FirestoreClient","Initializing OnlineComponentProvider"),yield e.initialize(t,n.configuration),n.setCredentialChangeListener(r=>ew(e.remoteStore,r)),n.setAppCheckTokenChangeListener((r,i)=>ew(e.remoteStore,i)),n._onlineComponents=e})}function VE(n){return n.name==="FirebaseError"?n.code===P.FAILED_PRECONDITION||n.code===P.UNIMPLEMENTED:!(typeof DOMException<"u"&&n instanceof DOMException)||n.code===22||n.code===20||n.code===11}function Jp(n){return x(this,null,function*(){if(!n._offlineComponents)if(n._uninitializedComponentsProvider){V("FirestoreClient","Using user provided OfflineComponentProvider");try{yield Vl(n,n._uninitializedComponentsProvider._offline)}catch(e){let t=e;if(!VE(t))throw t;Et("Error using user provided cache. Falling back to memory cache: "+t),yield Vl(n,new Ao)}}else V("FirestoreClient","Using default OfflineComponentProvider"),yield Vl(n,new Ao);return n._offlineComponents})}function Vu(n){return x(this,null,function*(){return n._onlineComponents||(n._uninitializedComponentsProvider?(V("FirestoreClient","Using user provided OnlineComponentProvider"),yield fp(n,n._uninitializedComponentsProvider._online)):(V("FirestoreClient","Using default OnlineComponentProvider"),yield fp(n,new Co))),n._onlineComponents})}function ME(n){return Jp(n).then(e=>e.persistence)}function Xp(n){return Jp(n).then(e=>e.localStore)}function OE(n){return Vu(n).then(e=>e.remoteStore)}function Zp(n){return Vu(n).then(e=>e.syncEngine)}function pb(n){return Vu(n).then(e=>e.datastore)}function Di(n){return x(this,null,function*(){let e=yield Vu(n),t=e.eventManager;return t.onListen=$0.bind(null,e.syncEngine),t.onUnlisten=Y0.bind(null,e.syncEngine),t.onFirstRemoteStoreListen=H0.bind(null,e.syncEngine),t.onLastRemoteStoreUnlisten=J0.bind(null,e.syncEngine),t})}function mb(n){return n.asyncQueue.enqueue(()=>x(this,null,function*(){let e=yield ME(n),t=yield OE(n);return e.setNetworkEnabled(!0),function(i){let s=L(i);return s.M_.delete(0),Vo(s)}(t)}))}function gb(n){return n.asyncQueue.enqueue(()=>x(this,null,function*(){let e=yield ME(n),t=yield OE(n);return e.setNetworkEnabled(!1),function(i){return x(this,null,function*(){let s=L(i);s.M_.add(0),yield Oi(s),s.N_.set("Offline")})}(t)}))}function _b(n,e){let t=new De;return n.asyncQueue.enqueueAndForget(()=>x(this,null,function*(){return function(i,s,o){return x(this,null,function*(){try{let l=yield function(c,d){let p=L(c);return p.persistence.runTransaction("read document","readonly",m=>p.localDocuments.getDocument(m,d))}(i,s);l.isFoundDocument()?o.resolve(l):l.isNoDocument()?o.resolve(null):o.reject(new k(P.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(l){let u=Ui(l,`Failed to get document '${s} from cache`);o.reject(u)}})}(yield Xp(n),e,t)})),t.promise}function FE(n,e,t={}){let r=new De;return n.asyncQueue.enqueueAndForget(()=>x(this,null,function*(){return function(s,o,l,u,c){let d=new Ni({next:m=>{o.enqueueAndForget(()=>zp(s,p));let v=m.docs.has(l);!v&&m.fromCache?c.reject(new k(P.UNAVAILABLE,"Failed to get document because the client is offline.")):v&&m.fromCache&&u&&u.source==="server"?c.reject(new k(P.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):c.resolve(m)},error:m=>c.reject(m)}),p=new So(Mi(l.path),d,{includeMetadataChanges:!0,ra:!0});return jp(s,p)}(yield Di(n),n.asyncQueue,e,t,r)})),r.promise}function yb(n,e){let t=new De;return n.asyncQueue.enqueueAndForget(()=>x(this,null,function*(){return function(i,s,o){return x(this,null,function*(){try{let l=yield lu(i,s,!0),u=new wu(s,l.hs),c=u.da(l.documents),d=u.applyChanges(c,!1);o.resolve(d.snapshot)}catch(l){let u=Ui(l,`Failed to execute query '${s} against cache`);o.reject(u)}})}(yield Xp(n),e,t)})),t.promise}function LE(n,e,t={}){let r=new De;return n.asyncQueue.enqueueAndForget(()=>x(this,null,function*(){return function(s,o,l,u,c){let d=new Ni({next:m=>{o.enqueueAndForget(()=>zp(s,p)),m.fromCache&&u.source==="server"?c.reject(new k(P.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):c.resolve(m)},error:m=>c.reject(m)}),p=new So(l,d,{includeMetadataChanges:!0,ra:!0});return jp(s,p)}(yield Di(n),n.asyncQueue,e,t,r)})),r.promise}function vb(n,e){let t=new Ni(e);return n.asyncQueue.enqueueAndForget(()=>x(this,null,function*(){return function(i,s){L(i).z_.add(s),s.next()}(yield Di(n),t)})),()=>{t.$a(),n.asyncQueue.enqueueAndForget(()=>x(this,null,function*(){return function(i,s){L(i).z_.delete(s)}(yield Di(n),t)}))}}function wb(n,e,t,r){let i=function(o,l){let u;return u=typeof o=="string"?Yw().encode(o):o,function(d,p){return new up(d,p)}(function(d,p){if(d instanceof Uint8Array)return iw(d,p);if(d instanceof ArrayBuffer)return iw(new Uint8Array(d),p);if(d instanceof ReadableStream)return d.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(u),l)}(t,ko(e));n.asyncQueue.enqueueAndForget(()=>x(this,null,function*(){fb(yield Zp(n),i,r)}))}function Eb(n,e){return n.asyncQueue.enqueue(()=>x(this,null,function*(){return function(r,i){let s=L(r);return s.persistence.runTransaction("Get named query","readonly",o=>s.$r.getNamedQuery(o,i))}(yield Xp(n),e)}))}function UE(n){let e={};return n.timeoutSeconds!==void 0&&(e.timeoutSeconds=n.timeoutSeconds),e}var sw=new Map;function em(n,e,t){if(!t)throw new k(P.INVALID_ARGUMENT,`Function ${n}() cannot be called with an empty ${e}.`)}function tm(n,e,t,r){if(e===!0&&r===!0)throw new k(P.INVALID_ARGUMENT,`${n} and ${t} cannot be used together.`)}function ow(n){if(!F.isDocumentKey(n))throw new k(P.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${n} has ${n.length}.`)}function aw(n){if(F.isDocumentKey(n))throw new k(P.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${n} has ${n.length}.`)}function Mu(n){if(n===void 0)return"undefined";if(n===null)return"null";if(typeof n=="string")return n.length>20&&(n=`${n.substring(0,20)}...`),JSON.stringify(n);if(typeof n=="number"||typeof n=="boolean")return""+n;if(typeof n=="object"){if(n instanceof Array)return"an array";{let e=function(r){return r.constructor?r.constructor.name:null}(n);return e?`a custom ${e} object`:"an object"}}return typeof n=="function"?"a function":U()}function oe(n,e){if("_delegate"in n&&(n=n._delegate),!(n instanceof e)){if(e.name===n.constructor.name)throw new k(P.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{let t=Mu(n);throw new k(P.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${t}`)}}return n}function qE(n,e){if(e<=0)throw new k(P.INVALID_ARGUMENT,`Function ${n}() requires a positive number, but it was: ${e}.`)}var Iu=class{constructor(e){var t,r;if(e.host===void 0){if(e.ssl!==void 0)throw new k(P.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=(t=e.ssl)===null||t===void 0||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,e.cacheSizeBytes===void 0)this.cacheSizeBytes=41943040;else{if(e.cacheSizeBytes!==-1&&e.cacheSizeBytes<1048576)throw new k(P.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}tm("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:e.experimentalAutoDetectLongPolling===void 0?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=UE((r=e.experimentalLongPollingOptions)!==null&&r!==void 0?r:{}),function(s){if(s.timeoutSeconds!==void 0){if(isNaN(s.timeoutSeconds))throw new k(P.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (must not be NaN)`);if(s.timeoutSeconds<5)throw new k(P.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (minimum allowed value is 5)`);if(s.timeoutSeconds>30)throw new k(P.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&function(r,i){return r.timeoutSeconds===i.timeoutSeconds}(this.experimentalLongPollingOptions,e.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}},Er=class{constructor(e,t,r,i){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=r,this._app=i,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Iu({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new k(P.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return this._terminateTask!==void 0}_setSettings(e){if(this._settingsFrozen)throw new k(P.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Iu(e),e.credentials!==void 0&&(this._authCredentials=function(r){if(!r)return new xd;switch(r.type){case"firstParty":return new Vd(r.sessionIndex||"0",r.iamToken||null,r.authTokenFactory||null);case"provider":return r.client;default:throw new k(P.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){let r=sw.get(t);r&&(V("ComponentProvider","Removing Datastore"),sw.delete(t),r.terminate())}(this),Promise.resolve()}};function BE(n,e,t,r={}){var i;let s=(n=oe(n,Er))._getSettings(),o=`${e}:${t}`;if(s.host!=="firestore.googleapis.com"&&s.host!==o&&Et("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),n._setSettings(Object.assign(Object.assign({},s),{host:o,ssl:!1})),r.mockUserToken){let l,u;if(typeof r.mockUserToken=="string")l=r.mockUserToken,u=Ne.MOCK_USER;else{l=ca(r.mockUserToken,(i=n._app)===null||i===void 0?void 0:i.options.projectId);let c=r.mockUserToken.sub||r.mockUserToken.user_id;if(!c)throw new k(P.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");u=new Ne(c)}n._authCredentials=new Nd(new Ml(l,u))}}var je=class n{constructor(e,t,r){this.converter=t,this._query=r,this.type="query",this.firestore=e}withConverter(e){return new n(this.firestore,e,this._query)}},me=class n{constructor(e,t,r){this.converter=t,this._key=r,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Gt(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new n(this.firestore,e,this._key)}},Gt=class n extends je{constructor(e,t,r){super(e,t,Mi(r)),this._path=r,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){let e=this._path.popLast();return e.isEmpty()?null:new me(this.firestore,null,new F(e))}withConverter(e){return new n(this.firestore,e,this._path)}};function nm(n,e,...t){if(n=ee(n),em("collection","path",e),n instanceof Er){let r=se.fromString(e,...t);return aw(r),new Gt(n,null,r)}{if(!(n instanceof me||n instanceof Gt))throw new k(P.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=n._path.child(se.fromString(e,...t));return aw(r),new Gt(n.firestore,null,r)}}function GE(n,e){if(n=oe(n,Er),em("collectionGroup","collection id",e),e.indexOf("/")>=0)throw new k(P.INVALID_ARGUMENT,`Invalid collection ID '${e}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new je(n,null,function(r){return new bt(se.emptyPath(),r)}(e))}function Mo(n,e,...t){if(n=ee(n),arguments.length===1&&(e=Ol.newId()),em("doc","path",e),n instanceof Er){let r=se.fromString(e,...t);return ow(r),new me(n,null,new F(r))}{if(!(n instanceof me||n instanceof Gt))throw new k(P.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=n._path.child(se.fromString(e,...t));return ow(r),new me(n.firestore,n instanceof Gt?n.converter:null,new F(r))}}function rm(n,e){return n=ee(n),e=ee(e),(n instanceof me||n instanceof Gt)&&(e instanceof me||e instanceof Gt)&&n.firestore===e.firestore&&n.path===e.path&&n.converter===e.converter}function im(n,e){return n=ee(n),e=ee(e),n instanceof je&&e instanceof je&&n.firestore===e.firestore&&No(n._query,e._query)&&n.converter===e.converter}var pp=class{constructor(){this.iu=Promise.resolve(),this.su=[],this.ou=!1,this._u=[],this.au=null,this.uu=!1,this.cu=!1,this.lu=[],this.Yo=new To(this,"async_queue_retry"),this.hu=()=>{let t=kl();t&&V("AsyncQueue","Visibility state changed to "+t.visibilityState),this.Yo.Wo()};let e=kl();e&&typeof e.addEventListener=="function"&&e.addEventListener("visibilitychange",this.hu)}get isShuttingDown(){return this.ou}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.Pu(),this.Iu(e)}enterRestrictedMode(e){if(!this.ou){this.ou=!0,this.cu=e||!1;let t=kl();t&&typeof t.removeEventListener=="function"&&t.removeEventListener("visibilitychange",this.hu)}}enqueue(e){if(this.Pu(),this.ou)return new Promise(()=>{});let t=new De;return this.Iu(()=>this.ou&&this.cu?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.su.push(e),this.Tu()))}Tu(){return x(this,null,function*(){if(this.su.length!==0){try{yield this.su[0](),this.su.shift(),this.Yo.reset()}catch(e){if(!zn(e))throw e;V("AsyncQueue","Operation failed with retryable error: "+e)}this.su.length>0&&this.Yo.$o(()=>this.Tu())}})}Iu(e){let t=this.iu.then(()=>(this.uu=!0,e().catch(r=>{this.au=r,this.uu=!1;let i=function(o){let l=o.message||"";return o.stack&&(l=o.stack.includes(o.message)?o.stack:o.message+`
`+o.stack),l}(r);throw Ae("INTERNAL UNHANDLED ERROR: ",i),r}).then(r=>(this.uu=!1,r))));return this.iu=t,t}enqueueAfterDelay(e,t,r){this.Pu(),this.lu.indexOf(e)>-1&&(t=0);let i=Xf.createAndSchedule(this,e,t,r,s=>this.Eu(s));return this._u.push(i),i}Pu(){this.au&&U()}verifyOperationInProgress(){}du(){return x(this,null,function*(){let e;do e=this.iu,yield e;while(e!==this.iu)})}Au(e){for(let t of this._u)if(t.timerId===e)return!0;return!1}Ru(e){return this.du().then(()=>{this._u.sort((t,r)=>t.targetTimeMs-r.targetTimeMs);for(let t of this._u)if(t.skipDelay(),e!=="all"&&t.timerId===e)break;return this.du()})}Vu(e){this.lu.push(e)}Eu(e){let t=this._u.indexOf(e);this._u.splice(t,1)}};function mp(n){return function(t,r){if(typeof t!="object"||t===null)return!1;let i=t;for(let s of r)if(s in i&&typeof i[s]=="function")return!0;return!1}(n,["next","error","complete"])}var gp=class{constructor(){this._progressObserver={},this._taskCompletionResolver=new De,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,r){this._progressObserver={next:e,error:t,complete:r}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}};var jE=-1,ve=class extends Er{constructor(e,t,r,i){super(e,t,r,i),this.type="firestore",this._queue=function(){return new pp}(),this._persistenceKey=i?.name||"[DEFAULT]"}_terminate(){return this._firestoreClient||zE(this),this._firestoreClient.terminate()}};function Oe(n){return n._firestoreClient||zE(n),n._firestoreClient.verifyNotTerminated(),n._firestoreClient}function zE(n){var e,t,r;let i=n._freezeSettings(),s=function(l,u,c,d){return new Gd(l,u,c,d.host,d.ssl,d.experimentalForceLongPolling,d.experimentalAutoDetectLongPolling,UE(d.experimentalLongPollingOptions),d.useFetchStreams)}(n._databaseId,((e=n._app)===null||e===void 0?void 0:e.options.appId)||"",n._persistenceKey,i);n._firestoreClient=new dp(n._authCredentials,n._appCheckCredentials,n._queue,s),!((t=i.localCache)===null||t===void 0)&&t._offlineComponentProvider&&(!((r=i.localCache)===null||r===void 0)&&r._onlineComponentProvider)&&(n._firestoreClient._uninitializedComponentsProvider={_offlineKind:i.localCache.kind,_offline:i.localCache._offlineComponentProvider,_online:i.localCache._onlineComponentProvider})}function KE(n,e){eI(n=oe(n,ve));let t=Oe(n);if(t._uninitializedComponentsProvider)throw new k(P.FAILED_PRECONDITION,"SDK cache is already specified.");Et("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");let r=n._freezeSettings(),i=new Co;return QE(t,i,new Eu(i,r.cacheSizeBytes,e?.forceOwnership))}function WE(n){eI(n=oe(n,ve));let e=Oe(n);if(e._uninitializedComponentsProvider)throw new k(P.FAILED_PRECONDITION,"SDK cache is already specified.");Et("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");let t=n._freezeSettings(),r=new Co;return QE(e,r,new lp(r,t.cacheSizeBytes))}function QE(n,e,t){let r=new De;return n.asyncQueue.enqueue(()=>x(this,null,function*(){try{yield Vl(n,t),yield fp(n,e),r.resolve()}catch(i){let s=i;if(!VE(s))throw s;Et("Error enabling indexeddb cache. Falling back to memory cache: "+s),r.reject(s)}})).then(()=>r.promise)}function $E(n){if(n._initialized&&!n._terminated)throw new k(P.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");let e=new De;return n._queue.enqueueAndForgetEvenWhileRestricted(()=>x(this,null,function*(){try{yield function(r){return x(this,null,function*(){if(!Vn.D())return Promise.resolve();let i=r+"main";yield Vn.delete(i)})}(Up(n._databaseId,n._persistenceKey)),e.resolve()}catch(t){e.reject(t)}})),e.promise}function HE(n){return function(t){let r=new De;return t.asyncQueue.enqueueAndForget(()=>x(this,null,function*(){return nb(yield Zp(t),r)})),r.promise}(Oe(n=oe(n,ve)))}function YE(n){return mb(Oe(n=oe(n,ve)))}function JE(n){return gb(Oe(n=oe(n,ve)))}function XE(n,e){let t=Oe(n=oe(n,ve)),r=new gp;return wb(t,n._databaseId,e,r),r}function ZE(n,e){return Eb(Oe(n=oe(n,ve)),e).then(t=>t?new je(n,null,t.query):null)}function eI(n){if(n._initialized||n._terminated)throw new k(P.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}var Wt=class n{constructor(e){this._byteString=e}static fromBase64String(e){try{return new n(qe.fromBase64String(e))}catch(t){throw new k(P.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(e){return new n(qe.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}};var Pt=class{constructor(...e){for(let t=0;t<e.length;++t)if(e[t].length===0)throw new k(P.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new Ce(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}};var on=class{constructor(e){this._methodName=e}};var Ir=class{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new k(P.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new k(P.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return $(this._lat,e._lat)||$(this._long,e._long)}};var Ib=/^__.*__$/,_p=class{constructor(e,t,r){this.data=e,this.fieldMask=t,this.fieldTransforms=r}toMutation(e,t){return this.fieldMask!==null?new Rt(e,this.data,this.fieldMask,t,this.fieldTransforms):new qn(e,this.data,t,this.fieldTransforms)}},Tu=class{constructor(e,t,r){this.data=e,this.fieldMask=t,this.fieldTransforms=r}toMutation(e,t){return new Rt(e,this.data,this.fieldMask,t,this.fieldTransforms)}};function tI(n){switch(n){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw U()}}var Su=class n{constructor(e,t,r,i,s,o){this.settings=e,this.databaseId=t,this.serializer=r,this.ignoreUndefinedProperties=i,s===void 0&&this.mu(),this.fieldTransforms=s||[],this.fieldMask=o||[]}get path(){return this.settings.path}get fu(){return this.settings.fu}gu(e){return new n(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}pu(e){var t;let r=(t=this.path)===null||t===void 0?void 0:t.child(e),i=this.gu({path:r,yu:!1});return i.wu(e),i}Su(e){var t;let r=(t=this.path)===null||t===void 0?void 0:t.child(e),i=this.gu({path:r,yu:!1});return i.mu(),i}bu(e){return this.gu({path:void 0,yu:!0})}Du(e){return Au(e,this.settings.methodName,this.settings.Cu||!1,this.path,this.settings.vu)}contains(e){return this.fieldMask.find(t=>e.isPrefixOf(t))!==void 0||this.fieldTransforms.find(t=>e.isPrefixOf(t.field))!==void 0}mu(){if(this.path)for(let e=0;e<this.path.length;e++)this.wu(this.path.get(e))}wu(e){if(e.length===0)throw this.Du("Document fields must not be empty");if(tI(this.fu)&&Ib.test(e))throw this.Du('Document fields cannot begin and end with "__"')}},yp=class{constructor(e,t,r){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=r||ko(e)}Fu(e,t,r,i=!1){return new Su({fu:e,methodName:t,vu:r,path:Ce.emptyPath(),yu:!1,Cu:i},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}};function Cr(n){let e=n._freezeSettings(),t=ko(n._databaseId);return new yp(n._databaseId,!!e.ignoreUndefinedProperties,t)}function Ou(n,e,t,r,i,s={}){let o=n.Fu(s.merge||s.mergeFields?2:0,e,t,i);am("Data must be an object, but it was:",o,r);let l=iI(r,o),u,c;if(s.merge)u=new pt(o.fieldMask),c=o.fieldTransforms;else if(s.mergeFields){let d=[];for(let p of s.mergeFields){let m=Tp(e,p,t);if(!o.contains(m))throw new k(P.INVALID_ARGUMENT,`Field '${m}' is specified in your field mask but missing from your input data.`);oI(d,m)||d.push(m)}u=new pt(d),c=o.fieldTransforms.filter(p=>u.covers(p.field))}else u=null,c=o.fieldTransforms;return new _p(new Ye(l),u,c)}var bo=class n extends on{_toFieldTransform(e){if(e.fu!==2)throw e.fu===1?e.Du(`${this._methodName}() can only appear at the top level of your update data`):e.Du(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof n}};function nI(n,e,t){return new Su({fu:3,vu:e.settings.vu,methodName:n._methodName,yu:t},e.databaseId,e.serializer,e.ignoreUndefinedProperties)}var vp=class n extends on{_toFieldTransform(e){return new yr(e.path,new Ln)}isEqual(e){return e instanceof n}},wp=class n extends on{constructor(e,t){super(e),this.Mu=t}_toFieldTransform(e){let t=nI(this,e,!0),r=this.Mu.map(s=>br(s,t)),i=new rn(r);return new yr(e.path,i)}isEqual(e){return e instanceof n&&Ic(this.Mu,e.Mu)}},Ep=class n extends on{constructor(e,t){super(e),this.Mu=t}_toFieldTransform(e){let t=nI(this,e,!0),r=this.Mu.map(s=>br(s,t)),i=new sn(r);return new yr(e.path,i)}isEqual(e){return e instanceof n&&Ic(this.Mu,e.Mu)}},Ip=class n extends on{constructor(e,t){super(e),this.xu=t}_toFieldTransform(e){let t=new Un(e.serializer,Bw(e.serializer,this.xu));return new yr(e.path,t)}isEqual(e){return e instanceof n&&this.xu===e.xu}};function sm(n,e,t,r){let i=n.Fu(1,e,t);am("Data must be an object, but it was:",i,r);let s=[],o=Ye.empty();Ar(r,(u,c)=>{let d=lm(e,u,t);c=ee(c);let p=i.Su(d);if(c instanceof bo)s.push(d);else{let m=br(c,p);m!=null&&(s.push(d),o.set(d,m))}});let l=new pt(s);return new Tu(o,l,i.fieldTransforms)}function om(n,e,t,r,i,s){let o=n.Fu(1,e,t),l=[Tp(e,r,t)],u=[i];if(s.length%2!=0)throw new k(P.INVALID_ARGUMENT,`Function ${e}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let m=0;m<s.length;m+=2)l.push(Tp(e,s[m])),u.push(s[m+1]);let c=[],d=Ye.empty();for(let m=l.length-1;m>=0;--m)if(!oI(c,l[m])){let v=l[m],C=u[m];C=ee(C);let N=o.Su(v);if(C instanceof bo)c.push(v);else{let D=br(C,N);D!=null&&(c.push(v),d.set(v,D))}}let p=new pt(c);return new Tu(d,p,o.fieldTransforms)}function rI(n,e,t,r=!1){return br(t,n.Fu(r?4:3,e))}function br(n,e){if(sI(n=ee(n)))return am("Unsupported field value:",e,n),iI(n,e);if(n instanceof on)return function(r,i){if(!tI(i.fu))throw i.Du(`${r._methodName}() can only be used with update() and set()`);if(!i.path)throw i.Du(`${r._methodName}() is not currently supported inside arrays`);let s=r._toFieldTransform(i);s&&i.fieldTransforms.push(s)}(n,e),null;if(n===void 0&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),n instanceof Array){if(e.settings.yu&&e.fu!==4)throw e.Du("Nested arrays are not supported");return function(r,i){let s=[],o=0;for(let l of r){let u=br(l,i.bu(o));u==null&&(u={nullValue:"NULL_VALUE"}),s.push(u),o++}return{arrayValue:{values:s}}}(n,e)}return function(r,i){if((r=ee(r))===null)return{nullValue:"NULL_VALUE"};if(typeof r=="number")return Bw(i.serializer,r);if(typeof r=="boolean")return{booleanValue:r};if(typeof r=="string")return{stringValue:r};if(r instanceof Date){let s=Ee.fromDate(r);return{timestampValue:Ti(i.serializer,s)}}if(r instanceof Ee){let s=new Ee(r.seconds,1e3*Math.floor(r.nanoseconds/1e3));return{timestampValue:Ti(i.serializer,s)}}if(r instanceof Ir)return{geoPointValue:{latitude:r.latitude,longitude:r.longitude}};if(r instanceof Wt)return{bytesValue:Jw(i.serializer,r._byteString)};if(r instanceof me){let s=i.databaseId,o=r.firestore._databaseId;if(!o.isEqual(s))throw i.Du(`Document reference is for database ${o.projectId}/${o.database} but should be for database ${s.projectId}/${s.database}`);return{referenceValue:Op(r.firestore._databaseId||i.databaseId,r._key.path)}}throw i.Du(`Unsupported field value: ${Mu(r)}`)}(n,e)}function iI(n,e){let t={};return Tw(n)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):Ar(n,(r,i)=>{let s=br(i,e.pu(r));s!=null&&(t[r]=s)}),{mapValue:{fields:t}}}function sI(n){return!(typeof n!="object"||n===null||n instanceof Array||n instanceof Date||n instanceof Ee||n instanceof Ir||n instanceof Wt||n instanceof me||n instanceof on)}function am(n,e,t){if(!sI(t)||!function(i){return typeof i=="object"&&i!==null&&(Object.getPrototypeOf(i)===Object.prototype||Object.getPrototypeOf(i)===null)}(t)){let r=Mu(t);throw r==="an object"?e.Du(n+" a custom object"):e.Du(n+" "+r)}}function Tp(n,e,t){if((e=ee(e))instanceof Pt)return e._internalPath;if(typeof e=="string")return lm(n,e);throw Au("Field path arguments must be of type string or ",n,!1,void 0,t)}var Tb=new RegExp("[~\\*/\\[\\]]");function lm(n,e,t){if(e.search(Tb)>=0)throw Au(`Invalid field path (${e}). Paths must not contain '~', '*', '/', '[', or ']'`,n,!1,void 0,t);try{return new Pt(...e.split("."))._internalPath}catch{throw Au(`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,n,!1,void 0,t)}}function Au(n,e,t,r,i){let s=r&&!r.isEmpty(),o=i!==void 0,l=`Function ${e}() called with invalid data`;t&&(l+=" (via `toFirestore()`)"),l+=". ";let u="";return(s||o)&&(u+=" (found",s&&(u+=` in field ${r}`),o&&(u+=` in document ${i}`),u+=")"),new k(P.INVALID_ARGUMENT,l+n+u)}function oI(n,e){return n.some(t=>t.isEqual(e))}var Tr=class{constructor(e,t,r,i,s){this._firestore=e,this._userDataWriter=t,this._key=r,this._document=i,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new me(this._firestore,this._converter,this._key)}exists(){return this._document!==null}data(){if(this._document){if(this._converter){let e=new Sp(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){let t=this._document.data.field(Fu("DocumentSnapshot.get",e));if(t!==null)return this._userDataWriter.convertValue(t)}}},Sp=class extends Tr{data(){return super.data()}};function Fu(n,e){return typeof e=="string"?lm(n,e):e instanceof Pt?e._internalPath:e._delegate._internalPath}function aI(n){if(n.limitType==="L"&&n.explicitOrderBy.length===0)throw new k(P.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}var Ro=class{},Sr=class extends Ro{};function un(n,e,...t){let r=[];e instanceof Ro&&r.push(e),r=r.concat(t),function(s){let o=s.filter(u=>u instanceof Ap).length,l=s.filter(u=>u instanceof Cu).length;if(o>1||o>0&&l>0)throw new k(P.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(let i of r)n=i._apply(n);return n}var Cu=class n extends Sr{constructor(e,t,r){super(),this._field=e,this._op=t,this._value=r,this.type="where"}static _create(e,t,r){return new n(e,t,r)}_apply(e){let t=this._parse(e);return _I(e._query,t),new je(e.firestore,e.converter,tf(e._query,t))}_parse(e){let t=Cr(e.firestore);return function(s,o,l,u,c,d,p){let m;if(c.isKeyField()){if(d==="array-contains"||d==="array-contains-any")throw new k(P.INVALID_ARGUMENT,`Invalid Query. You can't perform '${d}' queries on documentId().`);if(d==="in"||d==="not-in"){uw(p,d);let v=[];for(let C of p)v.push(lw(u,s,C));m={arrayValue:{values:v}}}else m=lw(u,s,p)}else d!=="in"&&d!=="not-in"&&d!=="array-contains-any"||uw(p,d),m=rI(l,o,p,d==="in"||d==="not-in");return te.create(c,d,m)}(e._query,"where",t,e.firestore._databaseId,this._field,this._op,this._value)}};function lI(n,e,t){let r=e,i=Fu("where",n);return Cu._create(i,r,t)}var Ap=class n extends Ro{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new n(e,t)}_parse(e){let t=this._queryConstraints.map(r=>r._parse(e)).filter(r=>r.getFilters().length>0);return t.length===1?t[0]:ce.create(t,this._getOperator())}_apply(e){let t=this._parse(e);return t.getFilters().length===0?e:(function(i,s){let o=i,l=s.getFlattenedFilters();for(let u of l)_I(o,u),o=tf(o,u)}(e._query,t),new je(e.firestore,e.converter,tf(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return this.type==="and"?"and":"or"}};var Cp=class n extends Sr{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new n(e,t)}_apply(e){let t=function(i,s,o){if(i.startAt!==null)throw new k(P.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(i.endAt!==null)throw new k(P.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new gr(s,o)}(e._query,this._field,this._direction);return new je(e.firestore,e.converter,function(i,s){let o=i.explicitOrderBy.concat([s]);return new bt(i.path,i.collectionGroup,o,i.filters.slice(),i.limit,i.limitType,i.startAt,i.endAt)}(e._query,t))}};function uI(n,e="asc"){let t=e,r=Fu("orderBy",n);return Cp._create(r,t)}var bu=class n extends Sr{constructor(e,t,r){super(),this.type=e,this._limit=t,this._limitType=r}static _create(e,t,r){return new n(e,t,r)}_apply(e){return new je(e.firestore,e.converter,Wl(e._query,this._limit,this._limitType))}};function cI(n){return qE("limit",n),bu._create("limit",n,"F")}function hI(n){return qE("limitToLast",n),bu._create("limitToLast",n,"L")}var Ru=class n extends Sr{constructor(e,t,r){super(),this.type=e,this._docOrFields=t,this._inclusive=r}static _create(e,t,r){return new n(e,t,r)}_apply(e){let t=gI(e,this.type,this._docOrFields,this._inclusive);return new je(e.firestore,e.converter,function(i,s){return new bt(i.path,i.collectionGroup,i.explicitOrderBy.slice(),i.filters.slice(),i.limit,i.limitType,s,i.endAt)}(e._query,t))}};function dI(...n){return Ru._create("startAt",n,!0)}function fI(...n){return Ru._create("startAfter",n,!1)}var Pu=class n extends Sr{constructor(e,t,r){super(),this.type=e,this._docOrFields=t,this._inclusive=r}static _create(e,t,r){return new n(e,t,r)}_apply(e){let t=gI(e,this.type,this._docOrFields,this._inclusive);return new je(e.firestore,e.converter,function(i,s){return new bt(i.path,i.collectionGroup,i.explicitOrderBy.slice(),i.filters.slice(),i.limit,i.limitType,i.startAt,s)}(e._query,t))}};function pI(...n){return Pu._create("endBefore",n,!1)}function mI(...n){return Pu._create("endAt",n,!0)}function gI(n,e,t,r){if(t[0]=ee(t[0]),t[0]instanceof Tr)return function(s,o,l,u,c){if(!u)throw new k(P.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${l}().`);let d=[];for(let p of mi(s))if(p.field.isKeyField())d.push(mr(o,u.key));else{let m=u.data.field(p.field);if(Nu(m))throw new k(P.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+p.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(m===null){let v=p.field.canonicalString();throw new k(P.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${v}' (used as the orderBy) does not exist.`)}d.push(m)}return new zt(d,c)}(n._query,n.firestore._databaseId,e,t[0]._document,r);{let i=Cr(n.firestore);return function(o,l,u,c,d,p){let m=o.explicitOrderBy;if(d.length>m.length)throw new k(P.INVALID_ARGUMENT,`Too many arguments provided to ${c}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);let v=[];for(let C=0;C<d.length;C++){let N=d[C];if(m[C].field.isKeyField()){if(typeof N!="string")throw new k(P.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${c}(), but got a ${typeof N}`);if(!Vp(o)&&N.indexOf("/")!==-1)throw new k(P.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${c}() must be a plain document ID, but '${N}' contains a slash.`);let D=o.path.child(se.fromString(N));if(!F.isDocumentKey(D))throw new k(P.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${c}() must result in a valid document path, but '${D}' is not because it contains an odd number of segments.`);let B=new F(D);v.push(mr(l,B))}else{let D=rI(u,c,N);v.push(D)}}return new zt(v,p)}(n._query,n.firestore._databaseId,i,e,t,r)}}function lw(n,e,t){if(typeof(t=ee(t))=="string"){if(t==="")throw new k(P.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Vp(e)&&t.indexOf("/")!==-1)throw new k(P.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${t}' contains a '/' character.`);let r=e.path.child(se.fromString(t));if(!F.isDocumentKey(r))throw new k(P.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return mr(n,new F(r))}if(t instanceof me)return mr(n,t._key);throw new k(P.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Mu(t)}.`)}function uw(n,e){if(!Array.isArray(n)||n.length===0)throw new k(P.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${e.toString()}' filters.`)}function _I(n,e){let t=function(i,s){for(let o of i)for(let l of o.getFlattenedFilters())if(s.indexOf(l.op)>=0)return l.op;return null}(n.filters,function(i){switch(i){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(e.op));if(t!==null)throw t===e.op?new k(P.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${e.op.toString()}' filter.`):new k(P.INVALID_ARGUMENT,`Invalid query. You cannot use '${e.op.toString()}' filters with '${t.toString()}' filters.`)}var ki=class{convertValue(e,t="none"){switch(pr(e)){case 0:return null;case 1:return e.booleanValue;case 2:return Te(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(Mn(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw U()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){let r={};return Ar(e,(i,s)=>{r[i]=this.convertValue(s,t)}),r}convertGeoPoint(e){return new Ir(Te(e.latitude),Te(e.longitude))}convertArray(e,t){return(e.values||[]).map(r=>this.convertValue(r,t))}convertServerTimestamp(e,t){switch(t){case"previous":let r=Dp(e);return r==null?null:this.convertValue(r,t);case"estimate":return this.convertTimestamp(uo(e));default:return null}}convertTimestamp(e){let t=nn(e);return new Ee(t.seconds,t.nanos)}convertDocumentKey(e,t){let r=se.fromString(e);G(lE(r));let i=new On(r.get(1),r.get(3)),s=new F(r.popFirst(5));return i.isEqual(t)||Ae(`Document ${s} contains a document reference within a different database (${i.projectId}/${i.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),s}};function Lu(n,e,t){let r;return r=n?t&&(t.merge||t.mergeFields)?n.toFirestore(e,t):n.toFirestore(e):e,r}var bp=class extends ki{constructor(e){super(),this.firestore=e}convertBytes(e){return new Wt(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new me(this.firestore,null,t)}};var tn=class{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}},Tt=class extends Tr{constructor(e,t,r,i,s,o){super(e,t,r,i,o),this._firestore=e,this._firestoreImpl=e,this.metadata=s}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){let t=new Dn(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){let r=this._document.data.field(Fu("DocumentSnapshot.get",e));if(r!==null)return this._userDataWriter.convertValue(r,t.serverTimestamps)}}},Dn=class extends Tt{data(e={}){return super.data(e)}},xt=class{constructor(e,t,r,i){this._firestore=e,this._userDataWriter=t,this._snapshot=i,this.metadata=new tn(i.hasPendingWrites,i.fromCache),this.query=r}get docs(){let e=[];return this.forEach(t=>e.push(t)),e}get size(){return this._snapshot.docs.size}get empty(){return this.size===0}forEach(e,t){this._snapshot.docs.forEach(r=>{e.call(t,new Dn(this._firestore,this._userDataWriter,r.key,r,new tn(this._snapshot.mutatedKeys.has(r.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){let t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new k(P.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(i,s){if(i._snapshot.oldDocs.isEmpty()){let o=0;return i._snapshot.docChanges.map(l=>{let u=new Dn(i._firestore,i._userDataWriter,l.doc.key,l.doc,new tn(i._snapshot.mutatedKeys.has(l.doc.key),i._snapshot.fromCache),i.query.converter);return l.doc,{type:"added",doc:u,oldIndex:-1,newIndex:o++}})}{let o=i._snapshot.oldDocs;return i._snapshot.docChanges.filter(l=>s||l.type!==3).map(l=>{let u=new Dn(i._firestore,i._userDataWriter,l.doc.key,l.doc,new tn(i._snapshot.mutatedKeys.has(l.doc.key),i._snapshot.fromCache),i.query.converter),c=-1,d=-1;return l.type!==0&&(c=o.indexOf(l.doc.key),o=o.delete(l.doc.key)),l.type!==1&&(o=o.add(l.doc),d=o.indexOf(l.doc.key)),{type:Sb(l.type),doc:u,oldIndex:c,newIndex:d}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}};function Sb(n){switch(n){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return U()}}function um(n,e){return n instanceof Tt&&e instanceof Tt?n._firestore===e._firestore&&n._key.isEqual(e._key)&&(n._document===null?e._document===null:n._document.isEqual(e._document))&&n._converter===e._converter:n instanceof xt&&e instanceof xt&&n._firestore===e._firestore&&im(n.query,e.query)&&n.metadata.isEqual(e.metadata)&&n._snapshot.isEqual(e._snapshot)}function yI(n){n=oe(n,me);let e=oe(n.firestore,ve);return FE(Oe(e),n._key).then(t=>fm(e,n,t))}var an=class extends ki{constructor(e){super(),this.firestore=e}convertBytes(e){return new Wt(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new me(this.firestore,null,t)}};function vI(n){n=oe(n,me);let e=oe(n.firestore,ve),t=Oe(e),r=new an(e);return _b(t,n._key).then(i=>new Tt(e,r,n._key,i,new tn(i!==null&&i.hasLocalMutations,!0),n.converter))}function wI(n){n=oe(n,me);let e=oe(n.firestore,ve);return FE(Oe(e),n._key,{source:"server"}).then(t=>fm(e,n,t))}function EI(n){n=oe(n,je);let e=oe(n.firestore,ve),t=Oe(e),r=new an(e);return aI(n._query),LE(t,n._query).then(i=>new xt(e,r,n,i))}function II(n){n=oe(n,je);let e=oe(n.firestore,ve),t=Oe(e),r=new an(e);return yb(t,n._query).then(i=>new xt(e,r,n,i))}function TI(n){n=oe(n,je);let e=oe(n.firestore,ve),t=Oe(e),r=new an(e);return LE(t,n._query,{source:"server"}).then(i=>new xt(e,r,n,i))}function cm(n,e,t){n=oe(n,me);let r=oe(n.firestore,ve),i=Lu(n.converter,e,t);return qi(r,[Ou(Cr(r),"setDoc",n._key,i,n.converter!==null,t).toMutation(n._key,Se.none())])}function hm(n,e,t,...r){n=oe(n,me);let i=oe(n.firestore,ve),s=Cr(i),o;return o=typeof(e=ee(e))=="string"||e instanceof Pt?om(s,"updateDoc",n._key,e,t,r):sm(s,"updateDoc",n._key,e),qi(i,[o.toMutation(n._key,Se.exists(!0))])}function SI(n){return qi(oe(n.firestore,ve),[new Bn(n._key,Se.none())])}function AI(n,e){let t=oe(n.firestore,ve),r=Mo(n),i=Lu(n.converter,e);return qi(t,[Ou(Cr(n.firestore),"addDoc",r._key,i,n.converter!==null,{}).toMutation(r._key,Se.exists(!1))]).then(()=>r)}function dm(n,...e){var t,r,i;n=ee(n);let s={includeMetadataChanges:!1,source:"default"},o=0;typeof e[o]!="object"||mp(e[o])||(s=e[o],o++);let l={includeMetadataChanges:s.includeMetadataChanges,source:s.source};if(mp(e[o])){let p=e[o];e[o]=(t=p.next)===null||t===void 0?void 0:t.bind(p),e[o+1]=(r=p.error)===null||r===void 0?void 0:r.bind(p),e[o+2]=(i=p.complete)===null||i===void 0?void 0:i.bind(p)}let u,c,d;if(n instanceof me)c=oe(n.firestore,ve),d=Mi(n._key.path),u={next:p=>{e[o]&&e[o](fm(c,n,p))},error:e[o+1],complete:e[o+2]};else{let p=oe(n,je);c=oe(p.firestore,ve),d=p._query;let m=new an(c);u={next:v=>{e[o]&&e[o](new xt(c,m,p,v))},error:e[o+1],complete:e[o+2]},aI(n._query)}return function(m,v,C,N){let D=new Ni(N),B=new So(v,D,C);return m.asyncQueue.enqueueAndForget(()=>x(this,null,function*(){return jp(yield Di(m),B)})),()=>{D.$a(),m.asyncQueue.enqueueAndForget(()=>x(this,null,function*(){return zp(yield Di(m),B)}))}}(Oe(c),d,l,u)}function CI(n,e){return vb(Oe(n=oe(n,ve)),mp(e)?e:{next:e})}function qi(n,e){return function(r,i){let s=new De;return r.asyncQueue.enqueueAndForget(()=>x(this,null,function*(){return X0(yield Zp(r),i,s)})),s.promise}(Oe(n),e)}function fm(n,e,t){let r=t.docs.get(e._key),i=new an(n);return new Tt(n,i,e._key,r,new tn(t.hasPendingWrites,t.fromCache),e.converter)}var Ab={maxAttempts:5};var xu=class{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=Cr(e)}set(e,t,r){this._verifyNotCommitted();let i=xn(e,this._firestore),s=Lu(i.converter,t,r),o=Ou(this._dataReader,"WriteBatch.set",i._key,s,i.converter!==null,r);return this._mutations.push(o.toMutation(i._key,Se.none())),this}update(e,t,r,...i){this._verifyNotCommitted();let s=xn(e,this._firestore),o;return o=typeof(t=ee(t))=="string"||t instanceof Pt?om(this._dataReader,"WriteBatch.update",s._key,t,r,i):sm(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(o.toMutation(s._key,Se.exists(!0))),this}delete(e){this._verifyNotCommitted();let t=xn(e,this._firestore);return this._mutations=this._mutations.concat(new Bn(t._key,Se.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new k(P.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}};function xn(n,e){if((n=ee(n)).firestore!==e)throw new k(P.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return n}var Rp=class extends class{constructor(t,r){this._firestore=t,this._transaction=r,this._dataReader=Cr(t)}get(t){let r=xn(t,this._firestore),i=new bp(this._firestore);return this._transaction.lookup([r._key]).then(s=>{if(!s||s.length!==1)return U();let o=s[0];if(o.isFoundDocument())return new Tr(this._firestore,i,o.key,o,r.converter);if(o.isNoDocument())return new Tr(this._firestore,i,r._key,null,r.converter);throw U()})}set(t,r,i){let s=xn(t,this._firestore),o=Lu(s.converter,r,i),l=Ou(this._dataReader,"Transaction.set",s._key,o,s.converter!==null,i);return this._transaction.set(s._key,l),this}update(t,r,i,...s){let o=xn(t,this._firestore),l;return l=typeof(r=ee(r))=="string"||r instanceof Pt?om(this._dataReader,"Transaction.update",o._key,r,i,s):sm(this._dataReader,"Transaction.update",o._key,r),this._transaction.update(o._key,l),this}delete(t){let r=xn(t,this._firestore);return this._transaction.delete(r._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){let t=xn(e,this._firestore),r=new an(this._firestore);return super.get(e).then(i=>new Tt(this._firestore,r,t._key,i._document,new tn(!1,!1),t.converter))}};function bI(n,e,t){n=oe(n,ve);let r=Object.assign(Object.assign({},Ab),t);return function(s){if(s.maxAttempts<1)throw new k(P.INVALID_ARGUMENT,"Max attempts must be at least 1")}(r),function(s,o,l){let u=new De;return s.asyncQueue.enqueueAndForget(()=>x(this,null,function*(){let c=yield pb(s);new hp(s.asyncQueue,c,l,o,u).Xa()})),u.promise}(Oe(n),i=>e(new Rp(n,i)),r)}function RI(){return new bo("deleteField")}function PI(){return new vp("serverTimestamp")}function xI(...n){return new wp("arrayUnion",n)}function NI(...n){return new Ep("arrayRemove",n)}function DI(n){return new Ip("increment",n)}(function(e,t=!0){(function(i){Vi=i})(ma),pa(new Dt("firestore",(r,{instanceIdentifier:i,options:s})=>{let o=r.getProvider("app").getImmediate(),l=new ve(new Dd(r.getProvider("auth-internal")),new Od(r.getProvider("app-check-internal")),function(c,d){if(!Object.prototype.hasOwnProperty.apply(c.options,["projectId"]))throw new k(P.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new On(c.options.projectId,d)}(o,i),o);return s=Object.assign({useFetchStreams:t},s),l._setSettings(s),l},"PUBLIC").setMultipleInstances(!0)),Ur(cv,"4.6.4",e),Ur(cv,"4.6.4","esm2017")})();var Cb="@firebase/firestore-compat",bb="0.3.33";function vm(n,e){if(e===void 0)return{merge:!1};if(e.mergeFields!==void 0&&e.merge!==void 0)throw new k("invalid-argument",`Invalid options passed to function ${n}(): You cannot specify both "merge" and "mergeFields".`);return e}function kI(){if(typeof Uint8Array>"u")throw new k("unimplemented","Uint8Arrays are not available in this environment.")}function VI(){if(!Sw())throw new k("unimplemented","Blobs are unavailable in Firestore in this environment.")}var Uu=class n{constructor(e){this._delegate=e}static fromBase64String(e){return VI(),new n(Wt.fromBase64String(e))}static fromUint8Array(e){return kI(),new n(Wt.fromUint8Array(e))}toBase64(){return VI(),this._delegate.toBase64()}toUint8Array(){return kI(),this._delegate.toUint8Array()}isEqual(e){return this._delegate.isEqual(e._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}};function pm(n){return Rb(n,["next","error","complete"])}function Rb(n,e){if(typeof n!="object"||n===null)return!1;let t=n;for(let r of e)if(r in t&&typeof t[r]=="function")return!0;return!1}var mm=class{enableIndexedDbPersistence(e,t){return KE(e._delegate,{forceOwnership:t})}enableMultiTabIndexedDbPersistence(e){return WE(e._delegate)}clearIndexedDbPersistence(e){return $E(e._delegate)}},qu=class{constructor(e,t,r){this._delegate=t,this._persistenceProvider=r,this.INTERNAL={delete:()=>this.terminate()},e instanceof On||(this._appCompat=e)}get _databaseId(){return this._delegate._databaseId}settings(e){let t=this._delegate._getSettings();!e.merge&&t.host!==e.host&&Et("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),e.merge&&(e=Object.assign(Object.assign({},t),e),delete e.merge),this._delegate._setSettings(e)}useEmulator(e,t,r={}){BE(this._delegate,e,t,r)}enableNetwork(){return YE(this._delegate)}disableNetwork(){return JE(this._delegate)}enablePersistence(e){let t=!1,r=!1;return e&&(t=!!e.synchronizeTabs,r=!!e.experimentalForceOwningTab,tm("synchronizeTabs",t,"experimentalForceOwningTab",r)),t?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,r)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){return HE(this._delegate)}onSnapshotsInSync(e){return CI(this._delegate,e)}get app(){if(!this._appCompat)throw new k("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._appCompat}collection(e){try{return new ji(this,nm(this._delegate,e))}catch(t){throw st(t,"collection()","Firestore.collection()")}}doc(e){try{return new Qt(this,Mo(this._delegate,e))}catch(t){throw st(t,"doc()","Firestore.doc()")}}collectionGroup(e){try{return new Nr(this,GE(this._delegate,e))}catch(t){throw st(t,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(e){return bI(this._delegate,t=>e(new Bu(this,t)))}batch(){return Oe(this._delegate),new Gu(new xu(this._delegate,e=>qi(this._delegate,e)))}loadBundle(e){return XE(this._delegate,e)}namedQuery(e){return ZE(this._delegate,e).then(t=>t?new Nr(this,t):null)}},Bi=class extends ki{constructor(e){super(),this.firestore=e}convertBytes(e){return new Uu(new Wt(e))}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return Qt.forKey(t,this.firestore,null)}};function Pb(n){cw(n)}var Bu=class{constructor(e,t){this._firestore=e,this._delegate=t,this._userDataWriter=new Bi(e)}get(e){let t=Rr(e);return this._delegate.get(t).then(r=>new Pr(this._firestore,new Tt(this._firestore._delegate,this._userDataWriter,r._key,r._document,r.metadata,t.converter)))}set(e,t,r){let i=Rr(e);return r?(vm("Transaction.set",r),this._delegate.set(i,t,r)):this._delegate.set(i,t),this}update(e,t,r,...i){let s=Rr(e);return arguments.length===2?this._delegate.update(s,t):this._delegate.update(s,t,r,...i),this}delete(e){let t=Rr(e);return this._delegate.delete(t),this}},Gu=class{constructor(e){this._delegate=e}set(e,t,r){let i=Rr(e);return r?(vm("WriteBatch.set",r),this._delegate.set(i,t,r)):this._delegate.set(i,t),this}update(e,t,r,...i){let s=Rr(e);return arguments.length===2?this._delegate.update(s,t):this._delegate.update(s,t,r,...i),this}delete(e){let t=Rr(e);return this._delegate.delete(t),this}commit(){return this._delegate.commit()}},Gi=class n{constructor(e,t,r){this._firestore=e,this._userDataWriter=t,this._delegate=r}fromFirestore(e,t){let r=new Dn(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,null);return this._delegate.fromFirestore(new xr(this._firestore,r),t??{})}toFirestore(e,t){return t?this._delegate.toFirestore(e,t):this._delegate.toFirestore(e)}static getInstance(e,t){let r=n.INSTANCES,i=r.get(e);i||(i=new WeakMap,r.set(e,i));let s=i.get(t);return s||(s=new n(e,new Bi(e),t),i.set(t,s)),s}};Gi.INSTANCES=new WeakMap;var Qt=class n{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new Bi(e)}static forPath(e,t,r){if(e.length%2!==0)throw new k("invalid-argument",`Invalid document reference. Document references must have an even number of segments, but ${e.canonicalString()} has ${e.length}`);return new n(t,new me(t._delegate,r,new F(e)))}static forKey(e,t,r){return new n(t,new me(t._delegate,r,e))}get id(){return this._delegate.id}get parent(){return new ji(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(e){try{return new ji(this.firestore,nm(this._delegate,e))}catch(t){throw st(t,"collection()","DocumentReference.collection()")}}isEqual(e){return e=ee(e),e instanceof me?rm(this._delegate,e):!1}set(e,t){t=vm("DocumentReference.set",t);try{return t?cm(this._delegate,e,t):cm(this._delegate,e)}catch(r){throw st(r,"setDoc()","DocumentReference.set()")}}update(e,t,...r){try{return arguments.length===1?hm(this._delegate,e):hm(this._delegate,e,t,...r)}catch(i){throw st(i,"updateDoc()","DocumentReference.update()")}}delete(){return SI(this._delegate)}onSnapshot(...e){let t=MI(e),r=OI(e,i=>new Pr(this.firestore,new Tt(this.firestore._delegate,this._userDataWriter,i._key,i._document,i.metadata,this._delegate.converter)));return dm(this._delegate,t,r)}get(e){let t;return e?.source==="cache"?t=vI(this._delegate):e?.source==="server"?t=wI(this._delegate):t=yI(this._delegate),t.then(r=>new Pr(this.firestore,new Tt(this.firestore._delegate,this._userDataWriter,r._key,r._document,r.metadata,this._delegate.converter)))}withConverter(e){return new n(this.firestore,e?this._delegate.withConverter(Gi.getInstance(this.firestore,e)):this._delegate.withConverter(null))}};function st(n,e,t){return n.message=n.message.replace(e,t),n}function MI(n){for(let e of n)if(typeof e=="object"&&!pm(e))return e;return{}}function OI(n,e){var t,r;let i;return pm(n[0])?i=n[0]:pm(n[1])?i=n[1]:typeof n[0]=="function"?i={next:n[0],error:n[1],complete:n[2]}:i={next:n[1],error:n[2],complete:n[3]},{next:s=>{i.next&&i.next(e(s))},error:(t=i.error)===null||t===void 0?void 0:t.bind(i),complete:(r=i.complete)===null||r===void 0?void 0:r.bind(i)}}var Pr=class{constructor(e,t){this._firestore=e,this._delegate=t}get ref(){return new Qt(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(e){return this._delegate.data(e)}get(e,t){return this._delegate.get(e,t)}isEqual(e){return um(this._delegate,e._delegate)}},xr=class extends Pr{data(e){let t=this._delegate.data(e);return this._delegate._converter||hw(t!==void 0,"Document in a QueryDocumentSnapshot should exist"),t}},Nr=class n{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new Bi(e)}where(e,t,r){try{return new n(this.firestore,un(this._delegate,lI(e,t,r)))}catch(i){throw st(i,/(orderBy|where)\(\)/,"Query.$1()")}}orderBy(e,t){try{return new n(this.firestore,un(this._delegate,uI(e,t)))}catch(r){throw st(r,/(orderBy|where)\(\)/,"Query.$1()")}}limit(e){try{return new n(this.firestore,un(this._delegate,cI(e)))}catch(t){throw st(t,"limit()","Query.limit()")}}limitToLast(e){try{return new n(this.firestore,un(this._delegate,hI(e)))}catch(t){throw st(t,"limitToLast()","Query.limitToLast()")}}startAt(...e){try{return new n(this.firestore,un(this._delegate,dI(...e)))}catch(t){throw st(t,"startAt()","Query.startAt()")}}startAfter(...e){try{return new n(this.firestore,un(this._delegate,fI(...e)))}catch(t){throw st(t,"startAfter()","Query.startAfter()")}}endBefore(...e){try{return new n(this.firestore,un(this._delegate,pI(...e)))}catch(t){throw st(t,"endBefore()","Query.endBefore()")}}endAt(...e){try{return new n(this.firestore,un(this._delegate,mI(...e)))}catch(t){throw st(t,"endAt()","Query.endAt()")}}isEqual(e){return im(this._delegate,e._delegate)}get(e){let t;return e?.source==="cache"?t=II(this._delegate):e?.source==="server"?t=TI(this._delegate):t=EI(this._delegate),t.then(r=>new Oo(this.firestore,new xt(this.firestore._delegate,this._userDataWriter,this._delegate,r._snapshot)))}onSnapshot(...e){let t=MI(e),r=OI(e,i=>new Oo(this.firestore,new xt(this.firestore._delegate,this._userDataWriter,this._delegate,i._snapshot)));return dm(this._delegate,t,r)}withConverter(e){return new n(this.firestore,e?this._delegate.withConverter(Gi.getInstance(this.firestore,e)):this._delegate.withConverter(null))}},gm=class{constructor(e,t){this._firestore=e,this._delegate=t}get type(){return this._delegate.type}get doc(){return new xr(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}},Oo=class{constructor(e,t){this._firestore=e,this._delegate=t}get query(){return new Nr(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map(e=>new xr(this._firestore,e))}docChanges(e){return this._delegate.docChanges(e).map(t=>new gm(this._firestore,t))}forEach(e,t){this._delegate.forEach(r=>{e.call(t,new xr(this._firestore,r))})}isEqual(e){return um(this._delegate,e._delegate)}},ji=class n extends Nr{constructor(e,t){super(e,t),this.firestore=e,this._delegate=t}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){let e=this._delegate.parent;return e?new Qt(this.firestore,e):null}doc(e){try{return e===void 0?new Qt(this.firestore,Mo(this._delegate)):new Qt(this.firestore,Mo(this._delegate,e))}catch(t){throw st(t,"doc()","CollectionReference.doc()")}}add(e){return AI(this._delegate,e).then(t=>new Qt(this.firestore,t))}isEqual(e){return rm(this._delegate,e._delegate)}withConverter(e){return new n(this.firestore,e?this._delegate.withConverter(Gi.getInstance(this.firestore,e)):this._delegate.withConverter(null))}};function Rr(n){return oe(n,me)}var _m=class n{constructor(...e){this._delegate=new Pt(...e)}static documentId(){return new n(Ce.keyField().canonicalString())}isEqual(e){return e=ee(e),e instanceof Pt?this._delegate._internalPath.isEqual(e._internalPath):!1}};var ym=class n{constructor(e){this._delegate=e}static serverTimestamp(){let e=PI();return e._methodName="FieldValue.serverTimestamp",new n(e)}static delete(){let e=RI();return e._methodName="FieldValue.delete",new n(e)}static arrayUnion(...e){let t=xI(...e);return t._methodName="FieldValue.arrayUnion",new n(t)}static arrayRemove(...e){let t=NI(...e);return t._methodName="FieldValue.arrayRemove",new n(t)}static increment(e){let t=DI(e);return t._methodName="FieldValue.increment",new n(t)}isEqual(e){return this._delegate.isEqual(e._delegate)}};var xb={Firestore:qu,GeoPoint:Ir,Timestamp:Ee,Blob:Uu,Transaction:Bu,WriteBatch:Gu,DocumentReference:Qt,DocumentSnapshot:Pr,Query:Nr,QueryDocumentSnapshot:xr,QuerySnapshot:Oo,CollectionReference:ji,FieldPath:_m,FieldValue:ym,setLogLevel:Pb,CACHE_SIZE_UNLIMITED:jE};function Nb(n,e){n.INTERNAL.registerComponent(new Dt("firestore-compat",t=>{let r=t.getProvider("app-compat").getImmediate(),i=t.getProvider("firestore").getImmediate();return e(r,i)},"PUBLIC").setServiceProps(Object.assign({},xb)))}function Db(n){Nb(n,(e,t)=>new qu(e,t,new mm)),n.registerVersion(Cb,bb)}Db(gn);function kb(n,e=ta){return new ea(t=>{let r;return e!=null?e.schedule(()=>{r=n.onSnapshot({includeMetadataChanges:!0},t)}):r=n.onSnapshot({includeMetadataChanges:!0},t),()=>{r?.()}})}function FI(n,e){return kb(n,e)}function Vb(n,e){return FI(n,e).pipe(ia(void 0),ra(),Fe(t=>{let[r,i]=t;return i.exists?r?.exists?{payload:i,type:"modified"}:{payload:i,type:"added"}:{payload:i,type:"removed"}}))}function Im(n,e){return FI(n,e).pipe(Fe(t=>({payload:t,type:"query"})))}var ju=class{ref;afs;constructor(e,t){this.ref=e,this.afs=t}set(e,t){return this.ref.set(e,t)}update(e){return this.ref.update(e)}delete(){return this.ref.delete()}collection(e,t){let r=this.ref.collection(e),{ref:i,query:s}=GI(r,t);return new Ku(i,s,this.afs)}snapshotChanges(){return Vb(this.ref,this.afs.schedulers.outsideAngular).pipe(Me)}valueChanges(e={}){return this.snapshotChanges().pipe(Fe(({payload:t})=>e.idField?us(Or({},t.data()),{[e.idField]:t.id}):t.data()))}get(e){return cs(this.ref.get(e)).pipe(Me)}};function zu(n,e){return Im(n,e).pipe(ia(void 0),ra(),Fe(t=>{let[r,i]=t,s=i.payload.docChanges(),o=s.map(l=>({type:l.type,payload:l}));return r&&JSON.stringify(r.payload.metadata)!==JSON.stringify(i.payload.metadata)&&i.payload.docs.forEach((l,u)=>{let c=s.find(p=>p.doc.ref.isEqual(l.ref)),d=r?.payload.docs.find(p=>p.ref.isEqual(l.ref));c&&JSON.stringify(c.doc.metadata)===JSON.stringify(l.metadata)||!c&&d&&JSON.stringify(d.metadata)===JSON.stringify(l.metadata)||o.push({type:"modified",payload:{oldIndex:u,newIndex:u,type:"modified",doc:l}})}),o}))}function LI(n,e,t){return zu(n,t).pipe(Yn((r,i)=>Mb(r,i.map(s=>s.payload),e),[]),na(),Fe(r=>r.map(i=>({type:i.type,payload:i}))))}function Mb(n,e,t){return e.forEach(r=>{t.indexOf(r.type)>-1&&(n=Ob(n,r))}),n}function wm(n,e,t,...r){let i=n.slice();return i.splice(e,t,...r),i}function Ob(n,e){switch(e.type){case"added":if(!(n[e.newIndex]&&n[e.newIndex].doc.ref.isEqual(e.doc.ref)))return wm(n,e.newIndex,0,e);break;case"modified":if(n[e.oldIndex]==null||n[e.oldIndex].doc.ref.isEqual(e.doc.ref))if(e.oldIndex!==e.newIndex){let t=n.slice();return t.splice(e.oldIndex,1),t.splice(e.newIndex,0,e),t}else return wm(n,e.newIndex,1,e);break;case"removed":if(n[e.oldIndex]&&n[e.oldIndex].doc.ref.isEqual(e.doc.ref))return wm(n,e.oldIndex,1);break}return n}function UI(n){return(!n||n.length===0)&&(n=["added","removed","modified"]),n}var Ku=class{ref;query;afs;constructor(e,t,r){this.ref=e,this.query=t,this.afs=r}stateChanges(e){let t=zu(this.query,this.afs.schedulers.outsideAngular);return e&&e.length>0&&(t=t.pipe(Fe(r=>r.filter(i=>e.indexOf(i.type)>-1)))),t.pipe(ia(void 0),ra(),vc(([r,i])=>i.length>0||!r),Fe(([,r])=>r),Me)}auditTrail(e){return this.stateChanges(e).pipe(Yn((t,r)=>[...t,...r],[]))}snapshotChanges(e){let t=UI(e);return LI(this.query,t,this.afs.schedulers.outsideAngular).pipe(Me)}valueChanges(e={}){return Im(this.query,this.afs.schedulers.outsideAngular).pipe(Fe(t=>t.payload.docs.map(r=>e.idField?us(Or({},r.data()),{[e.idField]:r.id}):r.data())),Me)}get(e){return cs(this.query.get(e)).pipe(Me)}add(e){return this.ref.add(e)}doc(e){return new ju(this.ref.doc(e),this.afs)}},Em=class{query;afs;constructor(e,t){this.query=e,this.afs=t}stateChanges(e){return!e||e.length===0?zu(this.query,this.afs.schedulers.outsideAngular).pipe(Me):zu(this.query,this.afs.schedulers.outsideAngular).pipe(Fe(t=>t.filter(r=>e.indexOf(r.type)>-1)),vc(t=>t.length>0),Me)}auditTrail(e){return this.stateChanges(e).pipe(Yn((t,r)=>[...t,...r],[]))}snapshotChanges(e){let t=UI(e);return LI(this.query,t,this.afs.schedulers.outsideAngular).pipe(Me)}valueChanges(e={}){return Im(this.query,this.afs.schedulers.outsideAngular).pipe(Fe(r=>r.payload.docs.map(i=>e.idField?Or({[e.idField]:i.id},i.data()):i.data())),Me)}get(e){return cs(this.query.get(e)).pipe(Me)}},qI=new pn("angularfire2.enableFirestorePersistence"),BI=new pn("angularfire2.firestore.persistenceSettings"),Fb=new pn("angularfire2.firestore.settings"),Lb=new pn("angularfire2.firestore.use-emulator");function GI(n,e=t=>t){return{query:e(n),ref:n}}var Ub=(()=>{class n{schedulers;firestore;persistenceEnabled$;constructor(t,r,i,s,o,l,u,c,d,p,m,v,C,N,D,B,j){this.schedulers=u;let q=Ea(t,l,r),Y=d;p&&Pa(q,l,m,C,N,D,v,B),[this.firestore,this.persistenceEnabled$]=Ia(`${q.name}.firestore`,"AngularFirestore",q.name,()=>{let ne=l.runOutsideAngular(()=>q.firestore());if(s&&ne.settings(s),Y&&ne.useEmulator(...Y),i&&!Rg(o)){let W=()=>{try{return cs(ne.enablePersistence(c||void 0).then(()=>!0,()=>!1))}catch(E){return typeof console<"u"&&console.warn(E),hs(!1)}};return[ne,l.runOutsideAngular(W)]}else return[ne,hs(!1)]},[s,Y,i])}collection(t,r){let i;typeof t=="string"?i=this.firestore.collection(t):i=t;let{ref:s,query:o}=GI(i,r),l=this.schedulers.ngZone.run(()=>s);return new Ku(l,o,this)}collectionGroup(t,r){let i=r||(o=>o),s=this.firestore.collectionGroup(t);return new Em(i(s),this)}doc(t){let r;typeof t=="string"?r=this.firestore.doc(t):r=t;let i=this.schedulers.ngZone.run(()=>r);return new ju(i,this)}createId(){return this.firestore.collection("_").doc().id}static \u0275fac=function(r){return new(r||n)(re(va),re(wa,8),re(qI,8),re(Fb,8),re(la),re(ua),re(ya),re(BI,8),re(Lb,8),re(xa,8),re(Ta,8),re(Sa,8),re(Aa,8),re(Ca,8),re(ba,8),re(Ra,8),re(_a,8))};static \u0275prov=sa({token:n,factory:n.\u0275fac,providedIn:"any"})}return n})(),XR=(()=>{class n{constructor(){gn.registerVersion("angularfire",ga.full,"fst-compat")}static enablePersistence(t){return{ngModule:n,providers:[{provide:qI,useValue:!0},{provide:BI,useValue:t}]}}static \u0275fac=function(r){return new(r||n)};static \u0275mod=aa({type:n});static \u0275inj=oa({providers:[Ub]})}return n})();var tP={production:!0,firebase:{apiKey:"********************************",authDomain:"********************************",projectId:"********************************",storageBucket:"********************************",messagingSenderId:"********************************",appId:"********************************",measurementId:"********************************"}};export{dR as a,XR as b,tP as c};
